<%- include('partials/header', { title: pageTitle || "Doctor Reviews", layout: "portal", showNav: false }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _reviews = (typeof reviews !== 'undefined' && Array.isArray(reviews)) ? reviews : [];
  var _avgRating = (typeof avgRating !== 'undefined') ? avgRating : 0;
  var _totalReviews = (typeof totalReviews !== 'undefined') ? totalReviews : 0;
  var _distribution = (typeof distribution !== 'undefined' && Array.isArray(distribution)) ? distribution : [];
  var _doctor = (typeof doctor !== 'undefined') ? doctor : {};
  var _specialtyName = (typeof specialtyName !== 'undefined') ? specialtyName : '';

  function stars(n) {
    var s = '';
    for (var i = 1; i <= 5; i++) {
      s += i <= n ? '<span style="color:#f59e0b;">&#9733;</span>' : '<span style="color:#e2e8f0;">&#9733;</span>';
    }
    return s;
  }

  function fmtDate(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleDateString(_lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
%>

<link rel="stylesheet" href="/css/portal-variables.css">
<link rel="stylesheet" href="/css/portal-components.css">

<style>
  .review-header { text-align: center; padding: 2rem 1rem 1.5rem; }
  .review-header h2 { margin: 0; font-size: 1.5rem; }
  .review-header .subtitle { color: #64748b; margin: 0.25rem 0; }
  .rating-summary { display: flex; align-items: center; justify-content: center; gap: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 12px; margin: 0 auto 2rem; max-width: 500px; }
  .big-rating { font-size: 3rem; font-weight: 800; color: var(--deep-blue, #1a365d); line-height: 1; }
  .big-stars { font-size: 1.5rem; margin: 0.25rem 0; }
  .rating-count { font-size: 0.85rem; color: #64748b; }
  .dist-bar { display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0; font-size: 0.8rem; }
  .dist-bar .bar { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
  .dist-bar .bar .fill { height: 100%; background: #f59e0b; border-radius: 4px; }
  .reviews-list { max-width: 700px; margin: 0 auto; padding: 0 1rem; }
  .review-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem; }
  .review-card .rc-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
  .review-card .rc-name { font-weight: 600; color: #1e293b; }
  .review-card .rc-date { font-size: 0.8rem; color: #94a3b8; }
  .review-card .rc-text { color: #475569; font-size: 0.92rem; line-height: 1.5; margin-top: 0.5rem; }
  .no-reviews { text-align: center; color: #94a3b8; padding: 3rem 1rem; }
</style>

<div style="padding: 1rem;">
  <div class="review-header">
    <h2><%= _isAr ? 'تقييمات د. ' : 'Reviews for Dr. ' %><%= _doctor.name || '' %></h2>
    <% if (_specialtyName) { %>
      <p class="subtitle"><%= _specialtyName %></p>
    <% } %>
  </div>

  <div class="rating-summary">
    <div>
      <div class="big-rating"><%= _avgRating %></div>
      <div class="big-stars"><%- stars(Math.round(_avgRating)) %></div>
      <div class="rating-count"><%= _totalReviews %> <%= _isAr ? 'تقييم' : 'reviews' %></div>
    </div>
    <div style="flex:1;max-width:200px;">
      <% for (var r = 5; r >= 1; r--) {
        var dRow = _distribution.find(function(d) { return d.rating === r; });
        var cnt = dRow ? dRow.count : 0;
        var pct = _totalReviews > 0 ? Math.round((cnt / _totalReviews) * 100) : 0;
      %>
        <div class="dist-bar">
          <span><%= r %>&#9733;</span>
          <div class="bar"><div class="fill" style="width:<%= pct %>%;"></div></div>
          <span><%= cnt %></span>
        </div>
      <% } %>
    </div>
  </div>

  <div class="reviews-list">
    <% if (_reviews.length === 0) { %>
      <div class="no-reviews"><%= _isAr ? 'لا توجد تقييمات بعد' : 'No reviews yet' %></div>
    <% } %>
    <% _reviews.forEach(function(rv) { %>
      <div class="review-card">
        <div class="rc-top">
          <span class="rc-name"><%= rv.is_anonymous ? (_isAr ? 'مريض مجهول' : 'Anonymous Patient') : (rv.patient_name || (_isAr ? 'مريض' : 'Patient')) %></span>
          <span class="rc-date"><%= fmtDate(rv.created_at) %></span>
        </div>
        <div><%- stars(rv.rating) %></div>
        <% if (rv.review_text) { %>
          <div class="rc-text"><%= rv.review_text %></div>
        <% } %>
      </div>
    <% }); %>
  </div>
</div>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
