<%- include('partials/header', { title: pageTitle || "Medical Records", layout: "portal", showNav: false }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _records = (typeof records !== 'undefined' && Array.isArray(records)) ? records : [];
  var _recordTypes = (typeof recordTypes !== 'undefined' && Array.isArray(recordTypes)) ? recordTypes : [];
  var _filters = (typeof filters !== 'undefined') ? filters : {};

  var typeLabels = {
    lab_result: { en: 'Lab Result', ar: 'Ù†ØªÙŠØ¬Ø© Ù…Ø®Ø¨Ø±ÙŠØ©' },
    imaging: { en: 'Imaging', ar: 'Ø£Ø´Ø¹Ø©' },
    prescription: { en: 'Prescription', ar: 'ÙˆØµÙØ© Ø·Ø¨ÙŠØ©' },
    discharge_summary: { en: 'Discharge Summary', ar: 'Ù…Ù„Ø®Øµ Ø®Ø±ÙˆØ¬' },
    surgical_report: { en: 'Surgical Report', ar: 'ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø§Ø­ÙŠ' },
    vaccination: { en: 'Vaccination', ar: 'ØªØ·Ø¹ÙŠÙ…' },
    allergy: { en: 'Allergy', ar: 'Ø­Ø³Ø§Ø³ÙŠØ©' },
    chronic_condition: { en: 'Chronic Condition', ar: 'Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†' },
    case_report: { en: 'Case Report', ar: 'ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø©' },
    other: { en: 'Other', ar: 'Ø£Ø®Ø±Ù‰' }
  };

  function typeLabel(type) {
    var t = typeLabels[type];
    return t ? (_isAr ? t.ar : t.en) : type;
  }

  function fmtDate(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleDateString(_lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }

  var typeIcons = {
    lab_result: 'ðŸ§ª', imaging: 'ðŸ“·', prescription: 'ðŸ’Š', discharge_summary: 'ðŸ“‹',
    surgical_report: 'ðŸ¥', vaccination: 'ðŸ’‰', allergy: 'âš ï¸', chronic_condition: 'â¤ï¸', case_report: 'ðŸ“', other: 'ðŸ“„'
  };
%>

<style nonce="<%= typeof cspNonce !== 'undefined' && cspNonce ? cspNonce : '' %>">
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.visible { display: flex; }
  .modal-box { background: var(--p1-surface); border-radius: var(--p1-r); padding: 1.5rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--p1-shadow-hover); }
  .modal-box .form-group { margin-bottom: 1rem; }
  .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
</style>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo"><%= (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa' %> <span><%= _isAr ? 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient Portal' %></span></div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'records', isAr: _isAr, user: (typeof user !== 'undefined' ? user : {}) }) %>
    <main class="portal-content">

      <!-- Hero -->
      <div class="portal-hero">
        <div>
          <h1 class="portal-hero-title"><%= _isAr ? 'Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©' : 'Medical Records' %></h1>
          <p class="portal-hero-subtitle"><%= _isAr ? 'Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„Ø§ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†' : 'Manage and view your medical records securely' %></p>
        </div>
        <div class="portal-hero-actions">
          <button class="p-btn p-btn-primary" onclick="showAddModal()">+ <%= _isAr ? 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„' : 'Add Record' %></button>
        </div>
      </div>

      <!-- GDPR Info Banner -->
      <div class="flow-card" style="border-left:4px solid var(--p1-accent);margin-bottom:18px;display:flex;align-items:center;gap:0.75rem;">
        <span style="font-size:1.2rem;flex-shrink:0;">ðŸ”’</span>
        <span style="font-size:0.82rem;color:var(--p1-text2);">
          <%= _isAr ? 'Ø³Ø¬Ù„Ø§ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†. ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£ÙŠ Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.' : 'Your medical records are stored securely. Reports from completed cases are auto-saved for your convenience. You can delete any record at any time.' %>
        </span>
      </div>

      <!-- Filter Tabs -->
      <div class="filter-tabs" style="flex-wrap:wrap;">
        <a href="/portal/patient/records" class="<%= !_filters.type ? 'active' : '' %>"><%= _isAr ? 'ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹' : 'All Types' %></a>
        <% _recordTypes.forEach(function(t) { %>
          <a href="/portal/patient/records?type=<%= t %><%= _filters.q ? '&q=' + encodeURIComponent(_filters.q) : '' %>" class="<%= _filters.type === t ? 'active' : '' %>"><%= typeLabel(t) %></a>
        <% }); %>
      </div>

      <!-- Search -->
      <form method="GET" action="/portal/patient/records" style="display:flex;gap:0.5rem;margin-bottom:18px;align-items:center;flex-wrap:wrap;">
        <% if (_filters.type) { %><input type="hidden" name="type" value="<%= _filters.type %>"><% } %>
        <input type="text" name="q" value="<%= _filters.q || '' %>" placeholder="<%= _isAr ? 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...' : 'Search records...' %>" style="max-width:280px;">
        <button type="submit" class="p-btn p-btn-secondary"><%= _isAr ? 'Ø¨Ø­Ø«' : 'Search' %></button>
      </form>

      <!-- Records List -->
      <% if (_records.length === 0) { %>
        <div class="flow-card" style="text-align:center;padding:48px 24px;">
          <div style="font-size:2.5rem;margin-bottom:12px;">ðŸ“‹</div>
          <h3 style="margin-bottom:6px;"><%= _isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø·Ø¨ÙŠØ© Ø¨Ø¹Ø¯' : 'No medical records yet' %></h3>
          <p style="color:var(--p1-text2);font-size:0.85rem;margin-bottom:16px;"><%= _isAr ? 'Ø£Ø¶Ù Ø³Ø¬Ù„Ø§ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ… Ù…Ù„ÙÙƒ Ø§Ù„ØµØ­ÙŠ.' : 'Add your medical records to organize your health file.' %></p>
          <button class="p-btn p-btn-primary" onclick="showAddModal()">+ <%= _isAr ? 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„' : 'Add Record' %></button>
        </div>
      <% } %>

      <% _records.forEach(function(rec) { %>
        <div class="flow-card" id="rec-<%= rec.id %>" style="display:flex;align-items:flex-start;gap:1rem;margin-bottom:14px;flex-wrap:wrap;">
          <div style="font-size:1.5rem;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--p1-primary-light);border-radius:var(--p1-rs);flex-shrink:0;">
            <%= typeIcons[rec.record_type] || 'ðŸ“„' %>
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:600;color:var(--p1-text);font-size:0.92rem;margin-bottom:4px;"><%= rec.title %></div>
            <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:4px;">
              <span class="status-badge status-submitted"><%= typeLabel(rec.record_type) %></span>
              <% if (rec.date_of_record) { %><span style="font-size:0.78rem;color:var(--p1-text3);"><%= fmtDate(rec.date_of_record) %></span><% } %>
              <% if (rec.provider) { %><span style="font-size:0.78rem;color:var(--p1-text3);"><%= rec.provider %></span><% } %>
              <% if (rec.is_shared_with_doctors) { %><span class="status-badge status-completed"><%= _isAr ? 'Ù…Ø´Ø§Ø±Ùƒ' : 'Shared' %></span><% } %>
            </div>
            <% if (rec.description) { %>
              <div style="font-size:0.82rem;color:var(--p1-text2);line-height:1.5;"><%= (rec.description || '').slice(0, 120) %></div>
            <% } %>
          </div>
          <div style="display:flex;gap:6px;flex-shrink:0;align-items:center;flex-wrap:wrap;">
            <% if (rec.file_url) { %>
              <a href="<%= rec.file_url %>" target="_blank" class="p-btn p-btn-secondary p-btn-sm"><%= _isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a>
            <% } %>
            <button class="p-btn p-btn-secondary p-btn-sm" onclick="toggleShare('<%= rec.id %>', <%= rec.is_shared_with_doctors ? 0 : 1 %>)"><%= rec.is_shared_with_doctors ? (_isAr ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©' : 'Unshare') : (_isAr ? 'Ù…Ø´Ø§Ø±ÙƒØ©' : 'Share') %></button>
            <button class="p-btn p-btn-secondary p-btn-sm" onclick="deleteRecord('<%= rec.id %>')" style="color:var(--p1-danger);">&times;</button>
          </div>
        </div>
      <% }); %>

<!-- Add Record Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal-box">
    <h3 style="margin:0 0 1rem;"><%= _isAr ? 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø·Ø¨ÙŠ' : 'Add Medical Record' %></h3>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Title' %> *</label>
      <input type="text" id="new-title" placeholder="<%= _isAr ? 'Ù…Ø«Ø§Ù„: Ù†ØªÙŠØ¬Ø© ØªØ­Ù„ÙŠÙ„ Ø¯Ù…' : 'e.g. Blood Test Results' %>">
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„Ù†ÙˆØ¹' : 'Type' %> *</label>
      <select id="new-type">
        <% _recordTypes.forEach(function(t) { %>
          <option value="<%= t %>"><%= typeLabel(t) %></option>
        <% }); %>
      </select>
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„ÙˆØµÙ' : 'Description' %></label>
      <textarea id="new-description" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù' : 'File URL' %></label>
      <input type="text" id="new-file-url" placeholder="https://...">
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¬Ù„' : 'Record Date' %></label>
      <input type="date" id="new-date">
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„Ù…Ù‚Ø¯Ù…' : 'Provider' %></label>
      <input type="text" id="new-provider" placeholder="<%= _isAr ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù…Ù„' : 'Hospital or lab name' %>">
    </div>
    <div class="form-group">
      <label style="display:inline-flex;align-items:center;gap:0.5rem;"><input type="checkbox" id="new-shared" value="1" style="width:auto;"> <%= _isAr ? 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡' : 'Share with doctors' %></label>
    </div>
    <div class="modal-actions">
      <button class="p-btn p-btn-secondary" onclick="hideAddModal()"><%= _isAr ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' %></button>
      <button class="p-btn p-btn-primary" onclick="saveRecord()"><%= _isAr ? 'Ø­ÙØ¸' : 'Save' %></button>
    </div>
  </div>
</div>

<script<% if (typeof cspNonce !== 'undefined' && cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
var csrfToken = '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>';

function showAddModal() { document.getElementById('add-modal').classList.add('visible'); }
function hideAddModal() { document.getElementById('add-modal').classList.remove('visible'); }

function saveRecord() {
  var data = {
    title: document.getElementById('new-title').value.trim(),
    record_type: document.getElementById('new-type').value,
    description: document.getElementById('new-description').value.trim(),
    file_url: document.getElementById('new-file-url').value.trim(),
    date_of_record: document.getElementById('new-date').value,
    provider: document.getElementById('new-provider').value.trim(),
    is_shared_with_doctors: document.getElementById('new-shared').checked ? '1' : '0'
  };

  if (!data.title) { alert('<%= _isAr ? "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨" : "Title is required" %>'); return; }

  fetch('/portal/patient/records', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
    body: JSON.stringify(data)
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.ok) window.location.reload();
    else alert(d.error || 'Error');
  })
  .catch(function() { alert('Network error'); });
}

function toggleShare(recordId, share) {
  fetch('/portal/patient/records/' + recordId + '/share', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
    body: JSON.stringify({ share: share ? '1' : '0' })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) { if (d.ok) window.location.reload(); });
}

function deleteRecord(recordId) {
  if (!confirm('<%= _isAr ? "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ" : "Are you sure?" %>')) return;
  fetch('/portal/patient/records/' + recordId, {
    method: 'DELETE',
    headers: { 'x-csrf-token': csrfToken }
  })
  .then(function(r) { return r.json(); })
  .then(function(d) { if (d.ok) document.getElementById('rec-' + recordId).remove(); });
}

// Close modal on overlay click
document.getElementById('add-modal').addEventListener('click', function(e) {
  if (e.target === this) hideAddModal();
});
</script>

    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
