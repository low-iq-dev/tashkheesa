<%- include('partials/header', { title: pageTitle || "Medical Records", layout: "portal", showNav: false }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _records = (typeof records !== 'undefined' && Array.isArray(records)) ? records : [];
  var _recordTypes = (typeof recordTypes !== 'undefined' && Array.isArray(recordTypes)) ? recordTypes : [];
  var _filters = (typeof filters !== 'undefined') ? filters : {};

  var typeLabels = {
    lab_result: { en: 'Lab Result', ar: 'Ù†ØªÙŠØ¬Ø© Ù…Ø®Ø¨Ø±ÙŠØ©' },
    imaging: { en: 'Imaging', ar: 'Ø£Ø´Ø¹Ø©' },
    prescription: { en: 'Prescription', ar: 'ÙˆØµÙØ© Ø·Ø¨ÙŠØ©' },
    discharge_summary: { en: 'Discharge Summary', ar: 'Ù…Ù„Ø®Øµ Ø®Ø±ÙˆØ¬' },
    surgical_report: { en: 'Surgical Report', ar: 'ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø§Ø­ÙŠ' },
    vaccination: { en: 'Vaccination', ar: 'ØªØ·Ø¹ÙŠÙ…' },
    allergy: { en: 'Allergy', ar: 'Ø­Ø³Ø§Ø³ÙŠØ©' },
    chronic_condition: { en: 'Chronic Condition', ar: 'Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†' },
    case_report: { en: 'Case Report', ar: 'ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø©' },
    other: { en: 'Other', ar: 'Ø£Ø®Ø±Ù‰' }
  };

  function typeLabel(type) {
    var t = typeLabels[type];
    return t ? (_isAr ? t.ar : t.en) : type;
  }

  function fmtDate(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleDateString(_lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }

  var typeIcons = {
    lab_result: 'ðŸ§ª', imaging: 'ðŸ“·', prescription: 'ðŸ’Š', discharge_summary: 'ðŸ“‹',
    surgical_report: 'ðŸ¥', vaccination: 'ðŸ’‰', allergy: 'âš ï¸', chronic_condition: 'â¤ï¸', case_report: 'ðŸ“', other: 'ðŸ“„'
  };
%>

<style>
  .records-container { max-width: 900px; margin: 0 auto; padding: 1.5rem 1rem; }
  .records-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
  .records-header h2 { margin: 0; font-size: 1.4rem; color: #1a365d; }
  .records-filters { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 1.25rem; }
  .records-filters select, .records-filters input { padding: 0.45rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.82rem; }
  .records-filters input { min-width: 180px; }
  .rec-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 1rem; transition: box-shadow 0.2s; }
  .rec-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .rec-icon { font-size: 1.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 8px; flex-shrink: 0; }
  .rec-info { flex: 1; min-width: 0; }
  .rec-title { font-weight: 600; color: #1e293b; font-size: 0.92rem; }
  .rec-meta { display: flex; gap: 0.75rem; margin-top: 0.25rem; font-size: 0.78rem; color: #94a3b8; flex-wrap: wrap; }
  .rec-type-badge { padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 500; background: #ebf8ff; color: #2b6cb0; }
  .rec-shared { padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; background: #e9f7ef; color: #065f46; }
  .rec-actions { display: flex; gap: 0.35rem; flex-shrink: 0; }
  .rec-actions button { padding: 0.3rem 0.6rem; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 0.75rem; cursor: pointer; background: #fff; color: #475569; }
  .rec-actions button:hover { background: #f8fafc; }
  .rec-empty { text-align: center; color: #94a3b8; padding: 3rem 1rem; }

  .add-record-btn { padding: 0.5rem 1rem; background: #38b2ac; color: #fff; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }

  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.visible { display: flex; }
  .modal-box { background: #fff; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
  .modal-box h3 { margin: 0 0 1rem; font-size: 1.1rem; color: #1a365d; }
  .modal-box .form-group { margin-bottom: 1rem; }
  .modal-box .form-group label { display: block; font-weight: 600; font-size: 0.82rem; color: #334155; margin-bottom: 0.3rem; }
  .modal-box .form-group input, .modal-box .form-group select, .modal-box .form-group textarea {
    width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; box-sizing: border-box;
  }
  .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
  .modal-actions button { padding: 0.5rem 1.2rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; }
</style>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo"><%= (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa' %> <span><%= _isAr ? 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient Portal' %></span></div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'records', isAr: _isAr }) %>
    <main class="portal-content">

<div class="records-container">
  <div style="background:#ebf8ff;border:1px solid #bee3f8;border-radius:8px;padding:0.75rem 1rem;margin-bottom:1rem;font-size:0.82rem;color:#2c5282;">
    <%= _isAr ? 'Ø³Ø¬Ù„Ø§ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†. ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£ÙŠ Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.' : 'Your medical records are stored securely. Reports from completed cases are auto-saved for your convenience. You can delete any record at any time.' %>
  </div>
  <div class="records-header">
    <h2><%= _isAr ? 'Ø³Ø¬Ù„Ø§ØªÙŠ Ø§Ù„Ø·Ø¨ÙŠØ©' : 'My Medical Records' %></h2>
    <button class="add-record-btn" onclick="showAddModal()">+ <%= _isAr ? 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„' : 'Add Record' %></button>
  </div>

  <form class="records-filters" method="GET" action="/portal/patient/records">
    <select name="type" onchange="this.form.submit()">
      <option value=""><%= _isAr ? 'ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹' : 'All Types' %></option>
      <% _recordTypes.forEach(function(t) { %>
        <option value="<%= t %>" <%= _filters.type === t ? 'selected' : '' %>><%= typeLabel(t) %></option>
      <% }); %>
    </select>
    <input type="text" name="q" value="<%= _filters.q || '' %>" placeholder="<%= _isAr ? 'Ø¨Ø­Ø«...' : 'Search...' %>">
    <button type="submit" style="padding:0.45rem 0.75rem;border:1px solid #e2e8f0;border-radius:6px;font-size:0.82rem;cursor:pointer;background:#fff;"><%= _isAr ? 'Ø¨Ø­Ø«' : 'Search' %></button>
  </form>

  <% if (_records.length === 0) { %>
    <div class="rec-empty"><%= _isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø·Ø¨ÙŠØ© Ø¨Ø¹Ø¯' : 'No medical records yet' %></div>
  <% } %>

  <% _records.forEach(function(rec) { %>
    <div class="rec-card" id="rec-<%= rec.id %>">
      <div class="rec-icon"><%= typeIcons[rec.record_type] || 'ðŸ“„' %></div>
      <div class="rec-info">
        <div class="rec-title"><%= rec.title %></div>
        <div class="rec-meta">
          <span class="rec-type-badge"><%= typeLabel(rec.record_type) %></span>
          <% if (rec.date_of_record) { %><span><%= fmtDate(rec.date_of_record) %></span><% } %>
          <% if (rec.provider) { %><span><%= rec.provider %></span><% } %>
          <% if (rec.is_shared_with_doctors) { %><span class="rec-shared"><%= _isAr ? 'Ù…Ø´Ø§Ø±Ùƒ' : 'Shared' %></span><% } %>
        </div>
        <% if (rec.description) { %>
          <div style="margin-top:0.35rem;font-size:0.82rem;color:#64748b;"><%= (rec.description || '').slice(0, 120) %></div>
        <% } %>
      </div>
      <div class="rec-actions">
        <% if (rec.file_url) { %>
          <a href="<%= rec.file_url %>" target="_blank" style="padding:0.3rem 0.6rem;border:1px solid #e2e8f0;border-radius:5px;font-size:0.75rem;text-decoration:none;color:#475569;"><%= _isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a>
        <% } %>
        <button onclick="toggleShare('<%= rec.id %>', <%= rec.is_shared_with_doctors ? 0 : 1 %>)"><%= rec.is_shared_with_doctors ? (_isAr ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©' : 'Unshare') : (_isAr ? 'Ù…Ø´Ø§Ø±ÙƒØ©' : 'Share') %></button>
        <button onclick="deleteRecord('<%= rec.id %>')" style="color:#ef4444;">&times;</button>
      </div>
    </div>
  <% }); %>
</div>

<!-- Add Record Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal-box">
    <h3><%= _isAr ? 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø·Ø¨ÙŠ' : 'Add Medical Record' %></h3>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Title' %> *</label>
      <input type="text" id="new-title" placeholder="<%= _isAr ? 'Ù…Ø«Ø§Ù„: Ù†ØªÙŠØ¬Ø© ØªØ­Ù„ÙŠÙ„ Ø¯Ù…' : 'e.g. Blood Test Results' %>">
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„Ù†ÙˆØ¹' : 'Type' %> *</label>
      <select id="new-type">
        <% _recordTypes.forEach(function(t) { %>
          <option value="<%= t %>"><%= typeLabel(t) %></option>
        <% }); %>
      </select>
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„ÙˆØµÙ' : 'Description' %></label>
      <textarea id="new-description" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù' : 'File URL' %></label>
      <input type="text" id="new-file-url" placeholder="https://...">
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¬Ù„' : 'Record Date' %></label>
      <input type="date" id="new-date">
    </div>
    <div class="form-group">
      <label><%= _isAr ? 'Ø§Ù„Ù…Ù‚Ø¯Ù…' : 'Provider' %></label>
      <input type="text" id="new-provider" placeholder="<%= _isAr ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù…Ù„' : 'Hospital or lab name' %>">
    </div>
    <div class="form-group">
      <label><input type="checkbox" id="new-shared" value="1"> <%= _isAr ? 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡' : 'Share with doctors' %></label>
    </div>
    <div class="modal-actions">
      <button onclick="hideAddModal()" style="background:#f8fafc;color:#64748b;"><%= _isAr ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' %></button>
      <button onclick="saveRecord()" style="background:#38b2ac;color:#fff;"><%= _isAr ? 'Ø­ÙØ¸' : 'Save' %></button>
    </div>
  </div>
</div>

<script<% if (typeof cspNonce !== 'undefined' && cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
var csrfToken = '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>';

function showAddModal() { document.getElementById('add-modal').classList.add('visible'); }
function hideAddModal() { document.getElementById('add-modal').classList.remove('visible'); }

function saveRecord() {
  var data = {
    title: document.getElementById('new-title').value.trim(),
    record_type: document.getElementById('new-type').value,
    description: document.getElementById('new-description').value.trim(),
    file_url: document.getElementById('new-file-url').value.trim(),
    date_of_record: document.getElementById('new-date').value,
    provider: document.getElementById('new-provider').value.trim(),
    is_shared_with_doctors: document.getElementById('new-shared').checked ? '1' : '0'
  };

  if (!data.title) { alert('<%= _isAr ? "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨" : "Title is required" %>'); return; }

  fetch('/portal/patient/records', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
    body: JSON.stringify(data)
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.ok) window.location.reload();
    else alert(d.error || 'Error');
  })
  .catch(function() { alert('Network error'); });
}

function toggleShare(recordId, share) {
  fetch('/portal/patient/records/' + recordId + '/share', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
    body: JSON.stringify({ share: share ? '1' : '0' })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) { if (d.ok) window.location.reload(); });
}

function deleteRecord(recordId) {
  if (!confirm('<%= _isAr ? "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ" : "Are you sure?" %>')) return;
  fetch('/portal/patient/records/' + recordId, {
    method: 'DELETE',
    headers: { 'x-csrf-token': csrfToken }
  })
  .then(function(r) { return r.json(); })
  .then(function(d) { if (d.ok) document.getElementById('rec-' + recordId).remove(); });
}

// Close modal on overlay click
document.getElementById('add-modal').addEventListener('click', function(e) {
  if (e.target === this) hideAddModal();
});
</script>

    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
