<%- include('partials/header', { title: "Alerts", layout: "portal", showNav: true, showFooter: false, portalFrame: true, portalRole: 'superadmin', portalActive: 'alerts', portalNext: '/superadmin/alerts' }) %>
<%
  const isAr = (typeof lang !== 'undefined' && lang === 'ar');
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  var fmtDate = (typeof formatEventDate !== 'undefined') ? formatEventDate : function(iso){ return iso || ''; };
  const nextPathSafe = (typeof nextPath !== 'undefined' && nextPath) ? nextPath : '/superadmin/alerts';
%>
      <div class="portal-page portal-superadmin-alerts">
        <div class="portal-page-header">
          <div class="portal-page-titleblock">
            <div class="portal-page-kicker"><%= isAr ? 'بوابة المشرف' : 'Superadmin Portal' %></div>
            <h1 class="portal-page-title"><%= isAr ? 'التنبيهات' : 'Alerts' %></h1>
            <p class="portal-page-subtitle"><%= isAr ? 'إشعارات متعلقة بالطلبات.' : 'Notifications related to orders.' %></p>
          </div>
          <div class="portal-page-actions">
            <a class="btn btn-secondary" href="/superadmin"><%= isAr ? 'العودة إلى لوحة التحكم' : 'Back to dashboard' %></a>
          </div>
        </div>

        <nav class="portal-top-tabs" aria-label="Superadmin navigation">
          <a href="/superadmin"><%= isAr ? 'لوحة التحكم' : 'Dashboard' %></a>
          <a href="/superadmin/doctors"><%= isAr ? 'الأطباء' : 'Doctors' %></a>
          <a href="/superadmin/services"><%= isAr ? 'الخدمات' : 'Services' %></a>
          <a href="/superadmin/events"><%= isAr ? 'سجل التدقيق' : 'Audit Log' %></a>
          <a href="/superadmin/alerts" class="active"><%= isAr ? 'التنبيهات' : 'Alerts' %></a>
        </nav>

        <section class="portal-card">
          <%
            const list = (typeof notifications !== 'undefined' && notifications) ? notifications
                      : (typeof alerts !== 'undefined' && alerts) ? alerts
                      : [];
          %>

          <% if (!list || !list.length) { %>
            <p class="muted" style="margin:0;"><%= isAr ? 'لا توجد تنبيهات حتى الآن.' : 'No alerts yet.' %></p>
          <% } else { %>
            <div class="table-scroll table-scroll--y table-scroll--6">
              <table>
                <thead>
                  <tr>
                    <th><%= isAr ? 'نوع التنبيه' : 'Notification type' %></th>
                    <th><%= isAr ? 'الحالة' : 'Case' %></th>
                    <th><%= isAr ? 'الحالة' : 'Status' %></th>
                    <th><%= isAr ? 'الوقت' : 'Time' %></th>
                  </tr>
                </thead>
                <tbody>
                  <% list.forEach(function(n){ %>
                    <% const isObj = n && typeof n === 'object'; %>

                    <% // Title / type (prefer localized titles if present)
                       const title = !isObj ? 'alert'
                         : (isAr
                             ? (n.title_ar || n.titleAr || n.template || n.type || n.kind || 'alert')
                             : (n.title_en || n.titleEn || n.template || n.type || n.kind || 'alert'));
                    %>

                    <% // Order / case id
                       const orderId = !isObj ? '' : (n.order_id || n.orderId || '');
                    %>

                    <% // Link (prefer explicit link; fallback to case page if we have orderId)
                       const href = !isObj ? '' : (n.link || n.href || (orderId ? ('/superadmin/orders/' + encodeURIComponent(orderId)) : ''));
                    %>

                    <% // Status (legacy: status; new: is_read)
                       const statusText = !isObj ? ''
                         : (n.status
                             || (typeof n.is_read !== 'undefined'
                                 ? (String(n.is_read) === '0' ? 'unread' : 'seen')
                                 : (typeof n.isRead !== 'undefined'
                                     ? (String(n.isRead) === '0' ? 'unread' : 'seen')
                                     : '')));
                    %>

                    <% // Time (legacy: at; new: created_at)
                       const atIso = !isObj ? '' : (n.at || n.created_at || n.createdAt || '');
                    %>

                    <tr>
                      <td><%= title %></td>
                      <td>
                        <% if (href) { %>
                          <a href="<%= href %>"><%= orderId || (isAr ? 'فتح الحالة' : 'Open case') %></a>
                        <% } else if (orderId) { %>
                          <%= orderId %>
                        <% } else { %>
                          <span class="muted">—</span>
                        <% } %>
                      </td>
                      <td><%= statusText || '—' %></td>
                      <td><%= atIso ? fmtDate(atIso) : '—' %></td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } %>
        </section>
      </div>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
