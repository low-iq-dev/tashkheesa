<%- include('partials/header', { title: "Doctor Dashboard", layout: "portal", showNav: false }) %>
<%
  const user = locals.user || {};

  function asArray(v) {
    return Array.isArray(v) ? v : [];
  }

  // Support both new and legacy naming from routes
  const availableCases = asArray(
    locals.availableCases ||
    locals.unassignedOrders ||
    locals.unassignedCases ||
    locals.availableOrders ||
    locals.newCases
  );

  const activeCases = asArray(
    locals.activeCases ||
    locals.activeOrders ||
    locals.inReviewCases
  );

  const completedCases = asArray(
    locals.completedCases ||
    locals.closedOrders ||
    locals.completedOrders
  );

  const brand = locals.brand || 'Tashkheesa';

  const lang = locals.lang || 'en';
  const isAr = String(lang).toLowerCase() === 'ar';

  function pickStatusUi(c, fallbackKey, fallbackLabel) {
    const ui = (c && (c.statusUi || c.status_ui || c.statusUI)) ? (c.statusUi || c.status_ui || c.statusUI) : null;
    const key = ui && (ui.key || ui.status || ui.value) ? String(ui.key || ui.status || ui.value) : (fallbackKey || '');
    const label = ui && (ui.title || ui.label || ui.name) ? (ui.title || ui.label || ui.name) : (fallbackLabel || '');
    return { key, label };
  }

  function pillVariantForKey(key) {
    const k = String(key || '').trim().toLowerCase();
    if (!k) return 'info';

    if (k.includes('completed') || k === 'done') return 'done';
    if (k.includes('breach')) return 'danger';
    if (k.includes('rejected_files') || k.includes('files') || k.includes('more_info')) return 'warning';
    if (k === 'new' || k.includes('submitted')) return 'new';

    // default for assigned / in_review / active
    return 'info';
  }

  const doctorName = (user && (user.display_name || user.name)) ? (user.display_name || user.name) : (isAr ? 'الطبيب' : 'Doctor');
  const doctorSpec = (user && user.specialty) ? user.specialty : '';
  const doctorChip = doctorSpec
    ? (isAr ? `د. ${doctorSpec}` : `Dr ${doctorSpec}`)
    : (isAr ? `د. ${doctorName}` : `Dr ${doctorName}`);
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brand %>
      <span><%= isAr ? 'بوابة الطبيب' : 'Doctor Portal' %></span>
    </div>
  </div>

  <div class="portal-grid">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/portal/doctor" class="active"><%= isAr ? 'لوحة التحكم' : 'Dashboard' %></a></li>
        <li><a href="/portal/doctor/alerts"><%= isAr ? 'التنبيهات' : 'Alerts' %></a></li>
        <li><a href="/portal/doctor/profile"><%= isAr ? 'الملف الشخصي' : 'Profile' %></a></li>
      </ul>
      <div class="section-cta">
        <a class="btn btn-secondary btn-full" href="/lang/en?next=/portal/doctor">EN</a>
        <a class="btn btn-secondary btn-full" href="/lang/ar?next=/portal/doctor">AR</a>
      </div>
      <form method="post" action="/logout">
        <%- (typeof csrfField === 'function') ? csrfField() : '' %>
        <button type="submit" class="btn btn-secondary btn-full"><%= isAr ? 'تسجيل الخروج' : 'Logout' %></button>
      </form>
    </aside>

    <main class="portal-content">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= isAr ? 'لوحة تحكم الطبيب' : 'Doctor Dashboard' %></h1>
        <p class="portal-hero-subtitle"><%= isAr ? 'قائمة مهامك: اقبل حالات جديدة، أكمل المراجعات، وارجع للتقارير المكتملة.' : 'Your worklist: accept new cases, complete reviews, and reference completed reports.' %></p>
        <div class="portal-hero-actions">
          <a class="btn btn-secondary" href="/portal/doctor"><%= isAr ? 'تحديث' : 'Refresh' %></a>
        </div>
      </div>

      <div class="flow-card">
        <h2><%= isAr ? 'ملخص العمل' : 'Work summary' %></h2>
        <ul>
          <li><strong><%= isAr ? 'قيد المراجعة' : 'In review' %>:</strong> <%= activeCases.length %></li>
          <li><strong><%= isAr ? 'جديدة' : 'New' %>:</strong> <%= availableCases.length %></li>
          <li><strong><%= isAr ? 'مكتملة' : 'Completed' %>:</strong> <%= completedCases.length %></li>
        </ul>
      </div>

      <section class="flow-card" aria-labelledby="cases-in-review-title">
        <h2 id="cases-in-review-title"><%= isAr ? 'حالات قيد المراجعة' : 'Cases in review' %></h2>
        <p class="flow-note"><%= isAr ? 'أكمل المراجعات قبل الموعد النهائي للحفاظ على الالتزام بالوقت.' : 'Finish reviews before the deadline to keep SLAs on track.' %></p>

        <% if (activeCases.length === 0) { %>
          <p class="flow-note"><%= isAr ? 'لا توجد حالات قيد المراجعة' : 'No cases in review' %></p>
        <% } else { %>
          <table>
            <thead>
              <tr>
                <th><%= isAr ? 'الحالة' : 'Case' %></th>
                <th><%= isAr ? 'التخصص' : 'Specialty' %></th>
                <th><%= isAr ? 'الحالة' : 'Status' %></th>
                <th><%= isAr ? 'الموعد النهائي' : 'Deadline' %></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% activeCases.forEach(c => { %>
                <tr>
                  <td><%= c.reference || c.id %></td>
                  <td><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></td>
                  <% const ui = pickStatusUi(c, c.status || 'in_review', c.status_display || c.statusLabel || (isAr ? 'قيد المراجعة' : 'In review')); %>
                  <td><%= ui.label %></td>
                  <td><%= c.deadline_display || c.deadlineLabel || c.deadline_at || '—' %></td>
                  <td><a class="btn btn-secondary" href="/portal/doctor/case/<%= c.id %>"><%= isAr ? 'فتح الحالة' : 'Open case' %></a></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>

      <section class="flow-card" aria-labelledby="new-cases-title">
        <h2 id="new-cases-title"><%= isAr ? 'حالات جديدة' : 'New cases' %></h2>
        <p class="flow-note"><%= isAr ? 'اقبل الحالة لبدء المراجعة. الموعد النهائي يوضح الأولوية.' : 'Accept a case to begin review. The deadline indicates priority.' %></p>

        <% if (availableCases.length === 0) { %>
          <p class="flow-note"><%= isAr ? 'لا توجد حالات جديدة' : 'No new cases' %></p>
        <% } else { %>
          <table>
            <thead>
              <tr>
                <th><%= isAr ? 'الحالة' : 'Case' %></th>
                <th><%= isAr ? 'التخصص' : 'Specialty' %></th>
                <th><%= isAr ? 'الحالة' : 'Status' %></th>
                <th><%= isAr ? 'الموعد النهائي' : 'Deadline' %></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% availableCases.forEach(c => { %>
                <%
                  const isPaid = ['paid', 'captured'].includes(
                    String(c.payment_status || '').toLowerCase()
                  );
                %>
                <tr>
                  <td><%= c.reference || c.id %></td>
                  <td><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></td>
                  <% const ui = pickStatusUi(c, c.status || 'new', (isAr ? 'جديدة' : 'New')); %>
                  <td><%= ui.label %></td>
                  <td><%= c.deadline_display || c.deadlineLabel || c.deadline_at || '—' %></td>
                  <td>
                    <a class="btn btn-secondary" href="/portal/doctor/case/<%= c.id %>"><%= isAr ? 'عرض' : 'View' %></a>

                    <% if (isPaid) { %>
                      <form method="POST" action="/portal/doctor/case/<%= c.id %>/accept">
                        <button type="submit" class="btn btn-primary"><%= isAr ? 'قبول' : 'Accept' %></button>
                      </form>
                    <% } else { %>
                      <div class="flow-note" style="font-size:13px;">
                        <%= isAr ? 'غير مدفوع — يظهر زر القبول بعد الدفع' : 'Unpaid — accept enabled after payment' %>
                      </div>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>

      <section class="flow-card" aria-labelledby="completed-cases-title">
        <h2 id="completed-cases-title"><%= isAr ? 'حالات مكتملة' : 'Completed cases' %></h2>
        <p class="flow-note"><%= isAr ? 'تقارير تم إرسالها سابقاً للرجوع إليها سريعاً.' : 'Previously submitted reports for quick reference.' %></p>

        <% if (completedCases.length === 0) { %>
          <p class="flow-note"><%= isAr ? 'لا توجد حالات مكتملة' : 'No completed cases' %></p>
        <% } else { %>
          <table>
            <thead>
              <tr>
                <th><%= isAr ? 'الحالة' : 'Case' %></th>
                <th><%= isAr ? 'التخصص' : 'Specialty' %></th>
                <th><%= isAr ? 'الحالة' : 'Status' %></th>
                <th><%= isAr ? 'الموعد النهائي' : 'Deadline' %></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% completedCases.forEach(c => { %>
                <tr>
                  <td><%= c.reference || c.id %></td>
                  <td><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></td>
                  <% const ui = pickStatusUi(c, c.status || 'completed', (isAr ? 'مكتملة' : 'Completed')); %>
                  <td><%= ui.label %></td>
                  <td><%= c.deadline_display || c.deadlineLabel || c.deadline_at || '—' %></td>
                  <td><a class="btn btn-secondary" href="/portal/doctor/case/<%= c.id %>"><%= isAr ? 'فتح الحالة' : 'Open case' %></a></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
