<%
  const user = locals.user || {};

  function asArray(v) {
    return Array.isArray(v) ? v : [];
  }

  // Support both new and legacy naming from routes
  const availableCases = asArray(
    locals.availableCases ||
    locals.unassignedOrders ||
    locals.unassignedCases ||
    locals.availableOrders ||
    locals.newCases
  );

  const activeCases = asArray(
    locals.activeCases ||
    locals.activeOrders ||
    locals.inReviewCases
  );

  const completedCases = asArray(
    locals.completedCases ||
    locals.closedOrders ||
    locals.completedOrders
  );

  const brand = locals.brand || 'Tashkheesa';

  const lang = locals.lang || 'en';
  const isAr = String(lang).toLowerCase() === 'ar';

  function pickStatusUi(c, fallbackKey, fallbackLabel) {
    const ui = (c && (c.statusUi || c.status_ui || c.statusUI)) ? (c.statusUi || c.status_ui || c.statusUI) : null;
    const key = ui && (ui.key || ui.status || ui.value) ? String(ui.key || ui.status || ui.value) : (fallbackKey || '');
    const label = ui && (ui.title || ui.label || ui.name) ? (ui.title || ui.label || ui.name) : (fallbackLabel || '');
    return { key, label };
  }

  function pillVariantForKey(key) {
    const k = String(key || '').trim().toLowerCase();
    if (!k) return 'info';

    if (k.includes('completed') || k === 'done') return 'done';
    if (k.includes('breach')) return 'danger';
    if (k.includes('rejected_files') || k.includes('files') || k.includes('more_info')) return 'warning';
    if (k === 'new' || k.includes('submitted')) return 'new';

    // default for assigned / in_review / active
    return 'info';
  }

  const doctorName = (user && (user.display_name || user.name)) ? (user.display_name || user.name) : (isAr ? 'الطبيب' : 'Doctor');
  const doctorSpec = (user && user.specialty) ? user.specialty : '';
  const doctorChip = doctorSpec
    ? (isAr ? `د. ${doctorSpec}` : `Dr ${doctorSpec}`)
    : (isAr ? `د. ${doctorName}` : `Dr ${doctorName}`);
%>

<!DOCTYPE html>
<html lang="<%= isAr ? 'ar' : 'en' %>" dir="<%= isAr ? 'rtl' : 'ltr' %>">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Global styles -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- Favicon + app icons -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <title><%= isAr ? 'لوحة تحكم الطبيب' : 'Doctor Dashboard' %></title>
</head>

<body class="doctor-worklist <%= isAr ? 'rtl' : '' %>">

  <a class="skip-link" href="#main-content"><%= isAr ? 'انتقل إلى المحتوى الرئيسي' : 'Skip to main content' %></a>

  <!-- HEADER -->
  <%- include('partials/doctor_header', { brand, user, isAr, activeTab: 'dashboard', nextPath: '/portal/doctor' }) %>

  <!-- CONTENT -->
  <main id="main-content" class="worklist-container" tabindex="-1">

    <div class="page-header">
      <div class="page-header-top">
        <div>
          <h1 class="page-title"><%= isAr ? 'لوحة تحكم الطبيب' : 'Doctor Dashboard' %></h1>
          <p class="page-subtitle"><%= isAr ? 'قائمة مهامك: اقبل حالات جديدة، أكمل المراجعات، وارجع للتقارير المكتملة.' : 'Your worklist: accept new cases, complete reviews, and reference completed reports.' %></p>
        </div>

        <div class="page-header-actions">
          <a class="btn-secondary" href="/portal/doctor"><%= isAr ? 'تحديث' : 'Refresh' %></a>
        </div>
      </div>

      <div class="dashboard-stats" role="list" aria-label="<%= isAr ? 'ملخص العمل' : 'Work summary' %>">
        <div class="stat-card" role="listitem">
          <div class="stat-label"><%= isAr ? 'قيد المراجعة' : 'In review' %></div>
          <div class="stat-value"><%= activeCases.length %></div>
          <div class="stat-hint"><%= isAr ? 'تم القبول وقيد التنفيذ' : 'Accepted & in progress' %></div>
        </div>

        <div class="stat-card" role="listitem">
          <div class="stat-label"><%= isAr ? 'جديدة' : 'New' %></div>
          <div class="stat-value"><%= availableCases.length %></div>
          <div class="stat-hint"><%= isAr ? 'بانتظار القبول' : 'Awaiting acceptance' %></div>
        </div>

        <div class="stat-card" role="listitem">
          <div class="stat-label"><%= isAr ? 'مكتملة' : 'Completed' %></div>
          <div class="stat-value"><%= completedCases.length %></div>
          <div class="stat-hint"><%= isAr ? 'تقارير مُرسلة' : 'Submitted reports' %></div>
        </div>
      </div>
    </div>

    <!-- ACTIVE CASES -->
    <section class="worklist-group" aria-labelledby="cases-in-review-title">
      <div class="worklist-group-head">
        <h2 id="cases-in-review-title" class="worklist-group-title"><%= isAr ? 'حالات قيد المراجعة' : 'Cases in review' %></h2>
        <div class="worklist-group-count" aria-label="<%= isAr ? 'عدد الحالات قيد المراجعة' : 'Cases in review count' %>"><%= activeCases.length %></div>
      </div>
      <div class="worklist-group-hint"><%= isAr ? 'أكمل المراجعات قبل الموعد النهائي للحفاظ على الالتزام بالوقت.' : 'Finish reviews before the deadline to keep SLAs on track.' %></div>

      <% if (activeCases.length === 0) { %>
        <div class="worklist-empty">
          <strong><%= isAr ? 'لا توجد حالات قيد المراجعة' : 'No cases in review' %></strong>
          <div class="muted"><%= isAr ? 'ستظهر الحالات المقبولة هنا حتى اكتمالها.' : 'Accepted cases will appear here until completion.' %></div>
        </div>
      <% } %>

      <% activeCases.forEach(c => { %>
        <div class="worklist-row">
          <div class="worklist-main">
            <strong><%= c.reference || c.id %></strong>
          </div>

          <div class="worklist-meta worklist-meta--specialty">
            <div class="muted"><%= isAr ? 'التخصص' : 'Specialty' %></div>
            <div class="case-value"><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></div>
          </div>

          <div class="worklist-meta">
            <div class="muted"><%= isAr ? 'الحالة' : 'Status' %></div>
            <% const ui = pickStatusUi(c, c.status || 'in_review', c.status_display || c.statusLabel || (isAr ? 'قيد المراجعة' : 'In review')); %>
            <div><span class="status-pill status-pill--<%= pillVariantForKey(ui.key) %>"><%= ui.label %></span></div>
          </div>

          <div class="worklist-meta">
            <div class="muted"><%= isAr ? 'الموعد النهائي' : 'Deadline' %></div>
            <div class="case-value"><%= c.deadline_display || c.deadlineLabel || c.deadline_at || '—' %></div>
          </div>

          <div class="worklist-action">
            <a class="btn-secondary" href="/portal/doctor/case/<%= c.id %>"><%= isAr ? 'فتح الحالة' : 'Open case' %></a>
          </div>
        </div>
      <% }) %>
    </section>

    <!-- AVAILABLE / NEW CASES -->
    <section class="worklist-group" aria-labelledby="new-cases-title">
      <div class="worklist-group-head">
        <h2 id="new-cases-title" class="worklist-group-title"><%= isAr ? 'حالات جديدة' : 'New cases' %></h2>
        <div class="worklist-group-count" aria-label="<%= isAr ? 'عدد الحالات الجديدة' : 'New cases count' %>"><%= availableCases.length %></div>
      </div>
      <div class="worklist-group-hint"><%= isAr ? 'اقبل الحالة لبدء المراجعة. الموعد النهائي يوضح الأولوية.' : 'Accept a case to begin review. The deadline indicates priority.' %></div>

      <% if (availableCases.length === 0) { %>
        <div class="worklist-empty">
          <strong><%= isAr ? 'لا توجد حالات جديدة' : 'No new cases' %></strong>
          <div class="muted"><%= isAr ? 'ستظهر الحالات الجديدة هنا عند تعيينها لك.' : 'New cases will appear here when they are assigned to you.' %></div>
        </div>
      <% } %>

      <% availableCases.forEach(c => { %>
        <div class="worklist-row">
          <div class="worklist-main">
            <strong><%= c.reference || c.id %></strong>
          </div>

          <div class="worklist-meta worklist-meta--specialty">
            <div class="muted"><%= isAr ? 'التخصص' : 'Specialty' %></div>
            <div class="case-value"><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></div>
          </div>

          <div class="worklist-meta">
            <div class="muted"><%= isAr ? 'الحالة' : 'Status' %></div>
            <% const ui = pickStatusUi(c, c.status || 'new', (isAr ? 'جديدة' : 'New')); %>
            <div><span class="status-pill status-pill--<%= pillVariantForKey(ui.key) %>"><%= ui.label %></span></div>
          </div>

          <div class="worklist-meta">
            <div class="muted"><%= isAr ? 'الموعد النهائي' : 'Deadline' %></div>
            <div class="case-value"><%= c.deadline_display || c.deadlineLabel || c.deadline_at || '—' %></div>
          </div>

          <div class="worklist-action">
            <a class="btn-secondary" href="/portal/doctor/case/<%= c.id %>"><%= isAr ? 'عرض' : 'View' %></a>
            <form method="POST" action="/portal/doctor/case/<%= c.id %>/accept">
              <button type="submit" class="btn-primary"><%= isAr ? 'قبول' : 'Accept' %></button>
            </form>
          </div>
        </div>
      <% }) %>
    </section>

    <!-- COMPLETED CASES -->
    <section class="worklist-group" aria-labelledby="completed-cases-title">
      <div class="worklist-group-head">
        <h2 id="completed-cases-title" class="worklist-group-title"><%= isAr ? 'حالات مكتملة' : 'Completed cases' %></h2>
        <div class="worklist-group-count" aria-label="<%= isAr ? 'عدد الحالات المكتملة' : 'Completed cases count' %>"><%= completedCases.length %></div>
      </div>
      <div class="worklist-group-hint"><%= isAr ? 'تقارير تم إرسالها سابقاً للرجوع إليها سريعاً.' : 'Previously submitted reports for quick reference.' %></div>

      <% if (completedCases.length === 0) { %>
        <div class="worklist-empty">
          <strong><%= isAr ? 'لا توجد حالات مكتملة' : 'No completed cases' %></strong>
          <div class="muted"><%= isAr ? 'ستظهر التقارير المُرسلة هنا.' : 'Submitted reports will appear here.' %></div>
        </div>
      <% } %>

      <% completedCases.forEach(c => { %>
        <div class="worklist-row">
          <div class="worklist-main">
            <strong><%= c.reference || c.id %></strong>
          </div>

          <div class="worklist-meta worklist-meta--specialty">
            <div class="muted"><%= isAr ? 'التخصص' : 'Specialty' %></div>
            <div class="case-value"><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></div>
          </div>

          <div class="worklist-meta">
            <div class="muted"><%= isAr ? 'الحالة' : 'Status' %></div>
            <% const ui = pickStatusUi(c, c.status || 'completed', (isAr ? 'مكتملة' : 'Completed')); %>
            <div><span class="status-pill status-pill--<%= pillVariantForKey(ui.key) %>"><%= ui.label %></span></div>
          </div>

          <div class="worklist-meta">
            <div class="muted"><%= isAr ? 'الموعد النهائي' : 'Deadline' %></div>
            <div class="case-value"><%= c.deadline_display || c.deadlineLabel || c.deadline_at || '—' %></div>
          </div>

          <div class="worklist-action">
            <a class="btn-secondary" href="/portal/doctor/case/<%= c.id %>"><%= isAr ? 'فتح الحالة' : 'Open case' %></a>
          </div>
        </div>
      <% }) %>
    </section>

  </main>

</body>
</html>
