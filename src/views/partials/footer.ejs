<%
  const renderFooter = (typeof showFooter === 'undefined') ? true : Boolean(showFooter);
  const usePortalFrame = Boolean(
    (typeof portalFrame !== 'undefined')
      ? portalFrame
      : ((typeof locals !== 'undefined' && locals && locals.portalFrame) ? locals.portalFrame : false)
  );
  const cspNonce = (typeof locals !== 'undefined' && locals && (locals.cspNonce || locals.csp_nonce || locals.nonce))
    ? String(locals.cspNonce || locals.csp_nonce || locals.nonce)
    : '';
%>

<% if (usePortalFrame) { %>
    </main>
  </div>
</div>
<% } else { %>
</div>
<% } %>

<% if (renderFooter) { %>
  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="footer-brand">
        <img src="/assets/brand/tashkheesa-logo-blue.png" class="footer-logo logo-light" alt="Tashkheesa" />
        <img src="/assets/brand/tashkheesa-logo-white.png" class="footer-logo logo-dark" alt="Tashkheesa" />
        <p class="muted">Specialist medical second opinions, delivered clearly.</p>
      </div>
      <div class="footer-columns">
        <div class="footer-col">
          <h4 class="footer-col-title">Services</h4>
          <a href="/services">Services & Pricing</a>
          <a href="/about">About Us</a>
          <a href="/contact">Contact Us</a>
        </div>
        <div class="footer-col">
          <h4 class="footer-col-title">Legal</h4>
          <a href="/privacy">Privacy Policy</a>
          <a href="/terms">Terms of Service</a>
          <a href="/refund-policy">Refund & Cancellation</a>
          <a href="/delivery-policy">Delivery Policy</a>
        </div>
        <div class="footer-col">
          <h4 class="footer-col-title">Contact</h4>
          <p>info@tashkheesa.com</p>
          <p>+20 XXX XXX XXXX</p>
          <p>Cairo, Egypt</p>
        </div>
      </div>
    </div>
  </footer>
<% } %>

<% if (usePortalFrame) { %>
  <script src="/vendor/lucide.min.js" defer></script>
  <script<% if (cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
    (function () {
      var attempts = 0;
      var done = false;

      function markReady() {
        document.documentElement.classList.add('lucide-ready');
        document.documentElement.classList.remove('lucide-fallback');
      }

      function markFallback() {
        document.documentElement.classList.add('lucide-fallback');
        document.documentElement.classList.remove('lucide-ready');
      }

      function initLucide() {
        if (done || attempts >= 2) return;
        attempts += 1;

        try {
          document.documentElement.classList.remove('lucide-ready');
          document.documentElement.classList.remove('lucide-fallback');

          if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
            if (document.querySelector('svg.lucide')) {
              done = true;
              markReady();
              return;
            }
          }
        } catch (e) {}

        if (attempts >= 2) {
          done = true;
          markFallback();
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLucide, { once: true });
      } else {
        initLucide();
      }

      // Safety retry for defer/load-order edge cases.
      setTimeout(initLucide, 0);
    })();
  </script>
<% } %>

<script<% if (cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
  (function () {
    /* ── Scroll-reveal animations ── */
    var els = document.querySelectorAll(
      '.scroll-reveal, .scroll-reveal-left, .scroll-reveal-right, .scroll-reveal-scale'
    );
    if (!els.length) return;

    if (!('IntersectionObserver' in window)) {
      els.forEach(function (el) { el.classList.add('is-visible'); });
      return;
    }

    var observer = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    els.forEach(function (el) { observer.observe(el); });
  })();
</script>

</body>
</html>
