<%- include('partials/header', { title: (isAr ? 'ملفي الشخصي' : 'My Profile'), layout: "portal", showNav: false }) %>
<%
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _user = (typeof profileUser !== 'undefined') ? profileUser : {};
  var _success = (typeof success !== 'undefined') ? success : null;
  var _error = (typeof error !== 'undefined') ? error : null;
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa' %>
      <span><%= _isAr ? 'بوابة المريض' : 'Patient Portal' %></span>
    </div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'profile', isAr: _isAr }) %>
    <main class="portal-content">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= _isAr ? 'ملفي الشخصي' : 'My Profile' %></h1>
        <p class="portal-hero-subtitle"><%= _isAr ? 'تحديث بياناتك الشخصية وتفضيلاتك.' : 'Update your personal information and preferences.' %></p>
      </div>

      <% if (_success) { %>
        <div class="flow-card" style="background:#e9f7ef;border:1px solid #a7f3d0;margin-bottom:1rem;">
          <p style="margin:0;color:#065f46;font-weight:600;"><%= _success %></p>
        </div>
      <% } %>

      <% if (_error) { %>
        <div class="flow-card" style="background:#fee2e2;border:1px solid #fca5a5;margin-bottom:1rem;">
          <p style="margin:0;color:#991b1b;font-weight:600;"><%= _error %></p>
        </div>
      <% } %>

      <div class="flow-card">
        <h2 style="margin:0 0 1.25rem;font-size:1.15rem;color:#1a365d;"><%= _isAr ? 'البيانات الشخصية' : 'Personal Information' %></h2>

        <form method="POST" action="/patient/profile">
          <%- (typeof csrfField === 'function') ? csrfField() : '' %>

          <div class="form-group" style="margin-bottom:1rem;">
            <label class="form-label" style="font-weight:600;font-size:0.85rem;color:#334155;margin-bottom:4px;display:block;">
              <%= _isAr ? 'الاسم الكامل' : 'Full Name' %>
            </label>
            <input type="text" name="name" value="<%= _user.name || '' %>" required
              class="form-control" style="width:100%;padding:0.6rem 0.85rem;border:1px solid #e2e8f0;border-radius:8px;font-size:0.9rem;" />
          </div>

          <div class="form-group" style="margin-bottom:1rem;">
            <label class="form-label" style="font-weight:600;font-size:0.85rem;color:#334155;margin-bottom:4px;display:block;">
              <%= _isAr ? 'البريد الإلكتروني' : 'Email' %>
            </label>
            <input type="email" name="email" value="<%= _user.email || '' %>" readonly
              class="form-control" style="width:100%;padding:0.6rem 0.85rem;border:1px solid #e2e8f0;border-radius:8px;font-size:0.9rem;background:#f8fafc;color:#64748b;" />
            <p style="margin:4px 0 0;font-size:0.75rem;color:#94a3b8;"><%= _isAr ? 'لتغيير البريد الإلكتروني تواصل مع الدعم.' : 'Contact support to change your email.' %></p>
          </div>

          <div class="form-group" style="margin-bottom:1rem;">
            <label class="form-label" style="font-weight:600;font-size:0.85rem;color:#334155;margin-bottom:4px;display:block;">
              <%= _isAr ? 'رقم الهاتف' : 'Phone Number' %>
            </label>
            <input type="tel" name="phone" value="<%= _user.phone || '' %>"
              class="form-control" style="width:100%;padding:0.6rem 0.85rem;border:1px solid #e2e8f0;border-radius:8px;font-size:0.9rem;" dir="ltr"
              placeholder="<%= _isAr ? '+966 5XX XXX XXXX' : '+966 5XX XXX XXXX' %>" />
          </div>

          <div class="form-group" style="margin-bottom:1rem;">
            <label class="form-label" style="font-weight:600;font-size:0.85rem;color:#334155;margin-bottom:4px;display:block;">
              <%= _isAr ? 'اللغة المفضلة' : 'Preferred Language' %>
            </label>
            <select name="lang" class="form-control" style="width:100%;padding:0.6rem 0.85rem;border:1px solid #e2e8f0;border-radius:8px;font-size:0.9rem;">
              <option value="en" <%= (_user.lang || 'en') === 'en' ? 'selected' : '' %>>English</option>
              <option value="ar" <%= (_user.lang || 'en') === 'ar' ? 'selected' : '' %>>العربية</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label" style="font-weight:600;font-size:0.85rem;color:#334155;margin-bottom:8px;display:block;">
              <%= _isAr ? 'تفضيلات الإشعارات' : 'Notification Preferences' %>
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:0.88rem;color:#475569;margin-bottom:6px;">
              <input type="checkbox" name="notify_whatsapp" value="1" <%= _user.notify_whatsapp ? 'checked' : '' %> />
              <%= _isAr ? 'تلقي إشعارات عبر واتساب' : 'Receive notifications via WhatsApp' %>
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:0.88rem;color:#475569;">
              <input type="checkbox" name="email_marketing_opt_out" value="1" <%= _user.email_marketing_opt_out ? 'checked' : '' %> />
              <%= _isAr ? 'إلغاء الاشتراك في رسائل التسويق' : 'Opt out of marketing emails' %>
            </label>
          </div>

          <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary"><%= _isAr ? 'حفظ التغييرات' : 'Save Changes' %></button>
          </div>
        </form>
      </div>

      <div class="flow-card" style="margin-top:1rem;">
        <h2 style="margin:0 0 0.75rem;font-size:1.05rem;color:#1a365d;"><%= _isAr ? 'معلومات الحساب' : 'Account Information' %></h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
          <div>
            <div style="font-size:0.75rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;"><%= _isAr ? 'الدور' : 'Role' %></div>
            <div style="font-size:0.9rem;color:#1e293b;font-weight:500;text-transform:capitalize;"><%= _user.role || 'patient' %></div>
          </div>
          <div>
            <div style="font-size:0.75rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;"><%= _isAr ? 'تاريخ التسجيل' : 'Joined' %></div>
            <div style="font-size:0.9rem;color:#1e293b;font-weight:500;">
              <%= _user.created_at ? new Date(_user.created_at).toLocaleDateString(_isAr ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '—' %>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
