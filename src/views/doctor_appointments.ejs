<%- include('partials/header', { title: (typeof title !== 'undefined' ? title : 'Appointments'), layout: 'portal', showNav: false }) %>
<%
  const isAr = (typeof lang !== 'undefined' && String(lang).toLowerCase() === 'ar');
  const _filters = (typeof filters !== 'undefined' && filters) ? filters : { status: 'all', period: 'all' };
  const _stats = (typeof stats !== 'undefined' && stats) ? stats : { totalEarnings: 0, monthEarnings: 0, completedCount: 0, noShowCount: 0 };
  const _appointments = (typeof appointments !== 'undefined' && appointments) ? appointments : [];
  const _upcoming = (typeof upcoming !== 'undefined' && upcoming) ? upcoming : [];
  const _todayAppts = (typeof todayAppts !== 'undefined' && todayAppts) ? todayAppts : [];
  const _past = (typeof past !== 'undefined' && past) ? past : [];

  function apptStatusLabel(val) {
    var v = (val || '').toLowerCase();
    if (isAr) {
      if (v === 'pending') return 'في الانتظار';
      if (v === 'confirmed') return 'مؤكد';
      if (v === 'started') return 'جارية';
      if (v === 'completed') return 'مكتمل';
      if (v === 'cancelled') return 'ملغى';
      if (v === 'no_show_patient') return 'غياب المريض';
      if (v === 'no_show_doctor') return 'غياب الطبيب';
      return v;
    }
    if (v === 'pending') return 'Pending';
    if (v === 'confirmed') return 'Confirmed';
    if (v === 'started') return 'In Progress';
    if (v === 'completed') return 'Completed';
    if (v === 'cancelled') return 'Cancelled';
    if (v === 'no_show_patient') return 'Patient No-Show';
    if (v === 'no_show_doctor') return 'Doctor No-Show';
    return v ? v.charAt(0).toUpperCase() + v.slice(1).replace(/_/g, ' ') : 'Unknown';
  }

  function statusBadgeClass(val) {
    var v = (val || '').toLowerCase();
    if (v === 'confirmed') return 'status-confirmed';
    if (v === 'started') return 'status-in-review';
    if (v === 'completed') return 'status-completed';
    if (v === 'cancelled') return 'status-cancelled';
    if (v === 'no_show_patient' || v === 'no_show_doctor') return 'status-no-show';
    return 'status-pending';
  }

  function formatDate(iso) {
    if (!iso) return '—';
    var d = new Date(iso);
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }
  function formatTime(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
  }
%>

<div class="doctor-layout">
  <!-- Header -->
  <header class="doctor-header">
    <div class="brand">
      <div class="brand-logo">T</div>
      <div>
        <div class="brand-text-main"><%= typeof brand !== 'undefined' ? brand : 'Tashkheesa' %></div>
        <div class="brand-text-sub"><%= isAr ? 'لوحة الاستشارات' : 'Consultations Dashboard' %></div>
      </div>
    </div>
    <div class="header-right">
      <a class="pill" href="/doctor/queue"><%= isAr ? 'حالاتي' : 'My Cases' %></a>
      <a class="pill active" href="/portal/doctor/appointments"><%= isAr ? 'المواعيد' : 'Appointments' %></a>
      <a class="pill" href="/portal/appointments/availability"><%= isAr ? 'أوقات العمل' : 'Availability' %></a>
      <a class="pill" href="/doctor/alerts">
        <%= isAr ? 'التنبيهات' : 'Alerts' %>
        <% if (typeof doctorAlertCount !== 'undefined' && doctorAlertCount > 0) { %>
          <span class="status-badge status-pending" style="font-size:10px;padding:2px 6px;margin-left:4px;"><%= doctorAlertCount %></span>
        <% } %>
      </a>
      <a class="pill" href="/"><%= isAr ? 'الرئيسية' : 'Home' %></a>
      <%- include('partials/user_menu', { menuUser: user, isAr, profileHref: '/doctor/profile' }) %>
      <div style="display:flex;gap:4px;font-size:12px;opacity:0.7;">
        <a href="/lang/en?next=<%= encodeURIComponent('/portal/doctor/appointments') %>" style="color:white;text-decoration:none;">EN</a>
        <span>|</span>
        <a href="/lang/ar?next=<%= encodeURIComponent('/portal/doctor/appointments') %>" style="color:white;text-decoration:none;">AR</a>
      </div>
    </div>
  </header>

  <main class="doctor-main">
    <!-- Page Header -->
    <div class="portal-page-header">
      <div>
        <h1 class="portal-page-title"><%= isAr ? 'استشارات الفيديو' : 'Video Consultations' %></h1>
        <p class="portal-page-subtitle"><%= isAr ? 'إدارة مواعيدك والاستشارات القادمة' : 'Manage your appointments and upcoming consultations' %></p>
      </div>
      <a class="p-btn p-btn-secondary" href="/portal/appointments/availability"><%= isAr ? 'إعداد الأوقات' : 'Set Availability' %></a>
    </div>

    <!-- Stats Row -->
    <div class="portal-stats">
      <div class="stat-card">
        <div class="stat-value"><%= _stats.completedCount %></div>
        <div class="stat-label"><%= isAr ? 'استشارات مكتملة' : 'Completed' %></div>
      </div>
      <div class="stat-card stat-teal">
        <div class="stat-value"><%= _upcoming.length %></div>
        <div class="stat-label"><%= isAr ? 'قادمة' : 'Upcoming' %></div>
      </div>
      <div class="stat-card stat-warning">
        <div class="stat-value"><%= _stats.noShowCount %></div>
        <div class="stat-label"><%= isAr ? 'غياب' : 'No-Shows' %></div>
      </div>
      <div class="stat-card stat-teal">
        <div class="stat-value"><%= Number(_stats.monthEarnings).toFixed(0) %></div>
        <div class="stat-label"><%= isAr ? 'أرباح الشهر (EGP)' : 'This Month (EGP)' %></div>
      </div>
    </div>

    <!-- Filters -->
    <div class="portal-filters">
      <form method="get" action="/portal/doctor/appointments">
        <div class="p-form-group">
          <label class="p-form-label"><%= isAr ? 'الفترة' : 'Period' %></label>
          <select class="p-form-select" name="period">
            <option value="all" <%= _filters.period === 'all' ? 'selected' : '' %>><%= isAr ? 'الكل' : 'All Time' %></option>
            <option value="today" <%= _filters.period === 'today' ? 'selected' : '' %>><%= isAr ? 'اليوم' : 'Today' %></option>
            <option value="week" <%= _filters.period === 'week' ? 'selected' : '' %>><%= isAr ? 'هذا الأسبوع' : 'This Week' %></option>
            <option value="month" <%= _filters.period === 'month' ? 'selected' : '' %>><%= isAr ? 'هذا الشهر' : 'This Month' %></option>
          </select>
        </div>
        <div class="p-form-group">
          <label class="p-form-label"><%= isAr ? 'الحالة' : 'Status' %></label>
          <select class="p-form-select" name="status">
            <option value="all" <%= _filters.status === 'all' ? 'selected' : '' %>><%= isAr ? 'كل الحالات' : 'All Statuses' %></option>
            <option value="confirmed" <%= _filters.status === 'confirmed' ? 'selected' : '' %>><%= isAr ? 'مؤكد' : 'Confirmed' %></option>
            <option value="started" <%= _filters.status === 'started' ? 'selected' : '' %>><%= isAr ? 'جارية' : 'In Progress' %></option>
            <option value="completed" <%= _filters.status === 'completed' ? 'selected' : '' %>><%= isAr ? 'مكتمل' : 'Completed' %></option>
            <option value="cancelled" <%= _filters.status === 'cancelled' ? 'selected' : '' %>><%= isAr ? 'ملغى' : 'Cancelled' %></option>
            <option value="no_show_patient" <%= _filters.status === 'no_show_patient' ? 'selected' : '' %>><%= isAr ? 'غياب المريض' : 'Patient No-Show' %></option>
          </select>
        </div>
        <div class="p-form-group" style="display:flex;gap:8px;align-items:flex-end;">
          <button class="p-btn p-btn-primary p-btn-sm" type="submit"><%= isAr ? 'تطبيق' : 'Apply' %></button>
          <a href="/portal/doctor/appointments" class="p-btn p-btn-ghost p-btn-sm"><%= isAr ? 'إعادة' : 'Reset' %></a>
        </div>
      </form>
    </div>

    <!-- Today's Appointments (highlighted) -->
    <% if (_todayAppts.length > 0) { %>
    <div class="portal-card" style="border-left:4px solid var(--medical-blue);margin-bottom:var(--space-3);">
      <div class="portal-card-header">
        <h2 class="portal-card-title" style="color:var(--medical-blue);"><%= isAr ? 'مواعيد اليوم' : "Today's Appointments" %></h2>
        <span class="status-badge status-in-review"><%= _todayAppts.length %></span>
      </div>
      <div class="p-table-wrap">
        <table class="p-table">
          <thead>
            <tr>
              <th><%= isAr ? 'الوقت' : 'Time' %></th>
              <th><%= isAr ? 'المريض' : 'Patient' %></th>
              <th><%= isAr ? 'التخصص' : 'Service' %></th>
              <th><%= isAr ? 'الحالة' : 'Status' %></th>
              <th><%= isAr ? 'إجراءات' : 'Actions' %></th>
            </tr>
          </thead>
          <tbody>
            <% _todayAppts.forEach(function(a) { %>
            <tr>
              <td>
                <div class="cell-bold"><%= formatTime(a.scheduled_at) %></div>
                <% if (a.canJoin) { %>
                  <span class="status-badge status-confirmed" style="font-size:10px;padding:2px 6px;"><%= isAr ? 'جاهز الآن' : 'Ready Now' %></span>
                <% } else if (a.minsAway > 0) { %>
                  <span class="cell-muted"><%= isAr ? 'خلال ' + a.minsAway + ' دقيقة' : 'in ' + a.minsAway + ' min' %></span>
                <% } %>
              </td>
              <td>
                <div class="cell-bold"><%= a.patient_name || 'Patient' %></div>
                <div class="cell-muted"><%= a.patient_email || '' %></div>
              </td>
              <td><%= a.service_name || '—' %></td>
              <td>
                <span class="status-badge <%= statusBadgeClass(a.status) %>">
                  <%= apptStatusLabel(a.status) %>
                </span>
              </td>
              <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">
                  <% if (a.canJoin) { %>
                    <a class="p-btn p-btn-teal p-btn-sm" href="/portal/video/call/<%= a.id %>"><%= isAr ? 'انضمام' : 'Join Call' %></a>
                  <% } %>
                  <a class="p-btn p-btn-secondary p-btn-sm" href="/portal/video/appointment/<%= a.id %>"><%= isAr ? 'تفاصيل' : 'Details' %></a>
                  <% if (a.canMarkNoShow) { %>
                    <form method="post" action="/portal/video/appointment/<%= a.id %>/no-show" style="display:inline;">
                      <input type="hidden" name="no_show_type" value="patient">
                      <button type="submit" class="p-btn p-btn-ghost p-btn-sm" style="color:var(--warning);" onclick="return confirm('<%= isAr ? 'تأكيد تسجيل غياب المريض؟' : 'Confirm patient no-show?' %>')"><%= isAr ? 'غياب' : 'No-Show' %></button>
                    </form>
                  <% } %>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
    <% } %>

    <!-- All Appointments Table -->
    <div class="portal-card" style="margin-bottom:var(--space-3);">
      <div class="portal-card-header">
        <h2 class="portal-card-title"><%= isAr ? 'كل المواعيد' : 'All Appointments' %></h2>
        <span class="portal-card-subtitle"><%= _appointments.length %> <%= isAr ? 'موعد' : 'appointment(s)' %></span>
      </div>
      <div class="p-table-wrap">
        <table class="p-table">
          <thead>
            <tr>
              <th><%= isAr ? 'التاريخ' : 'Date' %></th>
              <th><%= isAr ? 'الوقت' : 'Time' %></th>
              <th><%= isAr ? 'المريض' : 'Patient' %></th>
              <th><%= isAr ? 'التخصص' : 'Service' %></th>
              <th><%= isAr ? 'الحالة' : 'Status' %></th>
              <th><%= isAr ? 'المبلغ' : 'Amount' %></th>
              <th><%= isAr ? 'إجراءات' : 'Actions' %></th>
            </tr>
          </thead>
          <tbody>
          <% if (_appointments.length > 0) { %>
            <% _appointments.forEach(function(a) { %>
              <tr<% if (a.isToday) { %> style="background:var(--status-in-review-bg);"<% } %>>
                <td>
                  <div class="cell-bold"><%= formatDate(a.scheduled_at) %></div>
                  <% if (a.isToday) { %>
                    <span class="status-badge status-in-review" style="font-size:10px;padding:1px 6px;"><%= isAr ? 'اليوم' : 'TODAY' %></span>
                  <% } %>
                </td>
                <td><%= formatTime(a.scheduled_at) %></td>
                <td class="cell-bold"><%= a.patient_name || 'Patient' %></td>
                <td><%= a.service_name || '—' %></td>
                <td>
                  <span class="status-badge <%= statusBadgeClass(a.status) %>">
                    <%= apptStatusLabel(a.status) %>
                  </span>
                </td>
                <td>
                  <% if (a.price) { %>
                    <span class="cell-bold"><%= Number(a.price).toFixed(0) %></span>
                    <span class="cell-muted">EGP</span>
                  <% } else { %>
                    —
                  <% } %>
                </td>
                <td>
                  <div style="display:flex;gap:6px;flex-wrap:wrap;">
                    <% if (a.canJoin) { %>
                      <a class="p-btn p-btn-teal p-btn-sm" href="/portal/video/call/<%= a.id %>"><%= isAr ? 'انضمام' : 'Join' %></a>
                    <% } %>
                    <a class="p-btn p-btn-secondary p-btn-sm" href="/portal/video/appointment/<%= a.id %>"><%= isAr ? 'عرض' : 'View' %></a>
                    <% if (a.canReschedule) { %>
                      <button class="p-btn p-btn-ghost p-btn-sm" onclick="openReschedule('<%= a.id %>')"><%= isAr ? 'إعادة جدولة' : 'Reschedule' %></button>
                    <% } %>
                    <% if (a.canCancel) { %>
                      <form method="post" action="/portal/video/appointment/<%= a.id %>/cancel" style="display:inline;">
                        <input type="hidden" name="reason" value="Cancelled by doctor">
                        <button type="submit" class="p-btn p-btn-danger p-btn-sm" onclick="return confirm('<%= isAr ? 'هل أنت متأكد من إلغاء هذا الموعد؟' : 'Cancel this appointment?' %>')"><%= isAr ? 'إلغاء' : 'Cancel' %></button>
                      </form>
                    <% } %>
                    <% if (a.canMarkNoShow) { %>
                      <form method="post" action="/portal/video/appointment/<%= a.id %>/no-show" style="display:inline;">
                        <input type="hidden" name="no_show_type" value="patient">
                        <button type="submit" class="p-btn p-btn-ghost p-btn-sm" style="color:var(--warning);" onclick="return confirm('<%= isAr ? 'تأكيد تسجيل غياب المريض؟' : 'Mark patient as no-show?' %>')"><%= isAr ? 'غياب' : 'No-Show' %></button>
                      </form>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="7">
                <div class="p-empty">
                  <div class="p-empty-icon">&#128197;</div>
                  <div class="p-empty-title"><%= isAr ? 'لا توجد مواعيد' : 'No Appointments' %></div>
                  <p class="p-empty-text"><%= isAr ? 'لا توجد مواعيد مطابقة للفلاتر المحددة.' : 'No appointments match the selected filters.' %></p>
                </div>
              </td>
            </tr>
          <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Earnings Summary -->
    <div class="portal-card">
      <div class="portal-card-header">
        <h2 class="portal-card-title"><%= isAr ? 'ملخص الأرباح' : 'Earnings Summary' %></h2>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-3);padding:var(--space-2) 0;">
        <div>
          <div class="p-form-label"><%= isAr ? 'إجمالي الأرباح' : 'Total Earnings' %></div>
          <div style="font-size:22px;font-weight:700;color:var(--accent-teal);"><%= Number(_stats.totalEarnings).toFixed(2) %> EGP</div>
        </div>
        <div>
          <div class="p-form-label"><%= isAr ? 'أرباح هذا الشهر' : 'This Month' %></div>
          <div style="font-size:22px;font-weight:700;color:var(--medical-blue);"><%= Number(_stats.monthEarnings).toFixed(2) %> EGP</div>
        </div>
        <div>
          <div class="p-form-label"><%= isAr ? 'استشارات مكتملة' : 'Completed Consultations' %></div>
          <div style="font-size:22px;font-weight:700;color:var(--dark-gray);"><%= _stats.completedCount %></div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Reschedule Modal -->
<div class="p-modal-overlay" id="reschedule-modal">
  <div class="p-modal">
    <div class="p-modal-header">
      <h3 class="p-modal-title"><%= isAr ? 'إعادة جدولة الموعد' : 'Reschedule Appointment' %></h3>
      <button class="p-modal-close" onclick="closeReschedule()">&times;</button>
    </div>
    <form id="reschedule-form" method="post">
      <div class="p-modal-body">
        <div class="p-form-group">
          <label class="p-form-label"><%= isAr ? 'التاريخ والوقت الجديد' : 'New Date & Time' %></label>
          <input type="datetime-local" name="new_scheduled_at" required class="p-form-input">
        </div>
      </div>
      <div class="p-modal-footer">
        <button type="button" class="p-btn p-btn-ghost" onclick="closeReschedule()"><%= isAr ? 'إلغاء' : 'Cancel' %></button>
        <button type="submit" class="p-btn p-btn-primary"><%= isAr ? 'تأكيد' : 'Confirm' %></button>
      </div>
    </form>
  </div>
</div>

<script>
function openReschedule(appointmentId) {
  var modal = document.getElementById('reschedule-modal');
  var form = document.getElementById('reschedule-form');
  form.action = '/portal/video/appointment/' + appointmentId + '/reschedule';
  modal.classList.add('active');
}
function closeReschedule() {
  document.getElementById('reschedule-modal').classList.remove('active');
}
document.getElementById('reschedule-modal').addEventListener('click', function(e) {
  if (e.target === this) closeReschedule();
});
</script>

<%- include('partials/footer') %>
