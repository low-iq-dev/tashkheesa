<%- include('partials/header', { title: (typeof title !== 'undefined' ? title : 'Appointments'), layout: 'portal', showNav: false }) %>
<%
  const isAr = (typeof lang !== 'undefined' && String(lang).toLowerCase() === 'ar');
  const _filters = (typeof filters !== 'undefined' && filters) ? filters : { status: 'all', period: 'all' };
  const _stats = (typeof stats !== 'undefined' && stats) ? stats : { totalEarnings: 0, monthEarnings: 0, completedCount: 0, noShowCount: 0 };
  const _appointments = (typeof appointments !== 'undefined' && appointments) ? appointments : [];
  const _upcoming = (typeof upcoming !== 'undefined' && upcoming) ? upcoming : [];
  const _todayAppts = (typeof todayAppts !== 'undefined' && todayAppts) ? todayAppts : [];
  const _past = (typeof past !== 'undefined' && past) ? past : [];

  function apptStatusLabel(val) {
    var v = (val || '').toLowerCase();
    if (isAr) {
      if (v === 'pending') return 'في الانتظار';
      if (v === 'confirmed') return 'مؤكد';
      if (v === 'started') return 'جارية';
      if (v === 'completed') return 'مكتمل';
      if (v === 'cancelled') return 'ملغى';
      if (v === 'no_show_patient') return 'غياب المريض';
      if (v === 'no_show_doctor') return 'غياب الطبيب';
      return v;
    }
    if (v === 'pending') return 'Pending';
    if (v === 'confirmed') return 'Confirmed';
    if (v === 'started') return 'In Progress';
    if (v === 'completed') return 'Completed';
    if (v === 'cancelled') return 'Cancelled';
    if (v === 'no_show_patient') return 'Patient No-Show';
    if (v === 'no_show_doctor') return 'Doctor No-Show';
    return v ? v.charAt(0).toUpperCase() + v.slice(1).replace(/_/g, ' ') : 'Unknown';
  }

  function statusColor(val) {
    var v = (val || '').toLowerCase();
    if (v === 'confirmed') return '#22c55e';
    if (v === 'started') return '#3b82f6';
    if (v === 'completed') return '#6b7280';
    if (v === 'cancelled') return '#ef4444';
    if (v === 'no_show_patient' || v === 'no_show_doctor') return '#f59e0b';
    return '#9ca3af';
  }

  function formatDate(iso) {
    if (!iso) return '—';
    var d = new Date(iso);
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }
  function formatTime(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
  }
%>

<div class="layout">
  <header>
    <div class="brand">
      <div class="brand-logo">T</div>
      <div>
        <div class="brand-text-main"><%= typeof brand !== 'undefined' ? brand : 'Tashkheesa' %></div>
        <div class="brand-text-sub"><%= isAr ? 'لوحة الاستشارات' : 'Consultations Dashboard' %></div>
      </div>
    </div>
    <div class="header-right">
      <a class="pill" href="/doctor/queue"><%= isAr ? 'حالاتي' : 'My Cases' %></a>
      <a class="pill active" href="/portal/doctor/appointments"><%= isAr ? 'المواعيد' : 'Appointments' %></a>
      <a class="pill" href="/portal/appointments/availability"><%= isAr ? 'أوقات العمل' : 'Availability' %></a>
      <a class="pill" href="/doctor/alerts">
        <%= isAr ? 'التنبيهات' : 'Alerts' %>
        <% if (typeof doctorAlertCount !== 'undefined' && doctorAlertCount > 0) { %>
          <span class="status-pill status-pill--new"><%= doctorAlertCount %></span>
        <% } %>
      </a>
      <a class="pill" href="/"><%= isAr ? 'الرئيسية' : 'Home' %></a>
      <%- include('partials/user_menu', { menuUser: user, isAr, profileHref: '/doctor/profile' }) %>
      <div class="lang-switch">
        <a href="/lang/en?next=<%= encodeURIComponent('/portal/doctor/appointments') %>">EN</a> | <a href="/lang/ar?next=<%= encodeURIComponent('/portal/doctor/appointments') %>">AR</a>
      </div>
    </div>
  </header>

  <main>
    <div class="page-shell">
    <div class="page-inner">
    <div class="content-stack">

      <!-- Page heading -->
      <div class="page-heading">
        <div>
          <h1 class="page-title"><%= isAr ? 'استشارات الفيديو' : 'Video Consultations' %></h1>
          <p class="page-subtitle"><%= isAr ? 'إدارة مواعيدك والاستشارات القادمة' : 'Manage your appointments and upcoming consultations' %></p>
        </div>
        <div class="page-heading-actions">
          <a class="btn btn-outline" href="/portal/appointments/availability"><%= isAr ? 'إعداد الأوقات' : 'Set Availability' %></a>
        </div>
      </div>

      <!-- Stats cards -->
      <div class="grid four-cols" style="gap: 16px; margin-bottom: 20px;">
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #0066CC;"><%= _stats.completedCount %></div>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;"><%= isAr ? 'استشارات مكتملة' : 'Completed' %></div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #22c55e;"><%= _upcoming.length %></div>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;"><%= isAr ? 'قادمة' : 'Upcoming' %></div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #f59e0b;"><%= _stats.noShowCount %></div>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;"><%= isAr ? 'غياب' : 'No-Shows' %></div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #059669;"><%= Number(_stats.monthEarnings).toFixed(0) %> <span style="font-size:13px;">EGP</span></div>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;"><%= isAr ? 'أرباح الشهر' : 'This Month' %></div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card filters-card">
        <form class="filters-form" method="get" action="/portal/doctor/appointments">
          <div class="form-group">
            <label class="filter-label"><%= isAr ? 'الفترة' : 'Period' %></label>
            <select class="filter-select" name="period">
              <option value="all" <%= _filters.period === 'all' ? 'selected' : '' %>><%= isAr ? 'الكل' : 'All Time' %></option>
              <option value="today" <%= _filters.period === 'today' ? 'selected' : '' %>><%= isAr ? 'اليوم' : 'Today' %></option>
              <option value="week" <%= _filters.period === 'week' ? 'selected' : '' %>><%= isAr ? 'هذا الأسبوع' : 'This Week' %></option>
              <option value="month" <%= _filters.period === 'month' ? 'selected' : '' %>><%= isAr ? 'هذا الشهر' : 'This Month' %></option>
            </select>
          </div>
          <div class="form-group">
            <label class="filter-label"><%= isAr ? 'الحالة' : 'Status' %></label>
            <select class="filter-select" name="status">
              <option value="all" <%= _filters.status === 'all' ? 'selected' : '' %>><%= isAr ? 'كل الحالات' : 'All Statuses' %></option>
              <option value="confirmed" <%= _filters.status === 'confirmed' ? 'selected' : '' %>><%= isAr ? 'مؤكد' : 'Confirmed' %></option>
              <option value="started" <%= _filters.status === 'started' ? 'selected' : '' %>><%= isAr ? 'جارية' : 'In Progress' %></option>
              <option value="completed" <%= _filters.status === 'completed' ? 'selected' : '' %>><%= isAr ? 'مكتمل' : 'Completed' %></option>
              <option value="cancelled" <%= _filters.status === 'cancelled' ? 'selected' : '' %>><%= isAr ? 'ملغى' : 'Cancelled' %></option>
              <option value="no_show_patient" <%= _filters.status === 'no_show_patient' ? 'selected' : '' %>><%= isAr ? 'غياب المريض' : 'Patient No-Show' %></option>
            </select>
          </div>
          <div class="form-group" style="display:flex; justify-content:flex-end;">
            <button class="btn btn-primary" type="submit"><%= isAr ? 'تطبيق' : 'Apply' %></button>
          </div>
        </form>
      </div>

      <!-- Today's Appointments (highlighted) -->
      <% if (_todayAppts.length > 0) { %>
      <div class="card" style="border-left: 4px solid #0066CC;">
        <div class="card-header">
          <div class="card-title" style="color: #0066CC;"><%= isAr ? 'مواعيد اليوم' : "Today's Appointments" %></div>
          <span class="status-pill status-pill--new"><%= _todayAppts.length %></span>
        </div>
        <table>
          <thead>
            <tr>
              <th><%= isAr ? 'الوقت' : 'Time' %></th>
              <th><%= isAr ? 'المريض' : 'Patient' %></th>
              <th><%= isAr ? 'التخصص' : 'Service' %></th>
              <th><%= isAr ? 'الحالة' : 'Status' %></th>
              <th><%= isAr ? 'إجراءات' : 'Actions' %></th>
            </tr>
          </thead>
          <tbody>
            <% _todayAppts.forEach(function(a) { %>
            <tr>
              <td>
                <strong><%= formatTime(a.scheduled_at) %></strong>
                <% if (a.canJoin) { %>
                  <br><span style="color: #22c55e; font-size: 11px; font-weight: 600;"><%= isAr ? 'جاهز الآن' : 'Ready Now' %></span>
                <% } else if (a.minsAway > 0) { %>
                  <br><span style="color: #6b7280; font-size: 11px;"><%= isAr ? 'خلال ' + a.minsAway + ' دقيقة' : 'in ' + a.minsAway + ' min' %></span>
                <% } %>
              </td>
              <td>
                <div><%= a.patient_name || 'Patient' %></div>
                <div style="font-size: 11px; color: #6b7280;"><%= a.patient_email || '' %></div>
              </td>
              <td><%= a.service_name || '—' %></td>
              <td>
                <span class="status-chip" style="background: <%= statusColor(a.status) %>20; color: <%= statusColor(a.status) %>; border: 1px solid <%= statusColor(a.status) %>40; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                  <%= apptStatusLabel(a.status) %>
                </span>
              </td>
              <td class="actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
                <% if (a.canJoin) { %>
                  <a class="btn btn-primary btn-small" href="/portal/video/call/<%= a.id %>" style="background: #22c55e; border-color: #22c55e;"><%= isAr ? 'انضمام' : 'Join Call' %></a>
                <% } %>
                <a class="btn btn-outline btn-small" href="/portal/video/appointment/<%= a.id %>"><%= isAr ? 'تفاصيل' : 'Details' %></a>
                <% if (a.canMarkNoShow) { %>
                  <form method="post" action="/portal/video/appointment/<%= a.id %>/no-show" style="display:inline;">
                    <input type="hidden" name="no_show_type" value="patient">
                    <button type="submit" class="btn btn-small" style="background: #f59e0b; color: #fff; border-color: #f59e0b;" onclick="return confirm('<%= isAr ? 'تأكيد تسجيل غياب المريض؟' : 'Confirm patient no-show?' %>')"><%= isAr ? 'غياب' : 'No-Show' %></button>
                  </form>
                <% } %>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <% } %>

      <!-- All Appointments Table -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><%= isAr ? 'كل المواعيد' : 'All Appointments' %></div>
          <span style="font-size: 13px; color: #6b7280;"><%= _appointments.length %> <%= isAr ? 'موعد' : 'appointment(s)' %></span>
        </div>
        <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th><%= isAr ? 'التاريخ' : 'Date' %></th>
              <th><%= isAr ? 'الوقت' : 'Time' %></th>
              <th><%= isAr ? 'المريض' : 'Patient' %></th>
              <th><%= isAr ? 'التخصص' : 'Service' %></th>
              <th><%= isAr ? 'الحالة' : 'Status' %></th>
              <th><%= isAr ? 'المبلغ' : 'Amount' %></th>
              <th><%= isAr ? 'إجراءات' : 'Actions' %></th>
            </tr>
          </thead>
          <tbody>
          <% if (_appointments.length > 0) { %>
            <% _appointments.forEach(function(a) { %>
              <tr style="<%= a.isToday ? 'background: #eff6ff;' : '' %>">
                <td>
                  <strong><%= formatDate(a.scheduled_at) %></strong>
                  <% if (a.isToday) { %>
                    <br><span style="color: #0066CC; font-size: 10px; font-weight: 600;"><%= isAr ? 'اليوم' : 'TODAY' %></span>
                  <% } %>
                </td>
                <td><%= formatTime(a.scheduled_at) %></td>
                <td>
                  <div><%= a.patient_name || 'Patient' %></div>
                </td>
                <td><%= a.service_name || '—' %></td>
                <td>
                  <span class="status-chip" style="background: <%= statusColor(a.status) %>20; color: <%= statusColor(a.status) %>; border: 1px solid <%= statusColor(a.status) %>40; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                    <%= apptStatusLabel(a.status) %>
                  </span>
                </td>
                <td>
                  <% if (a.price) { %>
                    <strong><%= Number(a.price).toFixed(0) %></strong> <span style="font-size:11px;">EGP</span>
                  <% } else { %>
                    —
                  <% } %>
                </td>
                <td class="actions" style="white-space: nowrap;">
                  <% if (a.canJoin) { %>
                    <a class="btn btn-primary btn-small" href="/portal/video/call/<%= a.id %>" style="background: #22c55e; border-color: #22c55e;"><%= isAr ? 'انضمام' : 'Join' %></a>
                  <% } %>
                  <a class="btn btn-outline btn-small" href="/portal/video/appointment/<%= a.id %>"><%= isAr ? 'عرض' : 'View' %></a>
                  <% if (a.canReschedule) { %>
                    <button class="btn btn-outline btn-small" onclick="openReschedule('<%= a.id %>')"><%= isAr ? 'إعادة جدولة' : 'Reschedule' %></button>
                  <% } %>
                  <% if (a.canCancel) { %>
                    <form method="post" action="/portal/video/appointment/<%= a.id %>/cancel" style="display:inline;">
                      <input type="hidden" name="reason" value="Cancelled by doctor">
                      <button type="submit" class="btn btn-small" style="background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;" onclick="return confirm('<%= isAr ? 'هل أنت متأكد من إلغاء هذا الموعد؟' : 'Cancel this appointment?' %>')"><%= isAr ? 'إلغاء' : 'Cancel' %></button>
                    </form>
                  <% } %>
                  <% if (a.canMarkNoShow) { %>
                    <form method="post" action="/portal/video/appointment/<%= a.id %>/no-show" style="display:inline;">
                      <input type="hidden" name="no_show_type" value="patient">
                      <button type="submit" class="btn btn-small" style="background: #fef3c7; color: #d97706; border: 1px solid #fde68a;" onclick="return confirm('<%= isAr ? 'تأكيد تسجيل غياب المريض؟' : 'Mark patient as no-show?' %>')"><%= isAr ? 'غياب' : 'No-Show' %></button>
                    </form>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="7" class="empty" style="text-align: center; padding: 32px; color: #6b7280;">
                <%= isAr ? 'لا توجد مواعيد مطابقة للفلاتر المحددة.' : 'No appointments match the selected filters.' %>
              </td>
            </tr>
          <% } %>
          </tbody>
        </table>
        </div>
      </div>

      <!-- Earnings Summary -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><%= isAr ? 'ملخص الأرباح' : 'Earnings Summary' %></div>
        </div>
        <div style="display: flex; gap: 24px; padding: 16px; flex-wrap: wrap;">
          <div>
            <div style="font-size: 12px; color: #6b7280;"><%= isAr ? 'إجمالي الأرباح' : 'Total Earnings' %></div>
            <div style="font-size: 20px; font-weight: 700; color: #059669;"><%= Number(_stats.totalEarnings).toFixed(2) %> EGP</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #6b7280;"><%= isAr ? 'أرباح هذا الشهر' : 'This Month' %></div>
            <div style="font-size: 20px; font-weight: 700; color: #0066CC;"><%= Number(_stats.monthEarnings).toFixed(2) %> EGP</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #6b7280;"><%= isAr ? 'استشارات مكتملة' : 'Completed Consultations' %></div>
            <div style="font-size: 20px; font-weight: 700;"><%= _stats.completedCount %></div>
          </div>
        </div>
      </div>

    </div>
    </div>
    </div>
  </main>
</div>

<!-- Reschedule Modal -->
<div id="reschedule-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:12px; padding:24px; max-width:400px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <h3 style="margin:0 0 16px;"><%= isAr ? 'إعادة جدولة الموعد' : 'Reschedule Appointment' %></h3>
    <form id="reschedule-form" method="post">
      <div class="form-group" style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-size:14px;"><%= isAr ? 'التاريخ والوقت الجديد' : 'New Date & Time' %></label>
        <input type="datetime-local" name="new_scheduled_at" required style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeReschedule()"><%= isAr ? 'إلغاء' : 'Cancel' %></button>
        <button type="submit" class="btn btn-primary"><%= isAr ? 'تأكيد' : 'Confirm' %></button>
      </div>
    </form>
  </div>
</div>

<script>
function openReschedule(appointmentId) {
  var modal = document.getElementById('reschedule-modal');
  var form = document.getElementById('reschedule-form');
  form.action = '/portal/video/appointment/' + appointmentId + '/reschedule';
  modal.style.display = 'flex';
}
function closeReschedule() {
  document.getElementById('reschedule-modal').style.display = 'none';
}
document.getElementById('reschedule-modal').addEventListener('click', function(e) {
  if (e.target === this) closeReschedule();
});
</script>

<%- include('partials/footer') %>
