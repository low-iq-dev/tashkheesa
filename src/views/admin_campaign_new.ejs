<%- include('partials/header', { title: pageTitle || "New Campaign", layout: "portal", showNav: false, portalFrame: true, portalRole: (typeof portalRole !== 'undefined' ? portalRole : 'superadmin'), portalActive: 'campaigns' }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
%>

<div class="admin-page">
  <div class="admin-page-header">
    <div class="admin-page-header-left">
      <nav class="admin-breadcrumb">
        <a href="/admin">Dashboard</a>
        <span class="admin-breadcrumb-sep">›</span>
        <a href="/portal/admin/campaigns">Campaigns</a>
        <span class="admin-breadcrumb-sep">›</span>
        <span><%= _isAr ? 'حملة جديدة' : 'New Campaign' %></span>
      </nav>
      <h1 class="admin-page-title"><%= _isAr ? 'حملة جديدة' : 'New Campaign' %></h1>
      <p class="admin-page-subtitle"><%= _isAr ? 'إنشاء حملة بريد إلكتروني جديدة' : 'Create a new email campaign' %></p>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-body">
      <form id="campaignForm">
        <div class="admin-form-grid">
          <div class="admin-form-group" style="grid-column:1/-1;">
            <label><%= _isAr ? 'اسم الحملة' : 'Campaign Name' %> *</label>
            <input type="text" name="name" required maxlength="200" placeholder="<%= _isAr ? 'مثال: عرض الصيف' : 'e.g. Summer Promotion' %>">
          </div>

          <div class="admin-form-group">
            <label><%= _isAr ? 'الموضوع (إنجليزي)' : 'Subject (English)' %> *</label>
            <input type="text" name="subject_en" required maxlength="500">
          </div>
          <div class="admin-form-group">
            <label><%= _isAr ? 'الموضوع (عربي)' : 'Subject (Arabic)' %></label>
            <input type="text" name="subject_ar" maxlength="500" dir="rtl">
          </div>

          <div class="admin-form-group" style="grid-column:1/-1;">
            <label><%= _isAr ? 'الجمهور المستهدف' : 'Target Audience' %></label>
            <select name="target_audience">
              <option value="all"><%= _isAr ? 'الجميع' : 'All Users' %></option>
              <option value="patients"><%= _isAr ? 'المرضى' : 'Patients' %></option>
              <option value="doctors"><%= _isAr ? 'الأطباء' : 'Doctors' %></option>
              <option value="completed_cases"><%= _isAr ? 'حالات مكتملة' : 'Completed Cases' %></option>
              <option value="inactive_30d"><%= _isAr ? 'غير نشطين 30 يوم' : 'Inactive 30 Days' %></option>
            </select>
          </div>

          <div class="admin-form-group" style="grid-column:1/-1;">
            <label><%= _isAr ? 'محتوى البريد (HTML)' : 'Email Content (HTML)' %> *</label>
            <textarea name="template" required rows="12" style="font-family:monospace;" placeholder="<%= _isAr ? 'محتوى HTML للبريد الإلكتروني...' : 'HTML email content...' %>"></textarea>
            <p style="margin:4px 0 0;font-size:0.8rem;color:#94a3b8;"><%= _isAr ? 'سيتم تضمينه في قالب البريد الرسمي لتشخيصة' : 'Will be wrapped in the Tashkheesa email layout template' %></p>
          </div>

          <div class="admin-form-group" style="grid-column:1/-1;">
            <label><%= _isAr ? 'جدولة الإرسال (اختياري)' : 'Schedule Send (optional)' %></label>
            <input type="datetime-local" name="scheduled_at">
            <p style="margin:4px 0 0;font-size:0.8rem;color:#94a3b8;"><%= _isAr ? 'اتركه فارغاً للحفظ كمسودة' : 'Leave empty to save as draft' %></p>
          </div>

          <div class="admin-form-group" style="grid-column:1/-1;">
            <div style="display:flex;gap:0.75rem;margin-top:0.5rem;">
              <button type="submit" id="submitBtn" class="admin-btn admin-btn-primary">
                <%= _isAr ? 'إنشاء الحملة' : 'Create Campaign' %>
              </button>
              <a href="/portal/admin/campaigns" class="admin-btn admin-btn-outline">
                <%= _isAr ? 'إلغاء' : 'Cancel' %>
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="resultMsg" style="display:none;margin-top:1rem;padding:12px 16px;border-radius:8px;font-size:0.9rem;"></div>
</div>

<script nonce="<%= cspNonce %>">
(function() {
  var form = document.getElementById('campaignForm');
  var btn = document.getElementById('submitBtn');
  var msg = document.getElementById('resultMsg');

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    btn.disabled = true;
    btn.textContent = '<%= _isAr ? "جاري الإنشاء..." : "Creating..." %>';
    msg.style.display = 'none';

    var fd = new FormData(form);
    var data = {};
    fd.forEach(function(v, k) { data[k] = v; });

    fetch('/portal/admin/campaigns', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-csrf-token': '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>'
      },
      body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (res.ok) {
        msg.style.display = 'block';
        msg.style.background = '#e9f7ef';
        msg.style.color = '#065f46';
        msg.textContent = (res.message || 'Created') + ' (' + (res.recipientCount || 0) + ' recipients)';
        setTimeout(function() {
          window.location.href = '/portal/admin/campaigns/' + res.id;
        }, 1000);
      } else {
        msg.style.display = 'block';
        msg.style.background = '#fee2e2';
        msg.style.color = '#991b1b';
        msg.textContent = res.error || 'Error creating campaign';
        btn.disabled = false;
        btn.textContent = '<%= _isAr ? "إنشاء الحملة" : "Create Campaign" %>';
      }
    })
    .catch(function() {
      msg.style.display = 'block';
      msg.style.background = '#fee2e2';
      msg.style.color = '#991b1b';
      msg.textContent = 'Network error';
      btn.disabled = false;
      btn.textContent = '<%= _isAr ? "إنشاء الحملة" : "Create Campaign" %>';
    });
  });
})();
</script>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>