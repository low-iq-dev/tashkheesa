<%- include('partials/header', { title: pageTitle || "New Campaign", layout: "portal", showNav: false, portalFrame: true, portalRole: 'superadmin', portalActive: 'campaigns' }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
%>

<div style="padding: 1.5rem; max-width: 800px;">
  <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
    <a href="/portal/admin/campaigns" style="color:#64748b;text-decoration:none;font-size:1.2rem;">&larr;</a>
    <h2 style="margin:0;"><%= _isAr ? 'حملة جديدة' : 'New Campaign' %></h2>
  </div>

  <form id="campaignForm" style="display:flex;flex-direction:column;gap:1.25rem;">
    <div>
      <label style="display:block;font-weight:600;margin-bottom:4px;font-size:0.9rem;"><%= _isAr ? 'اسم الحملة' : 'Campaign Name' %> *</label>
      <input type="text" name="name" required maxlength="200" style="width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95rem;" placeholder="<%= _isAr ? 'مثال: عرض الصيف' : 'e.g. Summer Promotion' %>">
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
      <div>
        <label style="display:block;font-weight:600;margin-bottom:4px;font-size:0.9rem;"><%= _isAr ? 'الموضوع (إنجليزي)' : 'Subject (English)' %> *</label>
        <input type="text" name="subject_en" required maxlength="500" style="width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95rem;">
      </div>
      <div>
        <label style="display:block;font-weight:600;margin-bottom:4px;font-size:0.9rem;"><%= _isAr ? 'الموضوع (عربي)' : 'Subject (Arabic)' %></label>
        <input type="text" name="subject_ar" maxlength="500" style="width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95rem;" dir="rtl">
      </div>
    </div>

    <div>
      <label style="display:block;font-weight:600;margin-bottom:4px;font-size:0.9rem;"><%= _isAr ? 'الجمهور المستهدف' : 'Target Audience' %></label>
      <select name="target_audience" style="width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95rem;">
        <option value="all"><%= _isAr ? 'الجميع' : 'All Users' %></option>
        <option value="patients"><%= _isAr ? 'المرضى' : 'Patients' %></option>
        <option value="doctors"><%= _isAr ? 'الأطباء' : 'Doctors' %></option>
        <option value="completed_cases"><%= _isAr ? 'حالات مكتملة' : 'Completed Cases' %></option>
        <option value="inactive_30d"><%= _isAr ? 'غير نشطين 30 يوم' : 'Inactive 30 Days' %></option>
      </select>
    </div>

    <div>
      <label style="display:block;font-weight:600;margin-bottom:4px;font-size:0.9rem;"><%= _isAr ? 'محتوى البريد (HTML)' : 'Email Content (HTML)' %> *</label>
      <textarea name="template" required rows="12" style="width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95rem;font-family:monospace;" placeholder="<%= _isAr ? 'محتوى HTML للبريد الإلكتروني...' : 'HTML email content...' %>"></textarea>
      <p style="margin:4px 0 0;font-size:0.8rem;color:#94a3b8;"><%= _isAr ? 'سيتم تضمينه في قالب البريد الرسمي لتشخيصة' : 'Will be wrapped in the Tashkheesa email layout template' %></p>
    </div>

    <div>
      <label style="display:block;font-weight:600;margin-bottom:4px;font-size:0.9rem;"><%= _isAr ? 'جدولة الإرسال (اختياري)' : 'Schedule Send (optional)' %></label>
      <input type="datetime-local" name="scheduled_at" style="width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95rem;">
      <p style="margin:4px 0 0;font-size:0.8rem;color:#94a3b8;"><%= _isAr ? 'اتركه فارغاً للحفظ كمسودة' : 'Leave empty to save as draft' %></p>
    </div>

    <div style="display:flex;gap:0.75rem;margin-top:0.5rem;">
      <button type="submit" id="submitBtn" style="padding:10px 24px;background:#38b2ac;color:#fff;border:none;border-radius:8px;font-size:0.95rem;font-weight:600;cursor:pointer;">
        <%= _isAr ? 'إنشاء الحملة' : 'Create Campaign' %>
      </button>
      <a href="/portal/admin/campaigns" style="padding:10px 24px;background:#f1f5f9;color:#475569;border-radius:8px;text-decoration:none;font-size:0.95rem;">
        <%= _isAr ? 'إلغاء' : 'Cancel' %>
      </a>
    </div>
  </form>

  <div id="resultMsg" style="display:none;margin-top:1rem;padding:12px 16px;border-radius:8px;font-size:0.9rem;"></div>
</div>

<script nonce="<%= cspNonce %>">
(function() {
  var form = document.getElementById('campaignForm');
  var btn = document.getElementById('submitBtn');
  var msg = document.getElementById('resultMsg');

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    btn.disabled = true;
    btn.textContent = '<%= _isAr ? "جاري الإنشاء..." : "Creating..." %>';
    msg.style.display = 'none';

    var fd = new FormData(form);
    var data = {};
    fd.forEach(function(v, k) { data[k] = v; });

    fetch('/portal/admin/campaigns', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-csrf-token': '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>'
      },
      body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (res.ok) {
        msg.style.display = 'block';
        msg.style.background = '#e9f7ef';
        msg.style.color = '#065f46';
        msg.textContent = (res.message || 'Created') + ' (' + (res.recipientCount || 0) + ' recipients)';
        setTimeout(function() {
          window.location.href = '/portal/admin/campaigns/' + res.id;
        }, 1000);
      } else {
        msg.style.display = 'block';
        msg.style.background = '#fee2e2';
        msg.style.color = '#991b1b';
        msg.textContent = res.error || 'Error creating campaign';
        btn.disabled = false;
        btn.textContent = '<%= _isAr ? "إنشاء الحملة" : "Create Campaign" %>';
      }
    })
    .catch(function() {
      msg.style.display = 'block';
      msg.style.background = '#fee2e2';
      msg.style.color = '#991b1b';
      msg.textContent = 'Network error';
      btn.disabled = false;
      btn.textContent = '<%= _isAr ? "إنشاء الحملة" : "Create Campaign" %>';
    });
  });
})();
</script>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
