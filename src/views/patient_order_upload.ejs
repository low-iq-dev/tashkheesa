<%- include('partials/header', { title: "Upload Files", layout: "portal", showNav: false }) %>
<%
  // Use one consistent language + direction for this view.
  // Some routes may set `dir` without setting `lang`, which causes RTL layout with English strings.
  const pageLang = (typeof lang !== 'undefined' && lang) ? lang : ((typeof dir !== 'undefined' && dir === 'rtl') ? 'ar' : 'en');
  const isAr = pageLang === 'ar';
  const pageDir = (typeof dir !== 'undefined' && dir) ? dir : (isAr ? 'rtl' : 'ltr');
  const brandSafe = typeof brand !== 'undefined' ? brand : 'Tashkheesa';
  const safeNext = '/portal/patient/orders/' + order.id + '/upload';
  const tFn = (typeof t === 'function') ? t : ((k) => k);

  // Uploadcare should come from the route render locals (avoid reading env inside the view)
  const uploadcarePk = (typeof uploadcarePublicKey !== 'undefined' && uploadcarePublicKey)
    ? String(uploadcarePublicKey).trim()
    : '';
  const uploaderConfigured = uploadcarePk.length > 0;
%>
  <script<% if (typeof cspNonce !== 'undefined' && cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
    // Uploadcare config must be set BEFORE the Uploadcare script loads
    window.UPLOADCARE_PUBLIC_KEY = <%- JSON.stringify(uploadcarePk) %>;
    window.UPLOADCARE_SYSTEM_DIALOG = true;
    window.UPLOADCARE_MULTIPLE = false;
    window.UPLOADCARE_LOCALE = <%- JSON.stringify(pageLang === 'ar' ? 'ar' : 'en') %>;
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>
  <% 
    var files = (typeof files !== 'undefined' && files) ? files : [];
    var lockedFlag = (typeof locked !== 'undefined') ? locked : false;
    var uploadedFlag = (typeof uploaded !== 'undefined') ? uploaded : false;

    // `error` is a code (e.g., missing_uploader / missing / locked)
    var errorCode = (typeof error !== 'undefined' && error) ? String(error) : '';
  %>
  <div class="page-shell">
<div class="page-inner patient-upload-page">
        <header>
        <div class="brand">
          <div class="brand-logo">T</div>
          <div><%= isAr ? 'بوابة المريض' : 'Patient Portal' %></div>
        </div>
        <div class="header-right">
          <a class="pill" href="/dashboard"><%= isAr ? 'حالاتي' : 'My cases' %></a>
          <a class="pill" href="/portal/patient/alerts">
            <%= isAr ? 'التنبيهات' : 'Alerts' %>
            <% if (typeof hasUnseenAlerts !== 'undefined' && hasUnseenAlerts) { %>
              <span class="alert-dot" aria-label="<%= isAr ? 'تنبيهات غير مقروءة' : 'Unseen alerts' %>" title="<%= isAr ? 'تنبيهات غير مقروءة' : 'Unseen alerts' %>"></span>
            <% } %>
          </a>
          <div class="lang-switch">
            <a href="/lang/en?next=<%= encodeURIComponent(safeNext) %>">EN</a> | <a href="/lang/ar?next=<%= encodeURIComponent(safeNext) %>">AR</a>
          </div>

          <%- include('partials/user_menu', { menuUser: user, isAr, profileHref: '/patient/profile' }) %>
        </div>
      </header>

      <main>
        <div class="page-heading">
          <div>
            <h1><%= tFn('patient.upload.title') %></h1>
            <p class="subtitle"><%= tFn('patient.upload.subtitle') %></p>
            <p class="subtitle"><%= isAr ? 'الحالة' : 'Order' %> <%= order.id %> · <%= order.service_name || (isAr ? 'الخدمة' : 'Service') %> · <%= isAr ? 'الحالة' : 'Status' %>: <%= order.status || 'new' %></p>
          </div>
<div class="page-heading-actions patient-upload-actions">
              <a class="btn btn-outline" href="/portal/patient/orders/<%= order.id %>"><%= tFn('patient.upload.back_to_case') %></a>
          </div>
        </div>

        <div class="card patient-order-card">
          <div class="card-title"><%= isAr ? 'الحالة' : 'Order' %> <%= order.id %></div>
          <p class="muted"><%= order.service_name || (isAr ? 'الخدمة' : 'Service') %></p>
          <p class="muted"><%= isAr ? 'الحالة' : 'Status' %>: <%= order.status || 'new' %></p>
        </div>

        <div class="card patient-order-card">
          <div class="card-title"><%= tFn('patient.upload.current_files') %></div>
          <% if (!files.length) { %>
            <p class="muted"><%= tFn('patient.upload.no_files_yet') %></p>
          <% } else { %>
            <ul class="files-list">
              <% files.forEach(function(f) { %>
                <li>
                  <a href="<%= f.url %>" target="_blank" rel="noopener"><%= f.url %></a>
                  <div class="muted"><%= f.created_at %> <%= f.label ? '· ' + f.label : '' %></div>
                </li>
              <% }); %>
            </ul>
          <% } %>
        </div>

        <% if (!uploadcarePk) { %>
          <div class="card patient-order-card alert alert-warning">
            <div class="alert-title"><%= tFn('patient.upload.warning_not_configured_title') %></div>
            <div class="muted" style="margin-top:6px;">
              <%= tFn('patient.upload.warning_not_configured_body') %>
            </div>
          </div>
        <% } %>

        <% if (errorCode) { %>
          <div class="card patient-order-card alert alert-danger">
            <div class="alert-title">
              <% if (errorCode === 'missing_uploader') { %>
                <%= tFn('patient.upload.err_uploader_not_configured') %>
              <% } else if (errorCode === 'missing') { %>
                <%= tFn('patient.upload.err_choose_file') %>
              <% } else if (errorCode === 'locked') { %>
                <%= isAr ? 'تم إغلاق الرفع لهذا الطلب.' : 'Uploads are locked for this order.' %>
              <% } else if (errorCode === 'too_many') { %>
                <%= isAr ? 'عدد الملفات كبير جداً. الرجاء رفع ملف واحد في كل مرة.' : 'Too many files. Please upload one file at a time.' %>
              <% } else if (errorCode === 'invalid_url') { %>
                <%= isAr ? 'رابط الملف غير صالح.' : 'Invalid file URL.' %>
              <% } else { %>
                <%= isAr ? 'حدث خطأ.' : 'An error occurred.' %>
              <% } %>
            </div>
          </div>
        <% } %>

        <% if (uploadedFlag) { %>
          <div class="card patient-order-card alert alert-success">
            <div class="alert-title"><%= isAr ? 'تم رفع الملفات بنجاح' : 'Files uploaded successfully' %></div>
          </div>
        <% } %>

        <div class="card patient-order-card">
          <div class="card-title"><%= tFn('patient.upload.title') %></div>
          <% if (order.status === 'completed') { %>
            <p class="muted"><%= isAr ? 'تم إغلاق الرفع لهذا الطلب بعد إتمام التقرير.' : 'Uploads are closed because the report is completed.' %></p>
          <% } else if (order.uploads_locked === 1 || lockedFlag) { %>
            <p class="muted"><%= isAr ? 'تم إغلاق الرفع لهذا الطلب (عادةً بعد الدفع). إذا احتجت لإضافة ملفات، تواصل مع الدعم لفتح الرفع مؤقتاً.' : 'Uploads are locked for this order (typically after payment). If you need to add more files, contact support and an admin can temporarily unlock uploads.' %></p>
          <% } else { %>
            <p class="muted" style="margin-top:6px;"><%= tFn('patient.upload.drag_drop_hint') %></p>
            <p class="muted" style="margin-top:4px;"><%= tFn('patient.upload.compress_note') %></p>
            <form id="uploadForm" method="post" action="/portal/patient/orders/<%= order.id %>/upload">
              <%- (typeof csrfField === 'function') ? csrfField() : '' %>
              <input type="hidden" name="file_url" id="file_url_input" />
              <div id="upload_status" class="muted" style="margin-top:10px; display:none;"></div>
              <div id="upload_error" class="muted" style="display:none; color:#b91c1c; margin-top:10px;"><%= tFn('patient.upload.err_choose_file') %></div>

              <div class="upload-dropzone <%= uploaderConfigured ? '' : 'disabled' %>" <%= uploaderConfigured ? '' : 'aria-disabled="true"' %>>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <div class="muted"><%= tFn('patient.upload.drop_here') %></div>
                <input
                  type="hidden"
                  name="ucare_file"
                  role="uploadcare-uploader"
                  data-public-key="<%= uploadcarePk %>"
                  data-system-dialog="true"
                  data-multiple="false"
                  data-tabs="file"
                  data-clearable="true"
                  id="ucare_widget"
                />

                <input
                  class="visually-hidden-file"
                  type="file"
                  id="native_file"
                  accept="*/*"
                />
              </div>

              <div class="form-group">
                <label for="label"><%= tFn('patient.upload.optional_label') %></label>
                <input type="text" name="label" id="label" placeholder="<%= tFn('patient.upload.optional_label_ph') %>" />
              </div>

              <button class="btn btn-primary" type="submit"><%= tFn('patient.upload.add_file') %></button>
            </form>
          <% } %>
        </div>
      </main>
    </div>
  </div>

  <script<% if (typeof cspNonce !== 'undefined' && cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
    (function() {
      var input = document.getElementById('file_url_input');
      var err = document.getElementById('upload_error');
      var statusEl = document.getElementById('upload_status');
      var form = document.getElementById('uploadForm');
      var dz = document.querySelector('.upload-dropzone');
      var nativeFile = document.getElementById('native_file');

      function showStatus(msg) {
        if (!statusEl) return;
        statusEl.style.display = 'block';
        statusEl.textContent = msg;
      }
      function clearStatus() {
        if (!statusEl) return;
        statusEl.style.display = 'none';
        statusEl.textContent = '';
      }
      function fail(msg) {
        if (err) err.style.display = 'none';
        showStatus(msg);
      }
      function ready(msg) {
        if (err) err.style.display = 'none';
        showStatus(msg);
      }
      function setUrl(url) {
        clearStatus();
        if (input) input.value = url;
        if (err) err.style.display = 'none';
        var uploadedMsg = <%- JSON.stringify(tFn('patient.upload.toast_file_uploaded')) %>;
        ready(uploadedMsg);
      }

      // Drag & drop + click-to-choose (file-only).
      if (dz) {
        dz.style.cursor = 'copy';

        dz.addEventListener('click', function() {
          var pk = String(window.UPLOADCARE_PUBLIC_KEY || '').trim();
          if (!pk) return; // disabled when not configured
          if (nativeFile) nativeFile.click();
        });

        dz.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          dz.classList.add('dragover');
        });
        dz.addEventListener('dragleave', function() {
          dz.classList.remove('dragover');
        });
        dz.addEventListener('drop', function(e) {
          e.preventDefault();
          dz.classList.remove('dragover');
          var pk = String(window.UPLOADCARE_PUBLIC_KEY || '').trim();
          if (!pk) return;
          var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (f) uploadFile(f);
        });
      }

      if (nativeFile) {
        nativeFile.addEventListener('change', function(e) {
          var pk = String(window.UPLOADCARE_PUBLIC_KEY || '').trim();
          if (!pk) return;
          var f = e.target && e.target.files && e.target.files[0];
          if (f) uploadFile(f);
          // allow re-selecting the same file
          nativeFile.value = '';
        });
      }

      function waitForUploadcare(cb, tries) {
        tries = tries || 0;
        if (window.uploadcare && typeof window.uploadcare.fileFrom === 'function') return cb(true);
        if (tries >= 20) return cb(false);
        showStatus('<%= isAr ? "جارٍ تحميل أداة الرفع..." : "Loading uploader..." %>');
        setTimeout(function() { waitForUploadcare(cb, tries + 1); }, 150);
      }

      function uploadFile(file) {
        if (!file) return;
        if (err) err.style.display = 'none';

        var pk = String(window.UPLOADCARE_PUBLIC_KEY || '').trim();
        if (!pk) {
          fail('<%= isAr ? "الرفع غير مُهيأ حالياً (UPLOADCARE_PUBLIC_KEY غير موجود)." : "Uploader is not configured (UPLOADCARE_PUBLIC_KEY is missing)." %>');
          return;
        }

        waitForUploadcare(function(ok) {
          if (!ok) {
            fail('<%= isAr ? "تعذر تحميل خدمة الرفع (قد يكون محجوباً بواسطة مانع الإعلانات)." : "Uploader failed to load (may be blocked by an ad blocker)." %>');
            return;
          }

          showStatus('<%= isAr ? "جارٍ رفع الملف..." : "Uploading file..." %>');

          try {
            // Upload local file -> get CDN URL
            var ucFile = window.uploadcare.fileFrom('object', file);
            if (ucFile && typeof ucFile.done === 'function') {
              ucFile.done(function(info) {
                if (info && info.cdnUrl) return setUrl(info.cdnUrl);
                if (info && typeof info.done === 'function') {
                  info.done(function(info2) {
                    if (info2 && info2.cdnUrl) return setUrl(info2.cdnUrl);
                    fail('<%= isAr ? "فشل الرفع: لم يتم الحصول على رابط الملف." : "Upload failed: no file URL returned." %>');
                  });
                  return;
                }
                fail('<%= isAr ? "فشل الرفع: لم يتم الحصول على رابط الملف." : "Upload failed: no file URL returned." %>');
              });
            } else if (ucFile && typeof ucFile.then === 'function') {
              ucFile.then(function(info) {
                if (info && info.cdnUrl) return setUrl(info.cdnUrl);
                fail('<%= isAr ? "فشل الرفع: لم يتم الحصول على رابط الملف." : "Upload failed: no file URL returned." %>');
              }).catch(function() {
                fail('<%= isAr ? "فشل الرفع." : "Upload failed." %>');
              });
            } else {
              fail('<%= isAr ? "تعذر بدء الرفع." : "Could not start upload." %>');
            }
          } catch (e) {
            fail('<%= isAr ? "فشل الرفع." : "Upload failed." %>');
          }
        });
      }

      // Keep embedded Uploadcare widget (hidden input) as a safety net.
      try {
        if (window.uploadcare && typeof window.uploadcare.Widget === 'function') {
          var widget = window.uploadcare.Widget('#ucare_widget');
          if (widget && typeof widget.onUploadComplete === 'function') {
            widget.onUploadComplete(function(info) {
              if (info && info.cdnUrl) setUrl(info.cdnUrl);
            });
          }
        }
      } catch (_) {}

      // Client-side guard: don't submit unless we have a URL from the uploader.
      if (form) {
        form.addEventListener('submit', function(e) {
          if (!input || !input.value) {
            e.preventDefault();
            if (err) err.style.display = 'block';
          }
        });
      }
    })();
  </script>

<%- include('partials/footer') %>
