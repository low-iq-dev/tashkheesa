<!DOCTYPE html>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<html lang="<%= lang || 'en' %>" dir="<%= isAr ? 'rtl' : 'ltr' %>">
<head>
  <meta charset="utf-8" />
  <title>Doctor Queue ‚Äì <%= brand %></title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <% 
    var filters = (typeof filters !== 'undefined' && filters) ? filters : { status: 'all', sla: 'all', specialty: 'all' };
    // Preserve current filters when switching language
    var qs = new URLSearchParams({
      status: (filters && filters.status) ? filters.status : 'all',
      sla: (filters && filters.sla) ? filters.sla : 'all',
      specialty: (filters && filters.specialty) ? filters.specialty : 'all'
    });
    var langNextHref = '/doctor/queue' + (qs.toString() ? ('?' + qs.toString()) : '');
    var specialties = (typeof specialties !== 'undefined' && specialties) ? specialties : [];
    var activeOrders = (typeof activeOrders !== 'undefined' && activeOrders) ? activeOrders : [];
    var unassignedOrders = (typeof unassignedOrders !== 'undefined' && unassignedOrders) ? unassignedOrders : [];
    var closedOrders = (typeof closedOrders !== 'undefined' && closedOrders) ? closedOrders : [];
    function statusLabel(val) {
      var v = (val || '').toLowerCase();
      if (isAr) {
        if (v === 'accepted') return 'ÿ™ŸÖ ÿßŸÑŸÇÿ®ŸàŸÑ';
        if (v === 'in_review' || v === 'in-review') return 'ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©';
        if (v === 'completed') return 'ŸÖŸÉÿ™ŸÖŸÑ';
        if (v === 'breached') return 'ŸÖÿ™ÿ£ÿÆÿ± ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ';
        return 'ÿ¨ÿØŸäÿØ';
      }
      if (v === 'breached') return 'Breached (late)';
      if (v === 'in_review' || v === 'in-review') return 'In Review';
      return v ? v.charAt(0).toUpperCase() + v.slice(1) : 'Status';
    }
  %>
  <div class="layout">
    <header>
      <div class="brand">
        <div class="brand-logo">T</div>
        <div>
          <div class="brand-text-main"><%= brand %></div>
          <div class="brand-text-sub"><%= isAr ? 'ŸÇÿßÿ¶ŸÖÿ© ÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Doctor case queue' %></div>
        </div>
      </div>
      <div class="header-right">
        <a class="pill" href="/doctor/queue"><%= isAr ? 'ÿ≠ÿßŸÑÿßÿ™Ÿä' : 'My Cases' %></a>
        <a class="pill" href="/doctor/alerts">
          <%= isAr ? 'ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™' : 'Alerts' %>
          <% if (typeof doctorAlertCount !== 'undefined' && doctorAlertCount > 0) { %>
            <span class="status-pill status-pill--new"><%= doctorAlertCount %></span>
          <% } %>
        </a>
        <a class="pill" href="/"><%= isAr ? 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©' : 'Home' %></a>
        <div class="pill">
          üë®‚Äç‚öïÔ∏è <span><%= (user && user.name) || 'Doctor' %></span>
        </div>
        <div class="lang-switch">
          <a href="/lang/en?next=<%= encodeURIComponent(langNextHref) %>">EN</a> | <a href="/lang/ar?next=<%= encodeURIComponent(langNextHref) %>">AR</a>
        </div>
        <form class="logout-form" method="post" action="/logout">
          <%- (typeof csrfField === 'function') ? csrfField() : '' %>
          <button type="submit"><%= t('nav.logout') %></button>
        </form>
      </div>
    </header>

    <main>
      <div class="page-shell">
      <div class="page-inner">
      <div class="content-stack">
        <div class="page-heading">
          <div>
            <h1 class="page-title"><%= isAr ? 'ŸÑŸàÿ≠ÿ© ÿπŸÖŸÑ ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Doctor Workbench' %></h1>
            <p class="page-subtitle"><%= isAr ? 'ÿ±ÿßÿ¨ÿπ Ÿàÿ£ÿØŸêÿ± ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿßŸÑŸÖŸàŸÉŸÑÿ© ÿ•ŸÑŸäŸÉ.' : 'Review and manage your assigned cases.' %></p>
          </div>
          <div class="page-heading-actions">
            <a class="btn btn-outline" href="/doctor/alerts">
              <%= isAr ? 'ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™' : 'Alerts' %>
              <% if (typeof doctorAlertCount !== 'undefined' && doctorAlertCount > 0) { %>
                (<%= doctorAlertCount %>)
              <% } %>
            </a>
          </div>
        </div>

        <div class="card filters-card">
          <form class="filters-form" method="get" action="/doctor/queue">
            <div class="form-group">
              <label class="filter-label"><%= isAr ? 'ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Status' %></label>
              <select class="filter-select" name="status">
                <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>><%= isAr ? 'ŸÉŸÑ ÿßŸÑÿ≠ÿßŸÑÿßÿ™' : 'All statuses' %></option>
                <option value="new" <%= filters.status === 'new' ? 'selected' : '' %>><%= isAr ? 'ÿ¨ÿØŸäÿØ' : 'New' %></option>
                <option value="accepted" <%= filters.status === 'accepted' ? 'selected' : '' %>><%= isAr ? 'ÿ™ŸÖ ÿßŸÑŸÇÿ®ŸàŸÑ' : 'Accepted' %></option>
                <option value="in_review" <%= filters.status === 'in_review' ? 'selected' : '' %>><%= isAr ? 'ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©' : 'In Review' %></option>
                <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>><%= isAr ? 'ŸÖŸÉÿ™ŸÖŸÑ' : 'Completed' %></option>
                <option value="breached" <%= filters.status === 'breached' ? 'selected' : '' %>><%= isAr ? 'ŸÖÿ™ÿ£ÿÆÿ± ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ' : 'Breached (late)' %></option>
              </select>
            </div>

            <div class="form-group">
              <label class="filter-label"><%= isAr ? 'ÿ≤ŸÖŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©' : 'SLA' %></label>
              <select class="filter-select" name="sla">
                <option value="all" <%= filters.sla === 'all' ? 'selected' : '' %>><%= isAr ? 'ŸÉŸÑ ÿ£ŸÜŸàÿßÿπ ÿ≤ŸÖŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©' : 'All SLA types' %></option>
                <option value="24" <%= String(filters.sla) === '24' ? 'selected' : '' %>><%= isAr ? 'VIP 24 ÿ≥ÿßÿπÿ©' : 'VIP 24h' %></option>
                <option value="72" <%= String(filters.sla) === '72' ? 'selected' : '' %>><%= isAr ? 'ŸÇŸäÿßÿ≥Ÿä 72 ÿ≥ÿßÿπÿ©' : 'Standard 72h' %></option>
              </select>
            </div>

            <div class="form-group">
              <label class="filter-label"><%= isAr ? 'ÿßŸÑÿ™ÿÆÿµÿµ' : 'Specialty' %></label>
              <select class="filter-select" name="specialty">
                <option value="all" <%= filters.specialty === 'all' ? 'selected' : '' %>><%= isAr ? 'ŸÉŸÑ ÿßŸÑÿ™ÿÆÿµÿµÿßÿ™' : 'All specialties' %></option>
                <% specialties.forEach(function(sp) { %>
                  <option value="<%= sp.id %>" <%= String(filters.specialty) === String(sp.id) ? 'selected' : '' %>>
                    <%= sp.name %>
                  </option>
                <% }) %>
              </select>
            </div>

            <div class="form-group" style="display:flex; justify-content:flex-end;">
              <button class="btn btn-primary" type="submit"><%= isAr ? 'ÿ™ÿ∑ÿ®ŸäŸÇ' : 'Apply' %></button>
            </div>
          </form>
        </div>

      <div class="grid two-cols">
        <!-- Active cases -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><%= isAr ? 'ÿ≠ÿßŸÑÿßÿ™Ÿä ÿßŸÑŸÜÿ¥ÿ∑ÿ©' : 'My Active Cases' %></div>
          </div>
          <table>
            <thead>
              <tr>
                <th><%= isAr ? 'ÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case ID' %></th>
                <th><%= isAr ? 'ŸÜŸàÿπ ÿßŸÑŸÅÿ≠ÿµ' : 'Service' %></th>
                <th><%= isAr ? 'ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Status' %></th>
                <th><%= isAr ? 'ÿ≤ŸÖŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©' : 'SLA' %></th>
                <th><%= isAr ? 'ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™' : 'Flags' %></th>
                <th><%= isAr ? 'ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™' : 'Actions' %></th>
              </tr>
            </thead>
            <tbody>
            <% if (activeOrders && activeOrders.length > 0) { %>
              <% activeOrders.forEach(function(o) { %>
                <tr>
                  <td><small><%= o.id %></small></td>
                  <td>
                    <div><%= o.service_name || '-' %></div>
                    <div class="muted" style="font-size:11px;"><%= o.specialty_name || '' %></div>
                  </td>
                  <td>
                    <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                      <% 
                        var eff = o.effectiveStatus || o.status;
                        let statusClass = 'status-chip';
                        if (eff === 'completed') statusClass += ' completed';
                        if (eff === 'breached') statusClass += ' breached';
                        if (eff === 'accepted' || eff === 'in_review' || eff === 'in-review') statusClass += ' active';
                      %>
                      <span class="<%= statusClass %>"><%= statusLabel(eff) %></span>
                      <% if (eff === 'breached') { %>
                        <span class="status-pill status-pill--breached"><%= isAr ? 'ŸÖÿ™ÿ£ÿÆÿ± ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ' : 'Breached (late)' %></span>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <%
                      const slaState = o.sla || {};
                      let slaClass = 'sla-badge';
                      let label = o.sla_hours === 24
                        ? (isAr ? 'VIP 24 ÿ≥ÿßÿπÿ©' : 'VIP 24h')
                        : (isAr ? 'ŸÇŸäÿßÿ≥Ÿä ' + (o.sla_hours || '') + ' ÿ≥ÿßÿπÿ©' : 'Standard ' + (o.sla_hours || '') + 'h');
                      if (eff === 'breached' || slaState.isBreached) {
                        slaClass += ' breached';
                        label = isAr ? 'ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑŸÖŸàÿπÿØ' : 'Deadline passed';
                      } else if (typeof slaState.minutesRemaining === 'number') {
                        slaClass += ' ok';
                        label = isAr
                          ? Math.max(0, Math.floor((slaState.minutesRemaining || 0) / 60)) + 'ÿ≥ ŸÖÿ™ÿ®ŸÇŸäÿ©'
                          : Math.max(0, Math.floor((slaState.minutesRemaining || 0) / 60)) + 'h remaining';
                      } else if (slaState.isNew) {
                        label = isAr ? 'ŸÑŸÖ ÿ™ŸèŸÇÿ®ŸÑ ÿ®ÿπÿØ' : 'Not yet accepted';
                      }
                    %>
                    <span class="<%= slaClass %>"><%= label %></span>
                  </td>
                  <td>
                    <% if (o.additional_files_requested) { %>
                      <span class="tag"><%= isAr ? 'ŸÖÿ∑ŸÑŸàÿ® ŸÖŸÑŸÅÿßÿ™' : 'Files requested' %></span>
                    <% } %>
                    <% if (o.extra_files_count > 0) { %>
                      <span class="tag"><%= o.extra_files_count %> <%= isAr ? 'ŸÖŸÑŸÅ' : 'file(s)' %></span>
                    <% } %>
                  </td>
                  <td class="actions">
                    <a class="btn btn-primary btn-small" href="/doctor/orders/<%= o.id %>"><%= isAr ? 'ÿπÿ±ÿ∂ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'View case' %></a>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr><td colspan="6" class="empty"><%= isAr ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿßŸÑÿßÿ™ ŸÜÿ¥ÿ∑ÿ©.' : 'No active cases.' %></td></tr>
            <% } %>
            </tbody>
          </table>
        </div>

        <!-- New cases in specialty -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><%= isAr ? 'ÿ≠ÿßŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© (ÿ∫Ÿäÿ± ŸÖÿÆÿµÿµÿ©)' : 'New Cases (Unassigned)' %></div>
          </div>
          <table>
            <thead>
              <tr>
                <th><%= isAr ? 'ÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case ID' %></th>
                <th><%= isAr ? 'ŸÜŸàÿπ ÿßŸÑŸÅÿ≠ÿµ' : 'Service' %></th>
                <th><%= isAr ? 'ÿ≤ŸÖŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©' : 'SLA' %></th>
                <th><%= isAr ? 'ÿ•ÿ¨ÿ±ÿßÿ°' : 'Action' %></th>
              </tr>
            </thead>
            <tbody>
            <% if (unassignedOrders && unassignedOrders.length > 0) { %>
              <% unassignedOrders.forEach(function(o) { %>
                <tr>
                  <td><small><%= o.id %></small></td>
                  <td>
                    <div><%= o.service_name || '-' %></div>
                    <div class="muted" style="font-size:11px;"><%= o.specialty_name || '' %></div>
                  </td>
                <td>
                  <span class="sla-badge">
                    <%= isAr ? (o.sla_hours + ' ÿ≥ÿßÿπÿ© ÿ≤ŸÖŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©') : (o.sla_hours + 'h SLA') %>
                  </span>
                </td>
                <td>
                  <form method="post" action="/doctor/orders/<%= o.id %>/accept">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <button class="btn btn-primary btn-small" type="submit"><%= isAr ? 'ŸÇÿ®ŸàŸÑ' : 'Accept' %></button>
                  </form>
                </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr><td colspan="4" class="empty"><%= isAr ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿßŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖÿ™ÿßÿ≠ÿ©.' : 'No new cases available.' %></td></tr>
            <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><%= isAr ? 'ÿ≠ÿßŸÑÿßÿ™ ŸÖŸÉÿ™ŸÖŸÑÿ© / ŸÖÿ™ÿ£ÿÆÿ±ÿ©' : 'Completed / Breached' %></div>
        </div>
        <table>
          <thead>
            <tr>
              <th><%= isAr ? 'ÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case ID' %></th>
              <th><%= isAr ? 'ŸÜŸàÿπ ÿßŸÑŸÅÿ≠ÿµ' : 'Service' %></th>
              <th><%= isAr ? 'ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Status' %></th>
              <th><%= isAr ? 'ŸàŸÇÿ™ ÿßŸÑÿ•ÿ™ŸÖÿßŸÖ' : 'Completed at' %></th>
              <th><%= isAr ? 'ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™' : 'Actions' %></th>
            </tr>
          </thead>
          <tbody>
          <% if (closedOrders && closedOrders.length) { %>
            <% closedOrders.forEach(function(o){ %>
              <tr>
                <td><small><%= o.id %></small></td>
                <td>
                  <div><%= o.service_name || '-' %></div>
                  <div class="muted" style="font-size:11px;"><%= o.specialty_name || '' %></div>
                </td>
                <% var effClosed = o.effectiveStatus || o.status; %>
                <td><span class="status-chip <%= effClosed === 'breached' ? 'breached' : 'completed' %>"><%= statusLabel(effClosed) %></span></td>
                <td><%= o.completed_at || o.updated_at || '‚Äî' %></td>
                <td><a class="btn btn-outline btn-small" href="/doctor/orders/<%= o.id %>"><%= isAr ? 'ÿπÿ±ÿ∂ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'View case' %></a></td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr><td colspan="5" class="empty"><%= isAr ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿßŸÑÿßÿ™ ŸÖŸÉÿ™ŸÖŸÑÿ© ÿ£Ÿà ŸÖÿ™ÿ£ÿÆÿ±ÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ.' : 'No completed or breached cases yet.' %></td></tr>
          <% } %>
          </tbody>
        </table>
      </div>
      </div>
      </div>
      </div>
    </main>
  </div>
</body>
</html>
