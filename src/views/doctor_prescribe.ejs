<%- include('partials/header', { title: pageTitle || "Upload Prescription", layout: "portal", showNav: false }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _order = (typeof order !== 'undefined') ? order : {};
  var _existingId = (typeof existingPrescriptionId !== 'undefined') ? existingPrescriptionId : null;
%>

<link rel="stylesheet" href="/css/portal-variables.css">
<link rel="stylesheet" href="/css/portal-components.css">

<style>
  .rx-container { max-width: 700px; margin: 0 auto; padding: 1.5rem 1rem; }
  .rx-header { margin-bottom: 1.5rem; }
  .rx-header h2 { margin: 0; font-size: 1.4rem; color: #1a365d; }
  .rx-header p { color: #64748b; margin: 0.25rem 0 0; font-size: 0.85rem; }
  .rx-hint { color: #64748b; font-size: 0.82rem; margin-top: 0.25rem; }
  .form-group { margin-bottom: 1.25rem; }
  .form-group label { display: block; font-weight: 600; font-size: 0.85rem; color: #334155; margin-bottom: 0.35rem; }
  .form-group input[type="file"],
  .form-group textarea {
    width: 100%; padding: 0.6rem 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px;
    font-size: 0.88rem; color: #1e293b; background: #fff; box-sizing: border-box;
  }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .rx-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
  .btn-rx { padding: 0.65rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; border: none; cursor: pointer; text-decoration: none; display: inline-block; }
  .btn-rx-primary { background: #38b2ac; color: #fff; }
  .btn-rx-secondary { background: #fff; color: #64748b; border: 1px solid #e2e8f0; }
  .rx-alert { padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; }
  .rx-alert.success { background: #e9f7ef; color: #065f46; }
  .rx-alert.error { background: #fef2f2; color: #991b1b; }
</style>

<div class="rx-container">
  <div class="rx-header">
    <h2><%= _isAr ? 'رفع وصفة طبية' : 'Upload Prescription' %></h2>
    <p><%= _isAr ? 'اكتب الوصفة على ورق المستشفى ثم ارفع صورة أو ملف PDF' : 'Write the prescription on hospital letterhead, then upload a photo or PDF' %></p>
    <p class="rx-hint"><%= _isAr ? 'المريض: ' : 'Patient: ' %><strong><%= _order.patient_name || '-' %></strong> &middot; <%= _isAr ? 'الحالة: ' : 'Case: ' %><%= _order.id ? _order.id.slice(0, 8) : '' %></p>
  </div>

  <% if (_existingId) { %>
    <div class="rx-alert success"><%= _isAr ? 'توجد وصفة طبية لهذه الحالة بالفعل.' : 'A prescription already exists for this case.' %> <a href="/portal/patient/prescription/<%= _existingId %>"><%= _isAr ? 'عرض' : 'View' %></a></div>
  <% } %>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="rx-alert error"><%= error %></div>
  <% } %>

  <form action="/portal/doctor/case/<%= _order.id %>/prescribe" method="POST" enctype="multipart/form-data">
    <%- (typeof csrfField === 'function') ? csrfField() : '' %>

    <div class="form-group">
      <label><%= _isAr ? 'ملف الوصفة (صورة أو PDF)' : 'Prescription file (image or PDF)' %></label>
      <input type="file" name="prescription_file" accept="image/*,.pdf" required />
      <p class="rx-hint"><%= _isAr ? 'JPG, PNG, أو PDF — حد أقصى 10 ميجابايت' : 'JPG, PNG, or PDF — max 10MB' %></p>
    </div>

    <div class="form-group">
      <label><%= _isAr ? 'ملاحظات للمريض (اختياري)' : 'Notes for patient (optional)' %></label>
      <textarea name="notes" rows="3" placeholder="<%= _isAr ? 'أي تعليمات إضافية...' : 'Any additional instructions...' %>"></textarea>
    </div>

    <div class="rx-actions">
      <a href="/portal/doctor/case/<%= _order.id %>" class="btn-rx btn-rx-secondary"><%= _isAr ? 'إلغاء' : 'Cancel' %></a>
      <button type="submit" class="btn-rx btn-rx-primary"><%= _isAr ? 'رفع الوصفة' : 'Upload Prescription' %></button>
    </div>
  </form>
</div>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
