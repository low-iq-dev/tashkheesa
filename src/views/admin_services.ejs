<%- include('partials/header', { title: "Services", layout: "portal", showNav: false, portalFrame: true, portalRole: (typeof portalRole !== 'undefined' ? portalRole : 'superadmin'), portalActive: 'services' }) %>
      <div class="admin-page">
          <div class="admin-page-header">
            <div class="admin-page-header-left">
              <nav class="admin-breadcrumb">
                <a href="/admin">Dashboard</a>
                <span class="admin-breadcrumb-sep">&rsaquo;</span>
                <span>Services</span>
              </nav>
              <h1 class="admin-page-title">Services</h1>
              <p class="admin-page-subtitle">Manage service catalog</p>
            </div>
            <div class="admin-page-header-right">
              <a class="admin-btn admin-btn-primary" href="/admin/services/new">+ New service</a>
            </div>
          </div>

          <div class="card">
            <form class="admin-filters" method="GET" action="/admin/services">
              <div class="admin-filter-group">
                <label for="country" class="filter-label">Country</label>
                <select name="country" id="country" class="filter-select">
                  <option value="AE" <%= selectedCountry === 'AE' ? 'selected' : '' %>>AE</option>
                  <option value="SA" <%= selectedCountry === 'SA' ? 'selected' : '' %>>SA</option>
                  <option value="KW" <%= selectedCountry === 'KW' ? 'selected' : '' %>>KW</option>
                  <option value="QA" <%= selectedCountry === 'QA' ? 'selected' : '' %>>QA</option>
                  <option value="BH" <%= selectedCountry === 'BH' ? 'selected' : '' %>>BH</option>
                  <option value="OM" <%= selectedCountry === 'OM' ? 'selected' : '' %>>OM</option>
                  <option value="GB" <%= selectedCountry === 'GB' ? 'selected' : '' %>>GB</option>
                </select>
              </div>
              <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Apply</button>
              </div>
            </form>
            <div class="admin-table-wrap">
              <div class="admin-table-header">
                <h3 class="admin-table-title">Service Catalog</h3>
              </div>
              <div class="table-responsive">
              <table class="admin-table">
                <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Specialty</th>
                  <th>Visibility</th>
                  <th class="align-right">Base Price</th>
                  <th class="align-right">Doctor Fee</th>
                  <th>Cases</th>
                  <th class="align-right">Revenue</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% (services || []).forEach(function(sv){ %>
                  <%
                    const pricingByCountry = {};
                    (serviceCountryPricing || [])
                      .filter(p => p.service_id === sv.id)
                      .forEach(p => { pricingByCountry[p.country_code] = p; });
                    const selRow = pricingByCountry[selectedCountry];
                  %>
                  <tr>
                    <td><%= sv.code || '—' %></td>
                    <td class="cell-bold"><%= sv.name %></td>
                    <td><%= sv.specialty_name || '—' %></td>
                    <td>
                      <% const isVisible = (sv.is_visible == null ? 1 : Number(sv.is_visible)) === 1; %>
                      <% if (isVisible) { %>
                        <span class="status-pill status-pill--completed">Visible</span>
                      <% } else { %>
                        <span class="status-pill status-pill--breached">Hidden</span>
                      <% } %>
                    </td>
                    <td class="align-right">
                      <%= selRow ? Number(selRow.price).toLocaleString() : (sv.base_price != null ? Number(sv.base_price).toLocaleString() : '—') %>
                      <span class="cell-muted"><%= selRow ? selRow.currency : (sv.currency || '') %></span>
                    </td>
                    <td class="align-right">
                      <% if (sv.doctor_fee != null) { %>
                        <%= Number(sv.doctor_fee).toLocaleString() %>
                      <% } else { %>
                        <span class="cell-muted">—</span>
                      <% } %>
                    </td>
                    <td><%= sv.cases_count || 0 %></td>
                    <td class="align-right">
                      <% if (sv.service_revenue && Number(sv.service_revenue) > 0) { %>
                        <span class="cell-bold"><%= Number(sv.service_revenue).toLocaleString() %></span>
                      <% } else { %>
                        <span class="cell-muted">—</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="admin-page-header-right">
                        <a class="btn btn-outline btn-small" href="/admin/services/<%= sv.id %>/edit">Edit</a>
                        <form method="post" action="/admin/services/<%= sv.id %>/toggle-visibility" style="margin:0;">
                          <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                          <button class="btn btn-outline btn-small" type="submit"><%= isVisible ? 'Hide' : 'Show' %></button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }); %>
                <% if (!services || !services.length) { %>
                  <tr><td colspan="9" class="empty">No services yet.</td></tr>
                <% } %>
              </tbody>
              </table>
              </div>
            </div>
          </div>
      </div>
<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
