<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "وصفاتي الطبية" : "My Prescriptions"), layout: "portal", showNav: false }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var isAr = (typeof isAr !== 'undefined') ? isAr : (String(_lang).toLowerCase() === 'ar');
  var brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  var _prescriptions = (typeof prescriptions !== 'undefined' && Array.isArray(prescriptions)) ? prescriptions : [];

  function fmtDate(iso) {
    if (!iso) return '';
    try {
      var d = new Date(iso);
      if (isNaN(d.getTime())) return String(iso);
      return d.toLocaleDateString(_lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (e) { return String(iso); }
  }

  function isExpired(validUntil) {
    if (!validUntil) return false;
    try { return new Date(validUntil) < new Date(); } catch (e) { return false; }
  }

  function countMeds(medsJson) {
    try { return JSON.parse(medsJson || '[]').length; } catch (_) { return 0; }
  }
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= isAr ? 'بوابة المريض' : 'Patient Portal' %></span>
    </div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'prescriptions', isAr: isAr, user: (typeof user !== 'undefined' ? user : {}) }) %>
    <main class="portal-content">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= isAr ? 'وصفاتي الطبية' : 'My Prescriptions' %></h1>
        <p class="portal-hero-subtitle"><%= isAr ? 'جميع الوصفات الطبية الصادرة لك.' : 'All prescriptions issued by your doctors.' %></p>
      </div>

      <% if (_prescriptions.length === 0) { %>
        <div class="flow-card" style="text-align:center;padding:3rem 1.5rem;">
          <div style="margin-bottom:1rem;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--p1-text3)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.5 1.5H8A6.5 6.5 0 001.5 8v0A6.5 6.5 0 008 14.5h0a6.5 6.5 0 006.5-6.5V5.5"/>
              <path d="M13.5 22.5H16A6.5 6.5 0 0022.5 16v0A6.5 6.5 0 0016 9.5h0A6.5 6.5 0 009.5 16v2.5"/>
            </svg>
          </div>
          <h3 style="color:var(--p1-text2);margin:0 0 0.25rem;"><%= isAr ? 'لا توجد وصفات طبية' : 'No Prescriptions Yet' %></h3>
          <p style="color:var(--p1-text3);margin:0;font-size:0.85rem;"><%= isAr ? 'ستظهر الوصفات الطبية هنا بعد إصدارها من طبيبك.' : 'Prescriptions from your doctors will appear here.' %></p>
        </div>
      <% } else { %>
        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:0.75rem;">
          <% _prescriptions.forEach(function(rx) {
            var expired = isExpired(rx.valid_until);
            var medCount = countMeds(rx.medications);
          %>
            <div class="flow-card">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">
                <div>
                  <h3 style="margin:0 0 0.15rem;"><%= isAr ? 'د. ' : 'Dr. ' %><%= rx.doctor_name || '-' %></h3>
                  <% if (rx.specialty_name) { %>
                    <p style="margin:0;font-size:0.78rem;color:var(--p1-text3);"><%= rx.specialty_name %></p>
                  <% } %>
                </div>
                <span style="font-size:0.78rem;color:var(--p1-text3);flex-shrink:0;"><%= fmtDate(rx.created_at) %></span>
              </div>

              <div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:0.75rem;font-size:0.82rem;color:var(--p1-text2);">
                <span><%= medCount %> <%= isAr ? 'أدوية' : 'medications' %></span>
                <% if (rx.valid_until) { %>
                  <span><%= isAr ? 'صالحة حتى: ' : 'Valid until: ' %><%= fmtDate(rx.valid_until) %></span>
                <% } %>
                <span class="status-badge <%= expired ? 'status-breached' : 'status-completed' %>">
                  <%= expired ? (isAr ? 'منتهية' : 'Expired') : (isAr ? 'نشطة' : 'Active') %>
                </span>
              </div>

              <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                <a href="/portal/patient/prescription/<%= rx.id %>" class="p-btn p-btn-secondary p-btn-sm"><%= isAr ? 'عرض التفاصيل' : 'View Details' %></a>
                <% if (rx.pdf_url) { %>
                  <a href="/portal/patient/prescription/<%= rx.id %>/download" class="p-btn p-btn-primary p-btn-sm"><%= isAr ? 'تحميل PDF' : 'Download PDF' %></a>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
