<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "مراجعة الطلب" : "Review Order"), layout: "public", showNav: false }) %>
<%
  const isAr = (typeof lang !== 'undefined' && lang === 'ar') || (typeof dir !== 'undefined' && dir === 'rtl') || (typeof locals !== 'undefined' && locals && !!locals.isAr);
  const tr = function(enText, arText) { return isAr ? arText : enText; };

  function getPathBasename(value) {
    const raw = String(value || '').trim();
    if (!raw) return '';
    const withoutQuery = raw.split('?')[0].split('#')[0];
    const parts = withoutQuery.split('/').filter(Boolean);
    return parts.length ? parts[parts.length - 1] : withoutQuery;
  }

  function getDisplayFilename(item) {
    if (typeof item === 'string') {
      return getPathBasename(item) || tr('File', 'ملف');
    }

    if (item && typeof item === 'object') {
      const preferred = [item.name, item.filename, item.originalname].find(
        (candidate) => String(candidate || '').trim() !== ''
      );
      if (preferred) return String(preferred).trim();

      const fromUrl = getPathBasename(item.url);
      if (fromUrl) return fromUrl;
    }

    return tr('File', 'ملف');
  }
%>
  <div class="page-shell">
    <main>
      <div class="page-heading">
        <div>
          <h1><%= isAr ? 'مراجعة وتأكيد' : 'Review &amp; confirm' %></h1>
          <p><%= isAr ? 'راجع الملفات، درجة الاستعجال، واللغة قبل الانتقال إلى الدفع.' : 'Double-check the files, turnaround time, and language before moving toward payment.' %></p>
        </div>
      </div>

      <div class="flow-card primary">
        <h2 class="flow-title"><%= isAr ? 'ملخص الطلب' : 'Order summary' %></h2>

        <div class="flow-grid">
          <div class="flow-column">
            <div class="flow-section">
              <h3><%= isAr ? 'الملفات المرفوعة' : 'Uploaded files' %></h3>
              <% if (files && files.length) { %>
                <ul class="flow-list">
                  <% files.forEach(function (file) { %>
                    <li class="flow-list-item">
                      <span class="file-name"><%= getDisplayFilename(file) %></span>
                    </li>
                  <% }); %>
                </ul>
              <% } else { %>
                <p class="flow-note"><%= isAr ? 'لم يتم رفع ملفات بعد.' : 'No files uploaded yet.' %></p>
              <% } %>

              <% var _aiWarnings = (typeof aiWarnings !== 'undefined' && Array.isArray(aiWarnings)) ? aiWarnings : []; %>
              <% if (_aiWarnings.length > 0) { %>
                <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:0.75rem 1rem;margin-top:0.75rem;">
                  <strong style="color:#92400e;font-size:0.85rem;"><%= isAr ? 'تحذير جودة الصورة' : 'Image Quality Warning' %></strong>
                  <% _aiWarnings.forEach(function(w) { %>
                    <div style="margin-top:0.5rem;font-size:0.82rem;color:#78350f;">
                      <strong>"<%= w.file %>"</strong> — <%= isAr ? 'الجودة:' : 'Quality:' %> <%= w.quality %>
                      <% if (w.issues && w.issues.length) { %>
                        <br><%= isAr ? 'المشاكل:' : 'Issues:' %> <%= w.issues.join(', ') %>
                      <% } %>
                      <% if (w.recommendation) { %>
                        <br><%= isAr ? 'التوصية:' : 'Recommendation:' %> <%= w.recommendation %>
                      <% } %>
                    </div>
                  <% }); %>
                </div>
              <% } %>
            </div>

            <div class="flow-section">
              <h3><%= isAr ? 'السياق السريري' : 'Clinical context' %></h3>
              <p class="flow-note">
                <strong><%= isAr ? 'السبب:' : 'Reason:' %></strong>
                <%= reason || (isAr ? 'غير محدد' : 'Not provided') %>
              </p>
              
              <p class="flow-note">
                <strong><%= isAr ? 'اللغة:' : 'Language:' %></strong>
                <%= language %>
              </p>
            </div>
            <div class="flow-section">
  <h3><%= isAr ? 'بيانات المريض' : 'Patient details' %></h3>
  <p class="flow-note">
    <strong><%= isAr ? 'الاسم:' : 'Name:' %></strong>
    <%= patient_name || (isAr ? 'غير متوفر' : 'Not provided') %>
  </p>
  <p class="flow-note">
    <strong><%= isAr ? 'البريد الإلكتروني:' : 'Email:' %></strong>
    <%= patient_email || (isAr ? 'غير متوفر' : 'Not provided') %>
  </p>
  <p class="flow-note">
    <strong><%= isAr ? 'رقم الهاتف:' : 'Phone:' %></strong>
    <%= patient_phone || (isAr ? 'غير متوفر' : 'Not provided') %>
  </p>
</div>
          </div>

          <div class="flow-column">
            <div class="flow-card soft">
              <h3><%= isAr ? 'مدة التسليم' : 'Turnaround time' %></h3>
              <p class="flow-note">
                <%= isAr
                  ? 'سيتم تسليم تقرير مكتوب من اختصاصي خلال مدة SLA المحددة.'
                  : 'You will receive a written specialist report within the selected SLA window.' %>
              </p>
              <ul class="flow-list">
                <li class="<%= sla_hours === 72 ? 'highlight' : '' %>">
                  <strong><%= isAr ? 'عادي' : 'Standard' %></strong> — <%= isAr ? '٧٢ ساعة' : '72 hours' %>
                </li>
                <li class="<%= sla_hours === 24 ? 'highlight' : '' %>">
                  <strong><%= isAr ? 'أولوية' : 'Priority' %></strong> — <%= isAr ? '٢٤ ساعة' : '24 hours' %>
                </li>
              </ul>
            </div>

            <div class="flow-card primary">
              <h3><%= isAr ? 'الخطوة التالية' : 'Next step' %></h3>
              <p class="flow-note">
                <%= isAr
                  ? 'سيتم تحويلك الآن إلى صفحة الدفع لإكمال الطلب.'
                  : 'You will now be redirected to payment to complete your request.' %>
              </p>

              <form method="post" action="/order/<%= sessionToken %>/payment">
                <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                <input type="hidden" name="sla_hours" value="<%= sla_hours %>" />
                <input type="hidden" name="sla_choice" value="<%= urgency === 'priority' ? 'priority' : 'standard' %>" />
                <input type="hidden" name="file_names" value="<%= files.map(function (f) { return getDisplayFilename(f); }).join('|') %>" />
                <input type="hidden" name="reason" value="<%= reason %>" />
                <input type="hidden" name="language" value="<%= language %>" />

                <div class="section-cta">
                  <a href="/order/<%= sessionToken %>/upload" class="btn btn-secondary">
                    <%= isAr ? 'رجوع' : 'Back' %>
                  </a>
                  <button type="submit" class="btn btn-primary btn-full">
                    <%= isAr ? 'الانتقال إلى الدفع' : 'Proceed to payment' %>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
<%- include('partials/footer', { showFooter: false }) %>
