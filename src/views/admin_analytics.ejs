<%- include('partials/header', {
  title: "Analytics Dashboard",
  layout: "portal",
  showNav: false,
  portalFrame: true,
  portalActive: 'analytics',
  portalRole: (user && user.role === 'superadmin') ? 'superadmin' : 'admin'
}) %>
<%
  const lang = (locals.lang) || 'en';
  const isAr = lang === 'ar';
  const kpis = locals.kpis || {};
  const charts = locals.charts || {};
  const period = locals.period || '30d';
  const errorMsg = locals.error || null;
  const attn = locals.attention || {};

  function fmtNum(n) {
    return typeof n === 'number' ? n.toLocaleString() : (n || '0');
  }
  function fmtMoney(n) {
    return typeof n === 'number' ? n.toLocaleString(undefined, { minimumFractionDigits: 0 }) : '0';
  }
  function changeClass(v) {
    if (!v || v === 0) return 'flat';
    return v > 0 ? 'up' : 'down';
  }
  function changeIcon(v) {
    if (!v || v === 0) return '—';
    return v > 0 ? ('↑ ' + v + '%') : ('↓ ' + Math.abs(v) + '%');
  }
%>

<style>
/* Attention banners */
.attention-banner { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
.attention-item {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px; border-radius: 8px;
  font-size: 13px; text-decoration: none; color: inherit;
  transition: all 0.2s;
}
.attention-danger { background: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; }
.attention-warning { background: #fffbeb; border: 1px solid #fcd34d; color: #d97706; }
.attention-muted { background: #f3f4f6; border: 1px solid #d1d5db; color: #6b7280; }
.attention-item:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

/* KPI clickable cards */
a.kpi-card-link { display: block; text-decoration: none; color: inherit; transition: transform 0.2s, box-shadow 0.2s; border-radius: 12px; }
a.kpi-card-link:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }

/* Chart empty states */
.chart-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; color: var(--text-muted, #94a3b8); gap: 8px; }
.chart-empty p { margin: 0; font-size: 14px; font-weight: 500; }
.chart-empty span { font-size: 12px; }

/* Chart card styling */
.chart-card { border-radius: 12px; border: 1px solid var(--owner-border-light, #e5e7eb); }
.chart-card-title { font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 16px; }
</style>

<div class="admin-page">
  <div class="admin-page-header">
    <div class="admin-page-header-left">
      <nav class="admin-breadcrumb">
        <a href="/admin">Dashboard</a>
        <span class="admin-breadcrumb-sep">›</span>
        <span>Analytics</span>
      </nav>
      <h1 class="admin-page-title"><%= isAr ? 'لوحة التحليلات' : 'Analytics Dashboard' %></h1>
      <p class="admin-page-subtitle"><%= isAr ? 'مؤشرات الأداء والرؤى الرئيسية' : 'Performance metrics and business insights' %></p>
    </div>
    <div class="admin-page-header-right">
    </div>
  </div>

<% if (errorMsg) { %>
  <div class="p-alert p-alert-warning" style="margin-bottom:16px;">
    <div class="p-alert-content"><%= errorMsg %></div>
  </div>
<% } %>

<!-- Period Selector -->
<div class="period-selector">
  <a href="?period=7d" class="period-btn <%= period === '7d' ? 'active' : '' %>"><%= isAr ? '7 أيام' : '7 Days' %></a>
  <a href="?period=30d" class="period-btn <%= period === '30d' ? 'active' : '' %>"><%= isAr ? '30 يوم' : '30 Days' %></a>
  <a href="?period=90d" class="period-btn <%= period === '90d' ? 'active' : '' %>"><%= isAr ? '90 يوم' : '90 Days' %></a>
  <a href="?period=12m" class="period-btn <%= period === '12m' ? 'active' : '' %>"><%= isAr ? '12 شهر' : '12 Months' %></a>
  <span class="admin-page-header-right" style="margin-left:auto;">
    <a href="/api/analytics/export?period=<%= period %>&type=cases" class="period-btn"><%= isAr ? 'حالات CSV' : 'Cases CSV' %></a>
    <a href="/api/analytics/export?period=<%= period %>&type=revenue" class="period-btn"><%= isAr ? 'إيرادات CSV' : 'Revenue CSV' %></a>
    <a href="/api/analytics/export?period=<%= period %>&type=doctors" class="period-btn"><%= isAr ? 'أطباء CSV' : 'Doctors CSV' %></a>
  </span>
</div>

<!-- 1C: Needs Attention Banner -->
<% if ((attn.breached || 0) > 0 || (attn.unpaid || 0) > 0 || (attn.expired || 0) > 0) { %>
<div class="attention-banner">
  <% if (attn.breached > 0) { %>
    <a href="/admin/orders?status=breached" class="attention-item attention-danger">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span><strong><%= attn.breached %></strong> <%= isAr ? 'انتهاكات SLA' : 'SLA Breaches' %></span>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </a>
  <% } %>
  <% if (attn.unpaid > 0) { %>
    <a href="/admin/orders?payment=unpaid" class="attention-item attention-warning">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      <span><strong><%= attn.unpaid %></strong> <%= isAr ? 'غير مدفوعة' : 'Unpaid Orders' %></span>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </a>
  <% } %>
  <% if (attn.expired > 0) { %>
    <a href="/admin/orders?status=expired_unpaid" class="attention-item attention-muted">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span><strong><%= attn.expired %></strong> <%= isAr ? 'منتهية الصلاحية' : 'Expired Unpaid' %></span>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </a>
  <% } %>
</div>
<% } %>

<!-- KPI Cards Row 1 (1B: Clickable) -->
<div class="admin-kpi-grid">
  <a href="/admin/orders" class="kpi-card-link">
    <div class="kpi-card">
      <p class="kpi-label"><%= isAr ? 'إجمالي الحالات' : 'Total Cases' %></p>
      <p class="kpi-value"><%= fmtNum(kpis.totalCases) %></p>
      <p class="kpi-change <%= changeClass(kpis.casesChange) %>"><%= changeIcon(kpis.casesChange) %></p>
    </div>
  </a>
  <a href="/admin/orders?status=paid" class="kpi-card-link">
    <div class="kpi-card kpi-success">
      <p class="kpi-label"><%= isAr ? 'إجمالي الإيرادات' : 'Total Revenue' %></p>
      <p class="kpi-value"><%= fmtMoney(kpis.totalRevenue) %> <small>EGP</small></p>
      <p class="kpi-change <%= changeClass(kpis.revenueChange) %>"><%= changeIcon(kpis.revenueChange) %></p>
    </div>
  </a>
  <div class="kpi-card kpi-teal">
    <p class="kpi-label"><%= isAr ? 'متوسط قيمة الحالة' : 'Avg Case Value' %></p>
    <p class="kpi-value"><%= fmtMoney(kpis.avgCaseValue) %> <small>EGP</small></p>
  </div>
  <a href="/superadmin/doctors" class="kpi-card-link">
    <div class="kpi-card kpi-purple">
      <p class="kpi-label"><%= isAr ? 'المستخدمون الجدد' : 'New Users' %></p>
      <p class="kpi-value"><%= fmtNum(kpis.totalUsers) %></p>
      <p class="kpi-change <%= changeClass(kpis.usersChange) %>"><%= changeIcon(kpis.usersChange) %></p>
    </div>
  </a>
</div>

<!-- KPI Cards Row 2 (1B: Clickable) -->
<div class="admin-kpi-grid">
  <a href="/admin/orders?status=completed" class="kpi-card-link">
    <div class="kpi-card kpi-success">
      <p class="kpi-label"><%= isAr ? 'الحالات المكتملة' : 'Completed Cases' %></p>
      <p class="kpi-value"><%= fmtNum(kpis.completedCases) %></p>
    </div>
  </a>
  <a href="/superadmin/doctors" class="kpi-card-link">
    <div class="kpi-card">
      <p class="kpi-label"><%= isAr ? 'الأطباء النشطون' : 'Active Doctors' %></p>
      <p class="kpi-value"><%= fmtNum(kpis.activeDoctors) %></p>
    </div>
  </a>
  <a href="/admin/orders?status=breached" class="kpi-card-link">
    <div class="kpi-card <%= (kpis.slaCompliance || 0) >= 95 ? 'kpi-success' : ((kpis.slaCompliance || 0) >= 80 ? 'kpi-warning' : 'kpi-danger') %>">
      <p class="kpi-label"><%= isAr ? 'التزام SLA' : 'SLA Compliance' %></p>
      <p class="kpi-value"><%= kpis.slaCompliance || 0 %>%</p>
      <div class="sla-bar" style="margin-top:6px;">
        <div class="sla-bar-fill <%= (kpis.slaCompliance || 0) >= 95 ? 'sla-good' : ((kpis.slaCompliance || 0) >= 80 ? 'sla-warn' : 'sla-danger') %>" style="width:<%= Math.min(100, kpis.slaCompliance || 0) %>%;"></div>
      </div>
    </div>
  </a>
  <div class="kpi-card kpi-teal">
    <p class="kpi-label"><%= isAr ? 'متوسط وقت الإنجاز' : 'Avg Turnaround' %></p>
    <p class="kpi-value"><%= kpis.avgTatHours || 0 %> <small><%= isAr ? 'ساعة' : 'hrs' %></small></p>
  </div>
</div>

<!-- Charts Row 1 -->
<div class="admin-charts-row">
  <!-- Revenue Trend -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'اتجاه الإيرادات' : 'Revenue Trend' %></h3>
    <canvas id="revenueTrendChart" style="max-height:280px;"></canvas>
    <div id="revenueTrendEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
      <p><%= isAr ? 'لا توجد بيانات إيرادات' : 'No revenue data yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند اكتمال الطلبات' : 'Data will appear once orders are completed' %></span>
    </div>
  </div>

  <!-- Revenue by Service -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'الإيرادات حسب الخدمة' : 'Revenue by Service' %></h3>
    <canvas id="revenueByServiceChart" style="max-height:280px;"></canvas>
    <div id="revenueByServiceEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 10 10"/><path d="M12 12L12 2"/><path d="M12 12l7.07 7.07"/></svg>
      <p><%= isAr ? 'لا توجد بيانات خدمات' : 'No service data yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند اكتمال الطلبات' : 'Data will appear once orders are completed' %></span>
    </div>
  </div>
</div>

<!-- Charts Row 2 -->
<div class="admin-charts-row">
  <!-- Cases by Status -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'الحالات حسب الحالة' : 'Cases by Status' %></h3>
    <canvas id="casesByStatusChart" style="max-height:280px;"></canvas>
    <div id="casesByStatusEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
      <p><%= isAr ? 'لا توجد حالات' : 'No cases yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند إنشاء الحالات' : 'Data will appear once cases are created' %></span>
    </div>
  </div>

  <!-- SLA Compliance Trend -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'اتجاه التزام SLA' : 'SLA Compliance Trend' %></h3>
    <canvas id="slaTrendChart" style="max-height:280px;"></canvas>
    <div id="slaTrendEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      <p><%= isAr ? 'لا توجد بيانات SLA' : 'No SLA data yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند اكتمال الحالات' : 'Data will appear once cases are completed' %></span>
    </div>
  </div>
</div>

<!-- Charts Row 3 -->
<div class="admin-charts-row">
  <!-- Payment Methods -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'طرق الدفع' : 'Payment Methods' %></h3>
    <canvas id="paymentMethodsChart" style="max-height:280px;"></canvas>
    <div id="paymentMethodsEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      <p><%= isAr ? 'لا توجد بيانات دفع' : 'No payment data yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند إتمام المدفوعات' : 'Data will appear once payments are processed' %></span>
    </div>
  </div>

  <!-- Doctor Workload -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'توزيع عبء العمل' : 'Doctor Workload' %></h3>
    <canvas id="doctorWorkloadChart" style="max-height:280px;"></canvas>
    <div id="doctorWorkloadEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      <p><%= isAr ? 'لا توجد بيانات أطباء' : 'No workload data yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند تعيين الأطباء' : 'Data will appear once doctors are assigned' %></span>
    </div>
  </div>
</div>

<!-- Charts Row 4 -->
<div class="admin-charts-row">
  <!-- Notifications -->
  <div class="chart-card">
    <h3 class="chart-card-title"><%= isAr ? 'الإشعارات المرسلة' : 'Notifications Sent' %></h3>
    <canvas id="notificationStatsChart" style="max-height:280px;"></canvas>
    <div id="notificationStatsEmpty" class="chart-empty" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--text-muted,#94a3b8);"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      <p><%= isAr ? 'لا توجد إشعارات' : 'No notifications yet' %></p>
      <span><%= isAr ? 'ستظهر البيانات عند إرسال الإشعارات' : 'Data will appear once notifications are sent' %></span>
    </div>
  </div>
  <div class="chart-card">
    <div class="admin-kpi" style="text-align:center; border:none; padding:2rem;">
      <div class="admin-kpi-value" style="font-size:48px;"><%= fmtNum(kpis.paidCases) %></div>
      <div class="admin-kpi-label"><%= isAr ? 'حالة مدفوعة' : 'Paid Cases' %></div>
      <div class="admin-kpi-value" style="font-size:32px; color:#10b981; margin-top:16px;"><%= fmtMoney(kpis.totalRevenue) %> <small>EGP</small></div>
      <div class="admin-kpi-label"><%= isAr ? 'إجمالي الإيرادات' : 'Total Revenue' %></div>
    </div>
  </div>
</div>

<!-- Top Doctors -->
<div class="admin-table-wrap">
  <div class="admin-table-header">
    <h3 class="admin-table-title"><%= isAr ? 'أفضل الأطباء' : 'Top Performing Doctors' %></h3>
    <a href="/api/analytics/export?period=<%= period %>&type=doctors" class="period-btn"><%= isAr ? 'تصدير' : 'Export' %></a>
  </div>
  <table class="admin-table">
    <thead>
      <tr>
        <th>#</th>
        <th><%= isAr ? 'الطبيب' : 'Doctor' %></th>
        <th><%= isAr ? 'التخصص' : 'Specialty' %></th>
        <th><%= isAr ? 'الحالات' : 'Cases' %></th>
        <th><%= isAr ? 'الإيرادات' : 'Revenue' %></th>
      </tr>
    </thead>
    <tbody>
      <% var docs = (charts.topDoctors || []); %>
      <% if (!docs.length) { %>
        <tr><td colspan="5" class="admin-empty"><%= isAr ? 'لا توجد بيانات' : 'No data available' %></td></tr>
      <% } else { %>
        <% docs.forEach(function(d, i) { %>
          <tr>
            <td><span class="doctor-rank <%= i < 3 ? 'rank-' + (i + 1) : '' %>"><%= i + 1 %></span></td>
            <td class="cell-bold"><%= d.name || 'Doctor' %></td>
            <td class="cell-muted"><%= d.specialty_name || '—' %></td>
            <td><%= d.cases || 0 %></td>
            <td class="cell-bold"><%= fmtMoney(d.revenue || 0) %> EGP</td>
          </tr>
        <% }); %>
      <% } %>
    </tbody>
  </table>
</div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
  var COLORS = ['#2563eb', '#14b8a6', '#f59e0b', '#ef4444', '#8b5cf6', '#10b981', '#ec4899', '#6366f1'];

  // Helper: show empty state, hide canvas
  function showEmpty(canvasId, emptyId) {
    var canvas = document.getElementById(canvasId);
    var empty = document.getElementById(emptyId);
    if (canvas) canvas.style.display = 'none';
    if (empty) empty.style.display = 'flex';
  }

  // Revenue Trend
  var revData = <%- JSON.stringify(charts.revenueTrend || []) %>;
  if (revData.length && document.getElementById('revenueTrendChart')) {
    new Chart(document.getElementById('revenueTrendChart'), {
      type: 'line',
      data: {
        labels: revData.map(function(r) { return r.month; }),
        datasets: [{
          label: '<%= isAr ? "الإيرادات" : "Revenue" %>',
          data: revData.map(function(r) { return r.revenue; }),
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 4
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  } else {
    showEmpty('revenueTrendChart', 'revenueTrendEmpty');
  }

  // Revenue by Service
  var svcData = <%- JSON.stringify(charts.revenueByService || []) %>;
  if (svcData.length && document.getElementById('revenueByServiceChart')) {
    new Chart(document.getElementById('revenueByServiceChart'), {
      type: 'doughnut',
      data: {
        labels: svcData.map(function(s) { return s.name; }),
        datasets: [{
          data: svcData.map(function(s) { return s.revenue; }),
          backgroundColor: COLORS.slice(0, svcData.length)
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'right' } } }
    });
  } else {
    showEmpty('revenueByServiceChart', 'revenueByServiceEmpty');
  }

  // Cases by Status
  var statusData = <%- JSON.stringify(charts.casesByStatus || []) %>;
  if (statusData.length && document.getElementById('casesByStatusChart')) {
    var statusColors = {
      'completed': '#10b981', 'done': '#10b981', 'delivered': '#10b981',
      'new': '#3b82f6', 'submitted': '#3b82f6',
      'assigned': '#8b5cf6', 'accepted': '#8b5cf6',
      'in_review': '#f59e0b',
      'breached': '#ef4444', 'breached_sla': '#ef4444',
      'cancelled': '#6b7280'
    };
    new Chart(document.getElementById('casesByStatusChart'), {
      type: 'bar',
      data: {
        labels: statusData.map(function(s) { return s.status; }),
        datasets: [{
          label: '<%= isAr ? "الحالات" : "Cases" %>',
          data: statusData.map(function(s) { return s.count; }),
          backgroundColor: statusData.map(function(s) { return statusColors[s.status] || '#94a3b8'; })
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  } else {
    showEmpty('casesByStatusChart', 'casesByStatusEmpty');
  }

  // SLA Compliance Trend
  var slaData = <%- JSON.stringify(charts.slaTrend || []) %>;
  if (slaData.length && document.getElementById('slaTrendChart')) {
    new Chart(document.getElementById('slaTrendChart'), {
      type: 'bar',
      data: {
        labels: slaData.map(function(s) { return s.date; }),
        datasets: [
          {
            label: '<%= isAr ? "في الوقت" : "On Time" %>',
            data: slaData.map(function(s) { return s.on_time || 0; }),
            backgroundColor: '#10b981'
          },
          {
            label: '<%= isAr ? "متأخر" : "Late" %>',
            data: slaData.map(function(s) { return (s.total || 0) - (s.on_time || 0); }),
            backgroundColor: '#ef4444'
          }
        ]
      },
      options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
    });
  } else {
    showEmpty('slaTrendChart', 'slaTrendEmpty');
  }

  // Payment Methods (pie)
  var pmData = <%- JSON.stringify(charts.paymentMethods || []) %>;
  if (pmData.length && document.getElementById('paymentMethodsChart')) {
    new Chart(document.getElementById('paymentMethodsChart'), {
      type: 'pie',
      data: {
        labels: pmData.map(function(p) { return p.method; }),
        datasets: [{
          data: pmData.map(function(p) { return p.count; }),
          backgroundColor: COLORS.slice(0, pmData.length)
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'right' } } }
    });
  } else {
    showEmpty('paymentMethodsChart', 'paymentMethodsEmpty');
  }

  // Doctor Workload (horizontal bar)
  var wlData = <%- JSON.stringify(charts.doctorWorkload || []) %>;
  if (wlData.length && document.getElementById('doctorWorkloadChart')) {
    new Chart(document.getElementById('doctorWorkloadChart'), {
      type: 'bar',
      data: {
        labels: wlData.map(function(d) { return d.name; }),
        datasets: [{
          label: '<%= isAr ? "الحالات" : "Cases" %>',
          data: wlData.map(function(d) { return d.cases; }),
          backgroundColor: '#14b8a6',
          borderRadius: 4
        }]
      },
      options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
    });
  } else {
    showEmpty('doctorWorkloadChart', 'doctorWorkloadEmpty');
  }

  // Notification Stats (grouped bar)
  var nData = <%- JSON.stringify(charts.notificationStats || []) %>;
  if (nData.length && document.getElementById('notificationStatsChart')) {
    // Group by channel
    var channels = {};
    nData.forEach(function(n) {
      if (!channels[n.channel]) channels[n.channel] = { sent: 0, failed: 0, queued: 0 };
      var s = String(n.status || '').toLowerCase();
      if (s === 'sent' || s === 'delivered') channels[n.channel].sent += n.count;
      else if (s === 'failed' || s === 'error') channels[n.channel].failed += n.count;
      else channels[n.channel].queued += n.count;
    });
    var chLabels = Object.keys(channels);
    new Chart(document.getElementById('notificationStatsChart'), {
      type: 'bar',
      data: {
        labels: chLabels,
        datasets: [
          { label: '<%= isAr ? "مرسل" : "Sent" %>', data: chLabels.map(function(c) { return channels[c].sent; }), backgroundColor: '#10b981', borderRadius: 4 },
          { label: '<%= isAr ? "فشل" : "Failed" %>', data: chLabels.map(function(c) { return channels[c].failed; }), backgroundColor: '#ef4444', borderRadius: 4 },
          { label: '<%= isAr ? "في الانتظار" : "Queued" %>', data: chLabels.map(function(c) { return channels[c].queued; }), backgroundColor: '#f59e0b', borderRadius: 4 }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  } else {
    showEmpty('notificationStatsChart', 'notificationStatsEmpty');
  }
})();
</script>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>