<%
  const lang = locals.lang || 'en';
  const isAr = String(lang).toLowerCase() === 'ar';
  const bucket = ['new', 'review'].includes(String(locals.bucket || '').toLowerCase())
    ? String(locals.bucket).toLowerCase()
    : 'review';

  const q = String(locals.q || '').trim();
  const page = Number(locals.page) > 0 ? Math.floor(Number(locals.page)) : 1;
  const limit = Number(locals.limit) > 0 ? Math.floor(Number(locals.limit)) : 20;
  const total = Number.isFinite(Number(locals.total)) ? Math.max(0, Math.floor(Number(locals.total))) : 0;
  const showingFrom = Number.isFinite(Number(locals.showingFrom)) ? Number(locals.showingFrom) : (total > 0 ? ((page - 1) * limit + 1) : 0);
  const showingTo = Number.isFinite(Number(locals.showingTo)) ? Number(locals.showingTo) : Math.min((page - 1) * limit + ((locals.cases || []).length || 0), total);
  const hasMore = Boolean(locals.hasMore);

  const newBucketTotal = Number.isFinite(Number(locals.newBucketTotal)) ? Math.max(0, Math.floor(Number(locals.newBucketTotal))) : 0;
  const reviewBucketTotal = Number.isFinite(Number(locals.reviewBucketTotal)) ? Math.max(0, Math.floor(Number(locals.reviewBucketTotal))) : 0;

  const cases = Array.isArray(locals.cases) ? locals.cases : [];

  function withParams(base, params) {
    const parts = [];
    Object.keys(params || {}).forEach((key) => {
      const value = params[key];
      if (value === undefined || value === null || value === '') return;
      parts.push(encodeURIComponent(key) + '=' + encodeURIComponent(String(value)));
    });
    return parts.length ? (base + '?' + parts.join('&')) : base;
  }

  function listHref(nextBucket, nextPage) {
    return withParams('/portal/doctor/queue', {
      bucket: nextBucket,
      q: q || undefined,
      page: nextPage > 1 ? nextPage : undefined,
      limit: limit !== 20 ? limit : undefined
    });
  }

  const reviewHref = listHref('review', 1);
  const newHref = listHref('new', 1);
  const prevHref = page > 1 ? listHref(bucket, page - 1) : '';
  const nextHref = hasMore ? listHref(bucket, page + 1) : '';

  function normalizeKey(v) {
    return String(v || '').trim().toLowerCase();
  }

  function pickSpecialtyKey(c) {
    return normalizeKey(
      (c && (c.specialty_key || c.specialtyKey)) ||
      (c && (c.specialty_name || c.specialtyName)) ||
      (c && (c.service_name || c.serviceName)) ||
      (c && (c.specialtyLabel || c.serviceLabel)) ||
      ''
    );
  }

  function lucideForSpecialty(key) {
    const k = normalizeKey(key);
    if (k.includes('radio')) return 'scan';
    if (k.includes('cardio')) return 'heart-pulse';
    if (k.includes('derma') || k.includes('skin')) return 'sparkles';
    if (k.includes('onco') || k.includes('cancer')) return 'activity';
    if (k.includes('path')) return 'flask-conical';
    if (k.includes('neuro')) return 'brain';
    if (k.includes('ortho') || k.includes('bone')) return 'bone';
    if (k.includes('pedia') || k.includes('child')) return 'baby';
    if (k.includes('ent')) return 'ear';
    if (k.includes('oph') || k.includes('eye')) return 'eye';
    return 'briefcase-medical';
  }

  function fallbackGlyphForSpecialty(key) {
    const k = normalizeKey(key);
    if (k.includes('radio')) return 'R';
    if (k.includes('cardio')) return 'C';
    if (k.includes('derma') || k.includes('skin')) return 'D';
    if (k.includes('onco') || k.includes('cancer')) return 'O';
    if (k.includes('path')) return 'P';
    if (k.includes('neuro')) return 'N';
    if (k.includes('ortho') || k.includes('bone')) return 'Or';
    if (k.includes('pedia') || k.includes('child')) return 'Ped';
    if (k.includes('ent')) return 'ENT';
    if (k.includes('oph') || k.includes('eye')) return 'Eye';
    return 'Med';
  }

  function statusText(c) {
    if (bucket === 'review') {
      return isAr ? 'قيد المراجعة' : 'In review';
    }
    if (c && c.isPaid === false) {
      return isAr ? 'بانتظار الدفع' : 'Awaiting payment';
    }
    return isAr ? 'جاهزة' : 'Ready';
  }

  function pillVariant(c) {
    if (bucket === 'new' && c && c.isPaid === false) return 'orange';
    const k = normalizeKey(c && (c.status || c.db_status || c.statusLabel));
    if (k.includes('completed') || k === 'done') return 'green';
    if (k.includes('breach') || k.includes('overdue') || k.includes('late')) return 'red';
    if (k.includes('rejected_files') || k.includes('files') || k.includes('missing')) return 'orange';
    return 'blue';
  }
%>

<div class="portal-page portal-doctor-list portal-doctor-queue">
  <div class="portal-page-header">
    <div class="portal-page-titleblock">
      <div class="portal-page-kicker"><%= isAr ? 'بوابة الطبيب' : 'Doctor Portal' %></div>
      <h1 class="portal-page-title"><%= isAr ? 'قائمة الحالات' : 'Case Queue' %></h1>
      <p class="portal-page-subtitle"><%= isAr ? 'راجع الحالات حسب الدفعة أو حالة المراجعة، مع بحث سريع وترتيب زمني.' : 'Review assignments by payment/readiness and active review status with simple search and pagination.' %></p>
    </div>
  </div>

  <section class="portal-card">
    <div class="portal-filter-chips">
      <a class="portal-filter-chip <%= bucket === 'review' ? 'active' : '' %>" href="<%= reviewHref %>">
        <%= isAr ? `قيد المراجعة (${reviewBucketTotal})` : `In Review (${reviewBucketTotal})` %>
      </a>
      <a class="portal-filter-chip <%= bucket === 'new' ? 'active' : '' %>" href="<%= newHref %>">
        <%= isAr ? `تعيينات جديدة (${newBucketTotal})` : `New Assignments (${newBucketTotal})` %>
      </a>
    </div>

    <form class="portal-list-search" method="GET" action="/portal/doctor/queue">
      <input type="hidden" name="bucket" value="<%= bucket %>" />
      <input type="hidden" name="limit" value="<%= limit %>" />
      <input
        type="search"
        name="q"
        value="<%= q %>"
        placeholder="<%= isAr ? 'ابحث برقم الحالة' : 'Search by case ID/reference' %>"
        aria-label="<%= isAr ? 'بحث الحالة' : 'Search case' %>"
      />
      <button type="submit" class="btn btn-secondary"><%= isAr ? 'بحث' : 'Search' %></button>
      <% if (q) { %>
        <a class="btn btn-secondary" href="<%= withParams('/portal/doctor/queue', { bucket, limit: limit !== 20 ? limit : undefined }) %>"><%= isAr ? 'مسح' : 'Clear' %></a>
      <% } %>
    </form>
  </section>

  <section class="portal-card" aria-labelledby="queue-list-title">
    <div class="portal-card-header">
      <h2 id="queue-list-title" class="portal-card-title">
        <%= bucket === 'new'
          ? (isAr ? 'التعيينات الجديدة' : 'New Assignments')
          : (isAr ? 'الحالات قيد المراجعة' : 'In Review Cases') %>
      </h2>
      <div class="portal-card-actions">
        <span class="portal-list-meta">
          <%= isAr
            ? `عرض ${showingFrom}-${showingTo} من ${total}`
            : `Showing ${showingFrom}-${showingTo} of ${total}` %>
        </span>
      </div>
    </div>

    <% if (!cases.length) { %>
      <p class="portal-empty">
        <%= bucket === 'new'
          ? (isAr ? 'لا توجد تعيينات جديدة.' : 'No new assignments.')
          : (isAr ? 'لا توجد حالات قيد المراجعة.' : 'No cases in review.') %>
      </p>
    <% } else { %>
      <div class="portal-case-list">
        <% cases.forEach(c => { %>
          <% const iconKey = pickSpecialtyKey(c); %>
          <% const iconLucide = lucideForSpecialty(iconKey); %>
          <% const iconFallback = fallbackGlyphForSpecialty(iconKey); %>
          <% const rowHref = String((c && c.href) || '').trim(); %>
          <% const rowPill = pillVariant(c); %>
          <% const rowStatus = statusText(c); %>
          <% const rowSla = String((c && c.slaLabel) || '').trim(); %>

          <% if (rowHref) { %>
            <a class="portal-case-row portal-case-row--stack" href="<%= rowHref %>">
              <div class="portal-case-main">
                <div class="portal-case-icon" aria-hidden="true">
                  <i data-lucide="<%= iconLucide %>" class="portal-icon-lucide" aria-hidden="true"></i>
                  <span class="portal-icon-fallback" aria-hidden="true"><%= iconFallback %></span>
                </div>
                <div class="portal-case-ref"><%= c.reference || c.id %></div>
                <div class="portal-case-meta">
                  <span><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></span>
                </div>
              </div>
              <div class="portal-case-actions">
                <span class="portal-pill <%= rowPill %>"><%= rowStatus %></span>
                <% if (rowSla) { %>
                  <span class="portal-list-meta"><%= rowSla %></span>
                <% } %>
              </div>
            </a>
          <% } else { %>
            <div class="portal-case-row portal-case-row--stack is-static-row">
              <div class="portal-case-main">
                <div class="portal-case-icon" aria-hidden="true">
                  <i data-lucide="<%= iconLucide %>" class="portal-icon-lucide" aria-hidden="true"></i>
                  <span class="portal-icon-fallback" aria-hidden="true"><%= iconFallback %></span>
                </div>
                <div class="portal-case-ref"><%= c.reference || c.id %></div>
                <div class="portal-case-meta">
                  <span><%= c.specialtyLabel || c.specialty_name || c.service_name || '—' %></span>
                </div>
              </div>
              <div class="portal-case-actions">
                <span class="portal-pill <%= rowPill %>"><%= rowStatus %></span>
                <% if (rowSla) { %>
                  <span class="portal-list-meta"><%= rowSla %></span>
                <% } %>
              </div>
            </div>
          <% } %>
        <% }) %>
      </div>
    <% } %>

    <div class="portal-list-pagination">
      <% if (prevHref) { %>
        <a class="btn btn-secondary" href="<%= prevHref %>"><%= isAr ? 'السابق' : 'Previous' %></a>
      <% } else { %>
        <span class="btn btn-secondary is-disabled" aria-disabled="true"><%= isAr ? 'السابق' : 'Previous' %></span>
      <% } %>

      <% if (nextHref) { %>
        <a class="btn btn-secondary" href="<%= nextHref %>"><%= isAr ? 'التالي' : 'Next' %></a>
      <% } else { %>
        <span class="btn btn-secondary is-disabled" aria-disabled="true"><%= isAr ? 'التالي' : 'Next' %></span>
      <% } %>
    </div>
  </section>
</div>

