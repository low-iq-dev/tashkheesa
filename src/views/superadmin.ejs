<%- include('partials/header', { title: "Owner Dashboard", layout: "portal", showNav: false, showFooter: false, portalFrame: true, portalRole: 'superadmin', portalActive: 'dashboard', portalNext: '/superadmin' }) %>
  <% function formatEventDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = String(d.getFullYear());
    let hh = d.getHours();
    const min = String(d.getMinutes()).padStart(2, '0');
    const ampm = hh >= 12 ? 'PM' : 'AM';
    hh = hh % 12;
    if (hh === 0) hh = 12;
    return `${dd}/${mm}/${yyyy} ${hh}:${min} ${ampm}`;
  } %>
  <%
  // Safe defaults for all variables
  var filters = (typeof filters !== 'undefined' && filters) ? filters : {};
  filters = { from: filters.from || '', to: filters.to || '', specialty: filters.specialty || 'all' };
  var specialties = (typeof specialties !== 'undefined' && specialties) ? specialties : [];
  var totalOrders = typeof totalOrders !== 'undefined' ? totalOrders : 0;
  var completedCount = typeof completedCount !== 'undefined' ? completedCount : 0;
  var breachedCount = typeof breachedCount !== 'undefined' ? breachedCount : 0;
  var revenue = typeof revenue !== 'undefined' ? revenue : 0;
  var grossProfit = typeof grossProfit !== 'undefined' ? grossProfit : 0;
  var onTimePercent = typeof onTimePercent !== 'undefined' ? onTimePercent : 0;
  var avgTatMinutes = typeof avgTatMinutes !== 'undefined' && avgTatMinutes !== null ? avgTatMinutes : 0;
  var revenueBySpecialty = (typeof revenueBySpecialty !== 'undefined' && revenueBySpecialty) ? revenueBySpecialty : [];
  var events = (typeof events !== 'undefined' && events) ? events : [];
  var slaEvents = (typeof slaEvents !== 'undefined' && slaEvents) ? slaEvents : [];
  var ordersList = (typeof ordersList !== 'undefined' && ordersList) ? ordersList : [];
  var slaRiskOrders = (typeof slaRiskOrders !== 'undefined' && slaRiskOrders) ? slaRiskOrders : [];
  var breachedOrders = (typeof breachedOrders !== 'undefined' && breachedOrders) ? breachedOrders : [];
  var notificationLog = (typeof notificationLog !== 'undefined' && notificationLog) ? notificationLog : [];
  var pendingDocs = typeof pendingDoctorsCount !== 'undefined' ? pendingDoctorsCount : 0;
  var pendingFileRequests = (typeof pendingFileRequests !== 'undefined' && pendingFileRequests) ? pendingFileRequests : [];
  var pendingFileRequestsCount = (typeof pendingFileRequestsCount !== 'undefined') ? pendingFileRequestsCount : 0;

  // Glass Tower data
  var _doctorPayoutsPending = typeof doctorPayoutsPending !== 'undefined' ? doctorPayoutsPending : 0;
  var _doctorPayoutsPaid = typeof doctorPayoutsPaid !== 'undefined' ? doctorPayoutsPaid : 0;
  var _refundCount = typeof refundCount !== 'undefined' ? refundCount : 0;
  var _refundTotal = typeof refundTotal !== 'undefined' ? refundTotal : 0;
  var _videoRevenue = typeof videoRevenue !== 'undefined' ? videoRevenue : 0;
  var _avgOrderValue = typeof avgOrderValue !== 'undefined' ? avgOrderValue : 0;
  var _paymentFailRate = typeof paymentFailRate !== 'undefined' ? paymentFailRate : 0;
  var _totalPatients = typeof totalPatients !== 'undefined' ? totalPatients : 0;
  var _newPatientsThisMonth = typeof newPatientsThisMonth !== 'undefined' ? newPatientsThisMonth : 0;
  var _busyDoctors = typeof busyDoctors !== 'undefined' ? busyDoctors : 0;
  var _idleDoctors = typeof idleDoctors !== 'undefined' ? idleDoctors : 0;
  var _lastEmailSent = typeof lastEmailSent !== 'undefined' ? lastEmailSent : null;
  var _lastWhatsAppSent = typeof lastWhatsAppSent !== 'undefined' ? lastWhatsAppSent : null;
  var _errorsLast24h = typeof errorsLast24h !== 'undefined' ? errorsLast24h : 0;
  var _notifTotal = typeof notifTotal !== 'undefined' ? notifTotal : 0;
  var _notifDelivered = typeof notifDelivered !== 'undefined' ? notifDelivered : 0;
  var _notifFailed = typeof notifFailed !== 'undefined' ? notifFailed : 0;
  var _notifQueued = typeof notifQueued !== 'undefined' ? notifQueued : 0;
  var _pendingRefunds = (typeof pendingRefunds !== 'undefined' && pendingRefunds) ? pendingRefunds : [];
  var _openChatReports = typeof openChatReports !== 'undefined' ? openChatReports : 0;
  var _doctorNoShowsToday = typeof doctorNoShowsToday !== 'undefined' ? doctorNoShowsToday : 0;
  var _referralCodesUsed = typeof referralCodesUsed !== 'undefined' ? referralCodesUsed : 0;
  var _referralRevenue = typeof referralRevenue !== 'undefined' ? referralRevenue : 0;
  var isAr = (typeof lang !== 'undefined' && lang === 'ar');

  // Combined events feed
  var combinedEvents = [];
  try {
    combinedEvents = ([])
      .concat((events || []).map(function(ev){
        return { at: ev.at, label: ev.label, order_id: ev.order_id, _type: 'audit' };
      }))
      .concat((slaEvents || []).map(function(ev){
        return { at: ev.at, label: ev.label, order_id: ev.order_id, _type: 'sla' };
      }))
      .sort(function(a, b){
        var ta = a && a.at ? new Date(a.at).getTime() : 0;
        var tb = b && b.at ? new Date(b.at).getTime() : 0;
        return tb - ta;
      })
      .slice(0, 12);
  } catch (e) {
    combinedEvents = events || [];
  }

  var exportFilterParams = new URLSearchParams({ from: filters.from, to: filters.to, specialty: filters.specialty });
  var exportHref = '/superadmin/exports/orders.csv?' + exportFilterParams.toString();

  // Revenue bar max
  var maxRevenue = 1;
  revenueBySpecialty.forEach(function(r) { if (r.revenue > maxRevenue) maxRevenue = r.revenue; });

  // Health helpers
  function timeSince(isoStr) {
    if (!isoStr) return 'Never';
    var diff = Date.now() - new Date(isoStr).getTime();
    var mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    return Math.floor(hrs / 24) + 'd ago';
  }
  function healthDot(isoStr) {
    if (!isoStr) return 'err';
    var diff = Date.now() - new Date(isoStr).getTime();
    if (diff < 3600000) return 'ok';
    if (diff < 86400000) return 'warn';
    return 'err';
  }

  // Attention count
  var attentionCount = _openChatReports + _pendingRefunds.length + _doctorNoShowsToday + pendingDocs;

  // Status helpers
  function statusLabel(val) {
    switch((val || '').toLowerCase()) {
      case 'accepted': return 'Accepted';
      case 'in_review': return 'In Review';
      case 'completed': return 'Completed';
      case 'breached': return 'Breached';
      case 'new': default: return 'New';
    }
  }
  %>

  <div class="page-shell">
    <div class="page-inner">

      <!-- ===== HERO HEADER ===== -->
      <div class="owner-hero">
        <div class="hero-row">
          <div>
            <%
              // Personalized greeting based on time of day
              var hour = new Date().getHours();
              var greeting = '';
              var greetingAr = '';
              var firstName = (user && user.name) ? user.name.split(' ')[0] : 'Boss';
              if (hour < 12) { greeting = 'Good morning'; greetingAr = 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±'; }
              else if (hour < 17) { greeting = 'Good afternoon'; greetingAr = 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±'; }
              else if (hour < 21) { greeting = 'Good evening'; greetingAr = 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±'; }
              else { greeting = 'Working late'; greetingAr = 'Ø³Ù‡Ø±Ø© Ø¹Ù…Ù„'; }

              // Daily motivational quotes â€” cycles based on day of year
              var quotes = [
                { en: "The best way to predict the future is to create it.", ar: "Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù‡ÙŠ ØµÙ†Ø¹Ù‡.", by: "Peter Drucker" },
                { en: "Healthcare is not about the business. It's about the people.", ar: "Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ© Ù„ÙŠØ³Øª Ø¹Ù† Ø§Ù„ØªØ¬Ø§Ø±Ø©ØŒ Ø¨Ù„ Ø¹Ù† Ø§Ù„Ù†Ø§Ø³.", by: "Paul Grundy" },
                { en: "Success is not final, failure is not fatal â€” it is the courage to continue that counts.", ar: "Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„ÙŠØ³ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ§Ù„ÙØ´Ù„ Ù„ÙŠØ³ Ù‚Ø§ØªÙ„Ø§Ù‹ â€” Ø§Ù„Ø´Ø¬Ø§Ø¹Ø© Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù‡ÙŠ Ù…Ø§ ÙŠÙ‡Ù….", by: "Winston Churchill" },
                { en: "The only way to do great work is to love what you do.", ar: "Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ù„Ø¹Ù…Ù„ Ø´ÙŠØ¡ Ø¹Ø¸ÙŠÙ… Ù‡ÙŠ Ø£Ù† ØªØ­Ø¨ Ù…Ø§ ØªÙØ¹Ù„Ù‡.", by: "Steve Jobs" },
                { en: "In the middle of difficulty lies opportunity.", ar: "ÙÙŠ ÙˆØ³Ø· Ø§Ù„ØµØ¹ÙˆØ¨Ø© ØªÙƒÙ…Ù† Ø§Ù„ÙØ±ØµØ©.", by: "Albert Einstein" },
                { en: "Move fast and fix things.", ar: "ØªØ­Ø±Ùƒ Ø¨Ø³Ø±Ø¹Ø© ÙˆØ£ØµÙ„Ø­ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡.", by: "Startup Wisdom" },
                { en: "Every patient deserves a second chance at the right diagnosis.", ar: "ÙƒÙ„ Ù…Ø±ÙŠØ¶ ÙŠØ³ØªØ­Ù‚ ÙØ±ØµØ© Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØµØ­ÙŠØ­.", by: "Tashkheesa" },
                { en: "What gets measured gets managed.", ar: "Ù…Ø§ ÙŠÙÙ‚Ø§Ø³ ÙŠÙØ¯Ø§Ø±.", by: "Peter Drucker" },
                { en: "The secret of getting ahead is getting started.", ar: "Ø³Ø± Ø§Ù„ØªÙ‚Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø¨Ø¯Ø¡.", by: "Mark Twain" },
                { en: "Build something people want.", ar: "Ø§Ø¨Ù†Ù Ø´ÙŠØ¦Ø§Ù‹ ÙŠØ±ÙŠØ¯Ù‡ Ø§Ù„Ù†Ø§Ø³.", by: "Y Combinator" },
                { en: "Launch day is just day one.", ar: "ÙŠÙˆÙ… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ù‡Ùˆ Ù…Ø¬Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„.", by: "Tashkheesa" },
                { en: "A doctor's second look could save a life.", ar: "Ù†Ø¸Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø·Ø¨ÙŠØ¨ Ù‚Ø¯ ØªÙ†Ù‚Ø° Ø­ÙŠØ§Ø©.", by: "Tashkheesa" },
                { en: "Stay hungry, stay foolish.", ar: "Ø§Ø¨Ù‚ÙŽ Ø¬Ø§Ø¦Ø¹Ø§Ù‹ØŒ Ø§Ø¨Ù‚ÙŽ Ø£Ø­Ù…Ù‚Ø§Ù‹.", by: "Steve Jobs" },
                { en: "The best time to plant a tree was 20 years ago. The second best time is now.", ar: "Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ø²Ø±Ø§Ø¹Ø© Ø´Ø¬Ø±Ø© ÙƒØ§Ù† Ù‚Ø¨Ù„ 20 Ø¹Ø§Ù…Ø§Ù‹. Ø«Ø§Ù†ÙŠ Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù‡Ùˆ Ø§Ù„Ø¢Ù†.", by: "Chinese Proverb" },
                { en: "First, do no harm. Then, do great things.", ar: "Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù„Ø§ ØªØ¤Ø°Ù. Ø«Ù…ØŒ Ø§ÙØ¹Ù„ Ø£Ø´ÙŠØ§Ø¡ Ø¹Ø¸ÙŠÙ…Ø©.", by: "Tashkheesa" },
                { en: "Rome wasn't built in a day, but they were laying bricks every hour.", ar: "Ù„Ù… ØªÙØ¨Ù†ÙŽ Ø±ÙˆÙ…Ø§ ÙÙŠ ÙŠÙˆÙ…ØŒ Ù„ÙƒÙ†Ù‡Ù… ÙƒØ§Ù†ÙˆØ§ ÙŠØ¶Ø¹ÙˆÙ† Ø§Ù„Ø·ÙˆØ¨ ÙƒÙ„ Ø³Ø§Ø¹Ø©.", by: "John Heywood" },
                { en: "Done is better than perfect.", ar: "Ø§Ù„Ù…Ù†Ø¬Ø² Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ.", by: "Sheryl Sandberg" },
                { en: "The future of medicine is digital, and it starts here.", ar: "Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø·Ø¨ Ø±Ù‚Ù…ÙŠØŒ ÙˆÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§.", by: "Tashkheesa" },
                { en: "Be the change you wish to see in healthcare.", ar: "ÙƒÙ† Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø±Ø¤ÙŠØªÙ‡ ÙÙŠ Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©.", by: "Tashkheesa" },
                { en: "Entrepreneurship is living a few years of your life like most people won't, so you can spend the rest like most people can't.", ar: "Ø±ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù‡ÙŠ Ø£Ù† ØªØ¹ÙŠØ´ Ø¨Ø¶Ø¹ Ø³Ù†ÙˆØ§Øª ÙƒÙ…Ø§ Ù„Ù† ÙŠØ¹ÙŠØ´ Ù…Ø¹Ø¸Ù… Ø§Ù„Ù†Ø§Ø³ØŒ Ù„ØªÙ‚Ø¶ÙŠ Ø¨Ù‚ÙŠØ© Ø­ÙŠØ§ØªÙƒ ÙƒÙ…Ø§ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø¹Ø¸Ù…Ù‡Ù….", by: "Warren Tracy" },
                { en: "Your work is going to fill a large part of your life. Make it count.", ar: "Ø¹Ù…Ù„Ùƒ Ø³ÙŠÙ…Ù„Ø£ Ø¬Ø²Ø¡Ø§Ù‹ ÙƒØ¨ÙŠØ±Ø§Ù‹ Ù…Ù† Ø­ÙŠØ§ØªÙƒ. Ø§Ø¬Ø¹Ù„Ù‡ Ø°Ø§ Ù‚ÙŠÙ…Ø©.", by: "Steve Jobs" },
                { en: "11 days to launch. Let's make them count. ðŸš€", ar: "Ù¡Ù¡ ÙŠÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚. Ù„Ù†Ø¬Ø¹Ù„Ù‡Ø§ ØªØ³ØªØ­Ù‚. ðŸš€", by: "Tashkheesa" },
                { en: "Medicine + Technology = Better outcomes for everyone.", ar: "Ø§Ù„Ø·Ø¨ + Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ = Ù†ØªØ§Ø¦Ø¬ Ø£ÙØ¶Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹.", by: "Tashkheesa" },
                { en: "Think big, start small, scale fast.", ar: "ÙÙƒÙ‘Ø± ÙƒØ¨ÙŠØ±Ø§Ù‹ØŒ Ø§Ø¨Ø¯Ø£ ØµØºÙŠØ±Ø§Ù‹ØŒ ØªÙˆØ³Ù‘Ø¹ Ø¨Ø³Ø±Ø¹Ø©.", by: "Startup Wisdom" },
                { en: "Patients first. Always.", ar: "Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø£ÙˆÙ„Ø§Ù‹. Ø¯Ø§Ø¦Ù…Ø§Ù‹.", by: "Tashkheesa" },
                { en: "The harder you work, the luckier you get.", ar: "ÙƒÙ„Ù…Ø§ Ø¹Ù…Ù„Øª Ø£ÙƒØ«Ø±ØŒ ÙƒÙ„Ù…Ø§ Ø­Ø§Ù„ÙÙƒ Ø§Ù„Ø­Ø¸ Ø£ÙƒØ«Ø±.", by: "Gary Player" },
                { en: "Don't wait for opportunity. Create it.", ar: "Ù„Ø§ ØªÙ†ØªØ¸Ø± Ø§Ù„ÙØ±ØµØ©. Ø§ØµÙ†Ø¹Ù‡Ø§.", by: "George Bernard Shaw" },
                { en: "A journey of a thousand miles begins with a single step.", ar: "Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ù„Ù Ù…ÙŠÙ„ ØªØ¨Ø¯Ø£ Ø¨Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø©.", by: "Lao Tzu" },
                { en: "We didn't come this far to only come this far.", ar: "Ù„Ù… Ù†Ø£ØªÙ Ø¥Ù„Ù‰ Ù‡Ù†Ø§ Ù„Ù†ØªÙˆÙ‚Ù Ù‡Ù†Ø§ ÙÙ‚Ø·.", by: "Tashkheesa" },
                { en: "Today's pain is tomorrow's power.", ar: "Ø£Ù„Ù… Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ù‚ÙˆØ© Ø§Ù„ØºØ¯.", by: "Tashkheesa" },
                { en: "Keep going. You're closer than you think.", ar: "Ø§Ø³ØªÙ…Ø±. Ø£Ù†Øª Ø£Ù‚Ø±Ø¨ Ù…Ù…Ø§ ØªØ¸Ù†.", by: "Tashkheesa" },
              ];
              var dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
              var todayQuote = quotes[dayOfYear % quotes.length];
            %>
            <h1><%= isAr ? greetingAr : greeting %>, <%= firstName %> ðŸ‘‹</h1>
            <div class="hero-sub" style="display:flex;flex-direction:column;gap:4px;">
              <% if (filters.from || filters.to) { %>
                <span><%= filters.from || 'All' %> &rarr; <%= filters.to || 'Now' %></span>
              <% } %>
              <span style="font-style:italic;opacity:0.85;font-size:13px;">
                "<%= isAr ? todayQuote.ar : todayQuote.en %>"
                <span style="opacity:0.6;font-size:11px;">â€” <%= todayQuote.by %></span>
              </span>
            </div>
          </div>
        </div>
        <div class="hero-health">
          <div class="hero-health-item">
            <span class="hero-health-dot <%= healthDot(_lastEmailSent) %>"></span>
            <%= isAr ? 'Ø§Ù„Ø¨Ø±ÙŠØ¯' : 'Email' %>
            <span class="hero-health-val"><%= timeSince(_lastEmailSent) %></span>
          </div>
          <div class="hero-health-item">
            <span class="hero-health-dot <%= healthDot(_lastWhatsAppSent) %>"></span>
            WhatsApp
            <span class="hero-health-val"><%= timeSince(_lastWhatsAppSent) %></span>
          </div>
          <div class="hero-health-item">
            <span class="hero-health-dot <%= onTimePercent >= 80 ? 'ok' : (onTimePercent >= 50 ? 'warn' : 'err') %>"></span>
            SLA
            <span class="hero-health-val"><%= onTimePercent %>%</span>
          </div>
          <div class="hero-health-item">
            <span class="hero-health-dot <%= _errorsLast24h === 0 ? 'ok' : (_errorsLast24h <= 5 ? 'warn' : 'err') %>"></span>
            <%= isAr ? 'Ø£Ø®Ø·Ø§Ø¡' : 'Errors' %>
            <span class="hero-health-val"><%= _errorsLast24h %></span>
          </div>
        </div>
      </div>

      <!-- ===== FILTER BAR (moved from hero) ===== -->
      <div class="owner-filter-bar">
        <form method="get" action="/superadmin" class="filter-bar-form">
          <input type="date" name="from" value="<%= filters.from %>" placeholder="<%= isAr ? 'Ù…Ù†' : 'From' %>">
          <input type="date" name="to" value="<%= filters.to %>" placeholder="<%= isAr ? 'Ø¥Ù„Ù‰' : 'To' %>">
          <select name="specialty">
            <option value="all" <%= filters.specialty === 'all' ? 'selected' : '' %>><%= isAr ? 'ÙƒÙ„ Ø§Ù„ØªØ®ØµØµØ§Øª' : 'All Specialties' %></option>
            <% specialties.forEach(function(sp) { %>
              <option value="<%= sp.id %>" <%= String(filters.specialty) === String(sp.id) ? 'selected' : '' %>><%= sp.name %></option>
            <% }); %>
          </select>
          <button type="submit"><%= isAr ? 'ØªØ·Ø¨ÙŠÙ‚' : 'Apply' %></button>
          <a href="<%= exportHref %>" class="export-link">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            CSV
          </a>
        </form>
      </div>

      <!-- ===== FINANCIAL KPIs (6 frosted glass cards) ===== -->
      <div class="owner-finance-grid">
        <div class="owner-fin-card">
          <div class="fin-label"><%= isAr ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue' %></div>
          <div class="fin-val"><%= Number(revenue || 0).toLocaleString() %></div>
          <div class="fin-sub flat">EGP</div>
        </div>
        <div class="owner-fin-card">
          <div class="fin-label"><%= isAr ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Gross Profit' %></div>
          <div class="fin-val"><%= Number(grossProfit || 0).toLocaleString() %></div>
          <div class="fin-sub flat">EGP</div>
        </div>
        <div class="owner-fin-card">
          <div class="fin-label"><%= isAr ? 'Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡' : 'Dr Payouts' %></div>
          <div class="fin-val"><%= Number(_doctorPayoutsPending || 0).toLocaleString() %></div>
          <div class="fin-sub flat"><%= isAr ? 'Ù…Ø¹Ù„Ù‚' : 'Pending' %> &middot; <%= Number(_doctorPayoutsPaid || 0).toLocaleString() %> <%= isAr ? 'Ù…Ø¯ÙÙˆØ¹' : 'Paid' %></div>
        </div>
        <div class="owner-fin-card">
          <div class="fin-label"><%= isAr ? 'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©' : 'Refunds' %></div>
          <div class="fin-val"><%= _refundCount %></div>
          <div class="fin-sub flat"><%= Number(_refundTotal || 0).toLocaleString() %> EGP</div>
        </div>
        <div class="owner-fin-card">
          <div class="fin-label"><%= isAr ? 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Video Revenue' %></div>
          <div class="fin-val"><%= Number(_videoRevenue || 0).toLocaleString() %></div>
          <div class="fin-sub flat">EGP</div>
        </div>
        <div class="owner-fin-card">
          <div class="fin-label"><%= isAr ? 'Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨' : 'Avg Order Value' %></div>
          <div class="fin-val"><%= Number(_avgOrderValue || 0).toLocaleString() %></div>
          <div class="fin-sub flat">EGP</div>
        </div>
      </div>

      <!-- ===== QUICK ACTIONS ===== -->
      <div class="owner-quick-actions">
        <a href="/superadmin/orders/new">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          <%= isAr ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨' : 'Create Order' %>
        </a>
        <a href="/superadmin/doctors/new">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
          <%= isAr ? 'Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨' : 'Add Doctor' %>
        </a>
        <a href="/portal/admin/campaigns/new">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          <%= isAr ? 'Ø¥Ø±Ø³Ø§Ù„ Ø­Ù…Ù„Ø©' : 'Send Campaign' %>
        </a>
        <a href="/superadmin/run-sla-check" target="_blank" rel="noopener">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <%= isAr ? 'ÙØ­Øµ SLA' : 'Run SLA Check' %>
        </a>
      </div>

      <!-- ===== OPS KPIs (4 cards, clickable) ===== -->
      <div class="owner-ops-grid">
        <a href="/admin/orders" class="owner-ops-card ops-card-link">
          <div class="ops-icon blue">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
          </div>
          <div>
            <div class="ops-val"><%= totalOrders %></div>
            <div class="ops-label"><%= isAr ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª' : 'Total Cases' %></div>
          </div>
        </a>
        <a href="/admin/orders?status=completed" class="owner-ops-card ops-card-link">
          <div class="ops-icon green">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div>
            <div class="ops-val"><%= completedCount %></div>
            <div class="ops-label"><%= isAr ? 'Ù…ÙƒØªÙ…Ù„Ø©' : 'Completed' %> &middot; SLA <%= onTimePercent %>%</div>
          </div>
        </a>
        <a href="/portal/admin/analytics" class="owner-ops-card ops-card-link">
          <div class="ops-icon amber">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div>
            <div class="ops-val"><%= avgTatMinutes != null ? avgTatMinutes : 'â€”' %></div>
            <div class="ops-label"><%= isAr ? 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ­ÙˆÙ„ (Ø¯Ù‚ÙŠÙ‚Ø©)' : 'Avg Turnaround (min)' %></div>
          </div>
        </a>
        <a href="/admin/orders?status=breached" class="owner-ops-card ops-card-link">
          <div class="ops-icon red">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          </div>
          <div>
            <div class="ops-val"><%= breachedCount %></div>
            <div class="ops-label"><%= isAr ? 'Ø§Ù†ØªÙ‡Ø§ÙƒØ§Øª' : 'Breached' %> &middot; <%= _paymentFailRate %>% <%= isAr ? 'ÙØ´Ù„ Ø¯ÙØ¹' : 'Pay Fail' %></div>
          </div>
        </a>
      </div>

      <!-- ===== PEOPLE STRIP ===== -->
      <div class="owner-people-strip">
        <a href="/superadmin/doctors?status=pending" class="people-card people-card-link">
          <div class="people-label"><%= isAr ? 'Ø£Ø·Ø¨Ø§Ø¡ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Pending Dr Approvals' %></div>
          <div class="people-val"><%= pendingDocs %></div>
          <% if (pendingDocs > 0) { %>
            <div class="people-sub" style="color:var(--owner-amber);font-weight:600;"><%= isAr ? 'Ø¨Ø­Ø§Ø¬Ø© Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Needs review' %></div>
          <% } %>
        </a>
        <div class="people-card">
          <div class="people-label"><%= isAr ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰' : 'Total Patients' %></div>
          <div class="people-val"><%= _totalPatients %></div>
          <div class="people-sub"><%= _newPatientsThisMonth %> <%= isAr ? 'Ø¬Ø¯ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±' : 'new this month' %></div>
        </div>
        <a href="/superadmin/doctors" class="people-card people-card-link">
          <div class="people-label"><%= isAr ? 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡' : 'Doctor Utilization' %></div>
          <div class="people-val"><%= _busyDoctors %></div>
          <div class="people-sub"><%= isAr ? 'Ù…Ø´ØºÙˆÙ„' : 'busy' %> &middot; <%= _idleDoctors %> <%= isAr ? 'Ù…ØªØ§Ø­' : 'idle' %></div>
        </a>
      </div>

      <!-- ===== MAIN GRID: Recent Cases + Right Stack ===== -->
      <div class="owner-grid-2">

        <!-- Recent Cases Table -->
        <div class="card">
          <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
            <div class="card-title"><%= isAr ? 'Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©' : 'Recent Cases' %></div>
            <a class="hero-btn" href="/admin/orders" style="font-size:11px;padding:5px 12px;background:var(--owner-primary-light);color:var(--owner-primary);border-color:var(--owner-border-light);backdrop-filter:none;"><%= isAr ? 'Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„' : 'View All' %></a>
          </div>
          <div class="table-scroll table-scroll--y table-scroll--6">
            <table>
              <thead>
                <tr>
                  <th><%= isAr ? 'Ø§Ù„Ø·Ù„Ø¨' : 'Order' %></th>
                  <th><%= isAr ? 'Ø§Ù„ØªØ®ØµØµ' : 'Specialty' %></th>
                  <th><%= isAr ? 'Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Service' %></th>
                  <th><%= isAr ? 'Ø§Ù„Ø­Ø§Ù„Ø©' : 'Status' %></th>
                  <th class="align-right"><%= isAr ? 'Ø§Ù„Ù…Ø¨Ù„Øº' : 'Amount' %></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% (ordersList || []).slice(0, 10).forEach(function(o) {
                  var eff = o.effectiveStatus || o.status;
                  var statusUiLocal = o.statusUi || null;
                  var effKey = statusUiLocal && (statusUiLocal.key || statusUiLocal.status)
                    ? String(statusUiLocal.key || statusUiLocal.status).toLowerCase()
                    : String(eff || '').toLowerCase();
                  var effLabel = (statusUiLocal && statusUiLocal.title) ? statusUiLocal.title : statusLabel(eff);
                %>
                  <tr>
                    <td><a href="/superadmin/orders/<%= o.id %>" class="order-id"><%= String(o.id).substring(0, 8) %></a></td>
                    <td><%= o.specialty_name || 'â€”' %></td>
                    <td><%= o.service_name || 'â€”' %></td>
                    <td>
                      <span class="status-pill status-pill--<%= effKey %>"><%= effLabel %></span>
                      <% if (o.reassigned_count && Number(o.reassigned_count) > 0) { %>
                        <span class="tag" style="margin-left:4px;">R<%= o.reassigned_count %></span>
                      <% } %>
                    </td>
                    <td class="align-right"><span style="font-family:'Space Mono',monospace;font-size:12px;"><%= o.price != null ? Number(o.price).toLocaleString() : 'â€”' %></span></td>
                    <td><a class="btn btn-outline btn-small" href="/superadmin/orders/<%= o.id %>"><%= isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a></td>
                  </tr>
                <% }); %>
                <% if (!ordersList || !ordersList.length) { %>
                  <tr><td colspan="6" class="empty"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª' : 'No orders yet.' %></td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right Stack -->
        <div class="owner-right-stack">

          <!-- Needs Attention -->
          <div class="card attn-card">
            <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
              <div class="card-title"><%= isAr ? 'ÙŠØ­ØªØ§Ø¬ Ø§Ù†ØªØ¨Ø§Ù‡' : 'Needs Attention' %></div>
              <% if (attentionCount > 0) { %>
                <span class="status-pill status-pill--breached"><%= attentionCount %></span>
              <% } %>
            </div>
            <ul class="events-list" style="padding:12px 20px;">
              <% if (_openChatReports > 0) { %>
                <li class="event-item" style="padding:8px 0;display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;">
                    <div class="event-label"><%= isAr ? 'Ø¨Ù„Ø§ØºØ§Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø©' : 'Open chat reports' %></div>
                    <div class="event-meta"><%= _openChatReports %> <%= isAr ? 'Ø¨Ù„Ø§ØºØ§Øª' : 'reports' %></div>
                  </div>
                  <a href="/admin/chat-moderation" class="btn btn-small btn-outline" style="padding:4px 10px;font-size:11px;border-radius:6px;border:1px solid var(--owner-border-light,#e5e7eb);text-decoration:none;color:inherit;white-space:nowrap;"><%= isAr ? 'Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Review' %></a>
                </li>
              <% } %>
              <% if (_pendingRefunds.length > 0) { %>
                <li class="event-item" style="padding:8px 0;display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;">
                    <div class="event-label"><%= isAr ? 'Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ±Ø¯Ø§Ø¯' : 'Refund requests' %></div>
                    <div class="event-meta"><%= _pendingRefunds.length %> <%= isAr ? 'Ù…Ø¹Ù„Ù‚' : 'pending' %></div>
                  </div>
                  <a href="/admin/orders?payment=refund" class="btn btn-small btn-outline" style="padding:4px 10px;font-size:11px;border-radius:6px;border:1px solid var(--owner-border-light,#e5e7eb);text-decoration:none;color:inherit;white-space:nowrap;"><%= isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a>
                </li>
              <% } %>
              <% if (_doctorNoShowsToday > 0) { %>
                <li class="event-item" style="padding:8px 0;display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;">
                    <div class="event-label"><%= isAr ? 'Ø¹Ø¯Ù… Ø­Ø¶ÙˆØ± Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…' : 'Doctor no-shows today' %></div>
                    <div class="event-meta"><%= _doctorNoShowsToday %></div>
                  </div>
                  <a href="/admin/orders?status=breached" class="btn btn-small btn-outline" style="padding:4px 10px;font-size:11px;border-radius:6px;border:1px solid var(--owner-border-light,#e5e7eb);text-decoration:none;color:inherit;white-space:nowrap;"><%= isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a>
                </li>
              <% } %>
              <% if (pendingDocs > 0) { %>
                <li class="event-item" style="padding:8px 0;display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;">
                    <div class="event-label"><%= isAr ? 'Ø£Ø·Ø¨Ø§Ø¡ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Pending doctor approvals' %></div>
                    <div class="event-meta"><%= pendingDocs %></div>
                  </div>
                  <a href="/superadmin/doctors?status=pending" class="btn btn-small btn-outline" style="padding:4px 10px;font-size:11px;border-radius:6px;border:1px solid var(--owner-border-light,#e5e7eb);text-decoration:none;color:inherit;white-space:nowrap;"><%= isAr ? 'Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Review' %></a>
                </li>
              <% } %>
              <% if (pendingFileRequestsCount > 0) { %>
                <li class="event-item" style="padding:8px 0;display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;">
                    <div class="event-label"><%= isAr ? 'Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ù…Ù„ÙØ§Øª' : 'File re-upload requests' %></div>
                    <div class="event-meta"><%= pendingFileRequestsCount %></div>
                  </div>
                  <a href="/admin/orders" class="btn btn-small btn-outline" style="padding:4px 10px;font-size:11px;border-radius:6px;border:1px solid var(--owner-border-light,#e5e7eb);text-decoration:none;color:inherit;white-space:nowrap;"><%= isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a>
                </li>
              <% } %>
              <% if (attentionCount === 0 && pendingFileRequestsCount === 0) { %>
                <li class="event-item" style="padding:6px 0;">
                  <div class="event-meta"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ Ø¹Ø§Ø¬Ù„Ø©' : 'No urgent issues right now.' %></div>
                </li>
              <% } %>
            </ul>
          </div>

          <!-- SLA Risk -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><%= isAr ? 'Ù…Ø®Ø§Ø·Ø± SLA (24 Ø³Ø§Ø¹Ø©)' : 'SLA Risk (24h)' %></div>
            </div>
            <% if (slaRiskOrders && slaRiskOrders.length) { %>
              <ul class="events-list" style="padding:12px 20px;">
                <% slaRiskOrders.forEach(function(o){ %>
                  <li class="event-item" style="padding:6px 0;">
                    <div class="event-label">
                      <a href="/superadmin/orders/<%= o.id %>" class="order-id"><%= String(o.id).substring(0, 8) %></a>
                      &middot; <%= o.specialty_name || '' %>
                    </div>
                    <div class="event-meta">
                      <%= o.doctor_name || (isAr ? 'ØºÙŠØ± Ù…Ø¹ÙŠÙ†' : 'Unassigned') %> &middot;
                      <span class="sla-time"><%= Math.max(0, Math.floor(o.hours_remaining)) %>h</span> <%= isAr ? 'Ù…ØªØ¨Ù‚ÙŠ' : 'left' %>
                    </div>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <p class="muted" style="padding:16px 20px;margin:0;font-size:12px;"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ùƒ' : 'No orders nearing SLA.' %></p>
            <% } %>
          </div>

          <!-- Live Feed -->
          <div class="card">
            <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
              <div class="card-title"><%= isAr ? 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±' : 'Live Feed' %></div>
              <a class="btn btn-outline btn-small" href="/superadmin/events" style="font-size:10px;"><%= isAr ? 'Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„' : 'View All' %></a>
            </div>
            <ul class="events-list" style="padding:12px 20px;">
              <% (combinedEvents || []).slice(0, 8).forEach(function(ev) {
                var dotColor = ev._type === 'sla' ? 'amber' : 'blue';
                if (String(ev.label || '').toLowerCase().includes('breach')) dotColor = 'red';
                if (String(ev.label || '').toLowerCase().includes('complet')) dotColor = 'green';
              %>
                <li class="event-item" style="padding:5px 0;display:flex;align-items:flex-start;gap:8px;">
                  <span class="fi-dot <%= dotColor %>" style="margin-top:5px;flex-shrink:0;"></span>
                  <div style="flex:1;min-width:0;">
                    <div class="event-label" style="font-size:12px;"><%= ev.label %></div>
                    <div class="event-meta" style="font-size:10px;">
                      <%= formatEventDate(ev.at) %>
                      <% if (ev.order_id) { %> &middot; <a href="/superadmin/orders/<%= ev.order_id %>" class="order-id"><%= String(ev.order_id).substring(0, 8) %></a><% } %>
                    </div>
                  </div>
                </li>
              <% }) %>
              <% if (!combinedEvents || combinedEvents.length === 0) { %>
                <li class="event-item" style="padding:6px 0;">
                  <div class="event-meta"><%= isAr ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†' : 'No events recorded yet.' %></div>
                </li>
              <% } %>
            </ul>
          </div>
        </div>
      </div>

      <!-- ===== BOTTOM GRID: Revenue by Specialty + Notifications ===== -->
      <div class="owner-grid-2" style="margin-bottom:24px;">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><%= isAr ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ' : 'Revenue by Specialty' %></div>
          </div>
          <div class="table-scroll table-scroll--y table-scroll--6">
            <table>
              <thead>
                <tr>
                  <th><%= isAr ? 'Ø§Ù„ØªØ®ØµØµ' : 'Specialty' %></th>
                  <th class="align-right"><%= isAr ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Orders' %></th>
                  <th class="align-right"><%= isAr ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue' %></th>
                  <th><%= isAr ? 'Ø§Ù„Ø­ØµØ©' : 'Share' %></th>
                </tr>
              </thead>
              <tbody>
                <% revenueBySpecialty.forEach(function(row) {
                  var pct = maxRevenue > 0 ? Math.round((row.revenue / maxRevenue) * 100) : 0;
                %>
                  <tr>
                    <td><%= row.name %></td>
                    <td class="align-right" style="font-family:'Space Mono',monospace;"><%= row.count %></td>
                    <td class="align-right" style="font-family:'Space Mono',monospace;"><%= Number(row.revenue).toLocaleString() %></td>
                    <td style="min-width:80px;">
                      <div class="rev-bar-wrap">
                        <div class="rev-bar-fill" style="width:<%= pct %>%"></div>
                      </div>
                    </td>
                  </tr>
                <% }); %>
                <% if (!revenueBySpecialty || revenueBySpecialty.length === 0) { %>
                  <tr><td colspan="4" class="empty"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'No revenue data yet.' %></td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="owner-right-stack">
          <!-- Notification Stats -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><%= isAr ? 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' : 'Notification Stats' %></div>
            </div>
            <div class="notif-grid-4">
              <div class="notif-stat">
                <div class="ns-val"><%= _notifTotal %></div>
                <div class="ns-label"><%= isAr ? 'Ø§Ù„ÙƒÙ„' : 'Total' %></div>
              </div>
              <div class="notif-stat">
                <div class="ns-val" style="color:var(--owner-green);"><%= _notifDelivered %></div>
                <div class="ns-label"><%= isAr ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Delivered' %></div>
              </div>
              <div class="notif-stat">
                <div class="ns-val" style="color:var(--owner-red);"><%= _notifFailed %></div>
                <div class="ns-label"><%= isAr ? 'ÙØ´Ù„' : 'Failed' %></div>
              </div>
              <div class="notif-stat">
                <div class="ns-val" style="color:var(--owner-amber);"><%= _notifQueued %></div>
                <div class="ns-label"><%= isAr ? 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Queued' %></div>
              </div>
            </div>
          </div>

          <!-- Referral Stats -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><%= isAr ? 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª' : 'Referral Stats' %></div>
            </div>
            <div class="referral-stats">
              <div class="referral-stat">
                <div class="rs-val"><%= _referralCodesUsed %></div>
                <div class="rs-label"><%= isAr ? 'Ø£ÙƒÙˆØ§Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø©' : 'Codes Used' %></div>
              </div>
              <div class="referral-stat">
                <div class="rs-val"><%= Number(_referralRevenue || 0).toLocaleString() %></div>
                <div class="rs-label"><%= isAr ? 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (EGP)' : 'Referral Revenue (EGP)' %></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== BOTTOM GRID: Breached Orders + File Requests ===== -->
      <div class="owner-grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><%= isAr ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙƒØ©' : 'Breached Orders' %></div>
          </div>
          <% if (breachedOrders && breachedOrders.length) { %>
            <ul class="events-list" style="padding:12px 20px;">
              <% breachedOrders.forEach(function(o){ %>
                <li class="event-item" style="padding:8px 0;display:flex;align-items:center;gap:8px;">
                  <span class="fi-dot red" style="flex-shrink:0;"></span>
                  <div style="flex:1;">
                    <a href="/superadmin/orders/<%= o.id %>" class="order-id"><%= String(o.id).substring(0, 8) %></a>
                    &middot; <%= o.specialty_name || '' %>
                    <div class="event-meta"><%= o.doctor_name || (isAr ? 'ØºÙŠØ± Ù…Ø¹ÙŠÙ†' : 'Unassigned') %> &middot; <%= formatEventDate(o.breached_at) %></div>
                  </div>
                  <div style="display:flex;gap:4px;">
                    <a href="/superadmin/orders/<%= o.id %>" class="btn btn-small btn-primary" title="<%= isAr ? 'Ø¹Ø±Ø¶ ÙˆØ­Ù„' : 'View & Resolve' %>" style="padding:4px 8px;font-size:11px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;background:var(--owner-primary,#2563eb);color:white;border:none;text-decoration:none;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </a>
                    <% if (!o.doctor_id) { %>
                      <a href="/superadmin/orders/<%= o.id %>#assign" class="btn btn-small btn-outline" title="<%= isAr ? 'ØªØ¹ÙŠÙŠÙ† Ø·Ø¨ÙŠØ¨' : 'Assign Doctor' %>" style="padding:4px 8px;font-size:11px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;background:transparent;border:1px solid var(--owner-border-light,#e5e7eb);color:var(--text-primary);text-decoration:none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                      </a>
                    <% } %>
                  </div>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="muted" style="padding:16px 20px;margin:0;font-size:12px;"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ù†ØªÙ‡ÙƒØ©' : 'No breached orders.' %></p>
          <% } %>
        </div>

        <div class="card">
          <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
            <div class="card-title"><%= isAr ? 'Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª' : 'File Re-upload Requests' %></div>
            <% if (pendingFileRequestsCount > 0) { %>
              <span class="status-pill status-pill--new"><%= pendingFileRequestsCount %></span>
            <% } %>
          </div>
          <% if (pendingFileRequests && pendingFileRequests.length) { %>
            <ul class="events-list" style="padding:12px 20px;">
              <% pendingFileRequests.slice(0, 5).forEach(function(r){ %>
                <li class="event-item" style="padding:5px 0;">
                  <div class="event-label">
                    <a href="/superadmin/orders/<%= r.orderId %>" class="order-id"><%= String(r.orderId).substring(0, 8) %></a>
                    &middot; <%= r.doctor_name || 'â€”' %>
                  </div>
                  <div class="event-meta"><%= r.reason || 'â€”' %> &middot; <%= formatEventDate(r.requested_at) %></div>
                </li>
              <% }); %>
            </ul>
          <% } else { %>
            <p class="muted" style="padding:16px 20px;margin:0;font-size:12px;"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹' : 'No pending re-upload requests.' %></p>
          <% } %>
        </div>
      </div>

    </div>
  </div>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
