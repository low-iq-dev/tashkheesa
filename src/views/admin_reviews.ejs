<%- include('partials/header', { title: pageTitle || "Manage Reviews", layout: "portal", showNav: false, portalFrame: true, portalRole: (typeof portalRole !== 'undefined' ? portalRole : 'superadmin'), portalActive: 'reviews' }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _reviews = (typeof reviews !== 'undefined' && Array.isArray(reviews)) ? reviews : [];

  function stars(n) {
    var s = '';
    for (var i = 1; i <= 5; i++) {
      s += i <= n ? '<span style="color:#f59e0b;">&#9733;</span>' : '<span style="color:#e2e8f0;">&#9733;</span>';
    }
    return s;
  }

  function fmtDate(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
%>

<div class="admin-page">
  <div class="admin-page-header">
    <div class="admin-page-header-left">
      <nav class="admin-breadcrumb">
        <a href="/admin">Dashboard</a>
        <span class="admin-breadcrumb-sep">&rsaquo;</span>
        <span>Reviews</span>
      </nav>
      <h1 class="admin-page-title"><%= _isAr ? 'إدارة التقييمات' : 'Manage Reviews' %></h1>
    </div>
    <div class="admin-page-header-right">
    </div>
  </div>

  <div class="admin-table-wrap">
    <table class="admin-table">
      <thead>
        <tr>
          <th><%= _isAr ? 'الطبيب' : 'Doctor' %></th>
          <th><%= _isAr ? 'المريض' : 'Patient' %></th>
          <th><%= _isAr ? 'التقييم' : 'Rating' %></th>
          <th><%= _isAr ? 'النص' : 'Text' %></th>
          <th><%= _isAr ? 'التاريخ' : 'Date' %></th>
          <th><%= _isAr ? 'الحالة' : 'Status' %></th>
          <th><%= _isAr ? 'إجراءات' : 'Actions' %></th>
        </tr>
      </thead>
      <tbody>
        <% if (_reviews.length === 0) { %>
          <tr><td colspan="7" class="empty"><%= _isAr ? 'لا توجد تقييمات' : 'No reviews found' %></td></tr>
        <% } %>
        <% _reviews.forEach(function(rv) { %>
          <tr id="review-<%= rv.id %>">
            <td><%= rv.doctor_name || '-' %></td>
            <td><%= rv.is_anonymous ? '(anonymous)' : (rv.patient_name || '-') %></td>
            <td><%- stars(rv.rating) %></td>
            <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="<%= (rv.review_text || '').replace(/"/g, '&quot;') %>"><%= (rv.review_text || '').slice(0, 80) || '-' %></td>
            <td style="font-size:0.8rem;white-space:nowrap;"><%= fmtDate(rv.created_at) %></td>
            <td>
              <% if (rv.admin_flagged) { %>
                <span class="status-pill status-pill--in_review">Flagged</span>
              <% } else if (!rv.is_visible) { %>
                <span class="status-pill status-pill--cancelled">Hidden</span>
              <% } else { %>
                <span class="status-pill status-pill--completed">Visible</span>
              <% } %>
            </td>
            <td>
              <% if (rv.is_visible) { %>
                <button onclick="reviewAction('<%= rv.id %>', 'hide')" class="admin-btn admin-btn-outline" style="font-size:0.75rem;padding:0.3rem 0.6rem;">Hide</button>
                <button onclick="reviewAction('<%= rv.id %>', 'flag')" class="admin-btn admin-btn-outline" style="font-size:0.75rem;padding:0.3rem 0.6rem;">Flag</button>
              <% } else { %>
                <span class="cell-muted">-</span>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>

<script<% if (typeof cspNonce !== 'undefined' && cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
function reviewAction(reviewId, action) {
  var csrfToken = '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>';
  fetch('/portal/admin/review/' + reviewId, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
    body: JSON.stringify({ action: action })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ok) window.location.reload();
    else alert(data.error || 'Error');
  })
  .catch(function() { alert('Network error'); });
}
</script>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
