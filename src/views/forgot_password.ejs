<%- include('partials/header', { title: 'forgot_password.ejs' }) %>
<% const C = (typeof copy !== 'undefined' && copy) ? copy : {}; %>
<%
  const currentLang = ((typeof lang !== 'undefined' && lang) ? lang : ((typeof isAr !== 'undefined' && isAr) ? 'ar' : 'en'));
  const isArabicUi = (currentLang === 'ar') || (typeof isAr !== 'undefined' && isAr);
  const nextEn = encodeURIComponent('/forgot-password?lang=en');
  const nextAr = encodeURIComponent('/forgot-password?lang=ar');
%>
  <div class="page-shell" style="display:flex; justify-content:center; width:100%;">
    <div class="auth-card">
      <div class="auth-header">
        <div class="brand" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <div class="brand-logo">T</div>
            <div>
              <div class="brand-text-main">Tashkheesa</div>
              <div class="brand-text-sub"><%= (C.recoverAccountSub) ? C.recoverAccountSub : ((typeof isAr !== 'undefined' && isAr) ? 'استعادة الحساب' : 'Recover your account') %></div>
            </div>
          </div>
          <div class="lang-switch" style="font-weight:700; opacity:.9;">
            <a href="/lang/en?next=<%= nextEn %>">EN</a> | <a href="/lang/ar?next=<%= nextAr %>">AR</a>
          </div>
        </div>
      </div>

      <h2 class="auth-title"><%= (C.forgotPasswordTitle) ? C.forgotPasswordTitle : ((typeof isAr !== 'undefined' && isAr) ? 'هل نسيت كلمة المرور؟' : 'Forgot your password?') %></h2>
      <p class="auth-subtitle"><%= (C.forgotPasswordSubtitle) ? C.forgotPasswordSubtitle : ((typeof isAr !== 'undefined' && isAr) ? 'أدخل بريدك الإلكتروني وسنرسل لك رابط إعادة التعيين.' : "Enter your email and we’ll send you a reset link.") %></p>

      <% 
        const isArabic = ((typeof isAr !== 'undefined' && isAr) || ((typeof lang !== 'undefined' && lang) === 'ar'));
        const msgMapAr = {
          "If an account exists for this email, you will receive a reset link.": "إذا كان هناك حساب مرتبط بهذا البريد الإلكتروني، فسنرسل لك رابط إعادة التعيين.",
          "Please enter your email.": "يرجى إدخال بريدك الإلكتروني.",
          "Please enter a valid email address.": "يرجى إدخال بريد إلكتروني صحيح.",
          "Too many attempts. Please try again later.": "محاولات كثيرة. يرجى المحاولة لاحقًا.",
          "Something went wrong. Please try again.": "حدث خطأ ما. يرجى المحاولة مرة أخرى.",
          "Reset link sent.": "تم إرسال رابط إعادة التعيين.",
          "Email sent.": "تم إرسال البريد الإلكتروني."
        };
        function localizeServerMessage(msg) {
          if (!msg) return msg;
          if (!isArabic) return msg;
          return msgMapAr[msg] || msg;
        }
      %>

      <% if (typeof error !== 'undefined' && error) { %>
        <div class="card" style="background:#fef2f2; border:1px solid #fecdd3; color:#991b1b; margin-bottom:12px;"><%= localizeServerMessage(error) %></div>
      <% } %>

      <% if (typeof success !== 'undefined' && success) { %>
        <div class="card" style="background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; margin-bottom:12px;"><%= localizeServerMessage(success) %></div>
      <% } %>

      <% if (typeof info !== 'undefined' && info) { %>
        <div class="card" style="background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a; margin-bottom:12px;"><%= localizeServerMessage(info) %></div>
      <% } %>

      <form method="post" action="/forgot-password?lang=<%= (isArabicUi ? 'ar' : 'en') %>">
        <%- (typeof csrfField === 'function') ? csrfField() : '' %>

        <label class="input-label"><%= (C.emailLabel) ? C.emailLabel : ((typeof isAr !== 'undefined' && isAr) ? 'البريد الإلكتروني' : 'Email') %></label>
        <input class="input-field" type="email" name="email" autocomplete="email" required />

        <div class="actions" style="margin-top:12px;">
          <button class="btn btn-primary" type="submit"><%= (C.sendResetLinkCta) ? C.sendResetLinkCta : ((typeof isAr !== 'undefined' && isAr) ? 'إرسال رابط إعادة التعيين' : 'Send reset link') %></button>
        </div>
      </form>

      <div class="footer" style="margin-top:12px; font-size:12px; color: var(--text-muted); text-align:center;">
        <a class="link-muted" href="/login?lang=<%= (isArabicUi ? 'ar' : 'en') %>"><%= (C.backToLoginLink) ? C.backToLoginLink : ((typeof isAr !== 'undefined' && isAr) ? 'العودة لتسجيل الدخول' : 'Back to login') %></a>
      </div>
    </div>
  </div>