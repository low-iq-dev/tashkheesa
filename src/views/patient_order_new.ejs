<!DOCTYPE html>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<% const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa'; %>
<html lang="<%= lang || 'en' %>" dir="<%= isAr ? 'rtl' : 'ltr' %>">
<head>
  <meta charset="utf-8" />
  <title><%= t('patient.new_case.page_title') %> – <%= brandSafe %></title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="layout">
    <div class="page-shell">
      <div class="page-inner">
        <header>
          <div class="brand">
            <div class="brand-logo">T</div>
            <div>
              <div class="brand-text-main"><%= brandSafe %></div>
              <div class="brand-text-sub"><%= t('patient.portal') %></div>
            </div>
          </div>

          <div class="header-right">
            <a class="pill" href="/dashboard"><%= t('patient.my_orders') %></a>
            <div class="lang-switch">
              <a href="/lang/en?next=/patient/orders/new">EN</a> | <a href="/lang/ar?next=/patient/orders/new">AR</a>
            </div>
            <form class="logout-form" method="post" action="/logout">
              <%- (typeof csrfField === 'function') ? csrfField() : '' %>
              <button type="submit"><%= t('auth.logout') %></button>
            </form>
          </div>
        </header>

        <main>
          <div class="page-heading">
            <div>
              <h1><%= t('patient.new_case.page_title') %></h1>
              <p class="subtitle"><%= t('patient.new_case.subtitle') %></p>
            </div>
            <div class="page-heading-actions">
              <a class="btn btn-outline" href="/dashboard"><%= isAr ? '→ ' : '← ' %><%= t('common.back_to_dashboard') %></a>
            </div>
          </div>

          <div class="card" style="max-width: 900px;">
            <% if (typeof error !== 'undefined' && error) { %>
              <div style="background:#fff4f4; border:1px solid #fca5a5; padding:12px; border-radius:8px; margin-bottom:12px;">
                <strong style="color:#b91c1c;"><%= error %></strong>
              </div>
            <% } %>

            <form method="post" action="/patient/orders" style="display:flex; flex-direction:column; gap:14px;">
              <%- (typeof csrfField === 'function') ? csrfField() : '' %>

              <div class="form-grid">
                <div>
                  <label class="filter-label"><%= t('patient.new_case.specialty') %></label>
                  <select name="specialty_id" required>
                    <option value=""><%= t('patient.new_case.choose_specialty') %></option>
                    <% (specialties || []).forEach(function(sp){ %>
                      <option value="<%= sp.id %>" <%= ((form && String(form.specialty_id) === String(sp.id)) || ((!form || !form.specialty_id) && selectedSpecialtyId && String(selectedSpecialtyId) === String(sp.id))) ? 'selected' : '' %>><%= sp.name %></option>
                    <% }); %>
                  </select>
                </div>

                <div>
                  <label class="filter-label"><%= t('patient.new_case.service') %></label>
                  <select name="service_id" required>
                    <% if (!services || !services.length) { %>
                      <option value=""><%= t('patient.new_case.no_services') %></option>
                    <% } else { %>
                      <option value=""><%= t('patient.new_case.choose_service') %></option>
                      <% (services || []).forEach(function(sv){ %>
                        <option value="<%= sv.id %>" <%= (form && String(form.service_id) === String(sv.id)) ? 'selected' : '' %>>
                          <%= sv.specialty_name ? '[' + sv.specialty_name + '] ' : '' %><%= sv.name %> (<%= sv.currency || 'EGP' %> <%= (sv.base_price != null) ? sv.base_price : 0 %>)
                        </option>
                      <% }); %>
                    <% } %>
                  </select>
                  <p class="muted" style="font-size:12px; margin-top:4px;"><%= t('patient.new_case.pricing_note') %></p>
                </div>
              </div>

              <div class="form-grid">
                <div>
                  <label class="filter-label"><%= t('patient.new_case.sla') %></label>
                  <div style="display:flex; gap:16px; align-items:center; margin-top:6px;">
                    <label style="display:flex; align-items:center; gap:6px;">
                      <input type="radio" name="sla_option" value="72" <%= (!form || (form.sla_option !== '24' && form.sla_option !== 'vip')) ? 'checked' : '' %> />
                      <span><%= t('patient.new_case.sla_standard') %></span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px;">
                      <input type="radio" name="sla_option" value="24" <%= (form && (form.sla_option === '24' || form.sla_option === 'vip')) ? 'checked' : '' %> />
                      <span><%= t('patient.new_case.sla_priority') %></span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-grid-full">
                  <label class="filter-label"><%= t('patient.new_case.additional_notes') %></label>
                  <textarea name="clinical_question" rows="4" placeholder="<%= t('patient.new_case.additional_notes_ph') %>"><%= (form && form.clinical_question) ? form.clinical_question : '' %></textarea>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-grid-full">
                  <label class="filter-label"><%= t('patient.new_case.medical_history') %></label>
                  <textarea name="medical_history" rows="3" placeholder="<%= t('patient.new_case.medical_history_ph') %>"><%= (form && form.medical_history) ? form.medical_history : '' %></textarea>
                </div>
                <div class="form-grid-full">
                  <label class="filter-label"><%= t('patient.new_case.current_medications') %></label>
                  <textarea name="current_medications" rows="3" placeholder="<%= t('patient.new_case.current_medications_ph') %>"><%= (form && form.current_medications) ? form.current_medications : '' %></textarea>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-grid-full">
                  <label class="filter-label"><%= t('patient.new_case.initial_file_url') %></label>
                  <input type="url" name="initial_file_url" placeholder="https://example.com/scan.pdf" value="<%= (form && form.initial_file_url) ? form.initial_file_url : '' %>" />
                  <p class="muted" style="font-size:12px; margin-top:4px;"><%= t('patient.new_case.upload_later') %></p>
                </div>
              </div>

              <div style="margin-top:10px;">
                <button class="btn btn-primary" type="submit"><%= t('patient.new_case.submit') %></button>
                <a class="btn btn-outline" href="/dashboard" style="margin-left:8px;"><%= isAr ? '→ ' : '← ' %><%= t('common.back_to_dashboard') %></a>
              </div>
            </form>
          </div>
        </main>
      </div>
    </div>
  </div>
</body>
</html>
