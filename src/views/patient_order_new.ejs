<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "حالة جديدة" : "New Case"), layout: "portal", showNav: false }) %>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<% const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa'; %>
<% const fallbackCurrency = (typeof countryCurrency !== 'undefined' && countryCurrency) ? countryCurrency : 'EGP'; %>
<% const uploadcarePublicKeySafe = (typeof uploadcarePublicKey !== 'undefined' && uploadcarePublicKey) ? uploadcarePublicKey : ''; %>
<% const uploaderConfiguredSafe = (typeof uploaderConfigured !== 'undefined') ? uploaderConfigured : false; %>
  <script src="/js/patient_order_new.js" defer></script>
  <script>
    window.UPLOADCARE_PUBLIC_KEY = "<%= String(uploadcarePublicKeySafe || '').trim() %>";
    window.UPLOADCARE_SYSTEM_DIALOG = true;
    window.UPLOADCARE_MULTIPLE = false;
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>

  <div class="portal-shell">
    <div class="portal-header">
      <div class="portal-logo">
        <%= brandSafe %>
        <span><%= t('patient.portal') %></span>
      </div>
    </div>

    <div class="portal-grid">
      <%- include('partials/patient_sidebar', { activePage: 'new_case', isAr: isAr }) %>

      <main class="portal-content">
        <div class="portal-hero">
          <h1 class="portal-hero-title"><%= t('patient.new_case.page_title') %></h1>
          <p class="portal-hero-subtitle"><%= t('patient.new_case.subtitle') %></p>
        </div>

        <div class="flow-card">
          <% if (typeof error !== 'undefined' && error) { %>
            <p><strong><%= error %></strong></p>
          <% } %>

          <form method="post" action="/patient/orders">
            <%- (typeof csrfField === 'function') ? csrfField() : '' %>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.specialty') %></label>
              <select id="specialty_id" name="specialty_id" required class="form-control">
                <option value=""><%= t('patient.new_case.choose_specialty') %></option>
                <% (specialties || []).forEach(function(sp){ %>
                  <option value="<%= sp.id %>" <%= ((form && String(form.specialty_id) === String(sp.id)) || ((!form || !form.specialty_id) && selectedSpecialtyId && String(selectedSpecialtyId) === String(sp.id))) ? 'selected' : '' %>><%= sp.name %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.service') %></label>
              <select id="service_id" name="service_id" required class="form-control">
                <% if (!services || !services.length) { %>
                  <option value="" data-specialty-id=""><%= t('patient.new_case.no_services') %></option>
                <% } else { %>
                  <option value="" data-specialty-id=""><%= t('patient.new_case.choose_service') %></option>
                  <% (services || []).forEach(function(sv){ %>
                    <% const displayPrice = (sv.base_price != null) ? Number(sv.base_price) : null; %>
                    <% const displayCurrency = sv.currency || fallbackCurrency; %>
                    <% const priceLabel = (displayPrice == null) ? (displayCurrency + ' —') : (displayCurrency + ' ' + displayPrice.toLocaleString()); %>
                    <option value="<%= sv.id %>" data-specialty-id="<%= sv.specialty_id %>" <%= (form && String(form.service_id) === String(sv.id)) ? 'selected' : '' %>>
                      <%= sv.specialty_name ? '[' + sv.specialty_name + '] ' : '' %><%= sv.name %> (<%= priceLabel %>)
                    </option>
                  <% }); %>
                <% } %>
              </select>
              <p class="flow-note"><%= t('patient.new_case.pricing_note') %></p>
            </div>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.sla') %></label>
              <label class="form-label">
                <input type="radio" name="sla_option" value="72" <%= (!form || (form.sla_option !== '24' && form.sla_option !== 'vip')) ? 'checked' : '' %> />
                <span><%= t('patient.new_case.sla_standard') %></span>
              </label>
              <label class="form-label">
                <input type="radio" name="sla_option" value="24" <%= (form && (form.sla_option === '24' || form.sla_option === 'vip')) ? 'checked' : '' %> />
                <span><%= t('patient.new_case.sla_priority') %></span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.additional_notes') %></label>
              <textarea name="clinical_question" rows="4" placeholder="<%= t('patient.new_case.additional_notes_ph') %>" class="form-control"><%= (form && form.clinical_question) ? form.clinical_question : '' %></textarea>
            </div>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.medical_history') %></label>
              <textarea name="medical_history" rows="3" placeholder="<%= t('patient.new_case.medical_history_ph') %>" class="form-control"><%= (form && form.medical_history) ? form.medical_history : '' %></textarea>
            </div>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.current_medications') %></label>
              <textarea name="current_medications" rows="3" placeholder="<%= t('patient.new_case.current_medications_ph') %>" class="form-control"><%= (form && form.current_medications) ? form.current_medications : '' %></textarea>
            </div>

            <div class="form-group">
              <label class="form-label"><%= t('patient.new_case.initial_file_url') %></label>

              <% if (!uploaderConfiguredSafe) { %>
                <div style="background:#fff7ed; border:1px solid #fdba74; padding:12px; border-radius:8px; margin-top:8px;">
                  <strong style="color:#9a3412;"><%= isAr ? 'الرفع غير مُفعّل' : 'Uploader not configured' %></strong>
                  <div style="margin-top:6px;">
                    <%= isAr ? 'لم يتم إعداد مفتاح Uploadcare في الخادم. يمكنك إرسال الطلب الآن ثم رفع الملفات من صفحة الحالة بعد الإنشاء.' : 'Uploadcare key is missing. You can submit now and upload files from the order page after creation.' %>
                  </div>
                </div>
                <input type="url" name="initial_file_url" placeholder="https://example.com/scan.pdf" value="<%= (form && form.initial_file_url) ? form.initial_file_url : '' %>" class="form-control" />
              <% } else { %>
                <!-- Keep backend contract: store the Uploadcare CDN URL here -->
                <input type="hidden" name="initial_file_url" id="initial_file_url" value="<%= (form && form.initial_file_url) ? form.initial_file_url : '' %>" />

                <!-- Uploadcare widget (single file) -->
                <input
                  type="hidden"
                  role="uploadcare-uploader"
                  id="uc-uploader"
                  data-public-key="<%= String(uploadcarePublicKeySafe || '').trim() %>"
                  data-multiple="false"
                  data-clearable="true"
                  data-images-only="false"
                  data-tabs="file url"
                />

                <div id="uc-selected" class="flow-note" style="font-size:12px; margin-top:8px; display:none;">
                  <strong><%= isAr ? 'تم اختيار ملف:' : 'File selected:' %></strong>
                  <a id="uc-selected-link" href="#" target="_blank" rel="noopener" style="word-break:break-all;"></a>
                </div>

                <script>
                  (function () {
                    try {
                      if (!window.uploadcare || typeof window.uploadcare.Widget !== 'function') return;
                      var widget = window.uploadcare.Widget('#uc-uploader');
                      var hidden = document.getElementById('initial_file_url');
                      var wrap = document.getElementById('uc-selected');
                      var link = document.getElementById('uc-selected-link');

                      // Prefill if a value already exists
                      if (hidden && hidden.value && wrap && link) {
                        link.href = hidden.value;
                        link.textContent = hidden.value;
                        wrap.style.display = 'block';
                      }

                      widget.onChange(function (file) {
                        if (!file) {
                          if (hidden) hidden.value = '';
                          if (wrap) wrap.style.display = 'none';
                          if (link) { link.href = '#'; link.textContent = ''; }
                          return;
                        }
                        file.done(function (info) {
                          var url = info && info.cdnUrl ? info.cdnUrl : '';
                          if (hidden) hidden.value = url;
                          if (wrap && link && url) {
                            link.href = url;
                            link.textContent = url;
                            wrap.style.display = 'block';
                          }
                        });
                      });
                    } catch (e) {}
                  })();
                </script>
              <% } %>

              <p class="flow-note"><%= t('patient.new_case.upload_later') %></p>
            </div>

            <div class="section-cta">
              <button class="btn btn-primary" type="submit"><%= t('patient.new_case.submit') %></button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>

<%- include('partials/footer', { showFooter: false }) %>
