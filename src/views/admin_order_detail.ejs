<%- include('partials/header', { title: "Order Details", layout: "portal", showNav: false }) %>
  <% 
    function formatEventDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = String(d.getFullYear());
      let hh = d.getHours();
      const min = String(d.getMinutes()).padStart(2, '0');
      const ampm = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12;
      if (hh === 0) hh = 12;
      return `${dd}/${mm}/${yyyy} – ${hh}:${min} ${ampm}`;
    }
  %>
  <div class="layout">
    <header>
      <div class="brand">
        <div class="brand-logo">T</div>
        <div>
          <div class="brand-text-main"><%= brand %></div>
          <div class="brand-text-sub">Admin panel</div>
        </div>
      </div>
      <div class="header-right">
        <%- include('partials/admin_pills', { adminActivePill: 'orders' }) %>
        <div class="lang-switch" style="font-weight:700; opacity:.9;">
          <a href="/lang/en?next=/admin/orders/<%= order.id %>">EN</a> | <a href="/lang/ar?next=/admin/orders/<%= order.id %>">AR</a>
        </div>
        <%- include('partials/user_menu', { menuUser: user, isAr: (typeof lang !== 'undefined' && lang === 'ar'), profileHref: '/admin/profile' }) %>
      </div>
    </header>

    <main>
      <div class="page-shell">
        <div class="page-inner">
          <div class="page-heading page-heading--between">
            <div>
              <h1>Order <%= order.id %></h1>
              <p class="subtitle">
                <%= order.service_name || 'Service' %>
                <% if (order.specialty_name) { %> · <%= order.specialty_name %><% } %>
              </p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <%
                var completedStatuses = ['completed', 'done', 'delivered', 'report_ready', 'report-ready', 'finalized'];
                var isCompleted = completedStatuses.indexOf(String(order.status || '').toLowerCase()) !== -1;
              %>
              <% if (isCompleted) { %>
                <a class="btn btn-primary btn-small" href="/portal/case/<%= order.id %>/report">View Report</a>
              <% } %>
              <a class="btn btn-outline btn-small" href="/admin/orders">&larr; Back to orders</a>
            </div>
          </div>

          <div class="grid two-cols">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Summary</div>
                <span class="status-pill status-pill--<%= (order.status || 'new').toLowerCase() %>"><%= order.status %></span>
              </div>
              <ul class="events-list">
                <li><strong>Patient:</strong> <%= order.patient_name || '—' %> (<%= order.patient_email || '—' %>)</li>
                <li><strong>Doctor:</strong> <%= order.doctor_name || 'Unassigned' %> <%= order.doctor_email ? '(' + order.doctor_email + ')' : '' %></li>
                <li><strong>Specialty:</strong> <%= order.specialty_name || '—' %></li>
                <li><strong>Service:</strong> <%= order.service_name || '—' %></li>
                <li><strong>SLA:</strong> <%= order.sla_hours || '—' %>h</li>
                <li><strong>Status:</strong> <%= order.status %></li>
                <li><strong>Created:</strong> <%= order.created_at || '—' %></li>
                <li><strong>Price:</strong> <%= order.price != null ? Number(order.price).toLocaleString() + ' ' + (order.currency || 'EGP') : '—' %></li>
                <li>
                  <strong>Payment:</strong>
                  <% if (order.payment_status === 'paid' || order.payment_status === 'captured') { %>
                    <span class="status-pill status-pill--completed">Paid</span>
                  <% } else { %>
                    <span class="status-pill status-pill--new"><%= order.payment_status || 'unpaid' %></span>
                  <% } %>
                  <% if (order.payment_method) { %> · <%= order.payment_method %><% } %>
                  <% if (order.payment_reference) { %> · Ref: <%= order.payment_reference %><% } %>
                </li>
              </ul>
              <% if (order.payment_status !== 'paid' && order.payment_status !== 'captured') { %>
                <div style="margin-top:12px; padding-top:12px; border-top:1px solid #f1f5f9;">
                  <form method="post" action="/admin/orders/<%= order.id %>/mark-paid" style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <div style="flex:1; min-width:140px;">
                      <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">Method</label>
                      <select name="payment_method" style="width:100%; padding:6px; border:1px solid #e2e8f0; border-radius:6px;">
                        <option value="manual">Manual</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="cash">Cash</option>
                      </select>
                    </div>
                    <div style="flex:1; min-width:160px;">
                      <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">Reference</label>
                      <input type="text" name="payment_reference" placeholder="e.g. TXN-123" style="width:100%; padding:6px; border:1px solid #e2e8f0; border-radius:6px;" />
                    </div>
                    <button type="submit" class="btn btn-primary btn-small">Mark as Paid</button>
                  </form>
                </div>
              <% } %>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Uploads</div>
                <% if (Number(order.uploads_locked) === 1) { %>
                  <span id="uploadsStatePill" class="status-pill status-pill--breached" data-locked="1">Locked</span>
                <% } else { %>
                  <span id="uploadsStatePill" class="status-pill status-pill--completed" data-locked="0">Unlocked</span>
                <% } %>
              </div>

              <p class="muted" style="margin:6px 0; font-size:12px;">
                If uploads are locked (for example after payment), support/admin can unlock them for the patient to add missing files.
              </p>
              <p class="muted" style="margin:4px 0 0; font-size:12px;">
                Current flag: <strong id="uploadsFlagText"><%= Number(order.uploads_locked) === 1 ? 'uploads_locked = 1' : 'uploads_locked = 0' %></strong>
              </p>

              <div id="uploadsActionMsg" class="muted" style="display:none; margin:8px 0; font-size:12px;"></div>

              <div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; margin-top:10px;">
                <div style="flex:1; min-width:240px;">
                  <label style="font-size:12px; font-weight:700;">Unlock reason (audit)</label>
                  <input id="unlockReason" type="text" placeholder="e.g. patient requested to add missing MRI" value="support_unlock" />
                </div>

                <div id="uploadsCsrf" style="display:none;">
                  <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                </div>

                <button
                  id="unlockUploadsBtn"
                  class="btn btn-outline"
                  type="button"
                  data-action="/admin/orders/<%= order.id %>/uploads/unlock?format=json"
                  style="cursor:pointer; pointer-events:auto !important;"
                >
                  Unlock uploads
                </button>

                <button
                  id="lockUploadsBtn"
                  class="btn btn-outline"
                  type="button"
                  data-action="/admin/orders/<%= order.id %>/uploads/lock?format=json"
                  style="cursor:pointer; pointer-events:auto !important;"
                >
                  Lock uploads
                </button>
              </div>

              <p class="muted" style="font-size:12px; margin-top:8px;">
                This action calls the admin support endpoint and writes an audit event.
              </p>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Additional files request</div>
                <%
                  const afr = (typeof additionalFilesRequest !== 'undefined' && additionalFilesRequest) ? additionalFilesRequest : null;
                  const hasReq = !!(afr && afr.request);
                  const reqAtIso = hasReq && afr.request.at ? afr.request.at : null;
                  const reqMeta = hasReq ? (afr.request.meta || {}) : {};
                  const reqReason = (reqMeta && typeof reqMeta === 'object' && reqMeta.reason) ? String(reqMeta.reason) : '';
                  const reqDoctorId = (reqMeta && typeof reqMeta === 'object' && reqMeta.doctorId) ? String(reqMeta.doctorId) : '';

                  // Fallback: if the request meta was lost/normalized after a support decision,
                  // attempt to recover the doctor reason from the order events list.
                  function _safeParseMeta(m) {
                    if (!m) return null;
                    if (typeof m === 'object') return m;
                    if (typeof m === 'string') {
                      try { return JSON.parse(m); } catch (e) { return null; }
                    }
                    return null;
                  }

                  const fallbackDoctorReason = (!reqReason && typeof events !== 'undefined' && Array.isArray(events) && events.length)
                    ? (function () {
                        for (let i = 0; i < events.length; i++) {
                          const ev = events[i];
                          const metaObj = _safeParseMeta(ev && ev.meta);
                          if (!metaObj || typeof metaObj !== 'object') continue;

                          // We only consider events that clearly look like a doctor-triggered request.
                          // This avoids accidentally picking up upload lock/unlock audit reasons.
                          const hasDoctorMarker = !!(metaObj.doctorId || metaObj.doctor_id || metaObj.doctor);
                          if (!hasDoctorMarker) continue;

                          const r = metaObj.reason || metaObj.doctor_reason || metaObj.doctorReason;
                          if (r) return String(r);
                        }
                        return '';
                      })()
                    : '';

                  const displayReqReason = reqReason || fallbackDoctorReason;

                  const hasDecision = !!(afr && afr.decision);
                  const decisionLabel = hasDecision && afr.decision.label ? String(afr.decision.label).toLowerCase() : '';
                  const decisionAtIso = hasDecision && afr.decision.at ? afr.decision.at : null;
                  const decisionMeta = hasDecision ? (afr.decision.meta || {}) : {};
                  const decisionNote = (decisionMeta && typeof decisionMeta === 'object' && decisionMeta.support_note) ? String(decisionMeta.support_note) : '';

                  const status = afr && afr.pending
                    ? 'pending'
                    : (hasDecision && decisionLabel.includes('approved') ? 'approved'
                      : (hasDecision && (decisionLabel.includes('reject') || decisionLabel.includes('denied')) ? 'rejected'
                        : 'none'));

                  const pillClass = status === 'pending'
                    ? 'status-pill--breached'
                    : (status === 'approved' ? 'status-pill--completed' : 'status-pill--new');
                  const pillText = status === 'pending'
                    ? 'Pending'
                    : (status === 'approved' ? 'Approved' : (status === 'rejected' ? 'Rejected' : 'None'));
                %>
                <span class="status-pill <%= pillClass %>"><%= pillText %></span>
              </div>

              <% if (!hasReq) { %>
                <p class="muted" style="margin:6px 0; font-size:12px;">No additional-files requests for this order.</p>
              <% } else { %>
                <div class="muted" style="font-size:12px; margin:6px 0;">
                  Doctors can request a re-upload when files are unclear/incomplete. Support must approve before the patient is asked.
                </div>

                <div class="muted" style="font-size:12px; margin:6px 0;">
                  <% if (reqAtIso) { %>Requested: <strong><%= formatEventDate(reqAtIso) %></strong><% } %>
                  <% if (reqDoctorId) { %> · Doctor: <strong><%= reqDoctorId %></strong><% } %>
                </div>

                <div style="margin-top:10px;">
                  <div style="font-size:12px; font-weight:700;">Doctor reason</div>
                  <div class="muted" style="font-size:12px; white-space:pre-line; margin-top:4px;"><%= displayReqReason || '—' %></div>
                </div>

                <% if (status !== 'pending' && (decisionAtIso || decisionNote)) { %>
                  <div style="margin-top:12px;">
                    <div style="font-size:12px; font-weight:700;">Last decision</div>
                    <div class="muted" style="font-size:12px; margin-top:4px;">
                      <% if (decisionAtIso) { %>At: <strong><%= formatEventDate(decisionAtIso) %></strong><% } %>
                    </div>
                    <% if (decisionNote) { %>
                      <div class="muted" style="font-size:12px; white-space:pre-line; margin-top:4px;"><%= decisionNote %></div>
                    <% } %>
                  </div>
                <% } %>

                <% if (status === 'pending') { %>
                  <form method="post" action="/admin/orders/<%= order.id %>/additional-files/approve" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <input type="hidden" name="request_event_id" value="<%= afr.request.id %>" />
                    <label style="font-size:12px; font-weight:700;">Support note (optional)</label>
                    <input type="text" name="support_note" placeholder="e.g. approved - ask patient to re-upload clearer axial series" value="" />
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                      <button class="btn btn-primary btn-small" type="submit">Approve request</button>
                    </div>
                  </form>

                  <form method="post" action="/admin/orders/<%= order.id %>/additional-files/reject" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <input type="hidden" name="request_event_id" value="<%= afr.request.id %>" />
                    <label style="font-size:12px; font-weight:700;">Rejection note (optional)</label>
                    <input type="text" name="support_note" placeholder="e.g. rejected - request not specific enough" value="" />
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                      <button class="btn btn-outline btn-small" type="submit">Reject request</button>
                    </div>
                  </form>

                  <p class="muted" style="font-size:12px; margin-top:10px;">Approving moves the case into an “awaiting files” flow and notifies the patient to re-upload. Rejecting logs the decision and keeps the case moving.</p>
                <% } %>
              <% } %>
            </div>
          </div>

          <div class="card" style="margin-top:20px;">
            <div class="card-header">
              <div class="card-title">Reassign doctor</div>
            </div>
            <form method="post" action="/admin/orders/<%= order.id %>/reassign" style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
              <%- (typeof csrfField === 'function') ? csrfField() : '' %>
              <div style="flex:1; min-width:220px;">
                <label class="filter-label">Select doctor</label>
                <select name="doctor_id" required>
                  <option value="">Choose doctor</option>
                  <% (doctors || []).forEach(function(doc){ %>
                    <option value="<%= doc.id %>" <%= order.doctor_id && String(order.doctor_id) === String(doc.id) ? 'selected' : '' %>><%= doc.name %></option>
                  <% }); %>
                </select>
              </div>
              <button class="btn btn-primary" type="submit">Reassign</button>
            </form>
            <p class="muted" style="font-size:12px; margin-top:6px;">Reassigning will notify the new doctor and log an event.</p>
          </div>

          <div class="card" style="margin-top:20px;">
            <div class="card-header">
              <div class="card-title">Latest activity</div>
            </div>
            <ul class="events-list">
              <% if (events && events.length) { %>
                <% events.forEach(function(ev) { %>
                  <li class="event-item">
                    <div class="event-label"><%= ev.label %></div>
                    <div class="event-meta"><%= formatEventDate(ev.at) %></div>
                    <% if (ev.meta) { %>
                      <div class="muted" style="font-size:12px; white-space:pre-line;"><%= (typeof ev.meta === 'string') ? ev.meta : JSON.stringify(ev.meta, null, 2) %></div>
                    <% } %>
                  </li>
                <% }); %>
              <% } else { %>
                <li class="event-item">
                  <div class="event-meta">No events yet.</div>
                </li>
              <% } %>
            </ul>
          </div>
        </div>
      </div>
    </main>
  </div>
<script nonce="<%= (typeof cspNonce !== 'undefined' && cspNonce) ? cspNonce : '' %>">
  (function () {
    const unlockBtn = document.getElementById('unlockUploadsBtn');
    const lockBtn = document.getElementById('lockUploadsBtn');
    const uploadsCsrf = document.getElementById('uploadsCsrf');
    const msg = document.getElementById('uploadsActionMsg');
    const reasonEl = document.getElementById('unlockReason');
    const pill = document.getElementById('uploadsStatePill');
    const flagText = document.getElementById('uploadsFlagText');

    function show(text, isError) {
      if (!msg) return;
      msg.style.display = 'block';
      msg.style.color = isError ? '#b91c1c' : '#065f46';
      msg.textContent = text;
    }

    // Force-clickability in case CSS disables pointer events on buttons
    if (unlockBtn) {
      unlockBtn.style.pointerEvents = 'auto';
      unlockBtn.style.cursor = 'pointer';
    }
    if (lockBtn) {
      lockBtn.style.pointerEvents = 'auto';
      lockBtn.style.cursor = 'pointer';
    }

    // If you can see this message, the JS is running on this page
    if (msg) {
      msg.style.display = 'block';
      msg.style.color = '#334155';
      msg.textContent = 'Uploads controls ready.';
    }

    function setPillLocked(isLocked) {
      if (!pill) return;
      pill.dataset.locked = isLocked ? '1' : '0';
      pill.textContent = isLocked ? 'Locked' : 'Unlocked';
      pill.classList.remove('status-pill--breached', 'status-pill--completed');
      pill.classList.add(isLocked ? 'status-pill--breached' : 'status-pill--completed');
      if (flagText) flagText.textContent = isLocked ? 'uploads_locked = 1' : 'uploads_locked = 0';
    }

    function setButtons(isLocked) {
      // No restrictions: both buttons always clickable.
      // We only style the "recommended" action as primary.
      if (unlockBtn) {
        unlockBtn.disabled = false;
        unlockBtn.classList.remove('btn-primary', 'btn-outline');
        unlockBtn.classList.add(isLocked ? 'btn-primary' : 'btn-outline');
        unlockBtn.textContent = 'Unlock uploads';
        unlockBtn.title = isLocked ? '' : 'Uploads are already unlocked (you can still click to re-apply)';
      }
      if (lockBtn) {
        lockBtn.disabled = false;
        lockBtn.classList.remove('btn-primary', 'btn-outline');
        lockBtn.classList.add(!isLocked ? 'btn-primary' : 'btn-outline');
        lockBtn.textContent = 'Lock uploads';
        lockBtn.title = !isLocked ? '' : 'Uploads are already locked (you can still click to re-apply)';
      }
    }

    function getCsrfToken() {
      const el = uploadsCsrf ? uploadsCsrf.querySelector('input[name="_csrf"]') : null;
      return el && el.value ? String(el.value) : '';
    }

    async function callAction(action) {
      const reason = (reasonEl && reasonEl.value ? reasonEl.value : 'support_change').trim();
      const url = action === 'unlock'
        ? (unlockBtn && unlockBtn.dataset && unlockBtn.dataset.action ? unlockBtn.dataset.action : `/admin/orders/<%= order.id %>/uploads/unlock?format=json`)
        : (lockBtn && lockBtn.dataset && lockBtn.dataset.action ? lockBtn.dataset.action : `/admin/orders/<%= order.id %>/uploads/lock?format=json`);

      const csrf = getCsrfToken();
      if (!csrf) {
        throw new Error('Missing CSRF token on page. Refresh and try again.');
      }

      const body = new URLSearchParams();
      body.set('_csrf', csrf);
      body.set('reason', reason);

      const res = await fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        redirect: 'manual',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        },
        body: body.toString()
      });

      // If the server tries to redirect, we want to fail fast (this used to cause /admin -> /admin/doctors)
      if (res.status >= 300 && res.status < 400) {
        throw new Error('Server redirected (expected JSON). Please refresh and try again.');
      }

      const ct = (res.headers.get('content-type') || '').toLowerCase();
      const data = ct.includes('application/json') ? await res.json().catch(() => null) : null;

      if (!ct.includes('application/json')) {
        throw new Error('Expected JSON response but received HTML.');
      }

      if (!res.ok) {
        const detail = data && (data.error || data.message) ? (data.error || data.message) : (res.status + ' ' + res.statusText);
        throw new Error(detail);
      }

      return data;
    }

    function setBusy(btn, text) {
      if (!btn) return () => {};
      const prevText = btn.textContent;
      const prevDisabled = btn.disabled;
      btn.disabled = true;
      btn.textContent = text;
      return () => {
        btn.disabled = prevDisabled;
        btn.textContent = prevText;
      };
    }

    // Init: ensure button state matches pill state (in case template changes later)
    const initialLocked = pill ? pill.dataset.locked === '1' : (<%= Number(order.uploads_locked) === 1 ? 'true' : 'false' %>);
    setButtons(initialLocked);

    function syncReasonToHidden() {
      const reason = (reasonEl && reasonEl.value ? reasonEl.value : '').trim();
      return reason || 'support_change';
    }

    // Button-driven actions (no form submits). Prevents 302 redirects.
    async function onUnlockClick(e) {
      e.preventDefault();
      syncReasonToHidden();

      const restore = setBusy(unlockBtn, 'Unlocking…');
      const beforeLocked = pill ? pill.dataset.locked === '1' : false;

      show('Unlocking uploads…', false);

      try {
        const data = await callAction('unlock');
        setPillLocked(false);
        setButtons(false);
        show(`Uploads unlocked ✅ (reason: ${data && data.reason ? data.reason : '—'})`, false);
      } catch (err) {
        // Do NOT fall back to normal submit (it redirects to /admin/doctors)
        setPillLocked(beforeLocked);
        setButtons(beforeLocked);
        show(`Unlock failed: ${err.message}`, true);
      } finally {
        restore();
      }
    }

    async function onLockClick(e) {
      e.preventDefault();
      syncReasonToHidden();

      const restore = setBusy(lockBtn, 'Locking…');
      const beforeLocked = pill ? pill.dataset.locked === '1' : true;

      show('Locking uploads…', false);

      try {
        const data = await callAction('lock');
        setPillLocked(true);
        setButtons(true);
        show(`Uploads locked ✅ (reason: ${data && data.reason ? data.reason : '—'})`, false);
      } catch (err) {
        // Do NOT fall back to normal submit (it redirects to /admin/doctors)
        setPillLocked(beforeLocked);
        setButtons(beforeLocked);
        show(`Lock failed: ${err.message}`, true);
      } finally {
        restore();
      }
    }

    if (unlockBtn) unlockBtn.addEventListener('click', onUnlockClick);
    if (lockBtn) lockBtn.addEventListener('click', onLockClick);
  })();
</script>

<%- include('partials/footer') %>
