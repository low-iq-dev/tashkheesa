<%
  const baseTitle = (typeof title !== 'undefined' && title) ? String(title) : 'Tashkheesa';
  const pageTitle = baseTitle.includes('Tashkheesa') ? baseTitle : `${baseTitle} – Tashkheesa`;
  const pageLang = (typeof lang !== 'undefined' && lang)
    ? lang
    : ((typeof locals !== 'undefined' && locals && locals.lang)
        ? locals.lang
        : ((typeof locals !== 'undefined' && locals && locals.user && locals.user.lang)
            ? locals.user.lang
            : 'en'));
  const pageDir = (String(pageLang).toLowerCase() === 'ar') ? 'rtl' : 'ltr';
  const isAr = (String(pageLang).toLowerCase() === 'ar');
  const portalBrand = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  const usePortalFrame = Boolean((typeof portalFrame !== 'undefined') ? portalFrame : false);
  const roleHint = (typeof locals !== 'undefined' && locals && locals.user && locals.user.role)
    ? String(locals.user.role).toLowerCase()
    : '';
  const portalRoleName = (typeof portalRole !== 'undefined' && portalRole)
    ? String(portalRole).toLowerCase()
    : (roleHint === 'superadmin' ? 'superadmin' : 'doctor');
  const isSuperadminFrame = portalRoleName === 'superadmin';
  const activeNav = (typeof portalActive !== 'undefined' && portalActive) ? String(portalActive) : '';
  const nextPath = (typeof portalNext !== 'undefined' && portalNext)
    ? String(portalNext)
    : (isSuperadminFrame ? '/superadmin' : '/portal/doctor');
  const portalLabel = isSuperadminFrame
    ? (isAr ? 'بوابة المشرف' : 'Superadmin Portal')
    : (isAr ? 'بوابة الطبيب' : 'Doctor Portal');
  const showSuperadminAlertDot = Boolean(
    (typeof hasUnseenAlerts !== 'undefined')
      ? hasUnseenAlerts
      : ((typeof locals !== 'undefined' && locals) ? locals.hasUnseenAlerts : false)
  );

  function isActive(key) {
    return activeNav === key ? 'active' : '';
  }
%>
<!DOCTYPE html>
<html lang="<%= pageLang %>" dir="<%= pageDir %>">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= pageTitle %></title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/portal-variables.css" />
  <link rel="stylesheet" href="/css/portal-components.css" />
  <link rel="stylesheet" href="/css/portal-global.css" />
  <link rel="stylesheet" href="/css/annotator.css" />
  <link rel="stylesheet" href="/css/admin-styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <link rel="icon" href="/favicon.ico" />
</head>
<body class="layout layout-portal<% if (isSuperadminFrame) { %> admin-theme<% } %>">

<% if (usePortalFrame) { %>
  <div class="portal-shell">
    <button class="portal-sidebar-toggle" onclick="document.querySelector('.portal-sidebar').classList.toggle('open');document.querySelector('.portal-sidebar-overlay').classList.toggle('active');" aria-label="Toggle menu">&#9776;</button>
    <div class="portal-sidebar-overlay" onclick="document.querySelector('.portal-sidebar').classList.remove('open');this.classList.remove('active');"></div>
    <div class="portal-header">
      <div class="portal-logo">
        <%= portalBrand %>
        <span><%= portalLabel %></span>
      </div>
    </div>

    <div class="portal-grid">
      <aside class="portal-sidebar">
        <% if (isSuperadminFrame) { %>
        <ul class="portal-nav">
          <li><a href="/superadmin" class="<%= isActive('dashboard') %>"><%= isAr ? 'لوحة التحكم' : 'Dashboard' %></a></li>
          <li><a href="/admin/orders" class="<%= isActive('orders') %>"><%= isAr ? 'الطلبات' : 'Orders' %></a></li>
          <li><a href="/superadmin/doctors" class="<%= isActive('doctors') %>"><%= isAr ? 'الأطباء' : 'Doctors' %></a></li>
          <li><a href="/superadmin/services" class="<%= isActive('services') %>"><%= isAr ? 'الخدمات' : 'Services' %></a></li>
          <li><a href="/admin/pricing" class="<%= isActive('pricing') %>"><%= isAr ? 'التسعير' : 'Pricing' %></a></li>
          <li><a href="/portal/admin/analytics" class="<%= isActive('analytics') %>"><%= isAr ? 'التحليلات' : 'Analytics' %></a></li>
          <li><a href="/admin/reviews" class="<%= isActive('reviews') %>"><%= isAr ? 'المراجعات' : 'Reviews' %></a></li>
          <li><a href="/portal/admin/referrals" class="<%= isActive('referrals') %>"><%= isAr ? 'الإحالات' : 'Referrals' %></a></li>
          <li><a href="/portal/admin/campaigns" class="<%= isActive('campaigns') %>"><%= isAr ? 'الحملات' : 'Campaigns' %></a></li>
          <li><a href="/admin/errors" class="<%= isActive('errors') %>"><%= isAr ? 'سجل الأخطاء' : 'Error Log' %></a></li>
          <li><a href="/superadmin/events" class="<%= isActive('events') %>"><%= isAr ? 'سجل التدقيق' : 'Audit Log' %></a></li>
          <li>
            <a href="/superadmin/alerts" class="<%= isActive('alerts') %>">
              <%= isAr ? 'التنبيهات' : 'Alerts' %>
              <% if (showSuperadminAlertDot) { %>
                <span class="alert-dot" aria-label="<%= isAr ? 'تنبيهات غير مقروءة' : 'Unseen alerts' %>" title="<%= isAr ? 'تنبيهات غير مقروءة' : 'Unseen alerts' %>"></span>
              <% } %>
            </a>
          </li>
          <li><a href="/superadmin/profile" class="<%= isActive('profile') %>"><%= isAr ? 'الملف الشخصي' : 'Profile' %></a></li>
        </ul>
        <% } else { %>
        <ul class="portal-nav">
          <li><a href="/portal/doctor" class="<%= isActive('dashboard') %>"><%= isAr ? 'لوحة التحكم' : 'Dashboard' %></a></li>
          <li><a href="/portal/doctor/queue" class="<%= isActive('queue') %>"><%= isAr ? 'الحالات' : 'Case Queue' %></a></li>
          <li><a href="/portal/doctor/appointments" class="<%= isActive('appointments') %>"><%= isAr ? 'المواعيد' : 'Appointments' %></a></li>
          <li><a href="/portal/messages" class="<%= isActive('messages') %>"><%= isAr ? 'الرسائل' : 'Messages' %></a></li>
          <li><a href="/portal/doctor/prescriptions" class="<%= isActive('prescriptions') %>"><%= isAr ? 'الوصفات' : 'Prescriptions' %></a></li>
          <li><a href="/portal/doctor/reviews" class="<%= isActive('reviews') %>"><%= isAr ? 'التقييمات' : 'Reviews' %></a></li>
          <li><a href="/portal/doctor/analytics" class="<%= isActive('analytics') %>"><%= isAr ? 'تحليلاتي' : 'My Analytics' %></a></li>
          <li><a href="/portal/doctor/alerts" class="<%= isActive('alerts') %>"><%= isAr ? 'التنبيهات' : 'Alerts' %></a></li>
          <li><a href="/portal/doctor/profile" class="<%= isActive('profile') %>"><%= isAr ? 'الملف الشخصي' : 'Profile' %></a></li>
        </ul>
        <% } %>

        <div class="section-cta">
          <a class="btn btn-secondary btn-full" href="/lang/en?next=<%= encodeURIComponent(typeof currentUrl !== 'undefined' ? currentUrl : nextPath) %>">EN</a>
          <a class="btn btn-secondary btn-full" href="/lang/ar?next=<%= encodeURIComponent(typeof currentUrl !== 'undefined' ? currentUrl : nextPath) %>">AR</a>
        </div>

        <form method="post" action="/logout">
          <%- (typeof csrfField === 'function') ? csrfField() : '' %>
          <button type="submit" class="btn btn-secondary btn-full"><%= isAr ? 'تسجيل الخروج' : 'Logout' %></button>
        </form>
      </aside>

      <main id="main-content" class="portal-content">
<% } else { %>
<div id="main-content">
<% } %>
