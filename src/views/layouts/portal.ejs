<%
  const baseTitle = (typeof title !== 'undefined' && title) ? String(title) : 'Tashkheesa';
  const pageTitle = baseTitle.includes('Tashkheesa') ? baseTitle : `${baseTitle} – Tashkheesa`;
  const pageLang = (typeof lang !== 'undefined' && lang)
    ? lang
    : ((typeof locals !== 'undefined' && locals && locals.lang)
        ? locals.lang
        : ((typeof locals !== 'undefined' && locals && locals.user && locals.user.lang)
            ? locals.user.lang
            : 'en'));
  const pageDir = (String(pageLang).toLowerCase() === 'ar') ? 'rtl' : 'ltr';
  const isAr = (String(pageLang).toLowerCase() === 'ar');
  const portalBrand = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  const usePortalFrame = Boolean((typeof portalFrame !== 'undefined') ? portalFrame : false);
  const activeNav = (typeof portalActive !== 'undefined' && portalActive) ? String(portalActive) : '';
  const nextPath = (typeof portalNext !== 'undefined' && portalNext) ? String(portalNext) : '/portal/doctor';

  function isActive(key) {
    return activeNav === key ? 'active' : '';
  }
%>
<!DOCTYPE html>
<html lang="<%= pageLang %>" dir="<%= pageDir %>">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= pageTitle %></title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" href="/favicon.ico" />
</head>
<body class="layout layout-portal">

<% if (usePortalFrame) { %>
  <div class="portal-shell">
    <div class="portal-header">
      <div class="portal-logo">
        <%= portalBrand %>
        <span><%= isAr ? 'بوابة الطبيب' : 'Doctor Portal' %></span>
      </div>
    </div>

    <div class="portal-grid">
      <aside class="portal-sidebar">
        <ul class="portal-nav">
          <li><a href="/portal/doctor" class="<%= isActive('dashboard') %>"><%= isAr ? 'لوحة التحكم' : 'Dashboard' %></a></li>
          <li><a href="/portal/doctor/alerts" class="<%= isActive('alerts') %>"><%= isAr ? 'التنبيهات' : 'Alerts' %></a></li>
          <li><a href="/portal/doctor/profile" class="<%= isActive('profile') %>"><%= isAr ? 'الملف الشخصي' : 'Profile' %></a></li>
        </ul>

        <div class="section-cta">
          <a class="btn btn-secondary btn-full" href="/lang/en?next=<%= encodeURIComponent(nextPath) %>">EN</a>
          <a class="btn btn-secondary btn-full" href="/lang/ar?next=<%= encodeURIComponent(nextPath) %>">AR</a>
        </div>

        <form method="post" action="/logout">
          <%- (typeof csrfField === 'function') ? csrfField() : '' %>
          <button type="submit" class="btn btn-secondary btn-full"><%= isAr ? 'تسجيل الخروج' : 'Logout' %></button>
        </form>
      </aside>

      <main id="main-content" class="portal-content">
<% } else { %>
<main id="main-content" class="app-shell">
<% } %>
