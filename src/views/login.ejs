<%- include('partials/header', { title: 'login.ejs' }) %>
<% const effectiveLang = (typeof lang !== 'undefined' && lang) ? lang : 'en'; %>
<% const isAr = (effectiveLang === 'ar'); %>
<% const tFn = (typeof t === 'function') ? t : ((k) => k); %>
<% const tr = (key, en, ar) => {
     const v = tFn(key);
     if (v && v !== key) return v;
     return isAr ? ar : en;
   };
%>
  <% const nextHref = '/login' + ((typeof next !== 'undefined' && next) ? ('?next=' + encodeURIComponent(next)) : ''); %>
  <div class="page-shell">
    <div class="page-inner login-centered">
      <div class="card login-card">
        <div class="auth-header">
          <div class="brand">
            <div class="brand-logo">T</div>
            <div>
              <div class="brand-text-main"><%= brand || 'Tashkheesa' %></div>
              <div class="brand-text-sub"><%= tr('brand.subtitle','Second opinions, done right','رأي طبي ثانٍ… بالطريقة الصحيحة') %></div>
            </div>
          </div>
          <div class="lang-switch">
            <a href="/lang/en?next=<%= encodeURIComponent(nextHref) %>">EN</a> | <a href="/lang/ar?next=<%= encodeURIComponent(nextHref) %>">AR</a>
          </div>
        </div>

        <h1><%= tr('auth.login.title','Login','تسجيل الدخول') %></h1>
        <p class="subtitle"><%= tr('auth.login.subtitle','Access your portal securely.','ادخل إلى حسابك بأمان.') %></p>

        <% 
          const normalizeErr = (e) => String(e || '').trim();
          const err = normalizeErr(error);
          const errorKeyMap = {
            'Email and password are required.': 'auth.errors.email_password_required',
            'Invalid email or password.': 'auth.errors.invalid_credentials',
            'Your account is locked. Please contact support.': 'auth.errors.account_locked',
            'Access denied.': 'auth.errors.access_denied'
          };
          const key = err && errorKeyMap[err];
          const errorFallbacks = {
            'auth.errors.email_password_required': { en: 'Email and password are required.', ar: 'البريد الإلكتروني وكلمة المرور مطلوبان.' },
            'auth.errors.invalid_credentials': { en: 'Invalid email or password.', ar: 'البريد الإلكتروني أو كلمة المرور غير صحيحة.' },
            'auth.errors.account_locked': { en: 'Your account is locked. Please contact support.', ar: 'تم قفل حسابك. يرجى التواصل مع الدعم.' },
            'auth.errors.access_denied': { en: 'Access denied.', ar: 'غير مصرح بالدخول.' }
          };
          const fb = key && errorFallbacks[key] ? errorFallbacks[key] : null;
          const displayError = key ? tr(key, fb ? fb.en : err, fb ? fb.ar : err) : err;
        %>
        <% if (err) { %>
          <div class="error"><%= displayError %></div>
        <% } %>

        <form method="post" action="/login">
          <%- (typeof csrfField === 'function') ? csrfField() : '' %>
          <% if (typeof next !== 'undefined' && next) { %>
            <input type="hidden" name="next" value="<%= next %>">
          <% } %>
          <label class="input-label"><%= tr('auth.login.email','Email','البريد الإلكتروني') %></label>
          <input class="input-field" type="email" name="email" autocomplete="email" required />

          <label class="input-label"><%= tr('auth.login.password','Password','كلمة المرور') %></label>
          <input class="input-field" type="password" name="password" autocomplete="current-password" required />

          <div class="actions" style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:6px;">
            <button class="btn btn-primary" type="submit"><%= tr('auth.login.submit','Sign in','تسجيل الدخول') %></button>
            <a class="link-muted" href="/register"><%= tr('auth.login.register','Create account','إنشاء حساب') %></a>
          </div>
          <div style="margin-top:8px;">
            <a class="link-muted" href="/forgot-password"><%= tr('auth.login.forgot','Forgot password?','نسيت كلمة المرور؟') %></a>
          </div>
          <div style="margin-top:6px;">
            <a class="link-muted" href="/case/new"><%= tr('auth.login.guest_submit','Submit a case as guest','إرسال حالة كضيف') %></a>
          </div>
        </form>

        <div class="footer" style="margin-top:12px; font-size:12px; color: var(--text-muted); text-align:center;">
          © <%= new Date().getFullYear() %> · <%= brand || 'Tashkheesa' %> · <%= tr('brand.footer','All rights reserved','جميع الحقوق محفوظة') %>
        </div>
      </div>
    </div>
  </div>