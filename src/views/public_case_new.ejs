<%- include('partials/header') %>
  <% 
    var isAr = (typeof lang !== 'undefined' && lang === 'ar');
    var specialtyMap = {};
    (specialties || []).forEach(function(sp){ specialtyMap[sp.id] = sp.name; });
  %>
  <div class="page-shell">
    <div class="page-inner">
      <header>
        <div class="brand">
          <div class="brand-logo">T</div>
          <div>
            <div class="brand-text-main">Tashkheesa</div>
            <div class="brand-text-sub"><%= isAr ? 'إرسال حالة (عام)' : 'Public case submission' %></div>
          </div>
        </div>
        <div class="header-right">
          <div class="lang-switch" style="font-weight:700; opacity:.9;">
            <a href="/lang/en?next=/case/new">EN</a> | <a href="/lang/ar?next=/case/new">AR</a>
          </div>
          <a class="pill" href="/"><%= isAr ? 'الرئيسية' : 'Home' %></a>
          <a class="pill" href="/login"><%= isAr ? 'تسجيل الدخول' : 'Portal login' %></a>
        </div>
      </header>

      <main>
        <div class="page-heading">
          <div>
            <h1><%= isAr ? 'ابدأ حالتك على تشخيصة' : 'Start your Tashkheesa case' %></h1>
            <p class="subtitle"><%= isAr ? 'قدّم حالتك الطبية بشكل آمن. سيقوم فريقنا بالمراجعة وتعيين الاختصاصي المناسب.' : 'Submit your medical case securely. Our team will review and assign the right specialist.' %></p>
          </div>
        </div>

        <% if (error) { %>
          <div class="card" style="background:#fef2f2; border:1px solid #fecdd3; color:#991b1b; margin-bottom:12px;">
            <%= error %>
          </div>
        <% } %>

        <div class="card">
          <form method="post" action="/case/new" class="form-grid" style="row-gap:14px;">
            <%- (typeof csrfField === 'function') ? csrfField() : '' %>
            <div class="form-group">
              <label><%= isAr ? 'الاسم بالكامل' : 'Full name' %></label>
              <input type="text" name="patient_name" value="<%= (form && form.patient_name) || '' %>" required />
            </div>
            <div class="form-group">
              <label><%= isAr ? 'البريد الإلكتروني' : 'Email' %></label>
              <input type="email" name="patient_email" value="<%= (form && form.patient_email) || '' %>" required />
            </div>
            <div class="form-group">
              <label><%= isAr ? 'رقم الهاتف (اختياري)' : 'Phone (optional)' %></label>
              <input type="text" name="patient_phone" value="<%= (form && form.patient_phone) || '' %>" />
            </div>
            <div class="form-group">
              <label><%= isAr ? 'اللغة المفضلة' : 'Preferred language' %></label>
              <select name="patient_lang">
                <option value="en" <%= !form || form.patient_lang === 'en' ? 'selected' : '' %>>English</option>
                <option value="ar" <%= form && form.patient_lang === 'ar' ? 'selected' : '' %>>العربية</option>
              </select>
            </div>

            <div class="form-group">
              <label><%= isAr ? 'التخصص' : 'Specialty' %></label>
              <select name="specialty_id" required>
                <option value=""><%= isAr ? 'اختر التخصص' : 'Select specialty' %></option>
                <% specialties.forEach(function(sp){ %>
                  <option value="<%= sp.id %>" <%= form && form.specialty_id == sp.id ? 'selected' : '' %>><%= sp.name %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group" style="grid-column:1 / -1;">
              <label><%= isAr ? 'الخدمة' : 'Service' %></label>
              <select name="service_id" required>
                <option value=""><%= isAr ? 'اختر الخدمة' : 'Select service' %></option>
                <% services.forEach(function(sv){ %>
                  <option value="<%= sv.id %>" <%= form && form.service_id == sv.id ? 'selected' : '' %>>
                    <%= specialtyMap[sv.specialty_id] ? specialtyMap[sv.specialty_id] + ' – ' : '' %><%= sv.name %>
                  </option>
                <% }); %>
              </select>
            </div>

            <div class="form-group">
              <label><%= isAr ? 'مدة التسليم' : 'SLA' %></label>
              <div style="display:flex; gap:12px; align-items:center;">
                <label><input type="radio" name="sla_type" value="72" <%= (!form || form.sla_type !== '24') ? 'checked' : '' %> /> <%= isAr ? 'عادي ٧٢ ساعة' : 'Standard 72h' %></label>
                <label><input type="radio" name="sla_type" value="24" <%= form && form.sla_type === '24' ? 'checked' : '' %> /> <%= isAr ? 'VIP خلال ٢٤ ساعة' : 'VIP 24h' %></label>
              </div>
            </div>

            <div class="form-group" style="grid-column:1 / -1;">
              <label><%= isAr ? 'ملاحظات سريرية (اختياري)' : 'Clinical notes (optional)' %></label>
              <textarea name="clinical_notes" rows="4" placeholder="<%= isAr ? 'اكتب وصفاً مختصراً للحالة' : 'Describe your case' %>"><%= (form && form.clinical_notes) || '' %></textarea>
            </div>

            <div class="form-group" style="grid-column:1 / -1;">
              <label><%= isAr ? 'رابط ملف ١ (اختياري)' : 'File URL 1 (optional)' %></label>
              <input type="url" name="file_url_1" placeholder="<%= isAr ? 'الصق رابطاً آمناً للتصوير/التقرير (Uploadcare/Drive...)' : 'Paste a secure link to your imaging/report (Uploadcare/Drive/etc.)' %>" value="<%= (form && form.file_url_1) || '' %>" />
            </div>
            <div class="form-group" style="grid-column:1 / -1;">
              <label><%= isAr ? 'رابط ملف ٢ (اختياري)' : 'File URL 2 (optional)' %></label>
              <input type="url" name="file_url_2" placeholder="<%= isAr ? 'الصق رابطاً آمناً للتصوير/التقرير (Uploadcare/Drive...)' : 'Paste a secure link to your imaging/report (Uploadcare/Drive/etc.)' %>" value="<%= (form && form.file_url_2) || '' %>" />
            </div>

            <div style="grid-column:1 / -1; display:flex; justify-content:flex-end;">
              <button class="btn btn-primary" type="submit"><%= isAr ? 'إرسال الحالة' : 'Submit case' %></button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>
<%- include('partials/footer') %>
