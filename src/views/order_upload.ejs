<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "رفع الملفات" : "Upload Files"), layout: "public", showNav: false, showFooter: false }) %>
<%
  const form = typeof locals.form !== 'undefined' ? locals.form : {};
  const specialties = Array.isArray(locals.specialties) ? locals.specialties : [];
  const services = Array.isArray(locals.services) ? locals.services : [];
  const pageLang = (typeof lang !== 'undefined' && lang)
    ? lang
    : ((typeof dir !== 'undefined' && dir === 'rtl') ? 'ar' : 'en');
  const isAr = pageLang === 'ar';
  const tr = function(enText, arText) { return isAr ? arText : enText; };
  const localizeError = function(msg) {
    if (!msg) return '';
    const s = String(msg);
    if (!isAr) return s;
    const map = {
      'Email and phone are required to continue.': 'الاسم والبريد الإلكتروني ورقم الهاتف مطلوبة للمتابعة.',
      'You must accept the Terms & Privacy Policy before continuing.': 'يجب الموافقة على الشروط وسياسة الخصوصية قبل المتابعة.',
      'Please select a specialty and service.': 'يرجى اختيار التخصص والخدمة.'
    };
    return map[s] || s;
  };
%>

<div class="page-shell">
  <div class="page-inner">
    <div class="portal-hero">
      <h1 class="portal-hero-title"><%= tr('Upload your medical files', 'ارفع ملفاتك الطبية') %></h1>
      <p class="portal-hero-subtitle"><%= tr('Submit your scans, lab results, or reports so a specialist can begin reviewing your order.', 'أرسل الأشعة أو التحاليل أو التقارير حتى يبدأ الطبيب المختص مراجعة حالتك.') %></p>
      <p class="flow-note"><%= tr('Secure upload · Specialist review · 72h standard · 24h fast track', 'رفع آمن · مراجعة اختصاصي · ٧٢ ساعة عادي · ٢٤ ساعة سريع') %></p>
    </div>

    <form method="post" action="/order/<%= sessionToken %>/review" enctype="multipart/form-data">
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="flow-card soft">
          <p class="flow-note"><strong><%= localizeError(error) %></strong></p>
        </div>
      <% } %>
      <%- (typeof csrfField === 'function') ? csrfField() : '' %>
<div class="form-group">
  <label class="form-label"><%= tr('Full name', 'الاسم الكامل') %></label>
  <input type="text" name="patient_name" autocomplete="name" required class="form-control" value="<%= form.patient_name || '' %>" />
</div>

<div class="form-group">
  <label class="form-label"><%= tr('Email', 'البريد الإلكتروني') %></label>
  <input type="email" name="patient_email" autocomplete="email" required class="form-control" value="<%= form.patient_email || '' %>" />
</div>

<div class="form-group">
  <label class="form-label"><%= tr('Phone', 'رقم الهاتف') %></label>
  <input type="tel" name="patient_phone" autocomplete="tel" required pattern="^[0-9+\s()-]{7,}$" class="form-control" value="<%= form.patient_phone || '' %>" />
</div>
<input type="hidden" name="identity_captured" value="1" />
      <div class="flow-grid">
        <div class="flow-column">
          <section class="flow-card">
            <h2><%= tr('Files', 'الملفات') %></h2>
            <p class="flow-note"><%= tr('Accepted formats: PDF · DICOM (zip) · JPG/PNG · DOC/DOCX', 'الصيغ المقبولة: PDF · DICOM (zip) · JPG/PNG · DOC/DOCX') %></p>

            <div class="upload-dropzone" id="file-drop" role="group" aria-label="<%= tr('Upload files', 'رفع الملفات') %>">
              <input id="file-input" name="files" type="file" multiple required accept="application/pdf,image/*,.zip,.dcm,.doc,.docx" aria-required="true" aria-describedby="file-help" class="form-control" />
              <div>
                <strong><%= tr('Drag & drop files', 'اسحب الملفات وأفلتها') %></strong>
                <p><%= tr('or click to browse from your device.', 'أو اضغط للاختيار من جهازك.') %></p>
                <p class="flow-note"><%= tr('Recommended: one ZIP for DICOM folders.', 'يُفضّل رفع مجلدات DICOM في ملف ZIP واحد.') %></p>
                <p id="file-help" class="flow-note"><%= tr('Accepted formats: PDF, images, ZIP (DICOM), DOC/DOCX.', 'الصيغ المقبولة: PDF، صور، ZIP (DICOM)، DOC/DOCX.') %></p>
              </div>
            </div>

            <div id="file-list">
              <% if (existingFiles && existingFiles.length) { %>
                <ul>
                  <% existingFiles.forEach(function(f){ %>
                    <li><%= f.label || f.url %></li>
                  <% }) %>
                </ul>
              <% } else { %>
                <p class="flow-note"><%= tr('No files uploaded yet.', 'لا توجد ملفات مرفوعة بعد.') %></p>
              <% } %>
            </div>
          </section>
        </div>
        <div class="flow-column">
          <section class="flow-card">
            <h2><%= tr('Order details', 'تفاصيل الحالة') %></h2>
            <p class="flow-note"><%= tr('This helps us route your order to the right specialist.', 'يساعدنا هذا في توجيه الحالة للطبيب المختص المناسب.') %></p>

            <div class="form-group">
              <label class="form-label" for="specialty_id"><%= tr('Medical specialty', 'التخصص الطبي') %></label>
              <select id="specialty_id" name="specialty_id" required class="form-control">
                <option value=""><%= tr('Select a specialty', 'اختر التخصص') %></option>
                <% (specialties || []).forEach(function(sp){ %>
                  <option value="<%= sp.id %>" <%= (form.specialty_id == sp.id) ? 'selected' : '' %>><%= sp.name %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="service_id"><%= tr('Medical service', 'الخدمة الطبية') %></label>
              <select id="service_id" name="service_id" required class="form-control">
                <option value=""><%= tr('Select a service', 'اختر الخدمة') %></option>
                <% (services || []).forEach(function(sv){ %>
                  <option value="<%= sv.id %>" data-specialty-id="<%= sv.specialty_id %>" <%= (form.service_id == sv.id) ? 'selected' : '' %>><%= sv.name %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="language"><%= tr('Preferred report language', 'لغة التقرير المفضلة') %></label>
              <select id="language" name="language" class="form-control">
                <option value="en" <%= (form.language === 'en') ? 'selected' : '' %>>English</option>
                <option value="ar" <%= (form.language === 'ar') ? 'selected' : '' %>>العربية</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="reason"><%= tr('Reason for review', 'سبب طلب المراجعة') %></label>
              <textarea id="reason" name="reason" rows="4" required placeholder="<%= tr('Briefly explain the medical question you need clarified', 'اشرح باختصار السؤال الطبي الذي تحتاج توضيحه') %>" class="form-control"><%= form.reason || '' %></textarea>
              <p class="flow-note"><%= tr('Example: “Is this lesion benign or malignant?” “Do these labs explain my symptoms?”', 'مثال: «هل هذه الآفة حميدة أم خبيثة؟» «هل تفسر هذه التحاليل الأعراض؟»') %></p>
            </div>

            <div class="form-group">
              <label class="form-label" for="urgency"><%= tr('Urgency', 'درجة الاستعجال') %></label>
              <select id="urgency" name="urgency" class="form-control" required>
                <option value="standard" <%= (form.urgency === 'standard') ? 'selected' : '' %>><%= tr('Standard · 72 hours', 'عادي · ٧٢ ساعة') %></option>
                <option value="priority" <%= (form.urgency === 'priority') ? 'selected' : '' %>><%= tr('Priority · 24 hours', 'أولوية · ٢٤ ساعة') %></option>
              </select>
              <p class="flow-note"><%= tr('Priority cases are fast-tracked and monitored more aggressively.', 'حالات الأولوية تُراجع بشكل أسرع مع متابعة أعلى.') %></p>
            </div>
          </section>
        </div> 
      </div>

      <section class="flow-card">
        <h2><%= tr('Consent', 'الموافقة') %></h2>
        <p class="flow-note"><%= tr('We only use your files to produce your written specialist review.', 'نستخدم ملفاتك فقط لإعداد تقرير المراجعة الطبية المكتوب.') %></p>

        <% if (typeof consentError !== 'undefined' && consentError) { %>
          <p class="flow-note"><strong><%= localizeError(consentError) %></strong></p>
        <% } %>

        <div class="form-group consent-box">
          <label class="form-label">
            <input type="checkbox" name="consent" required />
            <span><%= tr('I confirm that I am the patient or have legal authority to submit this medical order, and I agree to the', 'أؤكد أنني المريض أو لدي تفويض قانوني لإرسال هذه الحالة الطبية، وأوافق على') %> <a href="/terms" target="_blank"><%= tr('Terms of Service', 'شروط الخدمة') %></a> <%= tr('and', 'و') %> <a href="/privacy" target="_blank"><%= tr('Privacy Policy', 'سياسة الخصوصية') %></a>.</span>
          </label>
        </div>
      </section>

      <section class="flow-card">
        <div class="section-cta">
          <button type="submit" class="btn btn-primary"><%= tr('Continue to Review', 'المتابعة إلى المراجعة') %></button>
          <div class="flow-note"><%= tr('Next: confirm details, then proceed to payment.', 'الخطوة التالية: تأكيد البيانات ثم المتابعة إلى الدفع.') %></div>
        </div>
      </section>

    </form>
  </div>
</div>

<script>
(function () {
  const fileInput = document.getElementById('file-input');
  const listNode = document.getElementById('file-list');
  const dropZone = document.getElementById('file-drop');

  function updateFileList(files) {
    const names = Array.from(files || []).map((file) => file.name);
    if (!names.length) {
      listNode.textContent = <%- JSON.stringify(tr('No files uploaded yet.', 'لا توجد ملفات مرفوعة بعد.')) %>;
      return;
    }
    listNode.innerHTML = '';
    const ul = document.createElement('ul');
    names.forEach((name) => {
      const li = document.createElement('li');
      li.textContent = name;
      ul.appendChild(li);
    });
    listNode.appendChild(ul);
  }

  fileInput.addEventListener('change', function () {
    updateFileList(this.files);
  });

  dropZone.addEventListener('dragover', function (event) {
    event.preventDefault();
    dropZone.classList.add('active');
  });

  dropZone.addEventListener('dragleave', function () {
    dropZone.classList.remove('active');
  });

  dropZone.addEventListener('drop', function (event) {
    event.preventDefault();
    dropZone.classList.remove('active');
    const files = event.dataTransfer.files;

    try {
      const dt = new DataTransfer();
      Array.from(files || []).forEach((f) => dt.items.add(f));
      fileInput.files = dt.files;
    } catch (e) {}

    updateFileList(files);
  });

  document.querySelector('form').addEventListener('submit', function (e) {
    const name = document.querySelector('[name="patient_name"]').value;
    const email = document.querySelector('[name="patient_email"]').value;
    const phone = document.querySelector('[name="patient_phone"]').value;
    if (!name || !email || !phone) {
      e.preventDefault();
      alert(<%- JSON.stringify(tr('Please enter your name, email, and phone number.', 'يرجى إدخال الاسم والبريد الإلكتروني ورقم الهاتف.')) %>);
      return;
    }
    if (!fileInput.files || !fileInput.files.length) {
      e.preventDefault();
      alert(<%- JSON.stringify(tr('Please upload at least one medical file.', 'يرجى رفع ملف طبي واحد على الأقل.')) %>);
    }
  });
})();
</script>

<%- include('partials/footer', { showFooter: false }) %>
