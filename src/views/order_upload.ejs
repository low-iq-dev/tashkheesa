<%- include('partials/header', { title: 'order_upload.ejs' }) %>
  <div class="page-shell">
    <div class="page-inner">
      <header>
        <div class="brand">
          <div class="brand-logo">T</div>
          <div>
            <div class="brand-text-main">Tashkheesa</div>
            <div class="brand-text-sub">Start Your Order</div>
          </div>
        </div>
      </header>

      <main>
        <div class="page-heading">
          <div>
            <h1>Upload your files</h1>
            <p class="subtitle">Submit imaging, labs, and reports so a consultant specialist can begin their review.</p>
          </div>
        </div>

        <div class="flow-card">
          <form method="post" action="/order/review" enctype="multipart/form-data">
            <%- (typeof csrfField === 'function') ? csrfField() : '' %>
            <label class="flow-label">Accepted file types</label>
            <div class="flow-note">PDF · DICOM (zip) · JPG/PNG · DOCX</div>

            <div class="upload-dropzone" id="file-drop">
              <input id="file-input" name="files" type="file" multiple required accept="application/pdf,image/*,.zip,.dcm,.doc,.docx" />
              <div>
                <strong>Drag &amp; drop files</strong>
                <p>or click to browse from your device.</p>
              </div>
            </div>

            <div class="flow-note" id="file-list">No files uploaded yet.</div>

            <div class="flow-group">
              <label>Reason for review</label>
              <textarea name="reason" rows="4" required placeholder="Briefly explain the medical question you need clarified"></textarea>
            </div>

            <div class="flow-group">
              <label>Urgency flag</label>
              <select name="urgency">
                <option value="no">Routine · No immediate rush</option>
                <option value="yes">Yes · I need a response sooner than 72 hours</option>
              </select>
            </div>

            <div class="flow-group">
              <label>Preferred report language</label>
              <select name="language">
                <option value="en">English</option>
                <option value="ar">العربية</option>
              </select>
            </div>

            <div class="flow-support">
              <p>Files are encrypted in transit, seen only by your assigned specialist, and never shared with third parties.</p>
            </div>

            <div class="section-cta">
              <button type="submit" class="btn btn-primary">Continue to Review</button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>

  <script>
    (function () {
      const fileInput = document.getElementById('file-input');
      const listNode = document.getElementById('file-list');
      const dropZone = document.getElementById('file-drop');

      function updateFileList(files) {
        const names = Array.from(files || []).map((file) => file.name);
        if (!names.length) {
          listNode.textContent = 'No files uploaded yet.';
          return;
        }
        listNode.innerHTML = '';
        const ul = document.createElement('ul');
        ul.className = 'flow-summary';
        names.forEach((name) => {
          const li = document.createElement('li');
          li.textContent = name;
          ul.appendChild(li);
        });
        listNode.appendChild(ul);
      }

      fileInput.addEventListener('change', function () {
        updateFileList(this.files);
      });

      dropZone.addEventListener('dragover', function (event) {
        event.preventDefault();
        dropZone.classList.add('upload-dropzone--active');
      });

      dropZone.addEventListener('dragleave', function () {
        dropZone.classList.remove('upload-dropzone--active');
      });

      dropZone.addEventListener('drop', function (event) {
        event.preventDefault();
        dropZone.classList.remove('upload-dropzone--active');
        const files = event.dataTransfer.files;

        // Assign dropped files to the input in a cross-browser-friendly way
        try {
          const dt = new DataTransfer();
          Array.from(files || []).forEach((f) => dt.items.add(f));
          fileInput.files = dt.files;
        } catch (e) {
          // If DataTransfer is not available, we still list the files; user can click to browse.
        }

        updateFileList(files);
      });
    })();
  </script>
<%- include('partials/footer') %>