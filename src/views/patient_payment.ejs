<%- include('partials/header', { title: ((typeof lang !== 'undefined' && String(lang).toLowerCase() === 'ar') ? "الدفع" : "Payment"), layout: "portal", showNav: false }) %>
<%
  const isArabic = (typeof isAr !== 'undefined' && isAr) || (typeof lang !== 'undefined' && String(lang).toLowerCase().startsWith('ar'));
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';

  // i18n helper (fallback-safe, never prints i18n keys to UI)
  const tFn = (typeof safeT !== 'undefined' && typeof safeT === 'function')
    ? safeT
    : ((typeof t !== 'undefined' && typeof t === 'function')
        ? t
        : (() => null));

  // Title
  const pageTitle = (typeof tFn === 'function')
    ? (tFn('patient.payment.title') || (isArabic ? 'الدفع مطلوب' : 'Payment required'))
    : (isArabic ? 'الدفع مطلوب' : 'Payment required');

  // Accept either `paymentUrl` (new) or `paymentLink` (legacy) so we never break renders.
  const rawPaymentUrl = (typeof paymentUrl !== 'undefined' && paymentUrl)
    ? paymentUrl
    : ((typeof paymentLink !== 'undefined' && paymentLink) ? paymentLink : null);

  // HARD GUARD: never allow undefined in template logic
  // Also prevent unsafe URL schemes from ever rendering into an href.
  const candidatePaymentUrl = rawPaymentUrl ? String(rawPaymentUrl).trim() : '';
  const isSafeHref = candidatePaymentUrl && (/^(https?:\/\/|\/)/i).test(candidatePaymentUrl);
  const safePaymentUrl = isSafeHref ? candidatePaymentUrl : null;

  // If the payment URL is external, open in a new tab safely.
  const isExternalPaymentUrl = safePaymentUrl && (/^https?:\/\//i).test(safePaymentUrl);
  const paymentLinkAttrs = isExternalPaymentUrl ? 'target="_blank" rel="noopener noreferrer"' : '';

  // Optional error message passed from the route
  const safeError = (typeof error !== 'undefined' && error) ? String(error) : null;

  // Localize common payment errors (fallback-safe)
  function localizeError(msg) {
    if (!msg) return msg;
    const m = String(msg);
    if (!isArabic) return m;

    // Keep this mapping tight to avoid unintended translations.
    const map = {
      'Payment required': 'الدفع مطلوب',
      'Payment is required': 'الدفع مطلوب',
      'Payment is required before you can proceed.': 'يجب إتمام الدفع قبل المتابعة.',
      'Payment link is not available': 'رابط الدفع غير متاح',
      'Payment link is not available yet.': 'رابط الدفع غير متاح حالياً.',
      'Payment link is not available yet': 'رابط الدفع غير متاح حالياً',
      'Payment not completed': 'لم يتم إتمام الدفع',
      'Payment has not yet been completed.': 'لم يتم إتمام الدفع بعد.',
      'Order not found': 'الحالة غير موجودة',
      'Case not found': 'الحالة غير موجودة',
      'Unauthorized': 'غير مصرح',
      'Forbidden': 'غير مسموح',
    };

    // Exact match first
    if (map[m]) return map[m];

    // Substring match for noisy backend errors
    const lc = m.toLowerCase();
    if (lc.includes('payment') && lc.includes('required')) return 'الدفع مطلوب';
    if (lc.includes('payment') && lc.includes('not') && lc.includes('completed')) return 'لم يتم إتمام الدفع بعد.';
    if (lc.includes('payment') && lc.includes('link') && (lc.includes('missing') || lc.includes('not available'))) return 'رابط الدفع غير متاح حالياً.';
    if (lc.includes('not found') && (lc.includes('order') || lc.includes('case'))) return 'الحالة غير موجودة';

    return m;
  }

  // Text (fallback-safe)
  const subtitle = (tFn('patient.payment.body') || (isArabic
    ? 'تم إنشاء هذه الحالة ولكن لم يتم إتمام الدفع بعد.'
    : 'This case has been created but payment has not yet been completed.'));

  const ctaProceed = (tFn('patient.payment.proceed') || (isArabic ? 'إكمال الدفع' : 'Proceed to payment'));
  const helperCopy = (tFn('patient.payment.helper_copy') || (isArabic ? 'إذا لم يفتح الرابط، انسخه والصقه في المتصفح.' : "If the button doesn't open, copy and paste the link into your browser."));
  const linkMissing = (tFn('patient.payment.missing_link') || (isArabic ? 'رابط الدفع غير متاح حالياً. يرجى التواصل مع الدعم.' : 'Payment link is not available. Please contact support.'));
  const backDash = (tFn('patient.payment.back_to_dashboard') || (isArabic ? 'العودة إلى لوحة التحكم' : 'Back to dashboard'));
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= tFn('patient.portal') || (isArabic ? 'بوابة المريض' : 'Patient Portal') %></span>
    </div>
  </div>

  <div class="portal-grid">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/dashboard"><%= tFn('nav.dashboard.patient') || (isArabic ? 'حالاتي الطبية' : 'My cases') %></a></li>
        <li><a href="/portal/patient/orders/new"><%= tFn('nav.new_case') || (isArabic ? 'حالة جديدة' : 'New case') %></a></li>
        <li><a href="/portal/patient/alerts"><%= tFn('nav.alerts') || (isArabic ? 'التنبيهات' : 'Alerts') %></a></li>
        <li><a href="/patient/profile"><%= tFn('nav.profile') || (isArabic ? 'الملف الشخصي' : 'Profile') %></a></li>
        <li><a href="/logout"><%= tFn('auth.logout') || (isArabic ? 'تسجيل الخروج' : 'Logout') %></a></li>
      </ul>
    </aside>

    <main class="portal-content" dir="<%= isArabic ? 'rtl' : 'ltr' %>">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= pageTitle %></h1>
        <p class="portal-hero-subtitle"><%= subtitle %></p>
      </div>

      <div class="flow-card">
        <% if (safeError) { %>
          <p class="flow-note"><%= localizeError(safeError) %></p>
        <% } %>

        <!-- ADD-ONS SECTION -->
        <% if (typeof serviceDetails !== 'undefined' && serviceDetails) { %>
          <div class="addons-section" style="margin-bottom: 24px; padding: 16px; background: #F9FAFB; border-radius: 8px; border: 1px solid #E5E7EB;">
            <h3 style="margin-top: 0; font-size: 16px; font-weight: 600;">
              <%= isArabic ? 'خدمات إضافية' : 'Add-on Services' %>
            </h3>

            <!-- Video Consultation Add-on -->
            <% if (typeof videoConsultationPrice !== 'undefined' && videoConsultationPrice > 0) { %>
              <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <input 
                  type="checkbox" 
                  id="addon_video_consultation" 
                  name="addon_video_consultation"
                  value="1"
                  style="width: 18px; height: 18px; cursor: pointer; margin-right: 12px;"
                />
                <label for="addon_video_consultation" style="flex: 1; cursor: pointer; margin: 0;">
                  <span style="font-weight: 500;">
                    <%= isArabic ? 'استشارة فيديو' : 'Video Consultation' %>
                  </span>
                  <span style="color: #6B7280; font-size: 14px;">
                    <br/><%= isArabic ? 'مع الطبيب المتخصص' : 'with the specialist' %>
                  </span>
                </label>
                <span style="font-weight: 600; color: #0066CC;">
                  +<%= videoConsultationPrice %> EGP
                </span>
              </div>
            <% } %>
          </div>

          <!-- PRICE BREAKDOWN -->
          <div style="margin-bottom: 24px; padding: 16px; background: #F0F7FF; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span><%= isArabic ? 'السعر الأساسي' : 'Base price' %>:</span>
              <span><strong><%= price %> <%= currency || 'SAR' %></strong></span>
            </div>
            <div id="addon-cost" style="display: none; flex; justify-content: space-between; margin-bottom: 8px;">
              <span><%= isArabic ? 'الخدمات الإضافية' : 'Add-ons' %>:</span>
              <span id="addon-cost-value"><strong>0 EGP</strong></span>
            </div>
            <hr style="margin: 12px 0; border: none; border-top: 1px solid #E5E7EB;" />
            <div style="display: flex; justify-content: space-between; font-size: 18px;">
              <span style="font-weight: 600;"><%= isArabic ? 'الإجمالي' : 'Total' %>:</span>
              <span id="total-price" style="font-weight: 700; color: #0066CC;"><strong><%= price %> <%= currency || 'SAR' %></strong></span>
            </div>
          </div>
        <% } %>

        <% if (safePaymentUrl) { %>
          <div class="section-cta">
            <a href="<%= safePaymentUrl %>" <%- paymentLinkAttrs %> class="btn btn-primary">
              <%= ctaProceed %>
            </a>

            <a href="/dashboard" class="btn btn-secondary">
              <%= backDash %>
            </a>
          </div>

          <p class="flow-note"><%= helperCopy %></p>

          <div class="form-group">
            <label class="form-label"><%= isArabic ? 'رابط الدفع' : 'Payment link' %></label>
            <input class="form-control" type="text" value="<%= safePaymentUrl %>" readonly />
          </div>
        <% } else { %>
          <p class="flow-note"><em><%= linkMissing %></em></p>

          <div class="section-cta">
            <a href="/dashboard" class="btn btn-secondary">
              <%= backDash %>
            </a>
          </div>
        <% } %>
      </div>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>

<script>
(function() {
  const videoPrice = <%= typeof videoConsultationPrice !== 'undefined' ? videoConsultationPrice : 0 %>;
  const basePrice = <%= price %>;
  
  const checkbox = document.getElementById('addon_video_consultation');
  const addonCostDiv = document.getElementById('addon-cost');
  const addonCostValue = document.getElementById('addon-cost-value');
  const totalPrice = document.getElementById('total-price');
  
  function updatePrice() {
    let total = basePrice;
    let addonCost = 0;
    
    if (checkbox && checkbox.checked) {
      addonCost = videoPrice;
      total += addonCost;
    }
    
    if (addonCostDiv && addonCostValue && addonCost > 0) {
      addonCostDiv.style.display = 'flex';
      addonCostValue.innerHTML = '<strong>' + addonCost + ' EGP</strong>';
    } else if (addonCostDiv) {
      addonCostDiv.style.display = 'none';
    }
    
    if (totalPrice) {
      totalPrice.innerHTML = '<strong>' + total + ' <%= currency || 'SAR' %></strong>';
    }
  }
  
  if (checkbox) {
    checkbox.addEventListener('change', updatePrice);
  }
  
  updatePrice();
})();
</script>
