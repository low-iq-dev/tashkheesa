<%- include('partials/header', { title: "Payment", layout: "portal", showNav: false }) %>
<%
  const isArabic = (typeof isAr !== 'undefined' && isAr) || (typeof lang !== 'undefined' && String(lang).toLowerCase().startsWith('ar'));
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';

  // i18n helper (fallback-safe, never prints i18n keys to UI)
  const tFn = (typeof safeT !== 'undefined' && typeof safeT === 'function')
    ? safeT
    : ((typeof t !== 'undefined' && typeof t === 'function')
        ? t
        : (() => null));

  // Title
  const pageTitle = (typeof tFn === 'function')
    ? (tFn('patient.payment.title') || (isArabic ? 'الدفع مطلوب' : 'Payment required'))
    : (isArabic ? 'الدفع مطلوب' : 'Payment required');

  // Accept either `paymentUrl` (new) or `paymentLink` (legacy) so we never break renders.
  const rawPaymentUrl = (typeof paymentUrl !== 'undefined' && paymentUrl)
    ? paymentUrl
    : ((typeof paymentLink !== 'undefined' && paymentLink) ? paymentLink : null);

  // HARD GUARD: never allow undefined in template logic
  // Also prevent unsafe URL schemes from ever rendering into an href.
  const candidatePaymentUrl = rawPaymentUrl ? String(rawPaymentUrl).trim() : '';
  const isSafeHref = candidatePaymentUrl && (/^(https?:\/\/|\/)/i).test(candidatePaymentUrl);
  const safePaymentUrl = isSafeHref ? candidatePaymentUrl : null;

  // If the payment URL is external, open in a new tab safely.
  const isExternalPaymentUrl = safePaymentUrl && (/^https?:\/\//i).test(safePaymentUrl);
  const paymentLinkAttrs = isExternalPaymentUrl ? 'target="_blank" rel="noopener noreferrer"' : '';

  // Optional error message passed from the route
  const safeError = (typeof error !== 'undefined' && error) ? String(error) : null;

  // Localize common payment errors (fallback-safe)
  function localizeError(msg) {
    if (!msg) return msg;
    const m = String(msg);
    if (!isArabic) return m;

    // Keep this mapping tight to avoid unintended translations.
    const map = {
      'Payment required': 'الدفع مطلوب',
      'Payment is required': 'الدفع مطلوب',
      'Payment is required before you can proceed.': 'يجب إتمام الدفع قبل المتابعة.',
      'Payment link is not available': 'رابط الدفع غير متاح',
      'Payment link is not available yet.': 'رابط الدفع غير متاح حالياً.',
      'Payment link is not available yet': 'رابط الدفع غير متاح حالياً',
      'Payment not completed': 'لم يتم إتمام الدفع',
      'Payment has not yet been completed.': 'لم يتم إتمام الدفع بعد.',
      'Order not found': 'الحالة غير موجودة',
      'Case not found': 'الحالة غير موجودة',
      'Unauthorized': 'غير مصرح',
      'Forbidden': 'غير مسموح',
    };

    // Exact match first
    if (map[m]) return map[m];

    // Substring match for noisy backend errors
    const lc = m.toLowerCase();
    if (lc.includes('payment') && lc.includes('required')) return 'الدفع مطلوب';
    if (lc.includes('payment') && lc.includes('not') && lc.includes('completed')) return 'لم يتم إتمام الدفع بعد.';
    if (lc.includes('payment') && lc.includes('link') && (lc.includes('missing') || lc.includes('not available'))) return 'رابط الدفع غير متاح حالياً.';
    if (lc.includes('not found') && (lc.includes('order') || lc.includes('case'))) return 'الحالة غير موجودة';

    return m;
  }

  // Text (fallback-safe)
  const subtitle = (tFn('patient.payment.body') || (isArabic
    ? 'تم إنشاء هذه الحالة ولكن لم يتم إتمام الدفع بعد.'
    : 'This case has been created but payment has not yet been completed.'));

  const ctaProceed = (tFn('patient.payment.proceed') || (isArabic ? 'إكمال الدفع' : 'Proceed to payment'));
  const helperCopy = (tFn('patient.payment.helper_copy') || (isArabic ? 'إذا لم يفتح الرابط، انسخه والصقه في المتصفح.' : "If the button doesn't open, copy and paste the link into your browser."));
  const linkMissing = (tFn('patient.payment.missing_link') || (isArabic ? 'رابط الدفع غير متاح حالياً. يرجى التواصل مع الدعم.' : 'Payment link is not available. Please contact support.'));
  const backDash = (tFn('patient.payment.back_to_dashboard') || (isArabic ? 'العودة إلى لوحة التحكم' : 'Back to dashboard'));
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= isArabic ? 'بوابة المريض' : 'Patient Portal' %></span>
    </div>
  </div>

  <div class="portal-grid">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/portal/patient/orders/new">New Case</a></li>
        <li><a href="/portal/patient/alerts">Alerts</a></li>
        <li><a href="/patient/profile">Profile</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </aside>

    <main class="portal-content" dir="<%= isArabic ? 'rtl' : 'ltr' %>">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= pageTitle %></h1>
        <p class="portal-hero-subtitle"><%= subtitle %></p>
      </div>

      <div class="flow-card">
        <% if (safeError) { %>
          <p class="flow-note"><%= localizeError(safeError) %></p>
        <% } %>

        <% if (safePaymentUrl) { %>
          <div class="section-cta">
            <a href="<%= safePaymentUrl %>" <%- paymentLinkAttrs %> class="btn btn-primary">
              <%= ctaProceed %>
            </a>

            <a href="/dashboard" class="btn btn-secondary">
              <%= backDash %>
            </a>
          </div>

          <p class="flow-note"><%= helperCopy %></p>

          <div class="form-group">
            <label class="form-label"><%= isArabic ? 'رابط الدفع' : 'Payment link' %></label>
            <input class="form-control" type="text" value="<%= safePaymentUrl %>" readonly />
          </div>
        <% } else { %>
          <p class="flow-note"><em><%= linkMissing %></em></p>

          <div class="section-cta">
            <a href="/dashboard" class="btn btn-secondary">
              <%= backDash %>
            </a>
          </div>
        <% } %>
      </div>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
