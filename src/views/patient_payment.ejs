<%- include('partials/header', { title: ((typeof lang !== 'undefined' && String(lang).toLowerCase() === 'ar') ? "الدفع" : "Payment"), layout: "portal", showNav: false }) %>
<%
  const isArabic = (typeof isAr !== 'undefined' && isAr) || (typeof lang !== 'undefined' && String(lang).toLowerCase().startsWith('ar'));
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';

  const tFn = (typeof safeT !== 'undefined' && typeof safeT === 'function')
    ? safeT
    : ((typeof t !== 'undefined' && typeof t === 'function')
        ? t
        : (() => null));

  const pageTitle = (typeof tFn === 'function')
    ? (tFn('patient.payment.title') || (isArabic ? 'الدفع مطلوب' : 'Payment Required'))
    : (isArabic ? 'الدفع مطلوب' : 'Payment Required');

  const rawPaymentUrl = (typeof paymentUrl !== 'undefined' && paymentUrl)
    ? paymentUrl
    : ((typeof paymentLink !== 'undefined' && paymentLink) ? paymentLink : null);

  const candidatePaymentUrl = rawPaymentUrl ? String(rawPaymentUrl).trim() : '';
  const isSafeHref = candidatePaymentUrl && (/^(https?:\/\/|\/)/i).test(candidatePaymentUrl);
  const safePaymentUrl = isSafeHref ? candidatePaymentUrl : null;
  const isExternalPaymentUrl = safePaymentUrl && (/^https?:\/\//i).test(safePaymentUrl);
  const paymentLinkAttrs = isExternalPaymentUrl ? 'target="_blank" rel="noopener noreferrer"' : '';
  const safeError = (typeof error !== 'undefined' && error) ? String(error) : null;

  function localizeError(msg) {
    if (!msg) return msg;
    const m = String(msg);
    if (!isArabic) return m;
    const map = {
      'Payment required': 'الدفع مطلوب',
      'Payment is required': 'الدفع مطلوب',
      'Payment link is not available': 'رابط الدفع غير متاح',
      'Payment link is not available yet.': 'رابط الدفع غير متاح حالياً.',
      'Order not found': 'الحالة غير موجودة',
    };
    if (map[m]) return map[m];
    return m;
  }

  const subtitle = (tFn('patient.payment.body') || (isArabic
    ? 'تم إنشاء هذه الحالة ولكن لم يتم إتمام الدفع بعد.'
    : 'This case has been created but payment has not yet been completed.'));
  const ctaProceed = (tFn('patient.payment.proceed') || (isArabic ? 'إكمال الدفع' : 'Proceed to Payment'));
  const helperCopy = (tFn('patient.payment.helper_copy') || (isArabic ? 'إذا لم يفتح الرابط، انسخه والصقه في المتصفح.' : "If the button doesn't open, copy and paste the link into your browser."));
  const linkMissing = (tFn('patient.payment.missing_link') || (isArabic ? 'رابط الدفع غير متاح حالياً. يرجى التواصل مع الدعم.' : 'Payment link is not available. Please contact support.'));
  const backDash = (tFn('patient.payment.back_to_dashboard') || (isArabic ? 'العودة إلى لوحة التحكم' : 'Back to Dashboard'));

  const hasVideoAddon = (typeof videoConsultationPrice !== 'undefined' && videoConsultationPrice > 0);
  const basePrice = (typeof price !== 'undefined') ? price : 0;
  const currencyLabel = (typeof currency !== 'undefined' && currency) ? currency : 'SAR';
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= tFn('patient.portal') || (isArabic ? 'بوابة المريض' : 'Patient Portal') %></span>
    </div>
  </div>

  <div class="portal-grid">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/dashboard"><%= tFn('nav.dashboard.patient') || (isArabic ? 'حالاتي الطبية' : 'My cases') %></a></li>
        <li><a href="/portal/patient/orders/new"><%= tFn('nav.new_case') || (isArabic ? 'حالة جديدة' : 'New case') %></a></li>
        <li><a href="/portal/patient/alerts"><%= tFn('nav.alerts') || (isArabic ? 'التنبيهات' : 'Alerts') %></a></li>
        <li><a href="/patient/profile"><%= tFn('nav.profile') || (isArabic ? 'الملف الشخصي' : 'Profile') %></a></li>
        <li><a href="/logout"><%= tFn('auth.logout') || (isArabic ? 'تسجيل الخروج' : 'Logout') %></a></li>
      </ul>
    </aside>

    <main class="portal-content" dir="<%= isArabic ? 'rtl' : 'ltr' %>">
      <!-- Hero -->
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= pageTitle %></h1>
        <p class="portal-hero-subtitle"><%= subtitle %></p>
      </div>

      <% if (safeError) { %>
        <div class="p-alert p-alert-warning">
          <div class="p-alert-content"><%= localizeError(safeError) %></div>
        </div>
      <% } %>

      <div class="portal-card">
        <% if (typeof serviceDetails !== 'undefined' && serviceDetails) { %>
          <!-- Add-ons Section -->
          <div style="margin-bottom:var(--space-3);">
            <h3 class="portal-card-title" style="margin-bottom:var(--space-2);"><%= isArabic ? 'خدمات إضافية' : 'Add-on Services' %></h3>

            <% if (hasVideoAddon) { %>
            <label class="p-checkbox-group">
              <input
                type="checkbox"
                id="addon_video_consultation"
                name="addon_video_consultation"
                value="1"
              />
              <div style="flex:1;">
                <div style="font-weight:600;font-size:15px;color:var(--dark-gray);margin-bottom:2px;">
                  <%= isArabic ? 'استشارة فيديو مع الطبيب المتخصص' : 'Video Consultation with Specialist' %>
                </div>
                <div style="font-size:13px;color:var(--text-secondary);">
                  <%= isArabic ? 'تواصل وجهاً لوجه مع الطبيب المختص' : 'Connect face-to-face with the doctor' %>
                </div>
              </div>
              <div style="font-weight:700;color:var(--medical-blue);white-space:nowrap;font-size:15px;">
                +<%= videoConsultationPrice %> EGP
              </div>
            </label>
            <% } %>
          </div>

          <!-- Price Breakdown -->
          <div style="background:var(--light-gray);border-radius:var(--radius-md);padding:var(--space-2);margin-bottom:var(--space-3);">
            <div class="p-price-row">
              <span class="label"><%= isArabic ? 'السعر الأساسي' : 'Base Price' %></span>
              <span class="value"><%= basePrice %> <%= currencyLabel %></span>
            </div>
            <div class="p-price-row" id="addon-cost" style="display:none;">
              <span class="label"><%= isArabic ? 'الخدمات الإضافية' : 'Add-ons' %></span>
              <span class="value" id="addon-cost-value">0 EGP</span>
            </div>
            <div class="p-price-row total">
              <span class="label"><%= isArabic ? 'الإجمالي' : 'Total' %></span>
              <span class="value" id="total-price"><%= basePrice %> <%= currencyLabel %></span>
            </div>
          </div>
        <% } %>

        <!-- Referral Code -->
        <div style="margin-bottom:var(--space-3);padding:var(--space-2);background:var(--light-gray);border-radius:var(--radius-md);">
          <label class="p-form-label" style="margin-bottom:6px;"><%= isArabic ? 'رمز الإحالة (اختياري)' : 'Referral Code (optional)' %></label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input class="p-form-input" type="text" id="referral_code_input" maxlength="20" placeholder="<%= isArabic ? 'أدخل رمز الإحالة' : 'Enter referral code' %>" style="flex:1;text-transform:uppercase;" dir="ltr" />
            <button type="button" id="referral_apply_btn" class="p-btn p-btn-secondary" style="white-space:nowrap;"><%= isArabic ? 'تطبيق' : 'Apply' %></button>
          </div>
          <div id="referral_result" style="margin-top:6px;font-size:13px;display:none;"></div>
        </div>

        <% if (safePaymentUrl) { %>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:var(--space-2);">
            <a href="<%= safePaymentUrl %>" <%- paymentLinkAttrs %> class="p-btn p-btn-primary p-btn-lg">
              <%= ctaProceed %>
            </a>
            <a href="/dashboard" class="p-btn p-btn-ghost">
              <%= backDash %>
            </a>
          </div>

          <div class="p-form-group">
            <label class="p-form-label"><%= isArabic ? 'رابط الدفع' : 'Payment Link' %></label>
            <input class="p-form-input" type="text" value="<%= safePaymentUrl %>" readonly dir="ltr" onclick="this.select();" />
            <p class="p-form-hint"><%= helperCopy %></p>
          </div>
        <% } else { %>
          <div class="p-alert p-alert-warning">
            <div class="p-alert-content"><%= linkMissing %></div>
          </div>
          <a href="/dashboard" class="p-btn p-btn-secondary" style="margin-top:var(--space-2);">
            <%= backDash %>
          </a>
        <% } %>
      </div>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>

<script>
(function() {
  var videoPrice = <%= typeof videoConsultationPrice !== 'undefined' ? videoConsultationPrice : 0 %>;
  var basePrice = <%= basePrice %>;
  var checkbox = document.getElementById('addon_video_consultation');
  var addonCostDiv = document.getElementById('addon-cost');
  var addonCostValue = document.getElementById('addon-cost-value');
  var totalPrice = document.getElementById('total-price');

  function updatePrice() {
    var total = basePrice;
    var addonCost = 0;
    if (checkbox && checkbox.checked) {
      addonCost = videoPrice;
      total += addonCost;
    }
    if (addonCostDiv && addonCostValue && addonCost > 0) {
      addonCostDiv.style.display = 'flex';
      addonCostValue.textContent = addonCost + ' EGP';
    } else if (addonCostDiv) {
      addonCostDiv.style.display = 'none';
    }
    if (totalPrice) {
      totalPrice.textContent = total + ' <%= currencyLabel %>';
    }
  }

  if (checkbox) {
    checkbox.addEventListener('change', updatePrice);
  }
  updatePrice();

  // Referral code validation
  var refInput = document.getElementById('referral_code_input');
  var refBtn = document.getElementById('referral_apply_btn');
  var refResult = document.getElementById('referral_result');
  var referralDiscount = 0;

  if (refBtn && refInput) {
    refBtn.addEventListener('click', function() {
      var code = (refInput.value || '').trim().toUpperCase();
      if (!code) return;
      refBtn.disabled = true;
      refBtn.textContent = '...';
      fetch('/api/referral/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: code })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        refResult.style.display = 'block';
        if (data.ok && data.valid) {
          var discountText = data.reward_type === 'discount'
            ? (data.reward_value + '%')
            : (data.reward_value + ' <%= currencyLabel %>');
          refResult.style.color = '#065f46';
          refResult.textContent = '<%= isArabic ? "تم تطبيق الخصم: " : "Discount applied: " %>' + discountText;
          referralDiscount = data.reward_value || 0;
          refInput.readOnly = true;
          refBtn.style.display = 'none';
        } else {
          refResult.style.color = '#991b1b';
          refResult.textContent = data.error || '<%= isArabic ? "رمز غير صالح" : "Invalid code" %>';
          referralDiscount = 0;
        }
        refBtn.disabled = false;
        refBtn.textContent = '<%= isArabic ? "تطبيق" : "Apply" %>';
      })
      .catch(function() {
        refResult.style.display = 'block';
        refResult.style.color = '#991b1b';
        refResult.textContent = '<%= isArabic ? "خطأ في الشبكة" : "Network error" %>';
        refBtn.disabled = false;
        refBtn.textContent = '<%= isArabic ? "تطبيق" : "Apply" %>';
      });
    });
  }
})();
</script>
