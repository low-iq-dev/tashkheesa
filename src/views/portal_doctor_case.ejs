<!DOCTYPE html>
<!-- CANONICAL_PORTAL_DOCTOR_CASE -->
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<html lang="<%= lang || 'en' %>" dir="<%= isAr ? 'rtl' : 'ltr' %>">
<head>
  <meta charset="utf-8" />
  <title>Case <%= order.id %> – <%= brand %></title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body class="portal-layout">

  <!-- TOP BAR -->
  <header class="portal-topbar">
    <div class="topbar-left">
      <strong><%= order.reference || ('Case ' + order.id) %></strong>
      <span class="muted">· <%= order.service_name || order.specialty_name || '' %></span>
    </div>
    <div class="topbar-right">
      <span class="status-pill"><%= statusLabel %></span>
      <span class="sla-pill"><%= slaLabel %></span>
    </div>
  </header>

  <main class="case-workspace">
<% if (order.accepted_at) { %>
  <div class="audit-banner">
    <span class="audit-icon">✅</span>
    <span class="audit-text">
      <%= isAr
        ? 'تم قبول هذه الحالة بتاريخ ' + new Date(order.accepted_at).toLocaleString()
        : 'You accepted this case on ' + new Date(order.accepted_at).toLocaleString()
      %>
    </span>
  </div>
<% } %>

    <!-- CASE IDENTITY -->
    <section class="card">
      <h2 class="section-title"><%= isAr ? 'ملخص الحالة' : 'Case summary' %></h2>

      <div class="summary-grid">
        <div>
          <label><%= isAr ? 'التخصص' : 'Specialty' %></label>
          <div><%= order.specialty_name || '—' %></div>
        </div>
        <div>
          <label><%= isAr ? 'الخدمة' : 'Service' %></label>
          <div><%= order.service_name || '—' %></div>
        </div>
        <div>
          <label><%= isAr ? 'الحالة' : 'Status' %></label>
          <div><span class="status-pill"><%= statusLabel %></span></div>
        </div>
        <div>
          <label><%= isAr ? 'الموعد النهائي' : 'Deadline' %></label>
          <div><%= order.deadline_at ? new Date(order.deadline_at).toLocaleString() : '—' %></div>
        </div>
      </div>
    </section>

    <!-- CLINICAL CONTEXT -->
    <section class="card">
      <h2 class="section-title"><%= isAr ? 'السياق الطبي' : 'Clinical context' %></h2>

      <div class="context-block">
        <h4><%= isAr ? 'سؤال المريض' : 'Patient question' %></h4>
        <p><%= clinicalContext?.question || (isAr ? 'لا توجد تفاصيل.' : 'No details provided.') %></p>
      </div>

      <div class="context-block">
        <h4><%= isAr ? 'التاريخ المرضي' : 'Medical history' %></h4>
        <p><%= clinicalContext?.medicalHistory || (isAr ? 'غير متوفر.' : 'Not provided.') %></p>
      </div>

      <div class="context-block">
        <h4><%= isAr ? 'الأدوية الحالية' : 'Current medications' %></h4>
        <p><%= clinicalContext?.medications || (isAr ? 'غير متوفر.' : 'Not provided.') %></p>
      </div>
    </section>

    <!-- FILES -->
    <section class="card">
      <h2 class="section-title"><%= isAr ? 'الملفات' : 'Files' %></h2>

      <% if (Array.isArray(files) && files.length) { %>
        <ul class="file-list">
          <% files.forEach(function(f){ %>
            <li>
              <a href="<%= f.url %>" target="_blank" rel="noopener"><%= f.name %></a>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <div class="empty-state">
          <%= isAr ? 'لا توجد ملفات مرفوعة.' : 'No files uploaded.' %>
        </div>
      <% } %>
    </section>

    <!-- DOCTOR ACTIONS (PRIMARY WORK ZONE) -->
<section class="card card-accent doctor-actions-card">
        <h2 class="section-title"><%= isAr ? 'إجراءات الطبيب' : 'Doctor actions' %></h2>

      <% if (errorMessage) { %>
        <div class="alert alert-error"><%= errorMessage %></div>
      <% } %>
      <% if (successMessage) { %>
        <div class="alert alert-success"><%= successMessage %></div>
      <% } %>

      <!-- ACCEPT -->
      <% if (stage === 'accept') { %>
        <form method="POST" action="/portal/doctor/case/<%= order.id %>/accept">
          <button class="btn-primary btn-block" type="submit">
            <%= isAr ? 'قبول الحالة' : 'Accept case' %>
          </button>
        </form>
      <% } %>

      <!-- NOTES -->
<% if (stage !== 'completed') { %>
  <div class="action-block">
    <form method="POST" action="/portal/doctor/case/<%= order.id %>/diagnosis">
      <label><%= isAr ? 'الملاحظات / الرأي الطبي' : 'Notes / Medical opinion' %></label>

      <textarea name="diagnosis" rows="7"
        placeholder="<%= isAr ? 'اكتب ملاحظاتك الطبية هنا' : 'Write your medical notes here' %>"><%= order.diagnosis_text || '' %></textarea>

      <button class="btn-secondary btn-block" type="submit">
        <%= isAr ? 'حفظ الملاحظات' : 'Save notes' %>
      </button>
    </form>
  </div>
<% } %>
      <!-- REQUEST FILES -->
      <% if (['accept','review','rejected'].includes(stage)) { %>
        <div class="action-block action-warning">
        <form method="POST" action="/portal/doctor/case/<%= order.id %>/reject-files">
          <label><%= isAr ? 'طلب توضيح / إعادة رفع' : 'Request clarification / re-upload' %></label>
          <textarea name="reason" rows="3" required
            placeholder="<%= isAr ? 'اشرح ما هو المطلوب' : 'Describe what is missing' %>"></textarea>
          <button class="btn-warning btn-block" type="submit">
            <%= isAr ? 'إرسال الطلب' : 'Submit request' %>
          </button>
        </form>
        </div>
      <% } %>

      <!-- FINAL REPORT -->
<% if (stage === 'review' || stage === 'rejected') { %>
  <div class="action-block action-final">
    <form method="POST" action="/portal/doctor/case/<%= order.id %>/report">
      <label><%= isAr ? 'رابط التقرير النهائي (PDF)' : 'Final report link (PDF)' %></label>
      <input type="url" name="report_url" required
             placeholder="https://example.com/final-report.pdf"
             value="<%= order.report_url || '' %>" />

      <label><%= isAr ? 'ملفات مشروحة (اختياري)' : 'Annotated files (optional)' %></label>
      <textarea name="annotated_files" rows="3"
        placeholder="<%= isAr ? 'كل رابط في سطر منفصل' : 'One URL per line' %>"></textarea>

      <button class="btn-primary btn-block" type="submit">
        <%= isAr ? 'إرسال التقرير النهائي' : 'Submit final report' %>
      </button>
    </form>
  </div>
<% } %>
      <% if (stage === 'completed') { %>
        <p class="muted"><%= isAr ? 'تم تسليم التقرير.' : 'Final report submitted.' %></p>
        <% if (order.report_url) { %>
          <a class="btn-link" href="<%= order.report_url %>" target="_blank" rel="noopener">
            <%= isAr ? 'عرض التقرير' : 'View report' %>
          </a>
        <% } %>
      <% } %>
    </section>

  </main>
</body>
</html>