<%
  // Defensive locals — REQUIRED
  const user = locals.user || {};
  const order = locals.order || {};
  const files = Array.isArray(locals.files) ? locals.files : [];
  const annotatedFiles = Array.isArray(locals.annotatedFiles) ? locals.annotatedFiles : [];
  const clinicalContext = locals.clinicalContext || {};
  const stage = locals.stage || 'review';
  const statusLabel = locals.statusLabel || 'Status';
  const slaLabel = locals.slaLabel || '';
  const errorMessage = locals.errorMessage || null;
  const successMessage = locals.successMessage || null;
  const doctorChip = user && user.specialty ? `Dr ${user.specialty}` : (user && (user.display_name || user.name) ? `Dr ${user.display_name || user.name}` : 'Doctor');
%>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Global styles -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- Favicon + app icons -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <title>Case Details</title>
</head>

<body class="doctor-case">

  <a class="skip-link" href="#main-content">Skip to main content</a>

  <header class="portal-header">
    <div class="header-left">
      <a class="header-brand" href="/portal/doctor" aria-label="Go to Doctor Dashboard">
        <strong>Tashkheesa</strong>
      </a>
      <span class="header-sub">Doctor portal</span>
    </div>

    <div class="header-right">
      <nav class="header-nav" aria-label="Doctor navigation">
        <a class="pill" href="/portal/doctor">Dashboard</a>
        <span class="pill active">Case</span>
        <a class="pill" href="/doctor/alerts">Alerts</a>
        <span class="pill"><%= doctorChip %></span>
        <span class="pill lang-switch">EN | AR</span>
        <form class="logout-form" action="/logout" method="POST">
          <button type="submit">Logout</button>
        </form>
      </nav>
    </div>
  </header>

  <div class="wrap">

    <div id="main-content" class="page-header" tabindex="-1">
      <div class="page-header-top">
        <div>
          <h1 class="page-title">Case <%= order.id || '' %></h1>
          <p class="page-subtitle">Review details, uploaded files, and submit your medical notes.</p>
        </div>

        <div class="page-header-actions">
          <span class="pill"><%= statusLabel %></span>
          <% if (slaLabel) { %>
            <span class="pill"><strong><%= slaLabel %></strong></span>
          <% } %>
        </div>
      </div>
    </div>

    <% if (errorMessage) { %>
      <div class="msg error"><%= errorMessage %></div>
    <% } %>

    <% if (successMessage) { %>
      <div class="msg success"><%= successMessage %></div>
    <% } %>

    <section class="panel">
      <h2 class="panel-title">Clinical context</h2>
      <p class="panel-hint">Use the patient’s question and history to guide your interpretation.</p>
      <p><strong>Question:</strong> <%= clinicalContext.question || '—' %></p>
      <p><strong>History:</strong> <%= clinicalContext.medicalHistory || '—' %></p>
      <p><strong>Medications:</strong> <%= clinicalContext.medications || '—' %></p>
    </section>

    <section class="panel">
      <h2 class="panel-title">Uploaded files</h2>
      <p class="panel-hint">Open files in a new tab to review. If files are unclear, request a re-upload.</p>
      <% if (!files.length) { %>
        <div class="worklist-empty"><strong>No files uploaded</strong><div class="muted">This case cannot be reviewed until files are provided.</div></div>
      <% } else { %>
        <ul>
          <% files.forEach(f => { %>
            <li><a href="<%= f.url %>" target="_blank" rel="noreferrer"><%= f.name %></a></li>
          <% }) %>
        </ul>
      <% } %>
    </section>

    <section class="panel">
      <h2 class="panel-title">Medical notes</h2>
      <p class="panel-hint">Add notes to support your final report. Keep it clear and clinically structured.</p>

      <form method="POST" action="/portal/doctor/case/<%= order.id %>/diagnosis">
        <div class="notes-fields">
          <label class="field">
            <span class="field-label">Findings / Observations</span>
            <!-- Keep name="diagnosis" for backward compatibility with the existing route -->
            <textarea
              class="notes-textarea"
              name="diagnosis"
              placeholder="Write findings/observations here…"
              rows="7"
            ></textarea>
            <span class="field-hint">Describe what you see in the study (key findings), in clear clinical language.</span>
          </label>

          <label class="field">
            <span class="field-label">Impression / Conclusion</span>
            <textarea
              class="notes-textarea"
              name="impression"
              placeholder="Summarize your impression/conclusion…"
              rows="5"
            ></textarea>
            <span class="field-hint">Your diagnostic impression (most likely diagnosis + brief reasoning if needed).</span>
          </label>

          <label class="field">
            <span class="field-label">Recommendations</span>
            <textarea
              class="notes-textarea"
              name="recommendations"
              placeholder="Add recommended next steps…"
              rows="5"
            ></textarea>
            <span class="field-hint">Follow‑up imaging, labs, referrals, urgency, or alternative differentials to consider.</span>
          </label>
        </div>

        <div class="form-actions">
          <button class="btn primary" type="submit">Save notes</button>

          <!-- Generates a PDF report using the same notes (POST /portal/doctor/case/:id/report) -->
          <button
            class="btn secondary"
            type="submit"
            formaction="/portal/doctor/case/<%= order.id %>/report"
            formmethod="POST"
          >
            Generate report (PDF)
          </button>
        </div>

        <p class="form-hint">Generate report creates a PDF from your saved notes and attaches it to the case.</p>
        <p class="form-hint muted">Tip: you can structure notes using headings like “Findings: … Impression: … Recommendations: …” if needed.</p>
      </form>
    </section>

    <% if (stage === 'accept') { %>
      <section class="panel">
        <h2 class="panel-title">Accept case</h2>
        <p class="panel-hint">Accepting a case starts your review and moves it into your active queue.</p>
        <form method="POST" action="/portal/doctor/case/<%= order.id %>/accept">
          <button class="btn primary">Accept</button>
        </form>
      </section>
    <% } %>

  </div>
</body>
</html>