<%
  // Defensive locals — REQUIRED
  const user = locals.user || {};
  const order = locals.order || {};
  const files = Array.isArray(locals.files) ? locals.files : [];
  const annotatedFiles = Array.isArray(locals.annotatedFiles) ? locals.annotatedFiles : [];
  const clinicalContext = locals.clinicalContext || {};
  const stage = locals.stage || 'review';
  const statusLabel = locals.statusLabel || 'Status';
  const slaLabel = locals.slaLabel || '';
  const errorMessage = locals.errorMessage || null;
  const successMessage = locals.successMessage || null;
%>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Global styles -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- Favicon + app icons -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <title>Case Details</title>
 
</head>

<body class="doctor-case">
  <div class="wrap">

    <div class="page-header">
      <div style="display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <h1 class="page-title">Case <%= order.id || '' %></h1>
          <p class="page-subtitle">Review details, uploaded files, and submit your medical notes.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span class="pill"><%= statusLabel %></span>
          <% if (slaLabel) { %>
            <span class="pill"><strong><%= slaLabel %></strong></span>
          <% } %>
        </div>
      </div>
    </div>

    <% if (errorMessage) { %>
      <div class="msg error"><%= errorMessage %></div>
    <% } %>

    <% if (successMessage) { %>
      <div class="msg success"><%= successMessage %></div>
    <% } %>

    <section class="panel">
      <h2 class="panel-title">Clinical context</h2>
      <p class="panel-hint">Use the patient’s question and history to guide your interpretation.</p>
      <p><strong>Question:</strong> <%= clinicalContext.question || '—' %></p>
      <p><strong>History:</strong> <%= clinicalContext.medicalHistory || '—' %></p>
      <p><strong>Medications:</strong> <%= clinicalContext.medications || '—' %></p>
    </section>

    <section class="panel">
      <h2 class="panel-title">Uploaded files</h2>
      <p class="panel-hint">Open files in a new tab to review. If files are unclear, request a re-upload.</p>
      <% if (!files.length) { %>
        <div class="worklist-empty"><strong>No files uploaded</strong><div class="muted">This case cannot be reviewed until files are provided.</div></div>
      <% } else { %>
        <ul>
          <% files.forEach(f => { %>
            <li><a href="<%= f.url %>" target="_blank"><%= f.name %></a></li>
          <% }) %>
        </ul>
      <% } %>
    </section>

    <section class="panel">
      <h2 class="panel-title">Medical notes</h2>
      <p class="panel-hint">Add notes to support your final report. Keep it clear and clinically structured.</p>

      <form method="POST" action="/portal/doctor/case/<%= order.id %>/diagnosis">
        <textarea name="diagnosis" placeholder="Write your medical notes here…"></textarea>
        <br><br>
        <button class="btn primary">Save notes</button>
      </form>
    </section>

    <% if (stage === 'accept') { %>
      <section class="panel">
        <h2 class="panel-title">Accept case</h2>
        <p class="panel-hint">Accepting a case starts your review and moves it into your active queue.</p>
        <form method="POST" action="/portal/doctor/case/<%= order.id %>/accept">
          <button class="btn primary">Accept</button>
        </form>
      </section>
    <% } %>

  </div>
</body>
</html>