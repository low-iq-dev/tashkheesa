<!DOCTYPE html>
<!-- CANONICAL_PORTAL_DOCTOR_CASE -->
<div style="background:#0a3d62;color:#fff;padding:14px;font-size:18px;text-align:center;">
  ‚úÖ PORTAL DOCTOR CASE (portal_doctor_case.ejs)
</div><!-- updated: 2025-12-15 doctor portal case UI polish -->
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<html lang="<%= lang || 'en' %>" dir="<%= isAr ? 'rtl' : 'ltr' %>">
<head>
  <meta charset="utf-8" />
  <title>Case <%= order.id %> ‚Äì <%= brand %></title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <% 
    const fmtShort = function(iso) {
      if (!iso) return '‚Äî';
      const d = new Date(iso);
      if (isNaN(d)) return '‚Äî';
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yy = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${dd}/${mm}/${yy} ‚Ä¢ ${hh}:${min}`;
    };
    const timeline = Array.isArray(order.timeline)
      ? order.timeline
      : (typeof events !== 'undefined' && Array.isArray(events) ? events : []);
    const toTs = function(value) {
      if (!value) return 0;
      const ts = new Date(value).getTime();
      return Number.isFinite(ts) ? ts : 0;
    };
    let timelineItems = Array.isArray(timeline) ? timeline.slice() : [];
    if (timelineItems.some((item) => item && item.at)) {
      timelineItems = timelineItems.sort((a, b) => toTs(b && b.at) - toTs(a && a.at));
    }
  %>
  <div class="layout">
    <header>
      <div class="brand">
        <div class="brand-logo">T</div>
        <div>
          <div class="brand-text-main"><%= brand %></div>
          <div class="brand-text-sub"><%= isAr ? 'ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Doctor portal' %></div>
        </div>
      </div>
      <div class="header-right">
        <a class="pill" href="/portal/doctor"><%= isAr ? 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Dashboard' %></a>
        <a class="pill" href="/doctor/alerts">
          <%= isAr ? 'ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™' : 'Alerts' %>
          <% if (typeof doctorAlertCount !== 'undefined' && doctorAlertCount > 0) { %>
            <span class="status-pill status-pill--new"><%= doctorAlertCount %></span>
          <% } %>
        </a>
        <a class="pill" href="/doctor/queue"><%= isAr ? 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ÿßŸÑÿßÿ™' : 'Active queue' %></a>
        <div class="pill">
          üë®‚Äç‚öïÔ∏è <span><%= (user && user.name) || 'Doctor' %></span>
        </div>
        <div class="lang-switch">
          <a href="/lang/en">EN</a> | <a href="/lang/ar">AR</a>
        </div>
        <form class="logout-form" method="post" action="/logout">
          <button type="submit"><%= t('nav.logout') %></button>
        </form>
      </div>
    </header>

    <main>
      <div class="page-shell portal-page">
        <div class="page-inner case-page doctor-case-page">
          <!-- portal_doctor_case rendered -->
          <div class="case-hero">
            <div>
              <div class="case-label"><%= isAr ? 'ÿßŸÑÿÆÿØŸÖÿ©' : 'Service' %></div>
              <h1><%= order.service_name || order.specialty_name || (isAr ? 'ÿ≠ÿßŸÑÿ© ÿ∑ÿ®Ÿäÿ©' : 'Medical case') %></h1>
              <p class="case-subtitle">
                <span class="status-pill"><%= statusLabel %></span>
                <% if (order.specialty_name) { %> ¬∑ <%= order.specialty_name %><% } %>
                ¬∑ <%= isAr ? 'ÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case ID' %> <%= order.id %>
              </p>
            </div>
            <div class="sla-banner">
              <div class="sla-banner__icon">‚è±</div>
              <div>
                <div class="sla-banner__text"><%= slaLabel %></div>
                <div class="sla-banner__meta">
                  <strong><%= isAr ? 'ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä' : 'Deadline' %>:</strong>
                  <%= fmtShort(order.deadline_at) %>
                </div>
                <% if (sla && sla.minutesRemaining) { %>
                  <div class="sla-banner__meta"><%= isAr ? 'ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä' : 'Time remaining' %>: <%= sla.minutesRemaining >= 60 ? Math.max(1, Math.ceil(sla.minutesRemaining / 60)) + 'h' : sla.minutesRemaining + 'm' %></div>
                <% } %>
              </div>
            </div>
          </div>

          <% if (errorMessage) { %>
            <div class="card alert-card alert-card--error">
              <strong><%= errorMessage %></strong>
            </div>
          <% } %>
          <% if (successMessage) { %>
            <div class="card alert-card alert-card--success">
              <strong><%= successMessage %></strong>
            </div>
          <% } %>

          <% 
            const diagnosisDraft = order.diagnosis_text || '';
            const canEditDiagnosis = stage !== 'completed';
          %>
        <div class="doctor-page-grid">
          <div class="doctor-main-col">
            <section class="card">
              <h2 class="card-title"><%= isAr ? 'ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case summary' %></h2>
              <div class="card-body info-grid">
                <div class="info-row">
                  <span><%= isAr ? 'ÿßŸÑÿ™ÿÆÿµÿµ' : 'Specialty' %></span>
                  <strong><%= order.specialty_name || order.service_name || '‚Äî' %></strong>
                </div>
                <div class="info-row">
                  <span><%= isAr ? 'ÿßŸÑÿÆÿØŸÖÿ©' : 'Service' %></span>
                  <strong><%= order.service_name || '‚Äî' %></strong>
                </div>
                <div class="info-row">
                  <span><%= isAr ? 'ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®' : 'Status' %></span>
                  <strong><span class="status-pill"><%= statusLabel %></span></strong>
                </div>
                <div class="info-row">
                  <span><%= isAr ? 'ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä' : 'Time remaining' %></span>
                  <strong>
                    <% if (sla && typeof sla.minutesRemaining === 'number') { %>
                      <%= sla.minutesRemaining >= 60 ? Math.max(1, Math.ceil(sla.minutesRemaining / 60)) + (isAr ? ' ÿ≥ÿßÿπÿ©' : 'h') : sla.minutesRemaining + (isAr ? ' ÿØŸÇŸäŸÇÿ©' : 'm') %>
                    <% } else if (sla && sla.isBreached) { %>
                      <%= isAr ? 'ŸÖÿ™ÿ£ÿÆÿ±' : 'Overdue' %>
                    <% } else { %>
                      ‚Äî
                    <% } %>
                  </strong>
                </div>
                <div class="info-row">
                  <span><%= isAr ? 'ÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case reference' %></span>
                  <strong><%= order.id %></strong>
                </div>
              </div>
              <div class="card-title card-title-sub"><%= isAr ? 'ÿßŸÑÿ™ŸàŸÇŸäÿ™' : 'Timing' %></div>
              <div class="card-body info-grid">
                <div class="info-row"><span><%= isAr ? 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°' : 'Created' %></span><strong><%= fmtShort(order.created_at) %></strong></div>
                <div class="info-row"><span><%= isAr ? 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÇÿ®ŸàŸÑ' : 'Accepted' %></span><strong><%= fmtShort(order.accepted_at) %></strong></div>
                <div class="info-row"><span><%= isAr ? 'ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©' : 'Review deadline' %></span><strong><%= fmtShort(order.deadline_at) %></strong></div>
                <div class="info-row"><span><%= isAr ? 'ŸàŸÇÿ™ ÿßŸÑÿ•ÿ™ŸÖÿßŸÖ' : 'Completed' %></span><strong><%= fmtShort(order.completed_at) %></strong></div>
              </div>
            </section>
              <section class="card context-card">
                <h2><%= isAr ? 'ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©' : 'Clinical context' %></h2>
                <div class="context-item">
                  <span class="context-label"><%= isAr ? 'ÿ≥ÿ§ÿßŸÑ ÿßŸÑŸÖÿ±Ÿäÿ∂' : 'Patient question' %></span>
                  <p><%= clinicalContext.question || (isAr ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ÿØÿÆÿßŸÑ ÿ£Ÿä ÿ™ŸÅÿßÿµŸäŸÑ.' : 'No details provided.') %></p>
                </div>
                <div class="context-item">
                  <span class="context-label"><%= isAr ? 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ÿ∂Ÿä' : 'Medical history' %></span>
                  <p><%= clinicalContext.medicalHistory || (isAr ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™.' : 'Not provided.') %></p>
                </div>
                <div class="context-item">
                  <span class="context-label"><%= isAr ? 'ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©' : 'Current medications' %></span>
                  <p><%= clinicalContext.medications || (isAr ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™.' : 'Not provided.') %></p>
                </div>
              </section>

              <section class="card files-card">
                <h2><%= isAr ? 'ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸàÿπÿ©' : 'Uploaded files' %></h2>
                <% if (files && files.length) { %>
                  <ul class="files-list">
                    <% files.forEach(function(file) { %>
                      <li><%= file.name %></li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="muted"><%= isAr ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ£Ÿä ŸÖŸÑŸÅÿßÿ™ ÿ®ÿπÿØ.' : 'No files uploaded yet.' %></p>
                <% } %>
              </section>
            </div>

            <div class="doctor-actions-col">
              <section class="card action-card actions-panel">
                <h2><%= isAr ? 'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™' : 'Actions' %></h2>
                <p class="muted small"><%= isAr ? 'ÿ£ŸÉŸÖŸÑ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ŸàŸÇÿØŸëŸÖ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÜ ŸáŸÜÿß.' : 'Complete your review and submit the report here.' %></p>

                <% if (stage === 'completed') { %>
                  <p class="muted"><%= isAr ? 'ÿ™ŸÖ ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä.' : 'Final report submitted.' %></p>
                  <% if (order.report_url) { %>
                    <a class="btn btn-primary btn-small" href="<%= order.report_url %>" target="_blank" rel="noopener"><%= isAr ? 'ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±' : 'View report' %></a>
                  <% } %>
                  <% if (order.diagnosis_text) { %>
                    <p class="diagnosis-text" style="margin-top:12px;"><%= order.diagnosis_text %></p>
                  <% } %>
                <% } %>

                <% if (stage === 'accept') { %>
                  <div class="action-block">
                    <p class="muted"><%= isAr ? 'ÿ±ÿßÿ¨ÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸàÿßŸÅŸÇ ŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿ≠ÿßŸÑÿ© ÿ•ŸÑŸâ ŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©.' : 'Review the files and accept to move the case into review.' %></p>
                    <form method="post" action="/portal/doctor/case/<%= order.id %>/accept">
                      <button class="btn btn-primary btn-block" type="submit"><%= isAr ? 'ŸÇÿ®ŸàŸÑ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Accept case' %></button>
                    </form>
                  </div>
                <% } %>

                <% if (stage !== 'completed') { %>
                  <div class="action-block">
                    <h3><%= isAr ? 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ / ÿßŸÑÿ±ÿ£Ÿä ÿßŸÑÿ∑ÿ®Ÿä' : 'Notes / Medical opinion' %></h3>
                    <p class="muted note-small">
                      <%= isAr ? 'ÿßŸÉÿ™ÿ® ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ŸÉ ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸáŸÜÿß. Ÿáÿ∞ÿß ÿßŸÑŸÜÿµ ŸäÿØÿπŸÖ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸàŸÑÿß ŸäŸèÿπÿ±ÿ∂ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑŸÑŸÖÿ±Ÿäÿ∂.' : 'Capture your full medical notes here. This text supports the final report and is not shown directly to the patient.' %>
                    </p>
                    <form method="post" action="/portal/doctor/case/<%= order.id %>/diagnosis" class="stacked-form">
                      <textarea class="textarea-large" name="diagnosis" rows="7" placeholder="<%= isAr ? 'ÿßŸÉÿ™ÿ® ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ŸÉ ÿßŸÑÿ∑ÿ®Ÿäÿ©' : 'Write your medical notes' %>"><%= diagnosisDraft %></textarea>
                      <button class="btn btn-outline btn-block" type="submit"><%= isAr ? 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ©' : 'Save medical notes' %></button>
                    </form>
                  </div>
                <% } %>

                <% if (['accept', 'review', 'rejected'].includes(stage)) { %>
                  <div class="action-block">
                    <h3><%= isAr ? 'ÿ∑ŸÑÿ® ÿ™Ÿàÿ∂Ÿäÿ≠ / ÿ±ŸÅÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™' : 'Request clarification / reject files' %></h3>
                    <p class="muted"><%= isAr ? 'ÿßÿ¥ÿ±ÿ≠ ŸÖÿß ŸäŸÜŸÇÿµ ÿßŸÑÿ≠ÿßŸÑÿ© Ÿàÿ≥Ÿäÿ™ŸÖ ÿ™ÿπŸÑŸäŸÇ ÿßŸÑŸÖŸáŸÑÿ© ÿ≠ÿ™Ÿâ ÿ™ÿ±ÿØ ÿßŸÑŸÖŸÑŸÅÿßÿ™.' : 'State what is missing so the deadline can pause while we wait for the files.' %></p>
                    <form method="post" action="/portal/doctor/case/<%= order.id %>/reject-files">
                      <label><%= isAr ? 'ÿßŸÑÿ≥ÿ®ÿ® ÿßŸÑŸÖÿÆÿ™ÿµÿ±' : 'Short reason' %></label>
                      <textarea name="reason" rows="3" placeholder="<%= isAr ? 'ÿßÿÆÿ™ÿ± ŸÖÿß ŸäŸÜŸÇÿµ ÿßŸÑÿ≠ÿßŸÑÿ© (ÿµŸàÿ±ÿå ÿ™ŸÇÿßÿ±Ÿäÿ±ÿå ÿ•ŸÑÿÆ).' : 'Describe what is missing (images, reports, etc.).' %>" required></textarea>
                      <button class="btn btn-outline btn-block" type="submit"><%= isAr ? 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®' : 'Submit request' %></button>
                    </form>
                  </div>
                <% } %>

                <% if (stage === 'review' || stage === 'rejected') { %>
                  <div class="action-block">
                    <h3><%= isAr ? 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä' : 'Submit final report' %></h3>
                    <p class="muted"><%= isAr ? 'Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸäŸèÿ™ŸÖ ÿßŸÑÿ≠ÿßŸÑÿ© ŸàŸäŸèÿπŸÑŸêŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.' : 'Completing will notify the patient automatically.' %></p>
                    <form method="post" action="/portal/doctor/case/<%= order.id %>/report" class="stacked-form">
                      <label><%= isAr ? 'ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä (PDF)' : 'Final report link (PDF)' %></label>
                      <input class="input-full" type="url" name="report_url" placeholder="https://example.com/final-report.pdf" value="<%= order.report_url || '' %>" required />
                      <label><%= isAr ? 'ŸÖŸÑŸÅÿßÿ™ ŸÖÿ¥ÿ±Ÿàÿ≠ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)' : 'Annotated files (optional)' %></label>
                      <textarea class="textarea-large" name="annotated_files" rows="3" placeholder="<%= isAr ? 'ÿ∂ÿπ ŸÉŸÑ ÿ±ÿßÿ®ÿ∑ ŸÅŸä ÿ≥ÿ∑ÿ± ŸÖŸÜŸÅÿµŸÑ.' : 'Place each URL on its own line.' %>"></textarea>
                      <button class="btn btn-primary btn-block" type="submit"><%= isAr ? 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ÿ™ŸÖÿßŸÖ' : 'Submit final report' %></button>
                    </form>
                  </div>
                <% } %>
              </section>
            </div>
          </div>

          <section class="card timeline-card">
            <div class="card-title"><%= isAr ? 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©' : 'Activity timeline' %></div>
            <div class="timeline-scroll">
              <% if (!timelineItems.length) { %>
                <p class="muted"><%= isAr ? 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿ¥ÿßÿ∑ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ.' : 'No activity yet.' %></p>
              <% } else { %>
                <ul class="timeline">
                  <% timelineItems.forEach(function(ev) { %>
                    <li class="timeline-item">
                      <div class="timeline-dot"></div>
                      <div class="timeline-content">
                        <div class="timeline-label"><%= ev.label || (isAr ? 'ÿ≠ÿØÿ´' : 'Event') %></div>
                        <div class="timeline-meta"><%= ev.at ? fmtShort(ev.at) : (ev.atFormatted || '‚Äî') %></div>
                      </div>
                    </li>
                  <% }); %>
                </ul>
              <% } %>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>
</body>
</html>
