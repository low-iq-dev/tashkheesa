<%
  // Defensive locals — REQUIRED
  const user = locals.user || {};
  const order = locals.order || {};
  const files = Array.isArray(locals.files) ? locals.files : [];
  const annotatedFiles = Array.isArray(locals.annotatedFiles) ? locals.annotatedFiles : [];
  const clinicalContext = locals.clinicalContext || {};
  const stage = locals.stage || 'review';
  const statusLabel = locals.statusLabel || 'Status';
  const slaLabel = locals.slaLabel || '';
  const errorMessage = locals.errorMessage || null;
  const successMessage = locals.successMessage || null;
%>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Doctor Case</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f6f7f9; margin:0; }
    .wrap { max-width: 1100px; margin: 40px auto; background:#fff; padding:24px; border-radius:10px; }
    .header { display:flex; justify-content:space-between; align-items:center; }
    .pill { padding:6px 10px; border-radius:999px; background:#eee; font-size:13px; }
    .section { margin-top:28px; }
    h2 { margin-bottom:10px; }
    textarea { width:100%; min-height:140px; padding:10px; }
    .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .primary { background:#2563eb; color:white; }
    .danger { background:#dc2626; color:white; }
    .msg { margin:12px 0; padding:10px; border-radius:6px; }
    .error { background:#fee2e2; color:#991b1b; }
    .success { background:#dcfce7; color:#166534; }
    ul { padding-left:18px; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="header">
      <div>
        <h1>Case <%= order.id || '' %></h1>
        <div class="pill"><%= statusLabel %></div>
      </div>
      <div><strong><%= slaLabel %></strong></div>
    </div>

    <% if (errorMessage) { %>
      <div class="msg error"><%= errorMessage %></div>
    <% } %>

    <% if (successMessage) { %>
      <div class="msg success"><%= successMessage %></div>
    <% } %>

    <div class="section">
      <h2>Clinical Context</h2>
      <p><strong>Question:</strong> <%= clinicalContext.question || '—' %></p>
      <p><strong>History:</strong> <%= clinicalContext.medicalHistory || '—' %></p>
      <p><strong>Medications:</strong> <%= clinicalContext.medications || '—' %></p>
    </div>

    <div class="section">
      <h2>Uploaded Files</h2>
      <% if (!files.length) { %>
        <p>No files uploaded.</p>
      <% } else { %>
        <ul>
          <% files.forEach(f => { %>
            <li><a href="<%= f.url %>" target="_blank"><%= f.name %></a></li>
          <% }) %>
        </ul>
      <% } %>
    </div>

    <div class="section">
      <h2>Doctor Diagnosis</h2>

      <form method="POST" action="/portal/doctor/case/<%= order.id %>/diagnosis">
        <textarea name="diagnosis" placeholder="Write your medical opinion here…"></textarea>
        <br><br>
        <button class="btn primary">Save Diagnosis</button>
      </form>
    </div>

    <% if (stage === 'accept') { %>
      <div class="section">
        <form method="POST" action="/portal/doctor/case/<%= order.id %>/accept">
          <button class="btn primary">Accept Case</button>
        </form>
      </div>
    <% } %>

  </div>
</body>
</html>