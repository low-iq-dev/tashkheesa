<%- include('partials/header', {
  title: "Case Details",
  layout: "portal",
  showNav: false,
  portalFrame: true,
  portalActive: 'dashboard',
  portalNext: (locals && locals.portalNext) ? locals.portalNext : '/portal/doctor'
}) %>
<%
  // Language + direction (MUST be first — TDZ safe)
  const lang =
    (locals && locals.lang) ||
    (locals && locals.user && locals.user.lang) ||
    'en';

  const isAr = String(lang).toLowerCase() === 'ar';
%>
<%
  // CSP nonce (for inline helpers). If missing, avoid rendering inline script.
  const cspNonce = (locals && (locals.cspNonce || locals.csp_nonce || locals.nonce))
    ? String(locals.cspNonce || locals.csp_nonce || locals.nonce)
    : '';

  // File name display (avoid [object Object])
  function getPathBasename(value) {
    const raw = String(value || '').trim();
    if (!raw) return '';
    const withoutQuery = raw.split('?')[0].split('#')[0];
    const parts = withoutQuery.split('/').filter(Boolean);
    return parts.length ? parts[parts.length - 1] : withoutQuery;
  }

  function getDisplayFilename(item) {
    if (typeof item === 'string') return getPathBasename(item) || 'File';
    if (item && typeof item === 'object') {
      const preferred = [item.name, item.label, item.originalname, item.filename].find(
        (candidate) => String(candidate || '').trim() !== ''
      );
      if (preferred) return String(preferred).trim();
      const fromUrl = getPathBasename(item.url || item.path);
      if (fromUrl) return fromUrl;
    }
    return 'File';
  }
%>
<%
  // Defensive locals — REQUIRED
  const user = locals.user || {};
  const order = locals.order || {};
  // Files MUST come from controller (order_files table)
  const files = Array.isArray(locals.files)
    ? locals.files
    : (Array.isArray(order.files) ? order.files : []);
  const annotatedFiles = Array.isArray(locals.annotatedFiles) ? locals.annotatedFiles : [];
  const clinicalContext = locals.clinicalContext || {};
  const status = String(order.status || '').trim().toLowerCase();
  // Payment state MUST come from controller; fall back to order only if explicitly present
  const isPaid =
    typeof locals.isPaid === 'boolean'
      ? locals.isPaid
      : ['paid', 'captured'].includes(String(order.payment_status || '').toLowerCase());
  // View access is broader to keep terminal/finalized cases readable.
  const VIEWABLE_STATUSES = [
    'accepted',
    'in_review',
    'completed',
    'done',
    'closed',
    'delivered',
    'report_ready',
    'report-ready',
    'finalized',
    'finalised',
    'paid',
    'captured'
  ];
  // Edit access is intentionally narrow.
  const EDITABLE_STATUSES = ['accepted', 'in_review', 'assigned'];
  // Accept CTA should only appear for truly new/unassigned cases.
  const ACCEPT_ELIGIBLE_STATUSES = ['new', 'submitted', 'unassigned', 'available'];

  const canViewDetails = VIEWABLE_STATUSES.includes(status) || EDITABLE_STATUSES.includes(status);
  const canEdit = EDITABLE_STATUSES.includes(status);
  const canAccept = ACCEPT_ELIGIBLE_STATUSES.includes(status) && isPaid;
  const detailsLocked = !canViewDetails;
  const orderIdEnc = encodeURIComponent(String(order.id));

  const acceptActionUrl = locals.acceptActionUrl || (`/portal/doctor/case/${orderIdEnc}/accept`);
  const acceptCtaText = locals.acceptCtaText || (isAr ? 'اقبل الحالة' : 'Accept case');
  const statusLabel = locals.statusLabel || 'Status';
  const slaLabel = locals.slaLabel || '';
  const errorMessage = locals.errorMessage || null;
  const successMessage = locals.successMessage || null;
  const query = locals.query || {};
  const uiBanner = locals.uiBanner || null;
  const notesPrefill = locals.notesPrefill || null;

  const savedDiagnosis = (order && (
    order.diagnosis ||
    order.diagnosis_text ||
    order.doctor_diagnosis ||
    order.findings ||
    order.medical_notes ||
    order.medical_opinion ||
    order.opinion_text ||
    order.notes ||
    ''
  )) || '';

  const savedImpression = (order && (
    order.impression ||
    order.impression_text ||
    order.conclusion ||
    order.summary ||
    ''
  )) || '';

  const savedRecommendations = (order && (
    order.recommendations ||
    order.recommendation_text ||
    order.next_steps ||
    order.plan ||
    ''
  )) || '';

  const casePath = (order && order.id)
    ? `/portal/doctor/case/${orderIdEnc}`
    : '/portal/doctor';

  const reportUrl = (query && query.reportUrl)
    ? query.reportUrl
    : (order && (order.report_url || order.reportUrl))
      ? (order.report_url || order.reportUrl)
      : null;

  // Lock notes once a report exists (prevents duplicate/overwritten reports)
  const isReportLocked = (
    status === 'completed'
    || (query && (query.report === 'locked' || query.report === 'ok'))
    || Boolean(reportUrl)
  );
%>

<div class="portal-page portal-doctor-case">
  <div class="portal-case-layout">
    <div class="portal-case-main">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= isAr ? 'الحالة' : 'Case' %> <%= order.id || '' %></h1>
        <p class="portal-hero-subtitle"><%= isAr ? 'راجع التفاصيل والملفات المرفوعة ثم أضف ملاحظاتك الطبية.' : 'Review details, uploaded files, and submit your medical notes.' %></p>
        <div class="portal-hero-meta">
          <p class="flow-note"><strong><%= statusLabel %></strong>: <%= order.status || '—' %></p>
          <% if (slaLabel) { %>
            <p class="flow-note"><strong><%= slaLabel %></strong></p>
          <% } %>
          <% if (order && order.sla_24hr_selected && order.sla_24hr_deadline) { %>
            <div style="margin-top: 8px; padding: 10px 14px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 18px;">&#9201;</span>
              <div>
                <strong style="color: #92400e;"><%= isAr ? 'تشخيص سريع 24 ساعة' : 'Priority 24h SLA' %></strong>
                <span id="sla24-countdown" style="color: #92400e; font-size: 13px; margin-<%= isAr ? 'right' : 'left' %>: 8px;"></span>
              </div>
            </div>
            <script>
            (function(){
              var deadline = new Date('<%= order.sla_24hr_deadline %>').getTime();
              var el = document.getElementById('sla24-countdown');
              function tick(){
                var now = Date.now();
                var diff = deadline - now;
                if(diff <= 0){ el.textContent = '<%= isAr ? "انتهى الوقت!" : "Deadline passed!" %>'; el.style.color='#dc2626'; return; }
                var h = Math.floor(diff/3600000);
                var m = Math.floor((diff%3600000)/60000);
                var s = Math.floor((diff%60000)/1000);
                el.textContent = (h>0?(h+'h '):'') + m+'m '+s+'s <%= isAr ? "متبقية" : "remaining" %>';
                setTimeout(tick, 1000);
              }
              tick();
            })();
            </script>
          <% } %>
        </div>
      </div>

      <nav class="portal-top-tabs" aria-label="Doctor portal navigation">
        <a class="portal-top-tab" href="/portal/doctor"><%= isAr ? 'لوحة التحكم' : 'Dashboard' %></a>
        <a class="portal-top-tab" href="/portal/doctor/queue"><%= isAr ? 'حالاتي' : 'My Cases' %></a>
        <a class="portal-top-tab active" href="<%= casePath %>"><%= isAr ? 'تفاصيل الحالة' : 'Case Details' %></a>
        <a class="portal-top-tab" href="/portal/doctor/alerts"><%= isAr ? 'التنبيهات' : 'Alerts' %></a>
      </nav>

      <% if (errorMessage) { %>
        <div class="flow-card"><%= errorMessage %></div>
      <% } %>

      <% if (successMessage) { %>
        <div class="flow-card"><%= successMessage %></div>
      <% } %>

      <% if (canAccept) { %>
        <section id="accept-case" class="flow-card">
          <h2><%= isAr ? 'قبول الحالة' : 'Accept case' %></h2>
          <p class="flow-note">
            <%= isAr
              ? 'يجب قبول الحالة أولاً قبل عرض التفاصيل أو الملفات أو إضافة أي ملاحظات.'
              : 'You must accept the case before viewing details, accessing files, or adding notes.' %>
          </p>
          <form id="acceptCaseForm" method="POST" action="<%= acceptActionUrl %>">
            <%- (typeof csrfField === 'function') ? csrfField() : '' %>
            <button class="btn btn-primary" type="submit"><%= acceptCtaText %></button>
          </form>
        </section>
      <% } else if (detailsLocked) { %>
        <section id="case-locked" class="flow-card">
          <h2><%= isAr ? 'وصول الحالة' : 'Case access' %></h2>
          <% if (!isPaid) { %>
            <p class="flow-note">
              <strong><%= isAr ? 'الدفع قيد الانتظار' : 'Payment pending' %></strong><br />
              <%= isAr
                ? 'هذه الحالة لم يتم الدفع لها بعد. ستصبح متاحة للمراجعة بعد تأكيد الدفع.'
                : 'This case has not been paid for yet. It will become reviewable after payment is confirmed.' %>
            </p>
          <% } else { %>
            <p class="flow-note">
              <%= isAr
                ? 'هذه الحالة ليست متاحة للمراجعة بعد. تحقق من قائمة الحالات أو التنبيهات.'
                : 'This case is not yet available for review. Check your queue or alerts for assignment updates.' %>
            </p>
          <% } %>
        </section>
      <% } %>

      <% if (query && query.report === 'ok' && reportUrl) { %>
        <div class="flow-card">
          <p><%= isAr ? 'تم إنشاء التقرير بنجاح.' : 'Report generated successfully.' %></p>
          <div class="section-cta">
            <a class="btn btn-secondary" href="<%= reportUrl %>" target="_blank" rel="noopener"><%= isAr ? 'فتح التقرير (PDF)' : 'Open report (PDF)' %></a>
          </div>
        </div>
      <% } else if (query && (query.report === 'fail' || query.report === 'error')) { %>
        <div class="flow-card">
          <p><%= isAr ? 'فشل إنشاء التقرير. يرجى المحاولة مرة أخرى أو التواصل مع الدعم.' : 'Report generation failed. Please try again or contact support.' %></p>
        </div>
      <% } else if (query && query.report === 'locked') { %>
        <div class="flow-card">
          <p><%= isAr ? 'تم إكمال هذه الحالة بالفعل. تم قفل الملاحظات لمنع إنشاء تقارير مكررة.' : 'This case is already completed. Notes are locked to prevent duplicate reports.' %></p>
          <% if (reportUrl) { %>
            <div class="section-cta">
              <a class="btn btn-secondary" href="<%= reportUrl %>" target="_blank" rel="noopener"><%= isAr ? 'فتح التقرير (PDF)' : 'Open report (PDF)' %></a>
            </div>
          <% } %>
        </div>
      <% } %>

      <section class="flow-card">
        <h2><%= isAr ? 'السياق السريري' : 'Clinical context' %></h2>
        <% if (detailsLocked) { %>
          <% if (canAccept) { %>
            <p class="flow-note"><%= isAr ? 'اقبل الحالة لعرض التفاصيل.' : 'Accept the case to view details.' %></p>
          <% } else if (!isPaid) { %>
            <p class="flow-note"><%= isAr ? 'التفاصيل غير متاحة حتى يتم تأكيد الدفع.' : 'Details are unavailable until payment is confirmed.' %></p>
          <% } else { %>
            <p class="flow-note"><%= isAr ? 'التفاصيل غير متاحة حتى يتم تخصيص الحالة للمراجعة.' : 'Details are unavailable until the case is assigned for review.' %></p>
          <% } %>
        <% } else { %>
          <p class="flow-note"><%= isAr ? 'استخدم سؤال المريض وتاريخه لتوجيه التفسير.' : "Use the patient's question and history to guide your interpretation." %></p>
          <p><strong><%= isAr ? 'السؤال:' : 'Question:' %></strong> <%= clinicalContext.question || '—' %></p>
          <p><strong><%= isAr ? 'التاريخ المرضي:' : 'History:' %></strong> <%= clinicalContext.medicalHistory || '—' %></p>
          <p><strong><%= isAr ? 'الأدوية:' : 'Medications:' %></strong> <%= clinicalContext.medications || '—' %></p>
        <% } %>
      </section>

      <section class="flow-card">
        <h2><%= isAr ? 'الملفات المرفوعة' : 'Uploaded files' %></h2>
        <% if (detailsLocked) { %>
          <% if (canAccept) { %>
            <p class="flow-note"><%= isAr ? 'اقبل الحالة لعرض الملفات.' : 'Accept the case to view files.' %></p>
          <% } else if (!isPaid) { %>
            <p class="flow-note"><%= isAr ? 'الملفات غير متاحة حتى يتم تأكيد الدفع.' : 'Files are unavailable until payment is confirmed.' %></p>
          <% } else { %>
            <p class="flow-note"><%= isAr ? 'الملفات غير متاحة حتى يتم تخصيص الحالة للمراجعة.' : 'Files are unavailable until the case is assigned for review.' %></p>
          <% } %>
        <% } else { %>
          <p class="flow-note"><%= isAr ? 'افتح الملفات في تبويب جديد للمراجعة. إذا كانت غير واضحة، اطلب إعادة الرفع.' : 'Open files in a new tab to review. If files are unclear, request a re-upload.' %></p>
          <% if (!files.length) { %>
            <p class="flow-note"><%= isAr ? 'لا توجد ملفات مرفوعة' : 'No files uploaded' %></p>
          <% } else { %>
            <p class="flow-note"><%= isAr ? 'إجمالي الملفات:' : 'Total files:' %> <%= files.length %></p>
            <ul>
              <% files.forEach(f => { %>
                <li>
                  <% const rawUrl = (f && (f.url || f.path)) ? String(f.url || f.path).trim() : ''; %>
                  <% const isExternal = /^https?:\/\/[^\s]+$/i.test(rawUrl); %>
                  <% const normalizedUploadPath = rawUrl ? rawUrl.replace(/^\/+/, '') : ''; %>
                  <% const internalUploadHref = normalizedUploadPath
                    ? (normalizedUploadPath.startsWith('uploads/')
                        ? ('/' + normalizedUploadPath)
                        : ('/uploads/' + normalizedUploadPath))
                    : ''; %>
                  <% const fileHref = (f && f.id)
                    ? ('/files/' + encodeURIComponent(String(f.id)))
                    : (isExternal ? rawUrl : internalUploadHref); %>
                  <% const isClickableFile = Boolean(fileHref); %>

                  <% if (isClickableFile) { %>
                    <a href="<%= fileHref %>" target="_blank" rel="noreferrer noopener">
                      <%= getDisplayFilename(f) %>
                    </a>
                  <% } else { %>
                    <span class="portal-file-unavailable">
                      <span><%= getDisplayFilename(f) %></span>
                      <span class="portal-file-unavailable-chip"><%= isAr ? 'غير متاح' : 'Unavailable' %></span>
                    </span>
                  <% } %>

                  <% if (!f.id && !isExternal && rawUrl) { %>
                    <span class="flow-note">(legacy)</span>
                  <% } %>

                  <% if (f.mimetype) { %>
                    <span class="flow-note"><%= f.mimetype %></span>
                  <% } %>

                  <% if (canEdit && isClickableFile && f.id) { %>
                    <a
                      href="/annotator.html?imageId=<%= encodeURIComponent(String(f.id)) %>&caseId=<%= orderIdEnc %>&lang=<%= lang %>"
                      target="_blank"
                      rel="noopener"
                      class="btn btn-secondary btn-sm"
                      style="margin-<%= isAr ? 'right' : 'left' %>:8px;font-size:12px;padding:2px 8px;vertical-align:middle;"
                    ><%= isAr ? 'تعليق' : 'Annotate' %></a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
          <% } %>
        <% } %>
      </section>

      <%
        // Check if any files have annotations (via annotatedFiles array from controller)
        const hasAnnotations = annotatedFiles.length > 0;
      %>
      <% if (hasAnnotations) { %>
        <section class="flow-card">
          <h2><%= isAr ? 'الملفات المُعلّق عليها' : 'Annotated Files' %></h2>
          <p class="flow-note"><%= isAr ? 'الصور التي تم تعليقها من قِبل الطبيب المختص.' : 'Images annotated by the reviewing doctor.' %></p>
          <div class="ann-documents-grid">
            <% annotatedFiles.forEach(function(af) { %>
              <div class="ann-doc-card">
                <img
                  src="/api/annotations/<%= encodeURIComponent(String(af.imageId || af.image_id)) %>/image"
                  alt="<%= isAr ? 'صورة مُعلّق عليها' : 'Annotated image' %>"
                  class="ann-doc-thumb"
                  loading="lazy"
                />
                <div class="ann-doc-info">
                  <p class="ann-doc-name"><%= af.doctorName || af.doctor_name || 'Doctor' %></p>
                  <p class="ann-doc-meta"><%= af.updatedAt || af.updated_at || '' %></p>
                </div>
                <div class="ann-doc-actions">
                  <a
                    href="/api/annotations/<%= encodeURIComponent(String(af.imageId || af.image_id)) %>/image"
                    target="_blank"
                    class="ann-doc-btn"
                  ><%= isAr ? 'عرض' : 'View' %></a>
                  <a
                    href="/annotator.html?imageId=<%= encodeURIComponent(String(af.imageId || af.image_id)) %>&caseId=<%= orderIdEnc %>&lang=<%= lang %>"
                    target="_blank"
                    class="ann-doc-btn ann-doc-btn-primary"
                  ><%= isAr ? 'تعديل' : 'Edit' %></a>
                </div>
              </div>
            <% }); %>
          </div>
        </section>
      <% } %>

      <% if (canEdit && !isReportLocked) { %>
        <section class="flow-card">
          <h2><%= isAr ? 'طلب ملفات إضافية' : 'Request additional files' %></h2>
          <p class="flow-note"><%= isAr ? 'استخدم هذا الخيار إذا كانت الملفات غير واضحة أو ناقصة. سيتم إبلاغ الدعم لطلب إعادة الرفع من المريض.' : 'Use this if files are unclear or incomplete. Support will be notified to request a re-upload from the patient.' %></p>

          <form id="requestFilesForm" method="POST" action="/portal/doctor/case/<%= orderIdEnc %>/reject-files">
            <%- (typeof csrfField === 'function') ? csrfField() : '' %>

            <div class="form-group">
              <label class="form-label" for="requestFilesReason"><%= isAr ? 'السبب (مطلوب)' : 'Reason (required)' %></label>
              <textarea
                class="form-control"
                id="requestFilesReason"
                name="reason"
                rows="4"
                required
                placeholder="<%= isAr ? 'مثال: الصور ضبابية / ملفات ناقصة / زاوية غير كافية…' : 'Example: images are blurry / missing files / insufficient angle…' %>"
              ></textarea>
              <p class="flow-note"><%= isAr ? 'اكتب سببًا واضحًا ومحددًا لتوجيه المريض بما يجب إعادة رفعه.' : 'Write a clear, specific reason so the patient knows what to re-upload.' %></p>
            </div>

            <!-- Backward-compat: some handlers may expect message/note -->
            <input type="hidden" id="requestFilesMessage" name="message" value="" />
            <input type="hidden" id="requestFilesNote" name="note" value="" />

            <div class="section-cta">
              <button class="btn btn-secondary" type="submit"><%= isAr ? 'إرسال الطلب' : 'Send request' %></button>
            </div>
          </form>
        </section>
      <% } %>

      <% if (canViewDetails) { %>
        <section class="flow-card">
          <h2><%= isAr ? 'الملاحظات الطبية' : 'Medical notes' %></h2>
          <% if (canEdit) { %>
            <p class="flow-note"><%= isAr ? 'أضف ملاحظات لدعم التقرير النهائي. حافظ على صياغة واضحة ومنظمة سريريًا.' : 'Add notes to support your final report. Keep it clear and clinically structured.' %></p>
          <% } else { %>
            <p class="flow-note"><%= isAr ? 'هذه الحالة للعرض فقط حالياً. يمكنك مراجعة الملاحظات والتقرير دون تعديل.' : 'This case is currently read-only. You can review notes and report details without editing.' %></p>
          <% } %>

          <form method="POST" action="/portal/doctor/case/<%= orderIdEnc %>/diagnosis">
            <%- (typeof csrfField === 'function') ? csrfField() : '' %>
            <div class="form-group">
              <label class="form-label"><%= isAr ? 'الملاحظات / النتائج' : 'Findings / Observations' %></label>
              <!-- Keep name="diagnosis" for backward compatibility with the existing route -->
              <textarea
                class="form-control"
                name="diagnosis"
                placeholder="<%= isAr ? 'اكتب الملاحظات/النتائج هنا…' : 'Write findings/observations here…' %>"
                rows="7"
                <%= (isReportLocked || !canEdit) ? 'readonly' : '' %>
              ><%= (notesPrefill && typeof notesPrefill.findings !== 'undefined') ? notesPrefill.findings : (savedDiagnosis || '') %></textarea>
              <p class="flow-note"><%= isAr ? 'صف ما تراه في الدراسة (النتائج الأساسية) بلغة سريرية واضحة.' : 'Describe what you see in the study (key findings), in clear clinical language.' %></p>
            </div>

            <div class="form-group">
              <label class="form-label"><%= isAr ? 'الخلاصة / الانطباع' : 'Impression / Conclusion' %></label>
              <textarea
                class="form-control"
                name="impression"
                placeholder="<%= isAr ? 'لخّص الخلاصة/الانطباع…' : 'Summarize your impression/conclusion…' %>"
                rows="5"
                <%= (isReportLocked || !canEdit) ? 'readonly' : '' %>
              ><%= (notesPrefill && typeof notesPrefill.impression !== 'undefined') ? notesPrefill.impression : (savedImpression || '') %></textarea>
              <p class="flow-note"><%= isAr ? 'انطباعك التشخيصي (التشخيص الأرجح + سبب مختصر إن لزم).' : 'Your diagnostic impression (most likely diagnosis + brief reasoning if needed).' %></p>
            </div>

            <div class="form-group">
              <label class="form-label"><%= isAr ? 'التوصيات' : 'Recommendations' %></label>
              <textarea
                class="form-control"
                name="recommendations"
                placeholder="<%= isAr ? 'أضف الخطوات التالية الموصى بها…' : 'Add recommended next steps…' %>"
                rows="5"
                <%= (isReportLocked || !canEdit) ? 'readonly' : '' %>
              ><%= (notesPrefill && typeof notesPrefill.recommendations !== 'undefined') ? notesPrefill.recommendations : (savedRecommendations || '') %></textarea>
              <p class="flow-note"><%= isAr ? 'تصوير/تحاليل متابعة، إحالات، درجة الاستعجال، أو بدائل تشخيصية مقترحة.' : 'Follow‑up imaging, labs, referrals, urgency, or alternative differentials to consider.' %></p>
            </div>

            <div class="section-cta">
              <% if (!isReportLocked && canEdit) { %>
                <!-- Save draft (keeps progress without generating a report) -->
                <button class="btn btn-secondary" type="submit"><%= isAr ? 'حفظ مسودة' : 'Save draft' %></button>

                <!-- Generates a PDF report (and should save current fields) -->
                <button
                  class="btn btn-primary"
                  type="submit"
                  formaction="/portal/doctor/case/<%= orderIdEnc %>/report"
                  formmethod="POST"
                >
                  <%= isAr ? 'إنشاء التقرير (PDF)' : 'Generate report (PDF)' %>
                </button>
              <% } %>
            </div>

            <% if (reportUrl || isReportLocked) { %>
              <div class="section-cta" style="display:flex;gap:8px;flex-wrap:wrap;">
                <% if (reportUrl) { %>
                  <a class="btn btn-secondary" href="<%= reportUrl %>" target="_blank" rel="noopener"><%= isAr ? 'فتح التقرير (PDF)' : 'Open report (PDF)' %></a>
                <% } %>
                <a class="btn btn-secondary" href="/portal/case/<%= order.id %>/report"><%= isAr ? 'عرض التقرير' : 'View Report' %></a>
              </div>
            <% } %>

            <% if (isReportLocked && !reportUrl) { %>
              <p class="flow-note"><%= isAr ? 'تم قفل الملاحظات لهذه الحالة.' : 'Notes are locked for this case.' %></p>
            <% } %>

            <p class="flow-note"><%= isAr ? 'زر إنشاء التقرير يقوم بإنشاء ملف PDF من ملاحظاتك وإرفاقه بالحالة.' : 'Generate report creates a PDF from your notes and attaches it to the case.' %></p>
            <p class="flow-note"><%= isAr ? 'ملاحظة: حفظ المسودة اختياري. بعد إنشاء التقرير يتم قفل الملاحظات لمنع التكرار.' : 'Tip: Save draft is optional. Once a report is generated, notes are locked to prevent duplicates.' %></p>
          </form>
        </section>
      <% } %>


<% if (canEdit && !isReportLocked && cspNonce) { %>
<script nonce="<%= cspNonce %>">
  (function () {
    try {
      var form = document.getElementById('requestFilesForm');
      if (!form) return;
      form.addEventListener('submit', function () {
        var reasonEl = document.getElementById('requestFilesReason');
        var msgEl = document.getElementById('requestFilesMessage');
        var noteEl = document.getElementById('requestFilesNote');
        var v = reasonEl ? String(reasonEl.value || '') : '';
        if (msgEl) msgEl.value = v;
        if (noteEl) noteEl.value = v;
      });
    } catch (e) {}
  })();
</script>
<% } %>

    </div>

    <aside class="portal-case-aside">
      <div class="portal-sticky">
        <div class="flow-card">
          <h2><%= isAr ? 'ملخص الحالة' : 'Case summary' %></h2>
          <div class="kv-grid">
            <div class="kv">
              <div class="kv-label"><%= isAr ? 'الحالة' : 'Status' %></div>
              <div class="kv-value"><%= order.status || '—' %></div>
            </div>
            <div class="kv">
              <div class="kv-label"><%= isAr ? 'الدفع' : 'Payment' %></div>
              <div class="kv-value"><%= isPaid ? (isAr ? 'مدفوع' : 'Paid') : (isAr ? 'غير مدفوع' : 'Unpaid') %></div>
            </div>
            <div class="kv">
              <div class="kv-label"><%= isAr ? 'الملفات' : 'Files' %></div>
              <div class="kv-value"><%= Array.isArray(files) ? files.length : 0 %></div>
            </div>
            <div class="kv">
              <div class="kv-label"><%= isAr ? 'التقرير' : 'Report' %></div>
              <div class="kv-value"><%= reportUrl ? (isAr ? 'متاح' : 'Available') : (isAr ? 'غير متاح' : 'None') %></div>
            </div>
          </div>

          <div class="section-cta">
            <a class="btn btn-secondary btn-full" href="/portal/doctor"><%= isAr ? 'العودة للوحة التحكم' : 'Back to dashboard' %></a>
            <% if (reportUrl) { %>
              <a class="btn btn-secondary btn-full" href="<%= reportUrl %>" target="_blank" rel="noopener"><%= isAr ? 'فتح التقرير (PDF)' : 'Open report (PDF)' %></a>
            <% } %>
            <% if (canViewDetails) { %>
              <a class="btn btn-primary btn-full" href="/portal/doctor/case/<%= orderIdEnc %>/prescribe"><%= isAr ? 'إنشاء وصفة طبية' : 'Create Prescription' %></a>
            <% } %>
          </div>
        </div>

        <% if (detailsLocked) { %>
          <div class="flow-card">
            <% if (!isPaid) { %>
              <p class="flow-note"><%= isAr ? 'هذه الحالة غير متاحة حتى يتم تأكيد الدفع.' : 'This case is unavailable until payment is confirmed.' %></p>
            <% } else if (canAccept) { %>
              <p class="flow-note"><%= isAr ? 'هذه الحالة مقفلة حتى يتم قبولها.' : 'This case is locked until it is accepted.' %></p>
            <% } else { %>
              <p class="flow-note"><%= isAr ? 'هذه الحالة غير متاحة بعد للمراجعة.' : 'This case is not yet available for review.' %></p>
            <% } %>
          </div>
        <% } %>

        <% if (isReportLocked) { %>
          <div class="flow-card">
            <p class="flow-note"><%= isAr ? 'تم قفل الملاحظات لأن التقرير تم إنشاؤه أو تم إكمال الحالة.' : 'Notes are locked because the report has been generated or the case is completed.' %></p>
          </div>
        <% } %>
      </div>
    </aside>
  </div>
</div>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
