<%- include('partials/header', { title: "Order Details", layout: "portal", showNav: true, showFooter: false, portalFrame: true, portalRole: 'superadmin', portalActive: 'dashboard', portalNext: '/superadmin/orders/' + (order && order.id ? order.id : '') }) %>
  <%
    function formatEventDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = String(d.getFullYear());
      let hh = d.getHours();
      const min = String(d.getMinutes()).padStart(2, '0');
      const ampm = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12;
      if (hh === 0) hh = 12;
      return `${dd}/${mm}/${yyyy} – ${hh}:${min} ${ampm}`;
    }
    const paymentLink = order.payment_link || order.service_payment_link;
    const isAr = (typeof lang !== 'undefined' && lang === 'ar');
  %>
        <div class="admin-page">
          <div class="admin-page-header">
            <div class="admin-page-header-left">
              <nav class="admin-breadcrumb">
                <a href="/superadmin">Dashboard</a>
                <span class="admin-breadcrumb-sep">&rsaquo;</span>
                <a href="/admin/orders"><%= isAr ? 'الحالات' : 'Cases' %></a>
                <span class="admin-breadcrumb-sep">&rsaquo;</span>
                <span>Order #<%= order.id %></span>
              </nav>
              <h1 class="admin-page-title">Order <%= order.id %></h1>
              <p class="admin-page-subtitle">
                <%= order.service_name || 'Service' %>
                <% if (order.specialty_name) { %> &middot; <%= order.specialty_name %><% } %>
              </p>
            </div>
            <div class="admin-page-header-right">
              <a class="admin-btn admin-btn-outline btn-small" href="/superadmin">&larr; Back to dashboard</a>
            </div>
          </div>

          <div class="admin-grid-2">
            <div class="admin-card">
              <div class="admin-card-body">
                <div class="card-header">
                  <div class="card-title">Summary</div>
                  <span class="status-pill status-pill--<%= (order.status || 'new').toLowerCase() %>"><%= order.status %></span>
                </div>
                <ul class="events-list">
                  <li><strong>Patient:</strong> <%= order.patient_name || '—' %> (<%= order.patient_email || '—' %>)</li>
                  <li><strong>Doctor:</strong> <%= order.doctor_name || 'Unassigned' %> <%= order.doctor_email ? '(' + order.doctor_email + ')' : '' %></li>
                  <li><strong>Specialty:</strong> <%= order.specialty_name || '—' %></li>
                  <li><strong>Service:</strong> <%= order.service_name || '—' %></li>
                  <li><strong>SLA:</strong> <%= order.sla_hours || '—' %>h</li>
                  <li><strong>Status:</strong> <%= order.status %></li>
                  <li><strong>Created:</strong> <%= order.created_at || '—' %></li>
                </ul>
              </div>
            </div>

            <div class="admin-card">
              <div class="admin-card-body">
                <div class="card-header">
                  <div class="card-title">Payment</div>
                  <% if (order.payment_status === 'paid') { %>
                    <span class="status-pill status-pill--completed">Paid</span>
                  <% } else { %>
                    <span class="status-pill status-pill--new">Unpaid</span>
                  <% } %>
                </div>
                <div class="muted" style="font-size:13px; margin-bottom:6px;">
                  Price: <%= order.displayCurrency %> <%= order.displayPrice != null ? order.displayPrice : '—' %> &middot; Doctor fee: <%= order.displayDoctorFee != null ? order.displayDoctorFee : '—' %>
                </div>
                <% if (order.payment_method || order.payment_reference) { %>
                  <div class="muted" style="font-size:12px; margin-bottom:10px;">
                    <% if (order.payment_method) { %>Method: <%= order.payment_method %><% } %>
                    <% if (order.payment_reference) { %> &middot; Ref: <%= order.payment_reference %><% } %>
                  </div>
                <% } %>
                <% if (paymentLink) { %>
                  <a class="admin-btn admin-btn-outline btn-small" href="<%= paymentLink %>" target="_blank" rel="noopener">Open payment link</a>
                <% } else { %>
                  <p class="muted" style="margin:6px 0;">No payment link on record.</p>
                <% } %>

                <% if (order.payment_status !== 'paid') { %>
                  <form method="post" action="/superadmin/orders/<%= order.id %>/mark-paid" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <label style="font-size:12px; font-weight:700;">Mark as paid</label>
                    <input type="text" name="payment_method" placeholder="Payment method (e.g. Paymob link, card, cash)" value="<%= order.payment_method || '' %>" />
                    <input type="text" name="payment_reference" placeholder="Payment reference / transaction id" value="<%= order.payment_reference || '' %>" />
                    <button class="admin-btn admin-btn-primary btn-small" type="submit">Mark paid</button>
                  </form>
                <% } else { %>
                  <form method="post" action="/superadmin/orders/<%= order.id %>/mark-unpaid" style="margin-top:12px;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <button class="admin-btn admin-btn-outline btn-small" type="submit">Mark as unpaid</button>
                  </form>
                <% } %>
              </div>
            </div>
            <div class="admin-card">
              <div class="admin-card-body">
                <div class="card-header">
                  <div class="card-title">Uploads</div>
                  <% if (Number(order.uploads_locked) === 1) { %>
                    <span id="uploadsStatePill" class="status-pill status-pill--breached" data-locked="1">Locked</span>
                  <% } else { %>
                    <span id="uploadsStatePill" class="status-pill status-pill--completed" data-locked="0">Unlocked</span>
                  <% } %>
                </div>

                <p class="muted" style="margin:6px 0; font-size:12px;">
                  If uploads are locked (for example after payment), support/admin can unlock them for the patient to add missing files.
                </p>
                <p class="muted" style="margin:4px 0 0; font-size:12px;">
                  Current flag: <strong id="uploadsFlagText"><%= Number(order.uploads_locked) === 1 ? 'uploads_locked = 1' : 'uploads_locked = 0' %></strong>
                </p>

                <div id="uploadsActionMsg" class="muted" style="display:none; margin:8px 0; font-size:12px;"></div>

                <div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; margin-top:10px;">
                  <div style="flex:1; min-width:240px;">
                    <label style="font-size:12px; font-weight:700;">Unlock reason (audit)</label>
                    <input id="unlockReason" type="text" placeholder="e.g. patient requested to add missing MRI" value="support_unlock" />
                  </div>

                  <div id="uploadsCsrf" style="display:none;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                  </div>

                  <button
                    id="unlockUploadsBtn"
                    class="admin-btn admin-btn-outline"
                    type="button"
                    data-action="/admin/orders/<%= order.id %>/uploads/unlock?format=json"
                    style="cursor:pointer; pointer-events:auto !important;"
                  >
                    Unlock uploads
                  </button>

                  <button
                    id="lockUploadsBtn"
                    class="admin-btn admin-btn-outline"
                    type="button"
                    data-action="/admin/orders/<%= order.id %>/uploads/lock?format=json"
                    style="cursor:pointer; pointer-events:auto !important;"
                  >
                    Lock uploads
                  </button>
                </div>

                <p class="muted" style="font-size:12px; margin-top:8px;">
                  This action calls the admin support endpoint and writes an audit event.
                </p>
              </div>
            </div>

            <div class="admin-card">
              <div class="admin-card-body">
                <div class="card-header">
                  <div class="card-title">Additional files request</div>
                  <%
                    const afr = (typeof additionalFilesRequest !== 'undefined' && additionalFilesRequest) ? additionalFilesRequest : null;
                    const hasReq = !!(afr && afr.request);
                    const reqAtIso = hasReq && afr.request.at ? afr.request.at : null;
                    const reqMeta = hasReq ? (afr.request.meta || {}) : {};
                    const reqReason = (reqMeta && typeof reqMeta === 'object' && reqMeta.reason) ? String(reqMeta.reason) : '';
                    const reqDoctorId = (reqMeta && typeof reqMeta === 'object' && reqMeta.doctorId) ? String(reqMeta.doctorId) : '';

                    const hasDecision = !!(afr && afr.decision);
                    const decisionLabel = hasDecision && afr.decision.label ? String(afr.decision.label).toLowerCase() : '';
                    const decisionAtIso = hasDecision && afr.decision.at ? afr.decision.at : null;
                    const decisionMeta = hasDecision ? (afr.decision.meta || {}) : {};
                    const decisionNote = (decisionMeta && typeof decisionMeta === 'object' && decisionMeta.support_note) ? String(decisionMeta.support_note) : '';

                    const uploadsLocked = Number(order && order.uploads_locked != null ? order.uploads_locked : 0);
                    const hasReqFlag = Number(order && order.additional_files_requested != null ? order.additional_files_requested : 0) === 1;

                    // Canonical UI state:
                    // 1) If a decision event exists, trust it.
                    // 2) Otherwise, infer approval from uploads unlocking (uploads_locked=0) when a request flag exists.
                    // 3) Otherwise, if there is a request event, it's pending.
                    // 4) Otherwise none.
                    const status = !hasReq
                      ? 'none'
                      : (hasDecision
                        ? (decisionLabel.includes('approved') ? 'approved'
                          : ((decisionLabel.includes('reject') || decisionLabel.includes('denied')) ? 'rejected' : 'pending'))
                        : ((hasReqFlag && uploadsLocked === 0) ? 'approved' : 'pending'));

                    const pillClass = status === 'approved'
                      ? 'status-pill--completed'
                      : (status === 'pending' ? 'status-pill--breached'
                        : (status === 'rejected' ? 'status-pill--breached' : 'status-pill--new'));

                    const pillText = status === 'approved'
                      ? 'Approved'
                      : (status === 'pending' ? 'Pending'
                        : (status === 'rejected' ? 'Rejected' : 'None'));
                  %>
                  <span class="status-pill <%= pillClass %>"><%= pillText %></span>
                </div>

                <% if (!hasReq) { %>
                  <p class="muted" style="margin:6px 0; font-size:12px;">No additional-files requests for this order.</p>
                <% } else { %>
                  <div class="muted" style="font-size:12px; margin:6px 0;">
                    Doctors can request a re-upload when files are unclear/incomplete. Support must approve before the patient is asked.
                  </div>

                  <div class="muted" style="font-size:12px; margin:6px 0;">
                    <% if (reqAtIso) { %>Requested: <strong><%= formatEventDate(reqAtIso) %></strong><% } %>
                    <% if (reqDoctorId) { %> &middot; Doctor: <strong><%= reqDoctorId %></strong><% } %>
                  </div>

                  <div style="margin-top:10px;">
                    <div style="font-size:12px; font-weight:700;">Doctor reason</div>
                    <div class="muted" style="font-size:12px; white-space:pre-line; margin-top:4px;"><%= reqReason || '—' %></div>
                  </div>

                  <% if (status !== 'pending' && (decisionAtIso || decisionNote)) { %>
                    <div style="margin-top:12px;">
                      <div style="font-size:12px; font-weight:700;">Last decision</div>
                      <div class="muted" style="font-size:12px; margin-top:4px;">
                        <% if (decisionAtIso) { %>At: <strong><%= formatEventDate(decisionAtIso) %></strong><% } %>
                      </div>
                      <% if (decisionNote) { %>
                        <div class="muted" style="font-size:12px; white-space:pre-line; margin-top:4px;"><%= decisionNote %></div>
                      <% } %>
                    </div>
                  <% } %>

                  <% if (status === 'pending') { %>
                    <form method="post" action="/superadmin/orders/<%= order.id %>/additional-files/approve" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                      <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                      <input type="hidden" name="request_event_id" value="<%= afr.request.id %>" />
                      <label style="font-size:12px; font-weight:700;">Support note (optional)</label>
                      <input type="text" name="support_note" placeholder="e.g. approved - ask patient to re-upload clearer axial series" value="" />
                      <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="admin-btn admin-btn-primary btn-small" type="submit">Approve request</button>
                      </div>
                    </form>

                    <form method="post" action="/superadmin/orders/<%= order.id %>/additional-files/reject" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
                      <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                      <input type="hidden" name="request_event_id" value="<%= afr.request.id %>" />
                      <label style="font-size:12px; font-weight:700;">Rejection note (optional)</label>
                      <input type="text" name="support_note" placeholder="e.g. rejected - request not specific enough" value="" />
                      <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="admin-btn admin-btn-outline btn-small" type="submit">Reject request</button>
                      </div>
                    </form>

                    <p class="muted" style="font-size:12px; margin-top:10px;">Approving moves the case into an "awaiting files" flow and notifies the patient to re-upload. Rejecting logs the decision and keeps the case moving.</p>
                  <% } %>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Status Timeline (3B) -->
          <div class="admin-card" style="margin-top:20px;">
            <div class="admin-card-body">
              <div class="card-header">
                <div class="card-title"><%= isAr ? 'مراحل الحالة' : 'Case Timeline' %></div>
              </div>
              <%
                var timelineSteps = [
                  { key: 'created', label: isAr ? 'تم الإنشاء' : 'Created', icon: 'plus-circle' },
                  { key: 'payment', label: isAr ? 'الدفع' : 'Payment', icon: 'credit-card' },
                  { key: 'assigned', label: isAr ? 'تم التعيين' : 'Assigned', icon: 'user-check' },
                  { key: 'in_review', label: isAr ? 'قيد المراجعة' : 'In Review', icon: 'file-text' },
                  { key: 'report', label: isAr ? 'التقرير' : 'Report', icon: 'clipboard' },
                  { key: 'completed', label: isAr ? 'مكتملة' : 'Completed', icon: 'check-circle' }
                ];
                var orderStatus = String(order.status || '').toLowerCase();
                var isPaid = String(order.payment_status || '').toLowerCase() === 'paid';
                var hasDoctor = !!order.doctor_id;
                var isCompleted = ['completed','done','delivered'].indexOf(orderStatus) >= 0;
                var isInReview = orderStatus === 'in_review' || orderStatus === 'accepted';
                var isBreach = orderStatus === 'breached';
                var hasReport = !!order.completed_at;

                function stepDone(key) {
                  if (key === 'created') return true;
                  if (key === 'payment') return isPaid;
                  if (key === 'assigned') return hasDoctor;
                  if (key === 'in_review') return isInReview || hasReport || isCompleted;
                  if (key === 'report') return hasReport || isCompleted;
                  if (key === 'completed') return isCompleted;
                  return false;
                }
                function stepActive(key) {
                  if (key === 'payment' && !isPaid) return true;
                  if (key === 'assigned' && isPaid && !hasDoctor) return true;
                  if (key === 'in_review' && hasDoctor && !isCompleted && !hasReport) return true;
                  if (key === 'report' && isInReview && !hasReport) return true;
                  if (key === 'completed' && hasReport && !isCompleted) return true;
                  return false;
                }
              %>
              <div style="display:flex;align-items:flex-start;gap:0;overflow-x:auto;padding:12px 0;">
                <% timelineSteps.forEach(function(step, idx) {
                  var done = stepDone(step.key);
                  var active = stepActive(step.key);
                  var dotColor = done ? '#10b981' : (active ? '#f59e0b' : '#d1d5db');
                  var textColor = done ? '#065f46' : (active ? '#92400e' : '#9ca3af');
                  var lineColor = done ? '#10b981' : '#e5e7eb';
                %>
                  <div style="display:flex;flex-direction:column;align-items:center;min-width:80px;position:relative;">
                    <div style="width:28px;height:28px;border-radius:50%;background:<%= dotColor %>;display:flex;align-items:center;justify-content:center;">
                      <% if (done) { %>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                      <% } else if (active) { %>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><circle cx="12" cy="12" r="4"/></svg>
                      <% } else { %>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="6"/></svg>
                      <% } %>
                    </div>
                    <div style="font-size:11px;font-weight:600;color:<%= textColor %>;margin-top:6px;text-align:center;"><%= step.label %></div>
                  </div>
                  <% if (idx < timelineSteps.length - 1) { %>
                    <div style="flex:1;height:2px;background:<%= lineColor %>;margin-top:14px;min-width:20px;"></div>
                  <% } %>
                <% }); %>
              </div>
              <% if (isBreach) { %>
                <div style="margin-top:8px;padding:6px 12px;background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;font-size:12px;color:#dc2626;display:flex;align-items:center;gap:6px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                  <%= isAr ? 'هذه الحالة تجاوزت الموعد النهائي لـ SLA' : 'This case has breached its SLA deadline' %>
                </div>
              <% } %>
            </div>
          </div>

          <!-- Additional Action Buttons (3A) -->
          <div class="admin-card" style="margin-top:20px;">
            <div class="admin-card-body">
              <div class="card-header">
                <div class="card-title"><%= isAr ? 'إجراءات إضافية' : 'Additional Actions' %></div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <% if (paymentLink) { %>
                  <a class="admin-btn admin-btn-outline btn-small" href="<%= paymentLink %>" target="_blank" rel="noopener">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                    <%= isAr ? 'إرسال رابط دفع' : 'Send Payment Link' %>
                  </a>
                <% } %>
                <% if (order.status !== 'cancelled') { %>
                  <form method="post" action="/superadmin/orders/<%= order.id %>/cancel" style="display:inline;" onsubmit="return confirm('<%= isAr ? 'هل أنت متأكد من إلغاء هذه الحالة؟' : 'Are you sure you want to cancel this case?' %>');">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <button class="admin-btn admin-btn-outline btn-small" type="submit" style="color:#dc2626;border-color:#fca5a5;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                      <%= isAr ? 'إلغاء الحالة' : 'Cancel Order' %>
                    </button>
                  </form>
                <% } %>
                <% if (order.sla_hours && order.deadline_at) { %>
                  <form method="post" action="/superadmin/orders/<%= order.id %>/extend-sla" style="display:inline-flex;gap:4px;align-items:center;">
                    <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                    <input type="number" name="extra_hours" value="24" min="1" max="168" style="width:60px;padding:4px 6px;font-size:12px;border:1px solid #d1d5db;border-radius:4px;" />
                    <button class="admin-btn admin-btn-outline btn-small" type="submit">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                      <%= isAr ? 'تمديد SLA' : 'Extend SLA' %>
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>

          <div class="admin-card" style="margin-top:20px;">
            <div class="admin-card-body">
              <div class="card-header">
                <div class="card-title">Reassign doctor</div>
              </div>
              <form method="post" action="/superadmin/orders/<%= order.id %>/reassign" style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
                <%- (typeof csrfField === 'function') ? csrfField() : '' %>
                <div style="flex:1; min-width:220px;">
                  <label class="filter-label">Select doctor</label>
                  <select name="doctor_id" required>
                    <option value="">Choose doctor</option>
                    <% (doctors || []).forEach(function(doc){ %>
                      <option value="<%= doc.id %>" <%= order.doctor_id && String(order.doctor_id) === String(doc.id) ? 'selected' : '' %>><%= doc.name %></option>
                    <% }); %>
                  </select>
                </div>
                <button class="admin-btn admin-btn-primary" type="submit">Reassign</button>
              </form>
              <p class="muted" style="font-size:12px; margin-top:6px;">Reassigning will notify the new doctor and log an event.</p>
            </div>
          </div>

          <div class="admin-card" style="margin-top:20px;">
            <div class="admin-card-body">
              <div class="card-header">
                <div class="card-title">Latest activity</div>
              </div>
              <ul class="events-list">
                <% if (events && events.length) { %>
                  <% events.forEach(function(ev) { %>
                    <li class="event-item">
                      <div class="event-label"><%= ev.label %></div>
                      <div class="event-meta"><%= formatEventDate(ev.at) %></div>
                      <% if (ev.meta) { %>
                        <div class="muted" style="font-size:12px; white-space:pre-line;"><%= (typeof ev.meta === 'string') ? ev.meta : JSON.stringify(ev.meta, null, 2) %></div>
                      <% } %>
                    </li>
                  <% }); %>
                <% } else { %>
                  <li class="event-item">
                    <div class="event-meta">No events yet.</div>
                  </li>
                <% } %>
              </ul>
            </div>
          </div>
        </div>
<script nonce="<%= (typeof cspNonce !== 'undefined' && cspNonce) ? cspNonce : '' %>">
  (function () {
    const unlockBtn = document.getElementById('unlockUploadsBtn');
    const lockBtn = document.getElementById('lockUploadsBtn');
    const uploadsCsrf = document.getElementById('uploadsCsrf');
    const msg = document.getElementById('uploadsActionMsg');
    const reasonEl = document.getElementById('unlockReason');
    const pill = document.getElementById('uploadsStatePill');
    const flagText = document.getElementById('uploadsFlagText');

    function show(text, isError) {
      if (!msg) return;
      msg.style.display = 'block';
      msg.style.color = isError ? '#b91c1c' : '#065f46';
      msg.textContent = text;
    }

    // Force-clickability in case CSS disables pointer events on buttons
    if (unlockBtn) {
      unlockBtn.style.pointerEvents = 'auto';
      unlockBtn.style.cursor = 'pointer';
    }
    if (lockBtn) {
      lockBtn.style.pointerEvents = 'auto';
      lockBtn.style.cursor = 'pointer';
    }

    // If you can see this message, the JS is running on this page
    if (msg) {
      msg.style.display = 'block';
      msg.style.color = '#334155';
      msg.textContent = 'Uploads controls ready.';
    }

    function setPillLocked(isLocked) {
      if (!pill) return;
      pill.dataset.locked = isLocked ? '1' : '0';
      pill.textContent = isLocked ? 'Locked' : 'Unlocked';
      pill.classList.remove('status-pill--breached', 'status-pill--completed');
      pill.classList.add(isLocked ? 'status-pill--breached' : 'status-pill--completed');
      if (flagText) flagText.textContent = isLocked ? 'uploads_locked = 1' : 'uploads_locked = 0';
    }

    function setButtons(isLocked) {
      // No restrictions: both buttons always clickable.
      // We only style the "recommended" action as primary.
      if (unlockBtn) {
        unlockBtn.disabled = false;
        unlockBtn.classList.remove('btn-primary', 'btn-outline');
        unlockBtn.classList.add(isLocked ? 'btn-primary' : 'btn-outline');
        unlockBtn.textContent = 'Unlock uploads';
        unlockBtn.title = isLocked ? '' : 'Uploads are already unlocked (you can still click to re-apply)';
      }
      if (lockBtn) {
        lockBtn.disabled = false;
        lockBtn.classList.remove('btn-primary', 'btn-outline');
        lockBtn.classList.add(!isLocked ? 'btn-primary' : 'btn-outline');
        lockBtn.textContent = 'Lock uploads';
        lockBtn.title = !isLocked ? '' : 'Uploads are already locked (you can still click to re-apply)';
      }
    }

    function getCsrfToken() {
      const el = uploadsCsrf ? uploadsCsrf.querySelector('input[name="_csrf"]') : null;
      return el && el.value ? String(el.value) : '';
    }

    async function callAction(action) {
      const reason = (reasonEl && reasonEl.value ? reasonEl.value : 'support_change').trim();
      const url = action === 'unlock'
        ? (unlockBtn && unlockBtn.dataset && unlockBtn.dataset.action ? unlockBtn.dataset.action : `/admin/orders/<%= order.id %>/uploads/unlock?format=json`)
        : (lockBtn && lockBtn.dataset && lockBtn.dataset.action ? lockBtn.dataset.action : `/admin/orders/<%= order.id %>/uploads/lock?format=json`);

      const csrf = getCsrfToken();
      if (!csrf) {
        throw new Error('Missing CSRF token on page. Refresh and try again.');
      }

      const body = new URLSearchParams();
      body.set('_csrf', csrf);
      body.set('reason', reason);

      const res = await fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        redirect: 'manual',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        },
        body: body.toString()
      });

      // If the server tries to redirect, we want to fail fast (this used to cause /admin -> /admin/doctors)
      if (res.status >= 300 && res.status < 400) {
        throw new Error('Server redirected (expected JSON). Please refresh and try again.');
      }

      const ct = (res.headers.get('content-type') || '').toLowerCase();
      const data = ct.includes('application/json') ? await res.json().catch(() => null) : null;

      if (!ct.includes('application/json')) {
        throw new Error('Expected JSON response but received HTML.');
      }

      if (!res.ok) {
        const detail = data && (data.error || data.message) ? (data.error || data.message) : (res.status + ' ' + res.statusText);
        throw new Error(detail);
      }

      return data;
    }

    function setBusy(btn, text) {
      if (!btn) return () => {};
      const prevText = btn.textContent;
      const prevDisabled = btn.disabled;
      btn.disabled = true;
      btn.textContent = text;
      return () => {
        btn.disabled = prevDisabled;
        btn.textContent = prevText;
      };
    }

    // Init: ensure button state matches pill state (in case template changes later)
    const initialLocked = pill ? pill.dataset.locked === '1' : (<%= Number(order.uploads_locked) === 1 ? 'true' : 'false' %>);
    setButtons(initialLocked);

    function syncReasonToHidden() {
      const reason = (reasonEl && reasonEl.value ? reasonEl.value : '').trim();
      return reason || 'support_change';
    }

    // Button-driven actions (no form submits). Prevents 302 redirects.
    async function onUnlockClick(e) {
      e.preventDefault();
      syncReasonToHidden();

      const restore = setBusy(unlockBtn, 'Unlocking…');
      const beforeLocked = pill ? pill.dataset.locked === '1' : false;

      show('Unlocking uploads…', false);

      try {
        const data = await callAction('unlock');
        setPillLocked(false);
        setButtons(false);
        show(`Uploads unlocked ✅ (reason: ${data && data.reason ? data.reason : '—'})`, false);
      } catch (err) {
        // Do NOT fall back to normal submit (it redirects to /admin/doctors)
        setPillLocked(beforeLocked);
        setButtons(beforeLocked);
        show(`Unlock failed: ${err.message}`, true);
      } finally {
        restore();
      }
    }

    async function onLockClick(e) {
      e.preventDefault();
      syncReasonToHidden();

      const restore = setBusy(lockBtn, 'Locking…');
      const beforeLocked = pill ? pill.dataset.locked === '1' : true;

      show('Locking uploads…', false);

      try {
        const data = await callAction('lock');
        setPillLocked(true);
        setButtons(true);
        show(`Uploads locked ✅ (reason: ${data && data.reason ? data.reason : '—'})`, false);
      } catch (err) {
        // Do NOT fall back to normal submit (it redirects to /admin/doctors)
        setPillLocked(beforeLocked);
        setButtons(beforeLocked);
        show(`Lock failed: ${err.message}`, true);
      } finally {
        restore();
      }
    }

    if (unlockBtn) unlockBtn.addEventListener('click', onUnlockClick);
    if (lockBtn) lockBtn.addEventListener('click', onLockClick);
  })();
</script>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
