<%- include('partials/header', { title: "Patient Dashboard", layout: "portal", showNav: false, showFooter: false }) %>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<% const brandSafe = typeof brand !== 'undefined' ? brand : 'Tashkheesa'; %>
  <%
    const list = Array.isArray(orders) ? orders : [];
    const filtersObj = filters || {};
    const specialtiesList = Array.isArray(specialties) ? specialties : [];
    const rawStatus = (filtersObj.status || '').toLowerCase();
    const statusAlias = { new: 'submitted', accepted: 'assigned', breached: 'sla_breach' };
    const activeStatus = statusAlias[rawStatus] || rawStatus;

    const tSafe = function(key, en, ar) {
      try {
        const v = t(key);
        if (!v || v === key) return isAr ? ar : en;
        return v;
      } catch (e) {
        return isAr ? ar : en;
      }
    };

    const buildStatusLink = function(val) {
      const params = new URLSearchParams();
      if (val) params.set('status', val);
      if (filtersObj.specialty) params.set('specialty', filtersObj.specialty);
      if (filtersObj.q) params.set('q', filtersObj.q);
      const qs = params.toString();
      return '/dashboard' + (qs ? ('?' + qs) : '');
    };

    const safeNext = buildStatusLink(activeStatus);
  %>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= isAr ? 'بوابة المريض' : 'Patient Portal' %></span>
    </div>
  </div>

  <div class="portal-grid">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/dashboard" class="active">Dashboard</a></li>
        <li><a href="/portal/patient/orders/new">New Case</a></li>
        <li><a href="/portal/patient/alerts">Alerts</a></li>
        <li><a href="/patient/profile">Profile</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </aside>

    <main class="portal-content">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= t('patient.dashboard.h1') %></h1>
        <p class="portal-hero-subtitle"><%= t('patient.dashboard.subtitle') %></p>
        <div class="portal-hero-actions">
          <a class="btn btn-primary" href="/portal/patient/orders/new"><%= t('patient.dashboard.create_new_case') %></a>
        </div>
      </div>

      <div class="flow-card soft">
        <h3><%= t('common.status') %></h3>
        <ul>
          <li><a href="/dashboard"><%= t('common.all') %></a></li>
          <li><a href="<%= buildStatusLink('submitted') %>"><%= tSafe('status.submitted', 'Submitted', 'تم الإرسال') %></a></li>
          <li><a href="<%= buildStatusLink('assigned') %>"><%= tSafe('status.assigned', 'Assigned', 'تم التعيين') %></a></li>
          <li><a href="<%= buildStatusLink('in_review') %>"><%= t('status.in_review') %></a></li>
          <li><a href="<%= buildStatusLink('completed') %>"><%= t('status.completed') %></a></li>
          <li><a href="<%= buildStatusLink('sla_breach') %>"><%= tSafe('status.sla_breach', 'SLA Breach', 'تجاوز الوقت') %></a></li>
        </ul>
      </div>

      <div class="flow-card primary">
        <form method="get" action="/dashboard">
          <div class="form-group">
            <label class="form-label"><%= t('common.status') %></label>
            <select name="status" class="form-control">
              <option value="" <%= !filtersObj.status ? 'selected' : '' %>><%= t('common.all_statuses') %></option>
              <option value="submitted" <%= activeStatus === 'submitted' ? 'selected' : '' %>><%= tSafe('status.submitted', 'Submitted', 'تم الإرسال') %></option>
              <option value="assigned" <%= activeStatus === 'assigned' ? 'selected' : '' %>><%= tSafe('status.assigned', 'Assigned', 'تم التعيين') %></option>
              <option value="in_review" <%= activeStatus === 'in_review' ? 'selected' : '' %>><%= t('status.in_review') %></option>
              <option value="completed" <%= activeStatus === 'completed' ? 'selected' : '' %>><%= t('status.completed') %></option>
              <option value="sla_breach" <%= activeStatus === 'sla_breach' ? 'selected' : '' %>><%= tSafe('status.sla_breach', 'SLA Breach', 'تجاوز الوقت') %></option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label"><%= t('patient.new_case.specialty') %></label>
            <select name="specialty" class="form-control">
              <option value="" <%= !filtersObj.specialty ? 'selected' : '' %>><%= t('patient.dashboard.all_specialties') %></option>
              <% specialtiesList.forEach(function(s) { %>
                <option value="<%= s.id %>" <%= String(filtersObj.specialty) === String(s.id) ? 'selected' : '' %>><%= s.name %></option>
              <% }); %>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label"><%= t('common.search') %></label>
            <input type="text" name="q" placeholder="<%= t('patient.dashboard.search_ph') %>" value="<%= filtersObj.q || '' %>" class="form-control" />
          </div>

          <div class="section-cta">
            <button type="submit" class="btn btn-primary"><%= t('common.apply') %></button>
            <a href="/dashboard" class="btn btn-secondary"><%= t('common.reset') %></a>
          </div>
        </form>
      </div>

      <% if (!list.length) { %>
        <div class="flow-card primary">
          <h3><%= t('patient.dashboard.empty_title') %></h3>
          <p><%= t('patient.dashboard.empty_body') %></p>
          <div class="section-cta">
            <a href="/portal/patient/orders/new" class="btn btn-primary"><%= t('patient.dashboard.empty_cta') %></a>
          </div>
        </div>
      <% } else { %>
        <section class="flow-section">
          <% list.forEach(function(order) { %>
            <div class="flow-card soft">
              <h3><%= order.service_name || 'Diagnostic Review' %></h3>
              <p class="flow-note">Case ID: <%= order.id %></p>
              <div class="section-cta">
                <a href="/portal/patient/orders/<%= order.id %>" class="btn btn-secondary">View</a>
              </div>
            </div>
          <% }); %>
        </section>
      <% } %>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
