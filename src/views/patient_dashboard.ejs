<!DOCTYPE html>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<% const brandSafe = typeof brand !== 'undefined' ? brand : 'Tashkheesa'; %>
<html lang="<%= lang || 'en' %>" dir="<%= isAr ? 'rtl' : 'ltr' %>">
<head>
  <meta charset="utf-8" />
  <title><%= brandSafe %> – <%= t('patient.dashboard.title') %></title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <%
    const list = Array.isArray(orders) ? orders : [];
    const filtersObj = filters || {};
    const specialtiesList = Array.isArray(specialties) ? specialties : [];
    const activeStatus = (filtersObj.status || '').toLowerCase();

    const buildStatusLink = function(val) {
      const params = new URLSearchParams();
      if (val) params.set('status', val);
      if (filtersObj.specialty) params.set('specialty', filtersObj.specialty);
      if (filtersObj.q) params.set('q', filtersObj.q);
      const qs = params.toString();
      return '/dashboard' + (qs ? ('?' + qs) : '');
    };

    const safeNext = buildStatusLink(activeStatus);
  %>

  <div class="layout">
    <div class="page-shell">
      <div class="page-inner patient-dashboard">

        <header>
          <div class="brand">
            <div class="brand-logo">T</div>
            <div>
              <div class="brand-text-main"><%= brandSafe %></div>
              <div class="brand-text-sub"><%= t('patient.portal') %></div>
            </div>
          </div>

          <div class="header-right">
            <a class="pill" href="/dashboard"><%= t('patient.my_cases') %></a>
            <a class="pill" href="/portal/patient/alerts">
              <%= isAr ? 'التنبيهات' : 'Alerts' %>
              <% if (typeof hasUnseenAlerts !== 'undefined' && hasUnseenAlerts) { %>
                <span class="alert-dot" aria-label="<%= isAr ? 'تنبيهات غير مقروءة' : 'Unseen alerts' %>" title="<%= isAr ? 'تنبيهات غير مقروءة' : 'Unseen alerts' %>"></span>
              <% } %>
            </a>
            <%- include('partials/user_menu', { menuUser: user, isAr, profileHref: '/patient/profile' }) %>
            <div class="lang-switch">
              <a href="/lang/en?next=<%= encodeURIComponent(safeNext) %>">EN</a> | <a href="/lang/ar?next=<%= encodeURIComponent(safeNext) %>">AR</a>
            </div>
          </div>
        </header>

        <main class="patient-dashboard-main">
          <div class="patient-dashboard-content">

              <section class="patient-header-card">
                <div class="patient-header-top">
                  <div>
                    <h1 class="patient-header-title"><%= t('patient.dashboard.h1') %></h1>
                    <p class="patient-header-subtitle"><%= t('patient.dashboard.subtitle') %></p>
                  </div>
                  <div class="patient-header-actions">
                    <a class="btn btn-primary" href="/patient/orders/new"><%= t('patient.dashboard.create_new_case') %></a>
                  </div>
                </div>
              </section>

              <nav class="status-tabs tab-bar">
                <a class="status-tab tab <%= !activeStatus ? 'active' : '' %>" href="/dashboard"><%= t('common.all') %></a>
                <a class="status-tab tab <%= activeStatus === 'new' ? 'active' : '' %>" href="<%= buildStatusLink('new') %>"><%= t('status.new') %></a>
                <a class="status-tab tab <%= activeStatus === 'accepted' ? 'active' : '' %>" href="<%= buildStatusLink('accepted') %>"><%= t('status.accepted') %></a>
                <a class="status-tab tab <%= activeStatus === 'in_review' ? 'active' : '' %>" href="<%= buildStatusLink('in_review') %>"><%= t('status.in_review') %></a>
                <a class="status-tab tab <%= activeStatus === 'completed' ? 'active' : '' %>" href="<%= buildStatusLink('completed') %>"><%= t('status.completed') %></a>
                <a class="status-tab tab <%= activeStatus === 'breached' ? 'active' : '' %>" href="<%= buildStatusLink('breached') %>"><%= t('status.breached') %></a>
              </nav>

              <section class="filter-bar patient-filter-panel">
                <form class="filters-form patient-filters" method="get" action="/dashboard">
                  <div class="filter-grid">
                    <div class="field">
                      <label><%= t('common.status') %></label>
                      <select name="status">
                        <option value="" <%= !filtersObj.status ? 'selected' : '' %>><%= t('common.all_statuses') %></option>
                        <option value="new" <%= filtersObj.status === 'new' ? 'selected' : '' %>><%= t('status.new') %></option>
                        <option value="accepted" <%= filtersObj.status === 'accepted' ? 'selected' : '' %>><%= t('status.accepted') %></option>
                        <option value="in_review" <%= filtersObj.status === 'in_review' ? 'selected' : '' %>><%= t('status.in_review') %></option>
                        <option value="completed" <%= filtersObj.status === 'completed' ? 'selected' : '' %>><%= t('status.completed') %></option>
                        <option value="breached" <%= filtersObj.status === 'breached' ? 'selected' : '' %>><%= t('status.breached') %></option>
                      </select>
                    </div>

                    <div class="field">
                      <label><%= t('patient.new_case.specialty') %></label>
                      <select name="specialty">
                        <option value="" <%= !filtersObj.specialty ? 'selected' : '' %>><%= t('patient.dashboard.all_specialties') %></option>
                        <% specialtiesList.forEach(function(s) { %>
                          <option value="<%= s.id %>" <%= String(filtersObj.specialty) === String(s.id) ? 'selected' : '' %>><%= s.name %></option>
                        <% }); %>
                      </select>
                    </div>

                    <div class="field">
                      <label><%= t('common.search') %></label>
                      <input
                        type="text"
                        name="q"
                        placeholder="<%= t('patient.dashboard.search_ph') %>"
                        value="<%= filtersObj.q || '' %>"
                      />
                    </div>
                  </div>

                  <div class="filter-actions">
                    <button type="submit" class="btn btn-primary"><%= t('common.apply') %></button>
                    <a href="/dashboard" class="btn btn-secondary btn-sm"><%= t('common.reset') %></a>
                  </div>
                </form>
              </section>

              <% if (!list.length) { %>
                <div class="empty-state">
                  <h3><%= t('patient.dashboard.empty_title') %></h3>
                  <p><%= t('patient.dashboard.empty_body') %></p>
                  <a href="/patient/orders/new" class="btn btn-primary"><%= t('patient.dashboard.empty_cta') %></a>
                </div>
              <% } else { %>
                <section class="cases-list orders-grid">
                  <% list.forEach(function(order) {
                       const status = (order.status || 'new').toLowerCase();
                       const statusUi = order.statusUi || null;
                       const statusLabelText = (statusUi && statusUi.title) ? statusUi.title : (order.status_label || status);
                       const statusBadge = (statusUi && statusUi.badge) ? statusUi.badge : status;
                  %>
                    <article class="case-card order-card order-card-modern case-card--<%= status %>">
                      <div class="case-card-accent"></div>
                      <div class="case-card-main">
                        <div class="case-card-header">
                          <div>
                            <h2 class="case-title"><%= order.service_name || t('patient.dashboard.diagnostic_service') %></h2>
                            <p class="case-subtitle"><%= order.id || order.order_id || '' %></p>
                          </div>
                          <div class="case-badges">
                            <% if (order.specialty_name) { %>
                              <span class="pill pill-soft"><%= order.specialty_name %></span>
                            <% } %>
                            <span class="pill pill-status pill-status-<%= status %> status-badge-<%= statusBadge %>"><%= statusLabelText %></span>
                          </div>
                        </div>
                      </div>
                      <div class="case-card-side order-actions">
                        <a href="/patient/orders/<%= order.id %>" class="btn btn-secondary btn-sm"><%= t('patient.dashboard.view_details') %></a>
                      </div>
                    </article>
                  <% }); %>
                </section>
              <% } %>

          </div>
        </main>

      </div>
    </div>
  </div>
</body>
</html>
