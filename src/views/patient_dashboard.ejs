<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙŠØ¶" : "Patient Dashboard"), layout: "portal", showNav: false, showFooter: false }) %>
<%
  const isAr = (typeof lang !== 'undefined' && lang === 'ar');
  const brandSafe = typeof brand !== 'undefined' ? brand : 'Tashkheesa';

  const list = Array.isArray(orders) ? orders : [];
  const filtersObj = filters || {};
  const specialtiesList = Array.isArray(specialties) ? specialties : [];
  const rawStatus = (filtersObj.status || '').toLowerCase();
  const statusAlias = { new: 'submitted', accepted: 'assigned', breached: 'sla_breach' };
  const activeStatus = statusAlias[rawStatus] || rawStatus;

  const tSafe = function(key, en, ar) {
    try {
      const v = t(key);
      if (!v || v === key) return isAr ? ar : en;
      return v;
    } catch (e) {
      return isAr ? ar : en;
    }
  };

  const buildStatusLink = function(val) {
    const params = new URLSearchParams();
    if (val) params.set('status', val);
    if (filtersObj.specialty) params.set('specialty', filtersObj.specialty);
    if (filtersObj.q) params.set('q', filtersObj.q);
    const qs = params.toString();
    return '/dashboard' + (qs ? ('?' + qs) : '');
  };

  const countByStatus = function(statusVal) {
    return list.filter(function(o) {
      const s = String(o.status || '').toLowerCase();
      if (Array.isArray(statusVal)) return statusVal.some(function(v) { return s === v || s.includes(v); });
      return s === statusVal || s.includes(statusVal);
    }).length;
  };

  const submittedCount = countByStatus(['submitted', 'new']);
  const inProgressCount = countByStatus(['assigned', 'in_review']);
  const completedCount = countByStatus('completed');
  const cancelledCount = countByStatus(['cancelled', 'canceled']);
  const breachedCount = countByStatus(['sla_breach', 'breached']);
  const pendingPayment = countByStatus(['expired_unpaid', 'pending']);

  function statusBadgeClass(status) {
    const s = String(status || '').toLowerCase();
    if (s === 'submitted' || s === 'new') return 'status-submitted';
    if (s === 'assigned') return 'status-assigned';
    if (s === 'in_review') return 'status-in_review';
    if (s === 'completed' || s === 'done' || s === 'delivered' || s === 'report_ready' || s === 'finalized') return 'status-completed';
    if (s === 'cancelled' || s === 'canceled') return 'status-cancelled';
    if (s.includes('breach') || s.includes('sla')) return 'status-breached';
    if (s === 'expired_unpaid' || s === 'pending') return 'status-pending';
    return 'status-submitted';
  }

  function statusLabel(status) {
    const s = String(status || '').toLowerCase();
    if (s === 'submitted' || s === 'new') return isAr ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Submitted';
    if (s === 'assigned') return isAr ? 'ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†' : 'Assigned';
    if (s === 'in_review') return isAr ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'In Review';
    if (s === 'completed' || s === 'done' || s === 'delivered' || s === 'report_ready' || s === 'finalized') return isAr ? 'Ù…ÙƒØªÙ…Ù„' : 'Completed';
    if (s === 'cancelled' || s === 'canceled') return isAr ? 'Ù…Ù„ØºÙ‰' : 'Cancelled';
    if (s.includes('breach') || s.includes('sla')) return isAr ? 'ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆÙ‚Øª' : 'SLA Breach';
    if (s === 'expired_unpaid' || s === 'pending') return isAr ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹' : 'Awaiting Payment';
    return status || '';
  }

  function formatDate(d) {
    if (!d) return 'â€”';
    try {
      return new Date(d).toLocaleDateString(isAr ? 'ar-EG' : 'en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    } catch (e) { return String(d).substring(0, 10); }
  }
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo"><%= brandSafe %> <span><%= isAr ? 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient Portal' %></span></div>
  </div>

  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'dashboard', isAr: isAr, user: (typeof user !== 'undefined' ? user : {}) }) %>

    <main class="portal-content">
      <!-- Welcome -->
      <div style="display:flex;align-items:center;gap:16px;padding:8px 0 24px;">
        <div style="width:52px;height:52px;border-radius:16px;background:linear-gradient(135deg,#3b82f6,#2EC4B6);display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:#fff;flex-shrink:0;box-shadow:0 4px 12px rgba(59,130,246,0.25);">
          <%= (function(){ var n = (user && user.name) || 'Patient'; var p = n.trim().split(/\s+/); return p.length >= 2 ? (p[0][0]+p[1][0]).toUpperCase() : p[0].substring(0,2).toUpperCase(); })() %>
        </div>
        <div>
          <h1 style="font-family:'DM Sans',sans-serif;font-size:1.35rem;font-weight:700;color:#1e293b;margin:0;line-height:1.3;">
            <%= isAr ? 'Ø£Ù‡Ù„Ø§Ù‹' : 'Welcome back' %><%= (user && user.name) ? ', ' + user.name.split(' ')[0] : '' %> ðŸ‘‹
          </h1>
          <p style="font-size:0.85rem;color:#64748b;margin:4px 0 0;">
            <%= isAr ? 'Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØªØ§Ø¨Ø¹ Ø­Ø§Ù„Ø§ØªÙƒ ÙˆØ§Ø³ØªØ´Ø§Ø±Ø§ØªÙƒ' : "Here's an overview of your cases and consultations" %>
          </p>
        </div>
      </div>

      <% if (typeof onboardingComplete !== 'undefined' && onboardingComplete === 0) { %>
      <div id="onboarding-banner" style="display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:16px 20px;margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:36px;height:36px;border-radius:10px;background:rgba(59,130,246,0.1);display:flex;align-items:center;justify-content:center;font-size:1rem;">ðŸ‘¤</div>
          <div>
            <div style="font-weight:600;font-size:0.9rem;color:#1e293b;"><%= isAr ? 'Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ' : 'Complete Your Profile' %></div>
            <div style="font-size:0.78rem;color:#64748b;"><%= isAr ? 'Ø§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„' : 'Fill in your details for a better experience' %></div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <a href="/patient/profile" style="padding:8px 16px;background:#3b82f6;color:#fff;border-radius:8px;font-size:0.78rem;font-weight:600;text-decoration:none;"><%= isAr ? 'Ø¥ÙƒÙ…Ø§Ù„' : 'Complete' %></a>
          <button onclick="document.getElementById('onboarding-banner').style.display='none'" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1.1rem;padding:4px;">&times;</button>
        </div>
      </div>
      <% } %>

      <!-- Stat Cards -->
      <div class="portal-stats">
        <div class="stat-card" style="border-left:4px solid #3b82f6;">
          <div class="stat-label"><%= isAr ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª' : 'Total Cases' %></div>
          <div class="stat-value"><%= list.length %></div>
        </div>
        <div class="stat-card" style="border-left:4px solid #f59e0b;">
          <div class="stat-label"><%= isAr ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : 'In Progress' %></div>
          <div class="stat-value"><%= inProgressCount %></div>
        </div>
        <div class="stat-card" style="border-left:4px solid #10b981;">
          <div class="stat-label"><%= isAr ? 'Ù…ÙƒØªÙ…Ù„Ø©' : 'Completed' %></div>
          <div class="stat-value"><%= completedCount %></div>
        </div>
        <div class="stat-card" style="border-left:4px solid #ef4444;">
          <div class="stat-label"><%= isAr ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹' : 'Awaiting Payment' %></div>
          <div class="stat-value"><%= pendingPayment %></div>
        </div>
      </div>

      <!-- Filter Pills -->
      <div class="filter-pills">
        <a href="<%= buildStatusLink('') %>" class="pill <%= !activeStatus ? 'active' : '' %>"><%= isAr ? 'Ø§Ù„ÙƒÙ„' : 'All' %> <span class="pill-count"><%= list.length %></span></a>
        <a href="<%= buildStatusLink('submitted') %>" class="pill <%= activeStatus === 'submitted' ? 'active' : '' %>"><%= isAr ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Submitted' %> <span class="pill-count"><%= submittedCount %></span></a>
        <a href="<%= buildStatusLink('in_review') %>" class="pill <%= (activeStatus === 'in_review' || activeStatus === 'assigned') ? 'active' : '' %>"><%= isAr ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'In Review' %> <span class="pill-count"><%= inProgressCount %></span></a>
        <a href="<%= buildStatusLink('completed') %>" class="pill <%= activeStatus === 'completed' ? 'active' : '' %>"><%= isAr ? 'Ù…ÙƒØªÙ…Ù„Ø©' : 'Completed' %> <span class="pill-count"><%= completedCount %></span></a>
        <a href="<%= buildStatusLink('cancelled') %>" class="pill <%= (activeStatus === 'cancelled' || activeStatus === 'canceled') ? 'active' : '' %>"><%= isAr ? 'Ù…Ù„ØºÙ‰' : 'Cancelled' %> <span class="pill-count"><%= cancelledCount %></span></a>
      </div>

      <!-- Cases Table -->
      <% if (!list.length) { %>
        <div class="flow-card" style="text-align:center;padding:48px 24px;">
          <div style="font-size:2.5rem;margin-bottom:12px;">ðŸ“‹</div>
          <h3 style="margin-bottom:6px;"><%= isAr ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯' : 'No cases yet' %></h3>
          <p style="color:var(--p1-text2);font-size:0.85rem;margin-bottom:16px;"><%= isAr ? 'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø£ÙŠ Ø·Ø¨ÙŠ Ø«Ø§Ù†Ù.' : 'Submit your first case to get a specialist second opinion.' %></p>
          <span style="font-size:0.75rem;color:#94a3b8;font-weight:500;"><%= isAr ? 'Ø§Ù„Ø·Ù„Ø¨ ÙŠÙØªØ­ Ù‚Ø±ÙŠØ¨Ø§Ù‹' : 'Ordering opens soon' %></span>
        </div>
      <% } else { %>

        <!-- Desktop Table -->
        <table class="portal-table">
          <thead>
            <tr>
              <th><%= isAr ? 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„Ø©' : 'Case ID' %></th>
              <th><%= isAr ? 'Ø§Ù„ØªØ®ØµØµ' : 'Specialty' %></th>
              <th><%= isAr ? 'Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Service' %></th>
              <th><%= isAr ? 'Ø§Ù„Ø­Ø§Ù„Ø©' : 'Status' %></th>
              <th><%= isAr ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date' %></th>
              <th><%= isAr ? 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª' : 'Actions' %></th>
            </tr>
          </thead>
          <tbody>
            <% list.forEach(function(order) { %>
              <tr>
                <td><span class="case-id">#<%= (String(order.id || '')).substring(0, 8) %></span></td>
                <td><%= order.specialty_name || order.specialtyName || 'â€”' %></td>
                <td><%= order.service_name || (isAr ? 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ©' : 'Medical Review') %></td>
                <td>
                  <span class="status-badge <%= statusBadgeClass(order.status) %>"><%= statusLabel(order.status) %></span>
                </td>
                <td style="font-size:0.8rem;color:var(--p1-text2);"><%= formatDate(order.created_at || order.created || order.createdAt) %></td>
                <td>
                  <div style="display:flex;gap:6px;align-items:center;">
                    <a href="/portal/patient/orders/<%= order.id %>" class="btn-view"><%= isAr ? 'Ø¹Ø±Ø¶' : 'View' %></a>
                    <% if (['completed', 'done', 'delivered', 'report_ready', 'finalized'].indexOf(String(order.status || '').toLowerCase()) !== -1) { %>
                      <a href="/portal/case/<%= order.id %>/report" class="p-btn p-btn-primary p-btn-sm"><%= isAr ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'Report' %></a>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

      <% } %>

      <!-- Bottom CTA -->
      <div class="flow-card" style="text-align:center;margin-top:18px;">
        <h3 style="margin-bottom:6px;"><%= isAr ? 'ØªØ­ØªØ§Ø¬ Ø§Ø³ØªØ´Ø§Ø±Ø©ØŸ' : 'Need a consultation?' %></h3>
        <p style="color:var(--p1-text2);font-size:0.85rem;margin-bottom:14px;"><%= isAr ? 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ø£ÙŠ Ø·Ø¨ÙŠ Ø«Ø§Ù†Ù Ù…Ù† Ø£ÙØ¶Ù„ Ø§Ù„Ù…ØªØ®ØµØµÙŠÙ†.' : 'Get a second opinion from top specialists.' %></p>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <a href="/services" class="p-btn p-btn-secondary"><%= isAr ? 'ØªØµÙØ­ Ø§Ù„Ø®Ø¯Ù…Ø§Øª' : 'Browse Services' %></a>
          <span style="font-size:0.75rem;color:#94a3b8;font-weight:500;align-self:center;"><%= isAr ? 'Ø§Ù„Ø·Ù„Ø¨ ÙŠÙØªØ­ Ù‚Ø±ÙŠØ¨Ø§Ù‹' : 'Ordering opens soon' %></span>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="/js/tours/patient-tour.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof PortalTour !== 'undefined' && !PortalTour.isDone('patient_dashboard')) {
    setTimeout(function() {
      PortalTour.showWelcome({
        tourId: 'patient_dashboard',
        mandatory: true,
        icon: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#0052cc" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        title: '<%= isAr ? "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ´Ø®ÙŠØµØ©!" : "Welcome to Tashkheesa!" %>',
        text: '<%= isAr ? "Ø¯Ø¹Ù†Ø§ Ù†Ø¹Ø±ÙÙƒ Ø¹Ù„Ù‰ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶. Ù„Ù† ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ø³ÙˆÙ‰ 30 Ø«Ø§Ù†ÙŠØ©." : "Let us show you around your patient portal. It only takes 30 seconds." %>',
        onStart: function() {
          PortalTour.start('patient_dashboard', patientDashboardTour);
        }
      });
    }, 1000);
  }

  window.startPortalTour = function() {
    PortalTour.reset('patient_dashboard');
    PortalTour.start('patient_dashboard', patientDashboardTour);
  };
});
</script>

<%- include('partials/footer', { showFooter: false }) %>
