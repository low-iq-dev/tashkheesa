<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≠ÿßŸÑÿ©" : "Case Details"), layout: "portal", showNav: false, showFooter: false }) %>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar'); %>
<% const brandSafe = typeof brand !== 'undefined' ? brand : 'Tashkheesa'; %>

<% if (!order) { %>
<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo"><%= brandSafe %> <span><%= isAr ? 'ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑŸÖÿ±Ÿäÿ∂' : 'Patient Portal' %></span></div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'dashboard', isAr: isAr, user: (typeof user !== 'undefined' ? user : {}) }) %>
    <main class="portal-content">
      <div class="portal-hero">
        <div>
          <h1 class="portal-hero-title"><%= isAr ? 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case Details' %></h1>
          <p class="portal-hero-subtitle"><%= isAr ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≠ÿßŸÑÿ©.' : 'Case not found.' %></p>
        </div>
      </div>
      <div class="flow-card" style="text-align:center;padding:48px 24px;">
        <div style="font-size:2.5rem;margin-bottom:12px;">üîç</div>
        <h3><%= isAr ? 'ÿßŸÑÿ≠ÿßŸÑÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©' : 'Case not found' %></h3>
        <p style="color:var(--p1-text2);margin-top:8px;"><%= isAr ? 'ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿ£Ÿà ÿπÿØ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ.' : 'Check the URL or return to your dashboard.' %></p>
        <a href="/dashboard" class="p-btn p-btn-primary" style="margin-top:14px;"><%= isAr ? 'ÿßŸÑÿπŸàÿØÿ©' : 'Back to Dashboard' %></a>
      </div>
    </main>
  </div>
</div>
<% } else { %>
<%
  function normalizeStatus(val) {
    if (!val) return '';
    return String(val).trim().toUpperCase();
  }

  function slaTimingCopy(order) {
    var windowText = '';
    if (order.sla_type === 'priority_24h' || Number(order.sla_hours) === 24) {
      windowText = isAr ? 'ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©' : 'Expected delivery within 24 hours';
    } else if (order.sla_type === 'standard_72h' || Number(order.sla_hours) === 72) {
      windowText = isAr ? 'ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿÆŸÑÿßŸÑ 72 ÿ≥ÿßÿπÿ©' : 'Expected delivery within 72 hours';
    } else if (order.sla_hours) {
      windowText = (isAr ? 'ÿßŸÑÿ≤ŸÖŸÜ ÿßŸÑŸÖÿ™ŸàŸÇÿπ' : 'Expected delivery within') + ' ' + order.sla_hours + (isAr ? ' ÿ≥ÿßÿπÿ©' : ' hours');
    }
    if (!windowText) return '';
    return windowText + ' ¬∑ ' + (isAr ? 'ÿ•ÿ∞ÿß ÿ™ÿ¨ÿßŸàÿ≤ŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ∑ÿßÿ±ÿå Ÿäÿ™ŸÖ ÿ™ÿµÿπŸäÿØ ÿ≠ÿßŸÑÿ™ŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.' : 'If this timeframe is exceeded, your case is automatically escalated.');
  }

  var fmtDate = function(iso) {
    if (!iso) return '‚Äî';
    try {
      var d = new Date(iso);
      return d.toLocaleDateString(isAr ? 'ar-EG' : 'en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    } catch(e) { return String(iso).substring(0, 16); }
  };

  var paymentLink = order.payment_link || order.service_payment_link;
  var priceDisplay = (typeof order.display_price !== 'undefined' && order.display_price !== null) ? order.display_price : order.price;
  var currencyDisplay = order.display_currency || order.currency || 'EGP';
  var baseFiles = Array.isArray(files) ? files : (Array.isArray(order_files) ? order_files : []);
  var slaCopyText = slaTimingCopy(order);
  const extraFiles = Array.isArray(order_additional_files) ? order_additional_files : [];
  const safeEvents = Array.isArray(events) ? events : [];
  var evts = safeEvents;
  var messagesList = Array.isArray(messages) ? messages : [];
  var normalizedStatus = normalizeStatus(order.effectiveStatus || order.status);
  var statusUiLocal = (typeof statusUi !== 'undefined' && statusUi) ? statusUi : null;
  var statusDetailText = (statusUiLocal && statusUiLocal.description) ? statusUiLocal.description : '';
  var uploadsLocked = Number(order.uploads_locked) === 1;
  var isCompleted = String(order.status || '').toLowerCase() === 'completed';
  var hasAdditionalFilesRequest = Number(order.additional_files_requested) === 1;
  var canUploadMore = !isCompleted && (!uploadsLocked || hasAdditionalFilesRequest);
  var safeNext = encodeURIComponent('/portal/patient/orders/' + order.id);
  var caseIdShort = String(order.id || '').substring(0, 8);

  function statusBadgeClass(status) {
    var s = String(status || '').toLowerCase();
    if (s === 'submitted' || s === 'new') return 'status-submitted';
    if (s === 'assigned') return 'status-assigned';
    if (s === 'in_review') return 'status-in_review';
    if (s === 'completed' || s === 'done' || s === 'delivered' || s === 'report_ready' || s === 'finalized') return 'status-completed';
    if (s === 'cancelled' || s === 'canceled') return 'status-cancelled';
    if (s.includes('breach') || s.includes('sla')) return 'status-breached';
    return 'status-submitted';
  }

  var latestDoctorRequestReason = '';
  if (hasAdditionalFilesRequest && Array.isArray(evts) && evts.length) {
    for (var i = evts.length - 1; i >= 0; i--) {
      var ev = evts[i];
      if (!ev || ev.label !== 'doctor_requested_additional_files') continue;
      try {
        var metaObj = (typeof ev.meta === 'object' && ev.meta) ? ev.meta : JSON.parse(String(ev.meta || '{}'));
        if (metaObj && metaObj.reason) { latestDoctorRequestReason = String(metaObj.reason); break; }
      } catch (e) {}
    }
  }
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo"><%= brandSafe %> <span><%= isAr ? 'ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑŸÖÿ±Ÿäÿ∂' : 'Patient Portal' %></span></div>
  </div>

  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'dashboard', isAr: isAr, user: (typeof user !== 'undefined' ? user : {}) }) %>

    <main class="portal-content">
      <!-- Hero -->
      <div class="portal-hero">
        <div>
          <h1 class="portal-hero-title"><%= isAr ? 'ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case' %> #<%= caseIdShort %></h1>
          <p class="portal-hero-subtitle">
            <%= order.specialty_name || '' %><% if (order.specialty_name && order.service_name) { %> ¬∑ <% } %><%= order.service_name || '' %>
          </p>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="status-badge <%= statusBadgeClass(order.status) %>"><%= (statusUiLocal && statusUiLocal.title) ? statusUiLocal.title : (order.status || '') %></span>
          <% if (canUploadMore) { %>
            <a class="p-btn p-btn-primary" href="/portal/patient/orders/<%= order.id %>/upload"><%= isAr ? 'ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™' : 'Upload Files' %></a>
          <% } %>
        </div>
      </div>

      <% if (statusDetailText) { %>
        <div class="flow-card" style="border-left:4px solid var(--p1-primary);margin-bottom:18px;padding:14px 20px;">
          <p style="margin:0;font-size:0.85rem;color:var(--p1-text2);"><%= statusDetailText %></p>
        </div>
      <% } %>

      <% if (normalizedStatus === 'SLA_BREACH' || normalizedStatus === 'BREACHED') { %>
        <div class="flow-card" style="border-left:4px solid var(--p1-danger);margin-bottom:18px;padding:14px 20px;">
          <p style="margin:0;font-size:0.85rem;color:#991b1b;"><%= isAr ? 'ÿ™ÿ¨ÿßŸàÿ≤ÿ™ ÿßŸÑÿ≠ÿßŸÑÿ© ŸÖÿØÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÇŸäÿßÿ≥Ÿäÿ©. ŸÅÿ±ŸäŸÇŸÜÿß Ÿäÿ™ÿπÿßŸÖŸÑ ŸÖÿπŸáÿß ÿ®ÿ£ŸàŸÑŸàŸäÿ©.' : 'Your case exceeded the standard review time. Our team is handling it with priority.' %></p>
        </div>
      <% } %>

      <!-- Two-column layout -->
      <div style="display:grid;grid-template-columns:1fr 300px;gap:18px;">

        <!-- LEFT: Main content -->
        <div>
          <!-- Case Information -->
          <div class="flow-card" style="margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:14px;">
              <span class="section-title"><%= isAr ? 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case Information' %></span>
            </div>
            <div style="display:grid;gap:12px;">
              <div style="display:flex;gap:8px;"><span style="font-size:0.78rem;color:var(--p1-text3);min-width:100px;"><%= isAr ? 'ÿßŸÑÿ™ÿÆÿµÿµ' : 'Specialty' %></span><span style="font-size:0.85rem;"><%= order.specialty_name || '‚Äî' %></span></div>
              <div style="display:flex;gap:8px;"><span style="font-size:0.78rem;color:var(--p1-text3);min-width:100px;"><%= isAr ? 'ÿßŸÑÿÆÿØŸÖÿ©' : 'Service' %></span><span style="font-size:0.85rem;"><%= order.service_name || '‚Äî' %></span></div>
              <div style="display:flex;gap:8px;"><span style="font-size:0.78rem;color:var(--p1-text3);min-width:100px;"><%= isAr ? 'ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Status' %></span><span class="status-badge <%= statusBadgeClass(order.status) %>"><%= (statusUiLocal && statusUiLocal.title) ? statusUiLocal.title : (order.status || '‚Äî') %></span></div>
              <div style="display:flex;gap:8px;"><span style="font-size:0.78rem;color:var(--p1-text3);min-width:100px;"><%= isAr ? 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°' : 'Created' %></span><span style="font-size:0.85rem;"><%= fmtDate(order.created_at) %></span></div>
              <div style="display:flex;gap:8px;"><span style="font-size:0.78rem;color:var(--p1-text3);min-width:100px;"><%= isAr ? 'ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä' : 'SLA Deadline' %></span><span style="font-size:0.85rem;"><%= fmtDate(order.deadline_at) %></span></div>
              <% if (slaCopyText) { %>
                <p style="font-size:0.8rem;color:var(--p1-text2);margin:0;"><%= slaCopyText %></p>
              <% } %>
            </div>
          </div>

          <!-- Medical History -->
          <% if ((order.medical_history && order.medical_history.trim()) || (order.current_medications && order.current_medications.trim())) { %>
          <div class="flow-card" style="margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:14px;">
              <span class="section-title"><%= isAr ? 'ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©' : 'Medical History' %></span>
            </div>
            <% if (order.medical_history && order.medical_history.trim()) { %>
              <div style="margin-bottom:12px;">
                <div style="font-size:0.78rem;color:var(--p1-text3);margin-bottom:4px;"><%= isAr ? 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ÿ∂Ÿä' : 'Previous history' %></div>
                <p style="font-size:0.85rem;margin:0;white-space:pre-line;"><%= order.medical_history %></p>
              </div>
            <% } %>
            <% if (order.current_medications && order.current_medications.trim()) { %>
              <div>
                <div style="font-size:0.78rem;color:var(--p1-text3);margin-bottom:4px;"><%= isAr ? 'ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©' : 'Current medications' %></div>
                <p style="font-size:0.85rem;margin:0;white-space:pre-line;"><%= order.current_medications %></p>
              </div>
            <% } %>
          </div>
          <% } %>

          <!-- Uploaded Files -->
          <% if (baseFiles.length || extraFiles.length) { %>
          <div class="flow-card" style="margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:14px;">
              <span class="section-title"><%= isAr ? 'ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸàÿπÿ©' : 'Uploaded Files' %></span>
            </div>
            <% if (baseFiles.length) { %>
              <ul style="list-style:none;padding:0;margin:0 0 8px;">
                <% baseFiles.forEach(function(f) { %>
                  <li style="padding:8px 0;border-bottom:1px solid var(--p1-border2);font-size:0.85rem;">
                    <a href="<%= f.url || f.file_url %>" target="_blank" rel="noopener" style="color:var(--p1-primary);text-decoration:none;font-weight:500;"><%= f.label || f.url || f.file_url %></a>
                  </li>
                <% }); %>
              </ul>
            <% } %>
            <% if (extraFiles.length) { %>
              <div style="font-size:0.78rem;color:var(--p1-text3);margin:8px 0 4px;"><%= isAr ? 'ŸÖŸÑŸÅÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©' : 'Additional files' %></div>
              <ul style="list-style:none;padding:0;margin:0;">
                <% extraFiles.forEach(function(f) { %>
                  <li style="padding:8px 0;border-bottom:1px solid var(--p1-border2);font-size:0.85rem;">
                    <a href="<%= f.url || f.file_url %>" target="_blank" rel="noopener" style="color:var(--p1-primary);text-decoration:none;font-weight:500;"><%= f.label || f.url || f.file_url %></a>
                  </li>
                <% }); %>
              </ul>
            <% } %>
          </div>
          <% } %>

          <!-- Doctor's Report -->
          <div class="flow-card" style="margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:14px;">
              <span class="section-title"><%= isAr ? 'ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ∑ÿ®Ÿä' : "Doctor's Report" %></span>
            </div>
            <% if ((order.status === 'completed' || order.report_url || order.notes || order.diagnosis_text) && (order.notes || order.diagnosis_text || order.report_url)) { %>
              <% if (order.notes || order.diagnosis_text) { %>
                <p style="font-size:0.85rem;white-space:pre-line;margin-bottom:12px;"><%= order.notes || order.diagnosis_text %></p>
              <% } %>
              <% if (order.report_url) { %>
                <a href="<%= order.report_url %>" target="_blank" class="p-btn p-btn-primary"><%= isAr ? 'ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± PDF' : 'Download Report PDF' %></a>
                <p style="font-size:0.78rem;color:var(--p1-text3);margin-top:8px;"><%= isAr ? 'ŸÑÿß Ÿäÿ≠ŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ±ÿ£Ÿä ŸÖÿ≠ŸÑ ÿ∑ÿ®Ÿäÿ®ŸÉ ÿßŸÑŸÖÿπÿßŸÑÿ¨.' : 'This opinion does not replace care from your treating physician.' %></p>
              <% } %>
            <% } else { %>
              <p style="font-size:0.85rem;color:var(--p1-text2);"><%= isAr ? 'ÿ™ŸÇÿ±Ÿäÿ±ŸÉ ŸÑÿß Ÿäÿ≤ÿßŸÑ ŸÇŸäÿØ ÿßŸÑÿ•ÿπÿØÿßÿØ.' : 'Your report is still being prepared.' %></p>
            <% } %>
          </div>

          <!-- Additional files request -->
          <% if (hasAdditionalFilesRequest) { %>
          <div class="flow-card" style="border-left:4px solid var(--p1-warn);margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:10px;">
              <span class="section-title"><%= isAr ? 'ÿßŸÑÿ∑ÿ®Ÿäÿ® Ÿäÿ≠ÿ™ÿßÿ¨ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©' : 'Doctor Needs More Information' %></span>
            </div>
            <p style="font-size:0.85rem;margin-bottom:10px;"><%= isAr ? 'Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑÿßÿ≥ÿ™ŸÉŸÖÿßŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ.' : 'Please upload the requested information to continue your review.' %></p>
            <% if (latestDoctorRequestReason) { %>
              <p style="font-size:0.85rem;background:var(--p1-warn-light);padding:10px 14px;border-radius:var(--p1-rs);margin-bottom:12px;"><strong><%= isAr ? 'ÿßŸÑÿ≥ÿ®ÿ®:' : 'Reason:' %></strong> <%= latestDoctorRequestReason %></p>
            <% } %>
            <a class="p-btn p-btn-primary" href="/portal/patient/orders/<%= order.id %>/upload"><%= isAr ? 'ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©' : 'Upload Requested Files' %></a>

            <form method="post" action="/portal/patient/orders/<%= order.id %>/submit-info" style="margin-top:14px;">
              <%- (typeof csrfField === 'function') ? csrfField() : '' %>
              <label style="display:block;margin-bottom:6px;"><%= isAr ? 'ÿ£ÿ¨ÿ® ÿ∑ÿ®Ÿäÿ®ŸÉ' : 'Reply to your doctor' %></label>
              <textarea name="message" placeholder="<%= isAr ? 'ÿ£ÿ∂ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿ∑ŸÑÿ®Ÿáÿß ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Add details your doctor asked for' %>" rows="3"></textarea>
              <button class="p-btn p-btn-primary" type="submit" style="margin-top:8px;"><%= isAr ? 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿØ' : 'Send Reply' %></button>
            </form>
          </div>
          <% } %>
        </div>

        <!-- RIGHT: Sidebar cards -->
        <div>
          <!-- Assigned Doctor -->
          <div class="flow-card" style="margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:10px;">
              <span class="section-title"><%= isAr ? 'ÿßŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑŸÖÿπŸäŸÜ' : 'Assigned Doctor' %></span>
            </div>
            <% if (order.doctor_name) { %>
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--p1-primary),var(--p1-accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8rem;flex-shrink:0;">
                  <%= (order.doctor_name || '').split(' ').map(function(w){return w[0]||''}).join('').substring(0,2).toUpperCase() %>
                </div>
                <div>
                  <div style="font-weight:600;font-size:0.9rem;"><%= order.doctor_name %></div>
                  <div style="font-size:0.78rem;color:var(--p1-text3);"><%= order.specialty_name || '' %></div>
                </div>
              </div>
              <% if (typeof caseConversationId !== 'undefined' && caseConversationId) { %>
                <a href="/portal/messages/<%= caseConversationId %>" class="p-btn p-btn-secondary" style="width:100%;text-align:center;display:block;"><%= isAr ? 'ÿ±ÿßÿ≥ŸÑ ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Message Doctor' %></a>
              <% } %>
            <% } else { %>
              <p style="font-size:0.85rem;color:var(--p1-text2);"><%= isAr ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿ®ÿπÿØ' : 'Not assigned yet' %></p>
            <% } %>
          </div>

          <!-- Payment Status -->
          <div class="flow-card" style="margin-bottom:18px;">
            <div class="section-head" style="margin-bottom:10px;">
              <span class="section-title"><%= isAr ? 'ÿßŸÑÿØŸÅÿπ' : 'Payment Status' %></span>
            </div>
            <% if (priceDisplay != null) { %>
              <div style="font-size:1.4rem;font-weight:700;color:var(--p1-text);margin-bottom:4px;"><%= currencyDisplay %> <%= Number(priceDisplay).toLocaleString() %></div>
            <% } %>
            <span class="status-badge <%= (order.payment_status === 'paid') ? 'status-completed' : 'status-pending' %>">
              <%= order.payment_status === 'paid' ? (isAr ? 'ŸÖÿØŸÅŸàÿπ' : 'Paid') : (isAr ? 'ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ' : 'Unpaid') %>
            </span>
          </div>

          <!-- Timeline -->
          <div class="flow-card">
            <div class="section-head" style="margin-bottom:10px;">
              <span class="section-title"><%= isAr ? 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©' : 'Timeline' %></span>
            </div>
            <%
              function eventTime(ev) {
                var raw = ev && (ev.at || ev.created_at || ev.timestamp);
                if (!raw) return 0;
                var t = new Date(raw).getTime();
                return isNaN(t) ? 0 : t;
              }
              function prettyEventLabel(label) {
                var key = String(label || '').trim().toLowerCase();
                var map = {
                  order_created_by_patient: isAr ? 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case created',
                  order_created: isAr ? 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case created',
                  doctor_assigned: isAr ? 'ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Specialist assigned',
                  assigned_to_doctor: isAr ? 'ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Specialist assigned',
                  doctor_accepted_case: isAr ? 'ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case accepted',
                  case_accepted_by_doctor: isAr ? 'ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑÿ≠ÿßŸÑÿ©' : 'Case accepted',
                  review_started: isAr ? 'ÿ®ÿØÿ£ÿ™ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©' : 'Review started',
                  in_review: isAr ? 'ÿ®ÿØÿ£ÿ™ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©' : 'Review started',
                  doctor_requested_additional_files: isAr ? 'ÿ∑ŸÑÿ® ÿßŸÑÿ∑ÿ®Ÿäÿ® ŸÖŸÑŸÅÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©' : 'Doctor requested files',
                  additional_files_requested: isAr ? 'ÿ∑ŸÑÿ® ÿßŸÑÿ∑ÿ®Ÿäÿ® ŸÖŸÑŸÅÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©' : 'Doctor requested files',
                  report_ready: isAr ? 'ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ¨ÿßŸáÿ≤' : 'Report ready',
                  report_generated: isAr ? 'ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ¨ÿßŸáÿ≤' : 'Report ready',
                  order_completed: isAr ? 'ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ¨ÿßŸáÿ≤' : 'Report ready',
                  completed: isAr ? 'ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ¨ÿßŸáÿ≤' : 'Report ready'
                };
                if (map[key]) return map[key];
                var safe = String(label || '').replace(/_/g, ' ');
                return safe ? (safe.charAt(0).toUpperCase() + safe.slice(1)) : (isAr ? 'ÿ™ÿ≠ÿØŸäÿ´' : 'Update');
              }

              var timelineRaw = Array.isArray(evts) ? evts.slice() : [];
              timelineRaw.sort(function(a, b) { return eventTime(a) - eventTime(b); });
              var timelineProcessed = [];
              var latestUploadToggle = null;
              for (var ti = 0; ti < timelineRaw.length; ti++) {
                var tev = timelineRaw[ti];
                if (!tev) continue;
                var key = String(tev.label || '').trim().toLowerCase();
                if (key === 'uploads_locked' || key === 'uploads_unlocked') { latestUploadToggle = tev; continue; }
                if (timelineProcessed.length) {
                  var prevKey = String(timelineProcessed[timelineProcessed.length - 1].label || '').trim().toLowerCase();
                  if (prevKey === key) continue;
                }
                timelineProcessed.push(tev);
              }
              if (latestUploadToggle) {
                timelineProcessed.push(latestUploadToggle);
                timelineProcessed.sort(function(a, b) { return eventTime(a) - eventTime(b); });
              }
              var timelineEvents = timelineProcessed;
            %>

            <% if (!timelineEvents.length) { %>
              <p style="font-size:0.85rem;color:var(--p1-text2);"><%= isAr ? 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿ¥ÿßÿ∑ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ.' : 'No activity yet.' %></p>
            <% } else { %>
              <div style="border-left:2px solid var(--p1-border);padding-left:16px;">
                <% timelineEvents.slice().reverse().forEach(function(ev) { %>
                  <div style="margin-bottom:14px;position:relative;">
                    <div style="position:absolute;left:-22px;top:4px;width:10px;height:10px;border-radius:50%;background:var(--p1-primary);border:2px solid var(--p1-surface);"></div>
                    <div style="font-size:0.85rem;font-weight:600;"><%= prettyEventLabel(ev.label) %></div>
                    <div style="font-size:0.75rem;color:var(--p1-text3);"><%= fmtDate(ev.at || ev.created_at || ev.timestamp) %></div>
                  </div>
                <% }); %>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Back to dashboard -->
      <div style="margin-top:18px;">
        <a href="/dashboard" class="p-btn p-btn-secondary"><%= isAr ? '‚Üê ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ' : '‚Üê Back to Dashboard' %></a>
      </div>
    </main>
  </div>
</div>
<% } %>

<style>
@media (max-width: 768px) {
  .portal-content > div[style*="grid-template-columns: 1fr 300px"] {
    grid-template-columns: 1fr !important;
  }
}
</style>

<script src="/js/tours/patient-tour.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof PortalTour !== 'undefined' && !PortalTour.isDone('patient_case_view')) {
    setTimeout(function() { PortalTour.start('patient_case_view', patientCaseViewTour); }, 800);
  }
  window.startPortalTour = function() {
    PortalTour.reset('patient_case_view');
    PortalTour.start('patient_case_view', patientCaseViewTour);
  };
});
</script>

<%- include('partials/footer', { showFooter: false }) %>
