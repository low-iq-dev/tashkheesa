<%- include('partials/header') %>
<%
  const isAr = String(lang).toLowerCase() === 'ar';
  function tt(en, ar) { return isAr ? ar : en; }
  const dayjs = require('dayjs');
%>

<div class="portal-page">
  <div class="portal-page-header" style="text-align:center;">
    <div class="fade-in-up" style="margin-bottom:16px;">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin:0 auto;">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    </div>
    <h1 class="portal-page-title fade-in-up" style="animation-delay:0.1s;"><%= tt('Call Ended', 'انتهت المكالمة') %></h1>
    <p class="portal-page-kicker fade-in-up" style="animation-delay:0.15s;"><%= tt('Your video consultation has been completed.', 'تم إكمال استشارة الفيديو الخاصة بك.') %></p>
  </div>

  <div class="portal-card fade-in-up" style="max-width:500px; margin:0 auto; animation-delay:0.2s;">
    <div class="portal-card-body" style="text-align:center;">

      <!-- Call Duration -->
      <div style="margin-bottom:24px;">
        <p class="muted" style="font-size:var(--text-xs); margin-bottom:4px;"><%= tt('Call Duration', 'مدة المكالمة') %></p>
        <p style="font-size:2rem; font-weight:800; font-variant-numeric:tabular-nums; color:var(--primary);">
          <%= durationFormatted || '0s' %>
        </p>
      </div>

      <!-- Participants -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px; text-align:center;">
        <div style="padding:12px; background:var(--neutral-offwhite); border-radius:var(--radius-lg);">
          <p class="muted" style="font-size:var(--text-xs); margin-bottom:2px;"><%= tt('Doctor', 'الطبيب') %></p>
          <p style="font-weight:600;"><%= doctor ? doctor.name : '—' %></p>
        </div>
        <div style="padding:12px; background:var(--neutral-offwhite); border-radius:var(--radius-lg);">
          <p class="muted" style="font-size:var(--text-xs); margin-bottom:2px;"><%= tt('Patient', 'المريض') %></p>
          <p style="font-weight:600;"><%= patient ? patient.name : '—' %></p>
        </div>
      </div>

      <!-- Appointment Details -->
      <div style="padding:16px; background:var(--primary-ultra-light); border-radius:var(--radius-lg); margin-bottom:24px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span class="muted"><%= tt('Scheduled', 'الموعد') %></span>
          <strong><%= dayjs(appointment.scheduled_at).format('DD/MM/YYYY — hh:mm A') %></strong>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span class="muted"><%= tt('Fee', 'الرسوم') %></span>
          <strong><%= appointment.price %> EGP</strong>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span class="muted"><%= tt('Status', 'الحالة') %></span>
          <span class="portal-pill pill-success"><%= tt('Completed', 'مكتمل') %></span>
        </div>
      </div>

      <!-- Doctor Earnings (visible to doctor only) -->
      <% if (isDoctor && earnings) { %>
        <div style="padding:16px; background:linear-gradient(135deg, var(--primary-ultra-light), var(--primary-light)); border-radius:var(--radius-lg); margin-bottom:24px; border:1px solid var(--primary); border-opacity:0.2;">
          <p class="muted" style="font-size:var(--text-xs); margin-bottom:4px;"><%= tt('Your Earnings', 'أرباحك') %></p>
          <p style="font-size:1.5rem; font-weight:800; color:var(--color-success);">
            <%= earnings.earned_amount %> EGP
          </p>
          <p class="muted" style="font-size:var(--text-xs);">
            <%= earnings.commission_pct %>% <%= tt('of', 'من') %> <%= earnings.gross_amount %> EGP
          </p>
        </div>
      <% } %>

      <!-- Actions -->
      <div style="display:flex; flex-direction:column; gap:10px;">
        <% if (appointment.order_id) { %>
          <a href="/portal/<%= isDoctor ? 'doctor/case' : 'patient/orders' %>/<%= appointment.order_id %>"
             class="btn btn-primary btn-full">
            <%= tt('Back to Case', 'العودة للحالة') %>
          </a>
        <% } %>
        <a href="/portal/video/appointments" class="btn btn-secondary btn-full">
          <%= tt('All Consultations', 'جميع الاستشارات') %>
        </a>
        <a href="<%= isDoctor ? '/portal/doctor' : '/dashboard' %>" class="btn btn-secondary btn-full">
          <%= tt('Back to Dashboard', 'العودة للوحة التحكم') %>
        </a>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
