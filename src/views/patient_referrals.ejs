<%- include('partials/header', { title: pageTitle || "Referral Program", layout: "portal", showNav: false }) %>
<%
  var _lang = (typeof lang !== 'undefined') ? lang : 'en';
  var _isAr = (typeof isAr !== 'undefined') ? isAr : false;
  var _code = (typeof referralCode !== 'undefined') ? referralCode : '';
  var _codeRow = (typeof codeRow !== 'undefined') ? codeRow : {};
  var _redemptions = (typeof redemptions !== 'undefined' && Array.isArray(redemptions)) ? redemptions : [];
  var _totalReferred = (typeof totalReferred !== 'undefined') ? totalReferred : 0;
  var _totalRewarded = (typeof totalRewarded !== 'undefined') ? totalRewarded : 0;

  function fmtDate(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    return d.toLocaleDateString(_lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo"><%= (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa' %> <span><%= _isAr ? 'بوابة المريض' : 'Patient Portal' %></span></div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'referrals', isAr: _isAr, user: (typeof user !== 'undefined' ? user : {}) }) %>
    <main class="portal-content">

      <!-- Hero -->
      <div class="portal-hero">
        <div>
          <h1 class="portal-hero-title"><%= _isAr ? 'برنامج الإحالة' : 'Referral Program' %></h1>
          <p class="portal-hero-subtitle"><%= _isAr ? 'شارك تشخيصة واحصل على مكافآت' : 'Share Tashkheesa and earn rewards' %></p>
        </div>
      </div>

      <!-- Your Referral Code -->
      <div class="flow-card" style="text-align:center;margin-bottom:18px;border-left:4px solid var(--p1-primary);">
        <div class="section-head" style="justify-content:center;">
          <span class="section-title"><%= _isAr ? 'كود الإحالة الخاص بك' : 'Your Referral Code' %></span>
        </div>
        <div id="ref-code" style="font-size:2rem;font-weight:800;color:var(--p1-primary-dark);letter-spacing:3px;margin:16px 0 8px;font-family:'JetBrains Mono','Space Mono',monospace;"><%= _code %></div>
        <div style="font-size:0.85rem;color:var(--p1-accent);font-weight:600;margin-bottom:16px;"><%= _isAr ? 'خصم 10% لك ولصديقك' : '10% discount for you and your friend' %></div>
        <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;">
          <button class="p-btn p-btn-primary" id="copy-btn" onclick="copyCode()"><%= _isAr ? 'نسخ الكود' : 'Copy Code' %></button>
          <a class="p-btn" style="background:#25d366;color:#fff;border:none;text-decoration:none;" href="https://wa.me/?text=<%= encodeURIComponent((_isAr ? 'جرب تشخيصة للرأي الطبي الثاني! استخدم كود الإحالة: ' : 'Try Tashkheesa for medical second opinions! Use my referral code: ') + _code) %>" target="_blank"><%= _isAr ? 'شارك عبر واتساب' : 'Share via WhatsApp' %></a>
        </div>
      </div>

      <!-- Referral Stats -->
      <div class="portal-stats" style="grid-template-columns:repeat(3, 1fr);">
        <div class="stat-card" style="border-left:4px solid var(--p1-primary);">
          <div class="stat-label"><%= _isAr ? 'تمت الإحالة' : 'Total Referred' %></div>
          <div class="stat-value"><%= _totalReferred %></div>
        </div>
        <div class="stat-card" style="border-left:4px solid var(--p1-accent);">
          <div class="stat-label"><%= _isAr ? 'مكافآت ممنوحة' : 'Rewards Earned' %></div>
          <div class="stat-value"><%= _totalRewarded %></div>
        </div>
        <div class="stat-card" style="border-left:4px solid var(--p1-warn);">
          <div class="stat-label"><%= _isAr ? 'مرات الاستخدام' : 'Times Used' %></div>
          <div class="stat-value"><%= _codeRow.times_used || 0 %></div>
        </div>
      </div>

      <!-- Referral History -->
      <div class="flow-card">
        <div class="section-head">
          <span class="section-title"><%= _isAr ? 'سجل الإحالات' : 'Referral History' %></span>
        </div>

        <% if (_redemptions.length === 0) { %>
          <div style="text-align:center;padding:36px 24px;">
            <div style="font-size:2.2rem;margin-bottom:10px;">↗️</div>
            <h3 style="margin-bottom:6px;"><%= _isAr ? 'لا توجد إحالات بعد' : 'No referrals yet' %></h3>
            <p style="color:var(--p1-text2);font-size:0.85rem;"><%= _isAr ? 'شارك الكود مع أصدقائك واحصل على مكافآت!' : 'Share your code with friends and earn rewards!' %></p>
          </div>
        <% } else { %>
          <table>
            <thead>
              <tr>
                <th><%= _isAr ? 'الاسم' : 'Name' %></th>
                <th><%= _isAr ? 'التاريخ' : 'Date' %></th>
                <th><%= _isAr ? 'الحالة' : 'Status' %></th>
              </tr>
            </thead>
            <tbody>
              <% _redemptions.forEach(function(r) { %>
                <tr>
                  <td style="font-weight:500;"><%= r.referred_name || (_isAr ? 'مستخدم' : 'User') %></td>
                  <td style="font-size:0.82rem;color:var(--p1-text2);"><%= fmtDate(r.created_at) %></td>
                  <td>
                    <span class="status-badge <%= r.reward_granted ? 'status-completed' : 'status-pending' %>">
                      <%= r.reward_granted ? (_isAr ? 'مكافأة ممنوحة' : 'Rewarded') : (_isAr ? 'قيد الانتظار' : 'Pending') %>
                    </span>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        <% } %>
      </div>

<script<% if (typeof cspNonce !== 'undefined' && cspNonce) { %> nonce="<%= cspNonce %>"<% } %>>
function copyCode() {
  var code = document.getElementById('ref-code').textContent.trim();
  navigator.clipboard.writeText(code).then(function() {
    var btn = document.getElementById('copy-btn');
    btn.textContent = '<%= _isAr ? "تم النسخ!" : "Copied!" %>';
    setTimeout(function() { btn.textContent = '<%= _isAr ? "نسخ الكود" : "Copy Code" %>'; }, 2000);
  });
}
</script>

    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
