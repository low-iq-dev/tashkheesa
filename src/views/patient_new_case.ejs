<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "New Case"), layout: "portal", showNav: false }) %>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>
<% const isAr = (typeof lang !== 'undefined' && lang === 'ar') || (typeof dir !== 'undefined' && dir === 'rtl'); %>
<% const fallbackCurrency = (typeof countryCurrency !== 'undefined' && countryCurrency) ? countryCurrency : 'EGP'; %>

<style>
/* Smart Case Submission Styles */
.case-wizard {
  max-width: 900px;
  margin: 0 auto;
}

.progress-steps {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-bottom: 40px;
  padding-bottom: 30px;
  border-bottom: 2px solid #e5e7eb;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  flex: 1;
  max-width: 120px;
}

.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #e5e7eb;
  color: #9ca3af;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  transition: all 0.3s ease;
}

.step-circle.active {
  background: #2563eb;
  color: white;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.step-circle.complete {
  background: #10b981;
  color: white;
}

.step-label {
  font-size: 13px;
  color: #6b7280;
  font-weight: 500;
  text-align: center;
}

.step-label.active {
  color: #2563eb;
  font-weight: 600;
}

.wizard-section {
  display: none;
}

.wizard-section.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.type-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin: 30px 0;
}

.type-card {
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 24px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  background: white;
}

.type-card:hover {
  border-color: #2563eb;
  background: #f0f9ff;
  transform: translateY(-2px);
}

.type-card.selected {
  border-color: #2563eb;
  background: #eff6ff;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}

.type-card .icon {
  font-size: 40px;
  margin-bottom: 12px;
}

.type-card h3 {
  font-size: 16px;
  margin-bottom: 6px;
  color: #1f2937;
}

.type-card p {
  font-size: 13px;
  color: #6b7280;
  margin: 0;
}

.info-box {
  background: #eff6ff;
  border: 2px solid #93c5fd;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 24px;
  display: flex;
  gap: 12px;
}

.info-box .icon {
  font-size: 24px;
  flex-shrink: 0;
}

.info-box-content p {
  font-size: 14px;
  color: #1e40af;
  line-height: 1.6;
  margin: 0;
}

.smart-fields {
  background: #fefce8;
  border: 2px solid #fde047;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 24px;
  display: none;
}

.smart-fields.active {
  display: block;
}

.smart-fields h4 {
  color: #713f12;
  font-size: 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tag {
  display: inline-block;
  background: #e0e7ff;
  color: #3730a3;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.form-section {
  margin-bottom: 24px;
}

.form-section h3 {
  font-size: 16px;
  margin-bottom: 16px;
  color: #1f2937;
}

.checkbox-group,
.radio-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.checkbox-item,
.radio-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.checkbox-item:hover,
.radio-item:hover {
  border-color: #2563eb;
  background: #f0f9ff;
}

.checkbox-item input,
.radio-item input {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.ai-assist-box {
  background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
  color: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  display: none;
}

.ai-assist-box.active {
  display: block;
}

.ai-assist-box h4 {
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
}

.ai-assist-box textarea {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  min-height: 100px;
  margin-bottom: 12px;
}

.ai-btn {
  background: white;
  color: #7c3aed;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.ai-btn:hover {
  background: #f3f4f6;
}

.ai-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.ai-result {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
  display: none;
}

.ai-result.active {
  display: block;
}

.ai-result h5 {
  margin-bottom: 8px;
  font-size: 14px;
}

.ai-suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
}

.ai-suggestion-chip {
  background: white;
  color: #7c3aed;
  padding: 6px 14px;
  border-radius: 16px;
  font-size: 13px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.ai-suggestion-chip:hover {
  border-color: white;
}

.button-group {
  display: flex;
  gap: 12px;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 2px solid #e5e7eb;
}

.btn-wizard {
  padding: 14px 32px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
  flex: 1;
}

.btn-wizard.primary {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.btn-wizard.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
}

.btn-wizard.secondary {
  background: white;
  color: #374151;
  border: 2px solid #e5e7eb;
}

.btn-wizard.secondary:hover {
  border-color: #2563eb;
  color: #2563eb;
}

.unsure-link {
  text-align: center;
  margin: 20px 0;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.unsure-link:hover {
  background: #f3f4f6;
}

.unsure-link span {
  color: #7c3aed;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

@media (max-width: 768px) {
  .type-grid {
    grid-template-columns: 1fr;
  }
  
  .progress-steps {
    gap: 8px;
  }
  
  .step {
    max-width: 80px;
  }
  
  .step-circle {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .step-label {
    font-size: 11px;
  }
}
</style>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa' %>
      <span><%= isAr ? 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient Portal' %></span>
    </div>
  </div>
  <div class="portal-grid">
    <%- include('partials/patient_sidebar', { activePage: 'new_case', isAr: isAr }) %>
    <main class="portal-content">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= isAr ? 'Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'Submit New Case' %></h1>
        <p class="portal-hero-subtitle"><%= isAr ? 'Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„ØªÙƒ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.' : 'Follow the steps to submit your case for review.' %></p>
      </div>

      <div class="flow-card case-wizard">
        <% if (error) { %>
          <div style="background:#fff4f4; border:1px solid #fca5a5; padding:12px; border-radius:8px; margin-bottom:20px;">
            <strong style="color:#b91c1c;"><%= error %></strong>
          </div>
        <% } %>

        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step">
            <div class="step-circle active" data-step="1">1</div>
            <span class="step-label active"><%= isAr ? 'Ø§Ù„Ù†ÙˆØ¹' : 'Type' %></span>
          </div>
          <div class="step">
            <div class="step-circle" data-step="2">2</div>
            <span class="step-label"><%= isAr ? 'Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Details' %></span>
          </div>
          <div class="step">
            <div class="step-circle" data-step="3">3</div>
            <span class="step-label"><%= isAr ? 'Ø§Ù„Ø±ÙØ¹' : 'Upload' %></span>
          </div>
          <div class="step">
            <div class="step-circle" data-step="4">4</div>
            <span class="step-label"><%= isAr ? 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Review' %></span>
          </div>
        </div>

        <form method="post" action="/patient/new-case" id="caseForm">
          <%- (typeof csrfField === 'function') ? csrfField() : '' %>
          
          <!-- Hidden fields to store selections -->
          <input type="hidden" name="case_type" id="caseType" value="">
          <input type="hidden" name="specialty_id" id="specialtyId" value="">
          <input type="hidden" name="service_id" id="serviceId" value="">

          <!-- STEP 1: Select Case Type -->
          <div class="wizard-section active" data-step="1">
            <h2 style="margin-bottom: 20px; font-size: 24px; text-align: center;">
              <%= isAr ? 'Ù…Ø§ Ù†ÙˆØ¹ Ø­Ø§Ù„ØªÙƒØŸ' : 'What type of case is this?' %>
            </h2>

            <div class="type-grid">
              <div class="type-card" data-type="imaging">
                <div class="icon">ğŸ©»</div>
                <h3><%= isAr ? 'Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ' : 'Diagnostic Imaging' %></h3>
                <p><%= isAr ? 'Ø£Ø´Ø¹Ø©ØŒ Ø±Ù†ÙŠÙ†ØŒ Ø£Ø´Ø¹Ø© Ù…Ù‚Ø·Ø¹ÙŠØ©ØŒ Ù…ÙˆØ¬Ø§Øª ÙÙˆÙ‚ ØµÙˆØªÙŠØ©' : 'X-ray, MRI, CT, Ultrasound' %></p>
              </div>

              <div class="type-card" data-type="labs">
                <div class="icon">ğŸ§ª</div>
                <h3><%= isAr ? 'Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©' : 'Laboratory Tests' %></h3>
                <p><%= isAr ? 'ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø¯Ù…ØŒ ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø£Ù†Ø³Ø¬Ø©' : 'Blood work, Pathology' %></p>
              </div>

              <div class="type-card" data-type="treatment">
                <div class="icon">ğŸ’Š</div>
                <h3><%= isAr ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬' : 'Treatment Review' %></h3>
                <p><%= isAr ? 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¬Ø±Ø§Ø­ÙŠØ©ØŒ Ø®Ø·Ø· Ø§Ù„Ø£Ø¯ÙˆÙŠØ©' : 'Surgical opinions, Medications' %></p>
              </div>

              <div class="type-card" data-type="general">
                <div class="icon">â“</div>
                <h3><%= isAr ? 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ© Ø¹Ø§Ù…Ø©' : 'General Medical' %></h3>
                <p><%= isAr ? 'ØªÙˆØ¶ÙŠØ­ Ø§Ù„ØªØ´Ø®ÙŠØµØŒ Ø±Ø£ÙŠ Ø«Ø§Ù†Ù' : 'Diagnosis clarity, Second opinion' %></p>
              </div>
            </div>

            <div class="unsure-link" id="unsureBtn">
              <span>
                <span style="font-size: 20px;">ğŸ¤–</span>
                <%= isAr ? 'ØºÙŠØ± Ù…ØªØ£ÙƒØ¯ØŸ Ø¯Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØ³Ø§Ø¹Ø¯Ùƒ' : 'Not sure? Let AI help you choose' %>
              </span>
            </div>

            <!-- AI Assistance Box -->
            <div class="ai-assist-box" id="aiAssistBox">
              <h4>
                <span style="font-size: 20px;">ğŸ¤–</span>
                <%= isAr ? 'Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'AI Assistant' %>
              </h4>
              <p style="font-size: 14px; margin-bottom: 12px; opacity: 0.95;">
                <%= isAr ? 'Ø§Ø´Ø±Ø­ Ø­Ø§Ù„ØªÙƒ ÙˆØ³Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨' : 'Describe your case and we\'ll help you pick the right type' %>
              </p>
              <textarea 
                id="aiInput" 
                placeholder="<%= isAr ? 'Ù…Ø«Ø§Ù„: Ù„Ø¯ÙŠ Ø£Ù„Ù… ÙÙŠ Ø§Ù„ØµØ¯Ø± ÙˆØ£Ø¬Ø±ÙŠØª ØªØ®Ø·ÙŠØ· Ù‚Ù„Ø¨ ÙˆØ£Ø­ØªØ§Ø¬ Ø±Ø£ÙŠØ§Ù‹ Ø«Ø§Ù†ÙŠØ§Ù‹' : 'Example: I have chest pain, got an ECG done, and need a second opinion' %>"
              ></textarea>
              <button type="button" class="ai-btn" id="aiAnalyzeBtn">
                <span id="aiAnalyzeText"><%= isAr ? 'ØªØ­Ù„ÙŠÙ„' : 'Analyze' %></span>
                <span id="aiLoadingText" style="display: none;"><%= isAr ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...' : 'Analyzing...' %></span>
              </button>

              <div class="ai-result" id="aiResult">
                <h5><%= isAr ? 'ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ©:' : 'ğŸ’¡ Recommendation:' %></h5>
                <p id="aiRecommendation"></p>
                <div class="ai-suggestions" id="aiSuggestions"></div>
              </div>
            </div>

            <div class="button-group">
              <button type="button" class="btn-wizard secondary" onclick="window.location.href='/dashboard'">
                <%= isAr ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' %>
              </button>
              <button type="button" class="btn-wizard primary" id="step1Next" disabled>
                <%= isAr ? 'Ø§Ù„ØªØ§Ù„ÙŠ â†’' : 'Continue â†’' %>
              </button>
            </div>
          </div>

          <!-- STEP 2: Case Details (Dynamic based on type) -->
          <div class="wizard-section" data-step="2">
            <div id="step2Content"></div>
            
            <div class="button-group">
              <button type="button" class="btn-wizard secondary" id="step2Back">
                <%= isAr ? 'â† Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'â† Back' %>
              </button>
              <button type="button" class="btn-wizard primary" id="step2Next">
                <%= isAr ? 'Ø§Ù„ØªØ§Ù„ÙŠ â†’' : 'Continue â†’' %>
              </button>
            </div>
          </div>

          <!-- STEP 3: Upload Files -->
          <div class="wizard-section" data-step="3">
            <h2 style="margin-bottom: 20px; font-size: 20px;">
              <%= isAr ? 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©' : 'Upload Medical Files' %>
            </h2>

            <div class="info-box">
              <div class="icon">ğŸ’¡</div>
              <div class="info-box-content">
                <p><%= isAr ? 'Ø±ÙÙ‘Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©. ØªØ¯Ø¹Ù…: PDFØŒ JPEGØŒ PNGØŒ DICOM. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 100 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª Ù„ÙƒÙ„ Ù…Ù„Ù.' : 'Upload all relevant medical files. Supports: PDF, JPEG, PNG, DICOM. Max 100MB per file.' %></p>
              </div>
            </div>

            <div>
              <label class="filter-label"><%= isAr ? 'Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©' : 'Medical Files' %></label>
              <input
                type="hidden"
                role="uploadcare-uploader"
                name="file_urls"
                data-multiple
                data-clearable
              />
              <p class="muted" style="font-size:12px; margin-top:4px;">
                <%= isAr ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©' : 'You can upload multiple files at once' %>
              </p>
            </div>

            <div style="margin-top: 24px;">
              <label class="filter-label"><%= isAr ? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Additional Notes (Optional)' %></label>
              <textarea 
                name="notes" 
                rows="4" 
                placeholder="<%= isAr ? 'Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ØªÙˆØ¯ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'Any additional details you want to share with the doctor' %>"
                style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;"
              ><%= form && form.notes ? form.notes : '' %></textarea>
            </div>

            <div class="button-group">
              <button type="button" class="btn-wizard secondary" id="step3Back">
                <%= isAr ? 'â† Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'â† Back' %>
              </button>
              <button type="button" class="btn-wizard primary" id="step3Next">
                <%= isAr ? 'Ø§Ù„ØªØ§Ù„ÙŠ â†’' : 'Continue â†’' %>
              </button>
            </div>
          </div>

          <!-- STEP 4: Review & Submit -->
          <div class="wizard-section" data-step="4">
            <h2 style="margin-bottom: 20px; font-size: 20px;">
              <%= isAr ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„' : 'Review & Submit' %>
            </h2>

            <div id="reviewSummary" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
              <!-- Summary will be populated by JS -->
            </div>

            <div class="form-section">
              <label class="filter-label"><%= isAr ? 'Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…' : 'Turnaround Time' %></label>
              <div style="display:flex; gap:16px; align-items:center; margin-top:12px; flex-wrap: wrap;">
                <label style="display:flex; align-items:center; gap:8px; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; flex: 1; min-width: 200px;">
                  <input type="radio" name="sla_type" value="72" checked style="width: 18px; height: 18px;" />
                  <div>
                    <div style="font-weight: 600;"><%= isAr ? 'Ø¹Ø§Ø¯ÙŠ (Ù§Ù¢ Ø³Ø§Ø¹Ø©)' : 'Standard (72h)' %></div>
                    <div style="font-size: 12px; color: #6b7280;"><%= isAr ? 'Ø£ÙØ¶Ù„ Ù‚ÙŠÙ…Ø©' : 'Best value' %></div>
                  </div>
                </label>
                <label style="display:flex; align-items:center; gap:8px; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; flex: 1; min-width: 200px;">
                  <input type="radio" name="sla_type" value="24" style="width: 18px; height: 18px;" />
                  <div>
                    <div style="font-weight: 600;"><%= isAr ? 'Ø³Ø±ÙŠØ¹ (Ù¢Ù¤ Ø³Ø§Ø¹Ø©)' : 'Fast (24h)' %></div>
                    <div style="font-size: 12px; color: #6b7280;"><%= isAr ? 'Ø£ÙˆÙ„ÙˆÙŠØ©' : 'Priority' %></div>
                  </div>
                </label>
              </div>
            </div>

            <div style="font-size:13px; color:#6b7280; margin: 20px 0; padding: 16px; background: #f0f9ff; border-radius: 8px;">
              <%= isAr ? 'Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· ØªØ´Ø®ÙŠØµØ© ÙˆØªØ¤ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ØµØ­ÙŠØ­Ø©.' : 'By submitting, you agree to Tashkheesa\'s terms and confirm the information provided is accurate.' %>
            </div>

            <div class="button-group">
              <button type="button" class="btn-wizard secondary" id="step4Back">
                <%= isAr ? 'â† Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'â† Back' %>
              </button>
              <button type="submit" class="btn-wizard primary" id="submitBtn">
                <%= isAr ? 'âœ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø©' : 'âœ“ Submit Case' %>
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>
  </div>
</div>

<script>
// Smart Case Submission Wizard
(function() {
  const isAr = <%= isAr ? 'true' : 'false' %>;
  const specialties = <%- JSON.stringify(specialties || []) %>;
  const services = <%- JSON.stringify(services || []) %>;
  
  let currentStep = 1;
  let selectedType = '';
  let formData = {};

  // Type selection
  document.querySelectorAll('.type-card').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      selectedType = this.dataset.type;
      document.getElementById('caseType').value = selectedType;
      document.getElementById('step1Next').disabled = false;
      document.getElementById('aiAssistBox').classList.remove('active');
    });
  });

  // AI Assistance toggle
  document.getElementById('unsureBtn').addEventListener('click', function() {
    const aiBox = document.getElementById('aiAssistBox');
    aiBox.classList.toggle('active');
  });

  // AI Analysis
  document.getElementById('aiAnalyzeBtn').addEventListener('click', async function() {
    const input = document.getElementById('aiInput').value.trim();
    if (!input) return;

    const btn = this;
    const analyzeText = document.getElementById('aiAnalyzeText');
    const loadingText = document.getElementById('aiLoadingText');
    
    btn.disabled = true;
    analyzeText.style.display = 'none';
    loadingText.style.display = 'inline';

    try {
      const response = await fetch('/api/analyze-case-type', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: input })
      });

      const result = await response.json();
      
      if (result.success) {
        const aiResult = document.getElementById('aiResult');
        const recommendation = document.getElementById('aiRecommendation');
        const suggestions = document.getElementById('aiSuggestions');
        
        recommendation.textContent = result.reasoning;
        
        suggestions.innerHTML = '';
        result.suggestedTypes.forEach(type => {
          const chip = document.createElement('div');
          chip.className = 'ai-suggestion-chip';
          chip.textContent = type.label;
          chip.onclick = () => {
            const typeCard = document.querySelector(`.type-card[data-type="${type.value}"]`);
            if (typeCard) typeCard.click();
          };
          suggestions.appendChild(chip);
        });
        
        aiResult.classList.add('active');
      }
    } catch (error) {
      console.error('AI analysis error:', error);
      alert(isAr ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' : 'Error analyzing. Please try again.');
    } finally {
      btn.disabled = false;
      analyzeText.style.display = 'inline';
      loadingText.style.display = 'none';
    }
  });

  // Step navigation
  function goToStep(step) {
    document.querySelectorAll('.wizard-section').forEach(section => {
      section.classList.remove('active');
    });
    document.querySelector(`.wizard-section[data-step="${step}"]`).classList.add('active');
    
    document.querySelectorAll('.step-circle, .step-label').forEach(el => {
      el.classList.remove('active', 'complete');
    });
    
    for (let i = 1; i < step; i++) {
      document.querySelector(`.step-circle[data-step="${i}"]`).classList.add('complete');
      document.querySelector(`.step-circle[data-step="${i}"]`).textContent = 'âœ“';
    }
    
    document.querySelector(`.step-circle[data-step="${step}"]`).classList.add('active');
    document.querySelectorAll('.step-label')[step - 1].classList.add('active');
    
    currentStep = step;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Step 1 -> Step 2
  document.getElementById('step1Next').addEventListener('click', function() {
    if (!selectedType) return;
    loadStep2Content(selectedType);
    goToStep(2);
  });

  // Load Step 2 content based on type
  function loadStep2Content(type) {
    const step2Content = document.getElementById('step2Content');
    let content = '';

    const typeInfo = {
      imaging: {
        title: isAr ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØ±' : 'Imaging Details',
        subtitle: isAr ? 'Ø³ÙŠÙ‚ÙˆÙ… Ø§Ø®ØªØµØ§ØµÙŠ Ø§Ù„Ø£Ø´Ø¹Ø© Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© ØµÙˆØ±Ùƒ ÙˆØªÙ‚Ø¯ÙŠÙ… ØªÙØ³ÙŠØ± Ù…ÙØµÙ„' : 'A radiologist will review your imaging and provide detailed interpretation',
        icon: 'ğŸ©»'
      },
      labs: {
        title: isAr ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„' : 'Lab Test Details',
        subtitle: isAr ? 'Ø³ÙŠÙ‚ÙˆÙ… Ø§Ø®ØªØµØ§ØµÙŠ Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø¨ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬Ùƒ ÙˆØ´Ø±Ø­ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø§Ø°Ø©' : 'A pathologist will analyze your results and explain abnormal values',
        icon: 'ğŸ§ª'
      },
      treatment: {
        title: isAr ? 'ØªÙØ§ØµÙŠÙ„ Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬' : 'Treatment Plan Details',
        subtitle: isAr ? 'Ø³ÙŠÙ‚ÙˆÙ… Ø§Ø®ØªØµØ§ØµÙŠ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬Ùƒ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø±Ø£ÙŠ Ù…Ø³ØªÙ‚Ù„' : 'A specialist will review your treatment plan and provide independent opinion',
        icon: 'ğŸ’Š'
      },
      general: {
        title: isAr ? 'Ø§Ø³ØªØ´Ø§Ø±ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ©' : 'Your Medical Question',
        subtitle: isAr ? 'Ø³ÙŠÙ‚ÙˆÙ… Ø·Ø¨ÙŠØ¨ Ù…Ø¹ØªÙ…Ø¯ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¤Ø§Ù„Ùƒ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø±Ø£ÙŠ Ø´Ø§Ù…Ù„' : 'A board-certified physician will review your question and provide comprehensive opinion',
        icon: 'â“'
      }
    };

    const info = typeInfo[type];
    
    content = `
      <h2 style="margin-bottom: 20px; font-size: 20px;">${info.title}</h2>
      
      <div class="info-box">
        <div class="icon">${info.icon}</div>
        <div class="info-box-content">
          <p><strong>${isAr ? 'Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØªÙˆÙ‚Ø¹Ù‡:' : 'What to expect:'}</strong> ${info.subtitle}</p>
        </div>
      </div>
      
      ${getTypeSpecificFields(type)}
      
      <div class="form-section">
        <h3>${isAr ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ±ÙŠØ©' : 'Clinical Information'}</h3>
        <div>
          <label class="filter-label">
            ${isAr ? 'Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ø§Ù„Ø³Ø¨Ø¨' : 'Chief Complaint / Reason'} <span style="color: #ef4444;">*</span>
          </label>
          <textarea 
            id="chiefComplaint" 
            name="chief_complaint" 
            required 
            rows="4" 
            placeholder="${type === 'imaging' ? (isAr ? 'Ù…Ø§ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø§ÙˆÙ Ø§Ù„ØªÙŠ Ø£Ø¯Øª Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙˆÙŠØ±ØŸ' : 'What symptoms or concerns led to this imaging?') : type === 'labs' ? (isAr ? 'Ù„Ù…Ø§Ø°Ø§ Ø·ÙÙ„Ø¨Øª Ù‡Ø°Ù‡ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ØŸ' : 'Why were these tests ordered?') : type === 'treatment' ? (isAr ? 'Ù…Ø§ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø¹Ù„Ø§Ø¬Ù‡Ø§ØŸ' : 'What condition is being treated?') : (isAr ? 'Ø§Ø´Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„ØªÙØµÙŠÙ„' : 'Describe your medical question in detail')}"
            style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;"
          ></textarea>
        </div>
        
        <div style="margin-top: 16px;">
          <label class="filter-label">${isAr ? 'Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ©' : 'Current Symptoms'}</label>
          <textarea 
            id="currentSymptoms"
            name="current_symptoms" 
            rows="3" 
            placeholder="${isAr ? 'Ø§Ø´Ø±Ø­ Ø£ÙŠ Ø£Ø¹Ø±Ø§Ø¶ ØªØ¹Ø§Ù†ÙŠ Ù…Ù†Ù‡Ø§' : 'Describe any symptoms you\'re experiencing'}"
            style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;"
          ></textarea>
        </div>
        
        <div style="margin-top: 16px;">
          <label class="filter-label">${isAr ? 'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ Ø°Ùˆ Ø§Ù„ØµÙ„Ø©' : 'Relevant Medical History'}</label>
          <textarea 
            id="medicalHistory"
            name="medical_history" 
            rows="3" 
            placeholder="${isAr ? 'Ø£ÙŠ Ø­Ø§Ù„Ø§Øª Ù…Ø²Ù…Ù†Ø©ØŒ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©' : 'Any chronic conditions, past surgeries, current medications'}"
            style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;"
          ></textarea>
        </div>
      </div>
    `;

    step2Content.innerHTML = content;
  }

  function getTypeSpecificFields(type) {
    let fields = '<div class="smart-fields active"><h4>âš¡ ' + (isAr ? 'Ø­Ù‚ÙˆÙ„ Ø°ÙƒÙŠØ©' : 'Smart Fields') + ' <span class="tag">' + (isAr ? 'ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'Auto-detected') + '</span></h4>';
    
    if (type === 'imaging') {
      fields += `
        <div style="margin-bottom: 16px;">
          <label class="filter-label">${isAr ? 'Ù†ÙˆØ¹ Ø§Ù„ØªØµÙˆÙŠØ±' : 'Imaging Type'} <span style="color: #ef4444;">*</span></label>
          <select id="imagingType" name="imaging_type" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <option value="">${isAr ? 'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµÙˆÙŠØ±' : 'Select imaging type'}</option>
            <option value="xray">${isAr ? 'Ø£Ø´Ø¹Ø© Ø³ÙŠÙ†ÙŠØ©' : 'X-Ray'}</option>
            <option value="mri">${isAr ? 'Ø±Ù†ÙŠÙ† Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ' : 'MRI'}</option>
            <option value="ct">${isAr ? 'Ø£Ø´Ø¹Ø© Ù…Ù‚Ø·Ø¹ÙŠØ©' : 'CT Scan'}</option>
            <option value="ultrasound">${isAr ? 'Ù…ÙˆØ¬Ø§Øª ÙÙˆÙ‚ ØµÙˆØªÙŠØ©' : 'Ultrasound'}</option>
            <option value="pet">${isAr ? 'PET Scan' : 'PET Scan'}</option>
            <option value="mammogram">${isAr ? 'ØªØµÙˆÙŠØ± Ø§Ù„Ø«Ø¯ÙŠ' : 'Mammogram'}</option>
            <option value="other">${isAr ? 'Ø£Ø®Ø±Ù‰' : 'Other'}</option>
          </select>
        </div>
        <div style="margin-bottom: 16px;">
          <label class="filter-label">${isAr ? 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø³Ù… / Ø§Ù„Ø¹Ø¶Ùˆ' : 'Body Part / Region'} <span style="color: #ef4444;">*</span></label>
          <input type="text" id="bodyPart" name="body_part" required placeholder="${isAr ? 'Ù…Ø«Ø§Ù„: Ø§Ù„ØµØ¯Ø±ØŒ Ø§Ù„Ø¨Ø·Ù†ØŒ Ø§Ù„Ø¯Ù…Ø§ØºØŒ Ø§Ù„Ø±ÙƒØ¨Ø©' : 'e.g., Chest, Abdomen, Brain, Knee'}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" />
        </div>
        <div>
          <label class="filter-label">${isAr ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµÙˆÙŠØ±' : 'Scan Date'}</label>
          <input type="date" id="scanDate" name="scan_date" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" />
        </div>
      `;
    } else if (type === 'labs') {
      fields += `
        <div>
          <label class="filter-label">${isAr ? 'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'Test Type'} <span style="color: #ef4444;">*</span></label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" name="test_types" value="cbc" />
              <span>${isAr ? 'ØªØ¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (CBC)' : 'Complete Blood Count (CBC)'}</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="test_types" value="cmp" />
              <span>${isAr ? 'Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙŠØ¶ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©' : 'Comprehensive Metabolic Panel'}</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="test_types" value="lipid" />
              <span>${isAr ? 'Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† (Ø§Ù„ÙƒÙˆÙ„ÙŠØ³ØªØ±ÙˆÙ„)' : 'Lipid Panel (Cholesterol)'}</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="test_types" value="thyroid" />
              <span>${isAr ? 'Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©' : 'Thyroid Function Tests'}</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="test_types" value="liver" />
              <span>${isAr ? 'Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ¨Ø¯' : 'Liver Function Tests'}</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="test_types" value="other" />
              <span>${isAr ? 'Ø£Ø®Ø±Ù‰' : 'Other'}</span>
            </label>
          </div>
        </div>
      `;
    } else if (type === 'treatment') {
      fields += `
        <div style="margin-bottom: 16px;">
          <label class="filter-label">${isAr ? 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ø¬' : 'Treatment Type'} <span style="color: #ef4444;">*</span></label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="treatment_type" value="surgery" required />
              <span>${isAr ? 'Ø¬Ø±Ø§Ø­Ø© / Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø±Ø§Ø­ÙŠ' : 'Surgery / Surgical Procedure'}</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="treatment_type" value="medication" />
              <span>${isAr ? 'Ø£Ø¯ÙˆÙŠØ© / Ø®Ø·Ø© ÙˆØµÙØ© Ø·Ø¨ÙŠØ©' : 'Medication / Prescription Plan'}</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="treatment_type" value="chemo" />
              <span>${isAr ? 'Ø¹Ù„Ø§Ø¬ ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ / Ø¥Ø´Ø¹Ø§Ø¹ÙŠ' : 'Chemotherapy / Radiation'}</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="treatment_type" value="therapy" />
              <span>${isAr ? 'Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ / ØªØ£Ù‡ÙŠÙ„' : 'Physical Therapy / Rehabilitation'}</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="treatment_type" value="other" />
              <span>${isAr ? 'Ø£Ø®Ø±Ù‰' : 'Other'}</span>
            </label>
          </div>
        </div>
        <div>
          <label class="filter-label">${isAr ? 'Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ / Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­' : 'Proposed Procedure / Treatment Name'} <span style="color: #ef4444;">*</span></label>
          <input type="text" id="treatmentName" name="treatment_name" required placeholder="${isAr ? 'Ù…Ø«Ø§Ù„: Ø§Ø³ØªØ¦ØµØ§Ù„ Ø§Ù„Ù…Ø±Ø§Ø±Ø© Ø¨Ø§Ù„Ù…Ù†Ø¸Ø§Ø±' : 'e.g., Laparoscopic cholecystectomy'}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" />
        </div>
      `;
    } else if (type === 'general') {
      fields += `
        <div style="margin-bottom: 16px;">
          <label class="filter-label">${isAr ? 'Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Question Type'} <span style="color: #ef4444;">*</span></label>
          <select id="questionType" name="question_type" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <option value="">${isAr ? 'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Select question type'}</option>
            <option value="diagnosis">${isAr ? 'ÙÙ‡Ù… ØªØ´Ø®ÙŠØµÙŠ' : 'Understanding my diagnosis'}</option>
            <option value="second_opinion">${isAr ? 'Ø±Ø£ÙŠ Ø«Ø§Ù†Ù Ø¹Ù† Ø§Ù„ØªØ´Ø®ÙŠØµ' : 'Second opinion on diagnosis'}</option>
            <option value="record_review">${isAr ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ' : 'Medical record review'}</option>
            <option value="treatment_options">${isAr ? 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬' : 'Treatment options'}</option>
            <option value="symptoms">${isAr ? 'Ø´Ø±Ø­ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©' : 'Chronic symptom explanation'}</option>
            <option value="preventive">${isAr ? 'Ù†ØµÙŠØ­Ø© ØµØ­ÙŠØ© ÙˆÙ‚Ø§Ø¦ÙŠØ©' : 'Preventive health advice'}</option>
            <option value="other">${isAr ? 'Ø³Ø¤Ø§Ù„ Ø·Ø¨ÙŠ Ø¢Ø®Ø±' : 'Other medical question'}</option>
          </select>
        </div>
        <div>
          <label class="filter-label">${isAr ? 'Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø·Ø¨ÙŠ (Ø¥Ù† ÙƒÙ†Øª ØªØ¹Ø±Ù)' : 'Medical Specialty (if known)'}</label>
          <select id="preferredSpecialty" name="preferred_specialty" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <option value="">${isAr ? 'ØºÙŠØ± Ù…ØªØ£ÙƒØ¯ - Ø¯Ø¹ ØªØ´Ø®ÙŠØµØ© ØªÙ‚Ø±Ø±' : 'Not sure - let Tashkheesa decide'}</option>
            ${specialties.map(sp => `<option value="${sp.id}">${sp.name}</option>`).join('')}
          </select>
        </div>
      `;
    }
    
    fields += '</div>';
    return fields;
  }

  // Step 2 -> Step 3
  document.getElementById('step2Next').addEventListener('click', function() {
    // Validate required fields in step 2
    const chiefComplaint = document.getElementById('chiefComplaint');
    if (!chiefComplaint || !chiefComplaint.value.trim()) {
      alert(isAr ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Please fill in the chief complaint');
      return;
    }
    
    // Validate type-specific required fields
    if (selectedType === 'imaging') {
      const imagingType = document.getElementById('imagingType');
      const bodyPart = document.getElementById('bodyPart');
      if (!imagingType.value || !bodyPart.value.trim()) {
        alert(isAr ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©' : 'Please fill in all required fields');
        return;
      }
    } else if (selectedType === 'treatment') {
      const treatmentType = document.querySelector('input[name="treatment_type"]:checked');
      const treatmentName = document.getElementById('treatmentName');
      if (!treatmentType || !treatmentName.value.trim()) {
        alert(isAr ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©' : 'Please fill in all required fields');
        return;
      }
    } else if (selectedType === 'general') {
      const questionType = document.getElementById('questionType');
      if (!questionType.value) {
        alert(isAr ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Please select question type');
        return;
      }
    }
    
    // Auto-assign specialty based on type
    autoAssignSpecialty();
    
    goToStep(3);
  });

  // Auto-assign specialty and service based on case type
  function autoAssignSpecialty() {
    const typeSpecialtyMap = {
      'imaging': 'Radiology',
      'labs': 'Pathology',
      'treatment': null, // Will be determined by treatment type or user selection
      'general': null // User can select or let system decide
    };
    
    const suggestedSpecialty = typeSpecialtyMap[selectedType];
    
    if (suggestedSpecialty) {
      const specialty = specialties.find(s => s.name === suggestedSpecialty);
      if (specialty) {
        document.getElementById('specialtyId').value = specialty.id;
        
        // Try to find matching service
        const matchingService = services.find(s => s.specialty_id === specialty.id);
        if (matchingService) {
          document.getElementById('serviceId').value = matchingService.id;
        }
      }
    }
  }

  // Step 3 -> Step 4
  document.getElementById('step3Next').addEventListener('click', function() {
    generateReviewSummary();
    goToStep(4);
  });

  // Generate review summary
  function generateReviewSummary() {
    const typeNames = {
      'imaging': isAr ? 'Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ' : 'Diagnostic Imaging',
      'labs': isAr ? 'Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©' : 'Laboratory Tests',
      'treatment': isAr ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬' : 'Treatment Review',
      'general': isAr ? 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ© Ø¹Ø§Ù…Ø©' : 'General Medical Question'
    };

    let summary = `
      <h3 style="margin-bottom: 16px; color: #1f2937;">${isAr ? 'Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©' : 'Case Summary'}</h3>
      <div style="margin-bottom: 16px;">
        <div style="font-weight: 600; color: #6b7280; font-size: 13px; margin-bottom: 4px;">${isAr ? 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©' : 'Case Type'}</div>
        <div style="font-size: 15px; color: #1f2937;">${typeNames[selectedType]}</div>
      </div>
    `;

    const chiefComplaint = document.getElementById('chiefComplaint');
    if (chiefComplaint && chiefComplaint.value) {
      summary += `
        <div style="margin-bottom: 16px;">
          <div style="font-weight: 600; color: #6b7280; font-size: 13px; margin-bottom: 4px;">${isAr ? 'Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Chief Complaint'}</div>
          <div style="font-size: 15px; color: #1f2937;">${chiefComplaint.value}</div>
        </div>
      `;
    }

    // Add type-specific summary
    if (selectedType === 'imaging') {
      const imagingType = document.getElementById('imagingType');
      const bodyPart = document.getElementById('bodyPart');
      if (imagingType && bodyPart) {
        summary += `
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 600; color: #6b7280; font-size: 13px; margin-bottom: 4px;">${isAr ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØ±' : 'Imaging Details'}</div>
            <div style="font-size: 15px; color: #1f2937;">
              ${imagingType.options[imagingType.selectedIndex].text} - ${bodyPart.value}
            </div>
          </div>
        `;
      }
    } else if (selectedType === 'treatment') {
      const treatmentName = document.getElementById('treatmentName');
      if (treatmentName) {
        summary += `
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 600; color: #6b7280; font-size: 13px; margin-bottom: 4px;">${isAr ? 'Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­' : 'Proposed Treatment'}</div>
            <div style="font-size: 15px; color: #1f2937;">${treatmentName.value}</div>
          </div>
        `;
      }
    }

    document.getElementById('reviewSummary').innerHTML = summary;
  }

  // Back buttons
  document.getElementById('step2Back').addEventListener('click', () => goToStep(1));
  document.getElementById('step3Back').addEventListener('click', () => goToStep(2));
  document.getElementById('step4Back').addEventListener('click', () => goToStep(3));

  // Handle URL parameters (from services page)
  const urlParams = new URLSearchParams(window.location.search);
  const typeParam = urlParams.get('type');
  if (typeParam && ['imaging', 'labs', 'treatment', 'general'].includes(typeParam)) {
    const typeCard = document.querySelector(`.type-card[data-type="${typeParam}"]`);
    if (typeCard) {
      typeCard.click();
    }
  }
})();
</script>

<script src="/js/patient_new_case.js"></script>
<%- include('partials/footer', { showFooter: false }) %>
