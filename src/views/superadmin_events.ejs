<%- include('partials/header', { title: "Audit Log", layout: "portal", showNav: true, showFooter: false, portalFrame: true, portalRole: 'superadmin', portalActive: 'events', portalNext: '/superadmin/events' }) %>
<%
  var _f = (typeof filters !== 'undefined' && filters) ? filters : {};
  var qs = new URLSearchParams();
  ['label','order_id','role','from','to'].forEach(function(k){
    if (_f && _f[k]) qs.set(k, _f[k]);
  });
  var langNextHref = '/superadmin/events' + (qs.toString() ? ('?' + qs.toString()) : '');
  const isAr = (typeof lang !== 'undefined' && lang === 'ar');
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
%>
      <div class="admin-page">
        <div class="admin-page-header">
          <div class="admin-page-header-left">
            <nav class="admin-breadcrumb">
              <a href="/superadmin">Dashboard</a>
              <span class="admin-breadcrumb-sep">&rsaquo;</span>
              <span><%= isAr ? 'سجل التدقيق' : 'Audit Log' %></span>
            </nav>
            <h1 class="admin-page-title"><%= isAr ? 'سجل التدقيق' : 'Audit Log' %></h1>
            <p class="admin-page-subtitle">Recent events across the platform.</p>
          </div>
        </div>

        <form class="admin-card" method="get" action="/superadmin/events">
          <div class="admin-card-body">
            <div class="admin-form-grid">
              <div class="admin-form-group">
                <label class="filter-label">Label</label>
                <input type="text" name="label" value="<%= filters.label || '' %>" placeholder="Search label..." />
              </div>
              <div class="admin-form-group">
                <label class="filter-label">Order ID</label>
                <input type="text" name="order_id" value="<%= filters.order_id || '' %>" placeholder="order id" />
              </div>
              <div class="admin-form-group">
                <label class="filter-label">Role</label>
                <select name="role" class="filter-select">
                  <% ['all','patient','doctor','admin','superadmin','system'].forEach(function(r){ %>
                    <option value="<%= r %>" <%= filters.role === r ? 'selected' : '' %>><%= r.charAt(0).toUpperCase() + r.slice(1) %></option>
                  <% }); %>
                </select>
              </div>
              <div class="admin-form-group">
                <label class="filter-label">From</label>
                <input type="date" name="from" value="<%= filters.from || '' %>" />
              </div>
              <div class="admin-form-group">
                <label class="filter-label">To</label>
                <input type="date" name="to" value="<%= filters.to || '' %>" />
              </div>
              <div class="admin-form-group" style="display:flex; align-items:flex-end; gap:8px;">
                <button class="admin-btn admin-btn-primary" type="submit">Apply</button>
                <a class="admin-btn admin-btn-outline" href="/superadmin/events">Reset</a>
              </div>
            </div>
          </div>
        </form>

        <section class="admin-card">
          <div class="admin-card-body">
            <div class="table-scroll table-scroll--y table-scroll--6">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Order</th>
                    <th>Actor</th>
                    <th>Role</th>
                    <th>Label</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (events && events.length) { %>
                    <% events.forEach(function(ev){ %>
                      <tr>
                        <td><%= formatEventDate(ev.at) %></td>
                        <td>
                          <% if (ev.order_id) { %>
                            <a href="/superadmin/orders/<%= ev.order_id %>"><%= ev.order_id %></a>
                          <% } else { %>
                            —
                          <% } %>
                        </td>
                        <td>
                          <% if (ev.actor_user_id && (ev.actor_role === 'doctor') && ev.doctor_name) { %>
                            <%= ev.doctor_name %>
                          <% } else if (ev.actor_user_id && (ev.actor_role === 'patient') && ev.patient_name) { %>
                            <%= ev.patient_name %>
                          <% } else { %>
                            <%= ev.actor_role || 'System' %>
                          <% } %>
                        </td>
                        <td><%= ev.actor_role || 'system' %></td>
                        <td><%= ev.label %></td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr><td colspan="5" class="empty">No events found.</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

<%- include('partials/footer', { showFooter: false, portalFrame: true }) %>
