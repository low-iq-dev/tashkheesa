<%- include('partials/header', { title: "Payment Required", layout: "portal", showNav: false }) %>

<% 
  const isArSafe = (typeof isAr !== 'undefined' && !!isAr);
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  const tFn = (typeof t === 'function') ? t : null;
  const safeT = (key, fallback) => {
    try {
      if (!tFn) return fallback;
      const v = tFn(key);
      if (!v) return fallback;
      // Some i18n helpers return the key itself when missing; never show raw keys.
      if (String(v).trim() === String(key).trim()) return fallback;
      return v;
    } catch (e) {
      return fallback;
    }
  };

  const rawPaymentUrl = (
    (typeof paymentUrl !== 'undefined' && paymentUrl) ? paymentUrl :
    ((typeof paymentLink !== 'undefined' && paymentLink) ? paymentLink : null)
  );

  // Guardrail: only allow http(s) or same-origin relative links to be rendered as href
  const isSafeHref = (u) => {
    if (!u) return false;
    const s = String(u).trim();
    if (!s) return false;
    return s.startsWith('http://') || s.startsWith('https://') || s.startsWith('/');
  };

  const safePaymentUrl = isSafeHref(rawPaymentUrl) ? String(rawPaymentUrl).trim() : null;
  const isExternalPaymentUrl = safePaymentUrl ? (safePaymentUrl.startsWith('http://') || safePaymentUrl.startsWith('https://')) : false;
  const safeError = (typeof error !== 'undefined' && error) ? String(error) : null;

  const localizeError = (msg) => {
    if (!msg) return null;
    const s = String(msg);
    if (!isArSafe) return s;

    // Map common server-side errors to Arabic (fallback: show original).
    const map = {
      'Payment is required before accessing this case.': 'الدفع مطلوب قبل الوصول إلى هذه الحالة.',
      'Payment is required before a specialist can be assigned and the review can begin.': 'الدفع مطلوب قبل تعيين الطبيب المختص وبدء المراجعة.',
      'Payment is not configured for this service. Please contact support.': 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.',
      'Payment link is not available. Please contact support.': 'رابط الدفع غير متاح حالياً. يرجى التواصل مع الدعم.'
    };

    // Exact match first
    if (map[s]) return map[s];

    // Light heuristics
    if (s.toLowerCase().includes('payment') && s.toLowerCase().includes('required')) {
      return 'الدفع مطلوب لإكمال هذه الخطوة.';
    }

    return s;
  };

  const missingValue = isArSafe ? 'غير متوفر' : '—';
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= isArSafe ? 'بوابة المريض' : 'Patient Portal' %></span>
    </div>
  </div>

  <div class="portal-grid">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/portal/patient/orders/new">New Case</a></li>
        <li><a href="/portal/patient/alerts">Alerts</a></li>
        <li><a href="/patient/profile">Profile</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </aside>

    <main class="portal-content" dir="<%= isArSafe ? 'rtl' : 'ltr' %>">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= safeT('patient.payment_required.title', isArSafe ? 'الدفع مطلوب' : 'Payment Required') %></h1>
        <p class="portal-hero-subtitle">
          <%= safeT(
            'patient.payment_required.body',
            isArSafe
              ? 'تم إنشاء هذه الحالة الطبية ولكن لم يتم دفع الرسوم بعد. يجب إتمام الدفع قبل تعيين الطبيب المختص وبدء المراجعة.'
              : 'This medical case has been created but has not yet been paid for. Payment is required before a specialist can be assigned and the review can begin.'
          ) %>
        </p>
      </div>

      <section class="flow-card">
        <% if (safeError) { %>
          <p class="flow-note"><%= localizeError(safeError) %></p>
        <% } %>

        <div>
          <p>
            <strong><%= safeT('common.service', isArSafe ? 'الخدمة:' : 'Service:') %></strong>
            <%= order && (order.service_name || order.serviceName) ? (order.service_name || order.serviceName) : missingValue %>
          </p>
          <p>
            <strong><%= safeT('common.specialty', isArSafe ? 'التخصص:' : 'Specialty:') %></strong>
            <%= order && (order.specialty_name || order.specialtyName) ? (order.specialty_name || order.specialtyName) : missingValue %>
          </p>
          <p>
            <strong><%= safeT('common.price', isArSafe ? 'السعر:' : 'Price:') %></strong>
            <%= order && (order.locked_price != null) ? order.locked_price : missingValue %>
            <%= order && order.locked_currency ? order.locked_currency : '' %>
          </p>
          <p>
            <strong><%= safeT('common.status', isArSafe ? 'الحالة:' : 'Status:') %></strong>
            <%= safeT('patient.payment_required.status_value', isArSafe ? 'بانتظار الدفع' : 'Awaiting payment') %>
          </p>
        </div>

        <% if (safePaymentUrl) { %>
          <div class="section-cta">
            <a class="btn btn-primary" href="<%= safePaymentUrl %>" <%= isExternalPaymentUrl ? 'target="_blank" rel="noopener noreferrer"' : '' %>>
              <%= safeT('patient.payment_required.cta_pay', isArSafe ? 'الانتقال للدفع' : 'Proceed to payment') %>
            </a>
          </div>

          <div class="form-group">
            <label class="form-label"><%= safeT('patient.payment_required.copy_link', isArSafe ? 'إذا لم يفتح الزر، انسخ الرابط:' : "If the button doesn't open, copy the link:") %></label>
            <input class="form-control" type="text" value="<%= safePaymentUrl %>" readonly dir="ltr" onclick="this.select();" />
            <p class="flow-note">
              <%= safeT('patient.payment_required.link_hint', isArSafe ? 'انسخ الرابط وافتحه في المتصفح إذا واجهت مشكلة.' : 'Copy the link and open it in your browser if you run into issues.') %>
            </p>
          </div>
        <% } else { %>
          <p class="flow-note">
            <%= safeT(
              'patient.payment_required.not_configured',
              isArSafe
                ? 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.'
                : 'Payment is not configured for this service. Please contact support.'
            ) %>
          </p>
        <% } %>

        <div class="section-cta">
          <a class="btn btn-secondary" href="/portal/patient/dashboard">
            <%= safeT('common.back_to_dashboard', isArSafe ? 'العودة إلى لوحة التحكم' : 'Back to dashboard') %>
          </a>
        </div>
      </section>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>
