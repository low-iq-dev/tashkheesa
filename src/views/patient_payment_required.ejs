<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "الدفع مطلوب" : "Payment Required"), layout: "portal", showNav: false }) %>

<% 
  const isArSafe = (typeof isAr !== 'undefined' && !!isAr);
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  const tFn = (typeof t === 'function') ? t : null;
  const safeT = (key, fallback) => {
    try {
      if (!tFn) return fallback;
      const v = tFn(key);
      if (!v) return fallback;
      // Some i18n helpers return the key itself when missing; never show raw keys.
      if (String(v).trim() === String(key).trim()) return fallback;
      return v;
    } catch (e) {
      return fallback;
    }
  };

  const rawPaymentUrl = (
    (typeof paymentUrl !== 'undefined' && paymentUrl) ? paymentUrl :
    ((typeof paymentLink !== 'undefined' && paymentLink) ? paymentLink : null)
  );

  // Guardrail: only allow http(s) or same-origin relative links to be rendered as href
  const isSafeHref = (u) => {
    if (!u) return false;
    const s = String(u).trim();
    if (!s) return false;
    return s.startsWith('http://') || s.startsWith('https://') || s.startsWith('/');
  };

  const safePaymentUrl = isSafeHref(rawPaymentUrl) ? String(rawPaymentUrl).trim() : null;
  const isExternalPaymentUrl = safePaymentUrl ? (safePaymentUrl.startsWith('http://') || safePaymentUrl.startsWith('https://')) : false;
  const safeError = (typeof error !== 'undefined' && error) ? String(error) : null;

  const localizeError = (msg) => {
    if (!msg) return null;
    const s = String(msg);
    if (!isArSafe) return s;

    // Map common server-side errors to Arabic (fallback: show original).
    const map = {
      'Payment is required before accessing this case.': 'الدفع مطلوب قبل الوصول إلى هذه الحالة.',
      'Payment is required before a specialist can be assigned and the review can begin.': 'الدفع مطلوب قبل تعيين الطبيب المختص وبدء المراجعة.',
      'Payment is not configured for this service. Please contact support.': 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.',
      'Payment link is not available. Please contact support.': 'رابط الدفع غير متاح حالياً. يرجى التواصل مع الدعم.'
    };

    // Exact match first
    if (map[s]) return map[s];

    // Light heuristics
    if (s.toLowerCase().includes('payment') && s.toLowerCase().includes('required')) {
      return 'الدفع مطلوب لإكمال هذه الخطوة.';
    }

    return s;
  };

  const missingValue = isArSafe ? 'غير متوفر' : '—';
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= safeT('patient.portal', isArSafe ? 'بوابة المريض' : 'Patient Portal') %></span>
    </div>
  </div>

  <div class="portal-grid" data-video-price="<%= typeof videoConsultationPrice !== 'undefined' ? videoConsultationPrice : 0 %>" data-sla-price="<%= typeof sla24hrPrice !== 'undefined' ? sla24hrPrice : 0 %>" data-base-price="<%= order && (order.locked_price != null) ? order.locked_price : 0 %>" data-currency="<%= order?.locked_currency || 'SAR' %>">
    <aside class="portal-sidebar">
      <ul class="portal-nav">
        <li><a href="/dashboard"><%= safeT('nav.dashboard.patient', isArSafe ? 'حالاتي الطبية' : 'My cases') %></a></li>
        <li><a href="/portal/patient/orders/new"><%= safeT('nav.new_case', isArSafe ? 'حالة جديدة' : 'New case') %></a></li>
        <li><a href="/portal/patient/alerts"><%= safeT('nav.alerts', isArSafe ? 'التنبيهات' : 'Alerts') %></a></li>
        <li><a href="/patient/profile"><%= safeT('nav.profile', isArSafe ? 'الملف الشخصي' : 'Profile') %></a></li>
        <li><a href="/logout"><%= safeT('auth.logout', isArSafe ? 'تسجيل الخروج' : 'Logout') %></a></li>
      </ul>
    </aside>

    <main class="portal-content" dir="<%= isArSafe ? 'rtl' : 'ltr' %>">
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= safeT('patient.payment_required.title', isArSafe ? 'الدفع مطلوب' : 'Payment Required') %></h1>
        <p class="portal-hero-subtitle">
          <%= safeT(
            'patient.payment_required.body',
            isArSafe
              ? 'تم إنشاء هذه الحالة الطبية ولكن لم يتم دفع الرسوم بعد. يجب إتمام الدفع قبل تعيين الطبيب المختص وبدء المراجعة.'
              : 'This medical case has been created but has not yet been paid for. Payment is required before a specialist can be assigned and the review can begin.'
          ) %>
        </p>
      </div>

      <section class="flow-card">
        <% if (safeError) { %>
          <p class="flow-note"><%= localizeError(safeError) %></p>
        <% } %>

        <div>
          <p>
            <strong><%= safeT('common.service', isArSafe ? 'الخدمة:' : 'Service:') %></strong>
            <%= order && (order.service_name || order.serviceName) ? (order.service_name || order.serviceName) : missingValue %>
          </p>
          <p>
            <strong><%= safeT('common.specialty', isArSafe ? 'التخصص:' : 'Specialty:') %></strong>
            <%= order && (order.specialty_name || order.specialtyName) ? (order.specialty_name || order.specialtyName) : missingValue %>
          </p>
          <p>
            <strong><%= safeT('common.price', isArSafe ? 'السعر:' : 'Price:') %></strong>
            <span id="base-price"><%= order && (order.locked_price != null) ? order.locked_price : missingValue %></span>
            <%= order && order.locked_currency ? order.locked_currency : '' %>
          </p>
          <p>
            <strong><%= safeT('common.status', isArSafe ? 'الحالة:' : 'Status:') %></strong>
            <%= safeT('patient.payment_required.status_value', isArSafe ? 'بانتظار الدفع' : 'Awaiting payment') %>
          </p>
        </div>

        <!-- DEBUG -->
        <!-- videoConsultationPrice = <%= typeof videoConsultationPrice %>, value = <%= videoConsultationPrice %> -->

        <!-- ADD-ONS SECTION -->
        <% const hasVideoAddon = (typeof videoConsultationPrice !== 'undefined' && videoConsultationPrice > 0);
           const hasSlaAddon = (typeof sla24hrPrice !== 'undefined' && sla24hrPrice > 0); %>
        <% if (hasVideoAddon || hasSlaAddon) { %>
          <div style="margin: 24px 0; padding: 16px; background: #F9FAFB; border-radius: 8px; border: 1px solid #E5E7EB;">
            <h3 style="margin-top: 0; font-size: 16px; font-weight: 600; margin-bottom: 12px;">
              <%= isArSafe ? 'خدمات إضافية' : 'Add-on Services' %>
            </h3>

            <% if (hasVideoAddon) { %>
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <input
                type="checkbox"
                id="addon_video_consultation"
                name="addon_video_consultation"
                value="1"
                style="width: 18px; height: 18px; cursor: pointer; margin-right: 12px;"
              />
              <label for="addon_video_consultation" style="flex: 1; cursor: pointer; margin: 0;">
                <span style="font-weight: 500; display: block;">
                  <%= isArSafe ? 'استشارة فيديو' : 'Video Consultation' %>
                </span>
                <span style="color: #6B7280; font-size: 14px;">
                  <%= isArSafe ? 'مع الطبيب المتخصص' : 'with the specialist' %>
                </span>
              </label>
              <span style="font-weight: 600; color: #0066CC; white-space: nowrap;">
                +<%= videoConsultationPrice %> <%= order?.locked_currency || 'EGP' %>
              </span>
            </div>
            <% } %>

            <% if (hasSlaAddon) { %>
            <div style="display: flex; align-items: center; margin-bottom: 12px; padding-top: 12px; border-top: 1px solid #E5E7EB;">
              <input
                type="checkbox"
                id="addon_sla_24hr"
                name="addon_sla_24hr"
                value="1"
                style="width: 18px; height: 18px; cursor: pointer; margin-right: 12px;"
              />
              <label for="addon_sla_24hr" style="flex: 1; cursor: pointer; margin: 0;">
                <span style="font-weight: 500; display: block;">
                  <%= isArSafe ? 'تشخيص سريع خلال 24 ساعة' : 'Priority 24-Hour Diagnosis' %>
                </span>
                <span style="color: #6B7280; font-size: 14px;">
                  <%= isArSafe ? 'احصل على نتيجتك خلال 24 ساعة بدلاً من 72 ساعة' : 'Get your results in 24 hours instead of 72 hours' %>
                </span>
              </label>
              <span style="font-weight: 600; color: #059669; white-space: nowrap;">
                +<%= sla24hrPrice %> <%= order?.locked_currency || 'EGP' %>
              </span>
            </div>
            <% } %>
          </div>

          <!-- PRICE BREAKDOWN -->
          <div style="margin-bottom: 24px; padding: 16px; background: #F0F7FF; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span><%= isArSafe ? 'السعر الأساسي' : 'Base price' %>:</span>
              <span><strong id="breakdown-base"><%= order && (order.locked_price != null) ? order.locked_price : '0' %></strong></span>
            </div>
            <div id="addon-cost-row" style="display: none; justify-content: space-between; margin-bottom: 8px;">
              <span><%= isArSafe ? 'الخدمات الإضافية' : 'Add-ons' %>:</span>
              <span id="addon-cost-value"><strong>0 EGP</strong></span>
            </div>
            <hr style="margin: 12px 0; border: none; border-top: 1px solid #E5E7EB;" />
            <div style="display: flex; justify-content: space-between; font-size: 18px;">
              <span style="font-weight: 600;"><%= isArSafe ? 'الإجمالي' : 'Total' %>:</span>
              <span id="total-price" style="font-weight: 700; color: #0066CC;"><strong><%= order && (order.locked_price != null) ? order.locked_price : '0' %> <%= order?.locked_currency || 'SAR' %></strong></span>
            </div>
          </div>
        <% } %>

        <% if (safePaymentUrl) { %>
          <div class="section-cta">
            <form id="addonForm" method="GET" action="<%= safePaymentUrl %>" style="width: 100%;">
              <input type="hidden" id="addon_video_hidden" name="addon_video_consultation" value="0">
              <input type="hidden" id="addon_sla_hidden" name="addon_sla_24hr" value="0">
              <button type="submit" class="btn btn-primary" style="width: 100%;">
                <%= safeT('patient.payment_required.cta_pay', isArSafe ? 'الانتقال للدفع' : 'Proceed to payment') %>
              </button>
            </form>
          </div>

          <div class="form-group">
            <label class="form-label"><%= safeT('patient.payment_required.copy_link', isArSafe ? 'إذا لم يفتح الزر، انسخ الرابط:' : "If the button doesn't open, copy the link:") %></label>
            <input class="form-control" type="text" value="<%= safePaymentUrl %>" readonly dir="ltr" onclick="this.select();" />
            <p class="flow-note">
              <%= safeT('patient.payment_required.link_hint', isArSafe ? 'انسخ الرابط وافتحه في المتصفح إذا واجهت مشكلة.' : 'Copy the link and open it in your browser if you run into issues.') %>
            </p>
          </div>
        <% } else { %>
          <p class="flow-note">
            <%= safeT(
              'patient.payment_required.not_configured',
              isArSafe
                ? 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.'
                : 'Payment is not configured for this service. Please contact support.'
            ) %>
          </p>
        <% } %>

        <div class="section-cta">
          <a class="btn btn-secondary" href="/portal/patient/dashboard">
            <%= safeT('common.back_to_dashboard', isArSafe ? 'العودة إلى لوحة التحكم' : 'Back to dashboard') %>
          </a>
        </div>
      </section>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>

<script src="/js/payment-addons.js" defer></script>
