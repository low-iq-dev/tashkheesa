<%- include('partials/header', { title: ((typeof lang !== 'undefined' && lang === 'ar') ? "الدفع مطلوب" : "Payment Required"), layout: "portal", showNav: false }) %>

<%
  const isArSafe = (typeof isAr !== 'undefined' && !!isAr);
  const brandSafe = (typeof brand !== 'undefined' && brand) ? brand : 'Tashkheesa';
  const tFn = (typeof t === 'function') ? t : null;
  const safeT = (key, fallback) => {
    try {
      if (!tFn) return fallback;
      const v = tFn(key);
      if (!v) return fallback;
      if (String(v).trim() === String(key).trim()) return fallback;
      return v;
    } catch (e) {
      return fallback;
    }
  };

  const rawPaymentUrl = (
    (typeof paymentUrl !== 'undefined' && paymentUrl) ? paymentUrl :
    ((typeof paymentLink !== 'undefined' && paymentLink) ? paymentLink : null)
  );

  const isSafeHref = (u) => {
    if (!u) return false;
    const s = String(u).trim();
    if (!s) return false;
    return s.startsWith('http://') || s.startsWith('https://') || s.startsWith('/');
  };

  const safePaymentUrl = isSafeHref(rawPaymentUrl) ? String(rawPaymentUrl).trim() : null;
  const safeError = (typeof error !== 'undefined' && error) ? String(error) : null;

  const localizeError = (msg) => {
    if (!msg) return null;
    const s = String(msg);
    if (!isArSafe) return s;
    const map = {
      'Payment is required before accessing this case.': 'الدفع مطلوب قبل الوصول إلى هذه الحالة.',
      'Payment is required before a specialist can be assigned and the review can begin.': 'الدفع مطلوب قبل تعيين الطبيب المختص وبدء المراجعة.',
      'Payment is not configured for this service. Please contact support.': 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.',
      'Payment link is not available. Please contact support.': 'رابط الدفع غير متاح حالياً. يرجى التواصل مع الدعم.'
    };
    if (map[s]) return map[s];
    if (s.toLowerCase().includes('payment') && s.toLowerCase().includes('required')) {
      return 'الدفع مطلوب لإكمال هذه الخطوة.';
    }
    return s;
  };

  const missingValue = isArSafe ? 'غير متوفر' : '—';
  const hasVideoAddon = (typeof videoConsultationPrice !== 'undefined' && videoConsultationPrice > 0);
  const hasSlaAddon = (typeof sla24hrPrice !== 'undefined' && sla24hrPrice > 0);
  const hasPrescriptionAddon = (typeof prescriptionPrice !== 'undefined' && prescriptionPrice > 0);
  const hasAddons = hasVideoAddon || hasSlaAddon || hasPrescriptionAddon;
  const currency = order?.locked_currency || 'SAR';
  const basePrice = order && (order.locked_price != null) ? order.locked_price : 0;
%>

<div class="portal-shell">
  <div class="portal-header">
    <div class="portal-logo">
      <%= brandSafe %>
      <span><%= safeT('patient.portal', isArSafe ? 'بوابة المريض' : 'Patient Portal') %></span>
    </div>
  </div>

  <div class="portal-grid" data-video-price="<%= typeof videoConsultationPrice !== 'undefined' ? videoConsultationPrice : 0 %>" data-sla-price="<%= typeof sla24hrPrice !== 'undefined' ? sla24hrPrice : 0 %>" data-prescription-price="<%= typeof prescriptionPrice !== 'undefined' ? prescriptionPrice : 0 %>" data-base-price="<%= basePrice %>" data-currency="<%= currency %>">
    <%- include('partials/patient_sidebar', { activePage: 'dashboard', isAr: isArSafe, user: (typeof user !== 'undefined' ? user : {}) }) %>

    <main class="portal-content" dir="<%= isArSafe ? 'rtl' : 'ltr' %>">
      <!-- Hero -->
      <div class="portal-hero">
        <h1 class="portal-hero-title"><%= safeT('patient.payment_required.title', isArSafe ? 'الدفع مطلوب' : 'Payment Required') %></h1>
        <p class="portal-hero-subtitle">
          <%= safeT(
            'patient.payment_required.body',
            isArSafe
              ? 'تم إنشاء هذه الحالة الطبية ولكن لم يتم دفع الرسوم بعد. يجب إتمام الدفع قبل تعيين الطبيب المختص وبدء المراجعة.'
              : 'This medical case has been created but has not yet been paid for. Payment is required before a specialist can be assigned and the review can begin.'
          ) %>
        </p>
      </div>

      <% if (safeError) { %>
        <div class="p-alert p-alert-warning">
          <div class="p-alert-content"><%= localizeError(safeError) %></div>
        </div>
      <% } %>

      <!-- Two-column layout -->
      <div style="display:grid;grid-template-columns:<%= hasAddons ? '1fr 380px' : '1fr' %>;gap:var(--space-3);align-items:start;">

        <!-- Left Column: Service Details + Add-ons -->
        <div style="display:flex;flex-direction:column;gap:var(--space-3);">

          <!-- Service Details Card -->
          <div class="flow-card">
            <div class="section-head" style="margin-bottom:14px;">
              <span class="section-title"><%= isArSafe ? 'تفاصيل الخدمة' : 'Service Details' %></span>
              <span class="status-badge status-unpaid"><%= safeT('patient.payment_required.status_value', isArSafe ? 'بانتظار الدفع' : 'Awaiting Payment') %></span>
            </div>
            <div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div>
                  <div class="p-form-label"><%= safeT('common.service', isArSafe ? 'الخدمة' : 'Service') %></div>
                  <div style="font-size:15px;font-weight:600;color:var(--dark-gray);">
                    <%= order && (order.service_name || order.serviceName) ? (order.service_name || order.serviceName) : missingValue %>
                  </div>
                </div>
                <div>
                  <div class="p-form-label"><%= safeT('common.specialty', isArSafe ? 'التخصص' : 'Specialty') %></div>
                  <div style="font-size:15px;color:var(--text-primary);">
                    <%= order && (order.specialty_name || order.specialtyName) ? (order.specialty_name || order.specialtyName) : missingValue %>
                  </div>
                </div>
                <div>
                  <div class="p-form-label"><%= safeT('common.price', isArSafe ? 'السعر الأساسي' : 'Base Price') %></div>
                  <div style="font-size:15px;font-weight:600;color:var(--medical-blue);">
                    <span id="base-price"><%= basePrice %></span> <%= currency %>
                  </div>
                </div>
                <div>
                  <div class="p-form-label"><%= safeT('common.status', isArSafe ? 'الحالة' : 'Status') %></div>
                  <span class="status-badge status-unpaid"><%= isArSafe ? 'بانتظار الدفع' : 'Awaiting Payment' %></span>
                </div>
              </div>
            </div>
          </div>

          <% if (hasAddons) { %>
          <!-- Add-ons Card -->
          <div class="flow-card">
            <div class="section-head" style="margin-bottom:14px;">
              <span class="section-title"><%= isArSafe ? 'خدمات إضافية' : 'Enhance Your Consultation' %></span>
            </div>
            <div style="display:flex;flex-direction:column;gap:12px;">

              <% if (hasVideoAddon) { %>
              <label class="p-checkbox-group" id="addon-video-group">
                <input
                  type="checkbox"
                  id="addon_video_consultation"
                  name="addon_video_consultation"
                  value="1"
                />
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:15px;color:var(--dark-gray);margin-bottom:2px;">
                    <%= isArSafe ? 'استشارة فيديو مع الطبيب المتخصص' : 'Video Consultation with Specialist' %>
                  </div>
                  <div style="font-size:13px;color:var(--text-secondary);">
                    <%= isArSafe ? 'تواصل وجهاً لوجه مع الطبيب المختص' : 'Connect face-to-face with the doctor for a detailed consultation' %>
                  </div>
                </div>
                <div style="font-weight:700;color:var(--medical-blue);white-space:nowrap;font-size:15px;">
                  +<%= videoConsultationPrice %> <%= currency %>
                </div>
              </label>
              <% } %>

              <% if (hasSlaAddon) { %>
              <label class="p-checkbox-group" id="addon-sla-group">
                <input
                  type="checkbox"
                  id="addon_sla_24hr"
                  name="addon_sla_24hr"
                  value="1"
                />
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:15px;color:var(--dark-gray);margin-bottom:2px;">
                    <%= isArSafe ? 'تشخيص سريع خلال 24 ساعة' : 'Priority 24-Hour Diagnosis' %>
                  </div>
                  <div style="font-size:13px;color:var(--text-secondary);">
                    <%= isArSafe ? 'احصل على نتيجتك خلال 24 ساعة بدلاً من 72 ساعة' : 'Get your results in 24 hours instead of 72 hours' %>
                  </div>
                </div>
                <div style="font-weight:700;color:var(--accent-teal);white-space:nowrap;font-size:15px;">
                  +<%= sla24hrPrice %> <%= currency %>
                </div>
              </label>
              <% } %>

              <% if (hasPrescriptionAddon) { %>
              <label class="p-checkbox-group" id="addon-prescription-group">
                <input
                  type="checkbox"
                  id="addon_prescription"
                  name="addon_prescription"
                  value="1"
                />
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:15px;color:var(--dark-gray);margin-bottom:2px;">
                    <%= isArSafe ? 'خدمة الوصفة الطبية' : 'Prescription Service' %>
                  </div>
                  <div style="font-size:13px;color:var(--text-secondary);">
                    <%= isArSafe ? 'يكتب الطبيب وصفة طبية مع التقرير' : 'Doctor writes a prescription along with your report' %>
                  </div>
                </div>
                <div style="font-weight:700;color:var(--medical-blue);white-space:nowrap;font-size:15px;">
                  +<%= prescriptionPrice %> <%= currency %>
                </div>
              </label>
              <% } %>

            </div>
          </div>
          <% } %>

          <!-- Payment Link (fallback) -->
          <% if (safePaymentUrl) { %>
          <div class="flow-card" style="display:none;" id="payment-link-fallback">
            <div class="p-form-group" style="margin-bottom:0;">
              <label class="p-form-label"><%= safeT('patient.payment_required.copy_link', isArSafe ? 'إذا لم يفتح الزر، انسخ الرابط:' : "If the button doesn't open, copy the link:") %></label>
              <input class="p-form-input" type="text" value="<%= safePaymentUrl %>" readonly dir="ltr" onclick="this.select();" />
              <p class="p-form-hint">
                <%= safeT('patient.payment_required.link_hint', isArSafe ? 'انسخ الرابط وافتحه في المتصفح إذا واجهت مشكلة.' : 'Copy the link and open it in your browser if you run into issues.') %>
              </p>
            </div>
          </div>
          <% } %>
        </div>

        <!-- Right Column: Price Breakdown (sticky sidebar) -->
        <% if (hasAddons) { %>
        <div style="position:sticky;top:96px;">
          <div class="flow-card" style="background:var(--light-gray);border:2px solid #e5e7eb;">
            <div class="section-head" style="margin-bottom:var(--space-2);"><span class="section-title"><%= isArSafe ? 'ملخص الدفع' : 'Payment Summary' %></span></div>

            <div class="p-price-row">
              <span class="label"><%= isArSafe ? 'السعر الأساسي' : 'Service Fee' %></span>
              <span class="value"><span id="breakdown-base"><%= basePrice %></span> <%= currency %></span>
            </div>

            <div class="p-price-row" id="addon-video-row" style="display:none;">
              <span class="label"><%= isArSafe ? 'استشارة فيديو' : 'Video Consultation' %></span>
              <span class="value" id="addon-video-price">+<%= typeof videoConsultationPrice !== 'undefined' ? videoConsultationPrice : 0 %> <%= currency %></span>
            </div>

            <div class="p-price-row" id="addon-sla-row" style="display:none;">
              <span class="label"><%= isArSafe ? 'تشخيص سريع 24 ساعة' : '24-Hour Diagnosis' %></span>
              <span class="value" id="addon-sla-price">+<%= typeof sla24hrPrice !== 'undefined' ? sla24hrPrice : 0 %> <%= currency %></span>
            </div>

            <div class="p-price-row" id="addon-prescription-row" style="display:none;">
              <span class="label"><%= isArSafe ? 'وصفة طبية' : 'Prescription' %></span>
              <span class="value" id="addon-prescription-price">+<%= typeof prescriptionPrice !== 'undefined' ? prescriptionPrice : 0 %> <%= currency %></span>
            </div>

            <div class="p-price-row total">
              <span class="label"><%= isArSafe ? 'الإجمالي' : 'Total' %></span>
              <span class="value" id="total-price"><%= basePrice %> <%= currency %></span>
            </div>

            <% if (safePaymentUrl) { %>
              <form id="addonForm" method="GET" action="<%= safePaymentUrl %>" style="margin-top:var(--space-2);">
                <input type="hidden" id="addon_video_hidden" name="addon_video_consultation" value="0">
                <input type="hidden" id="addon_sla_hidden" name="addon_sla_24hr" value="0">
                <input type="hidden" id="addon_prescription_hidden" name="addon_prescription" value="0">
                <button type="submit" class="p-btn p-btn-primary p-btn-block p-btn-lg">
                  <%= safeT('patient.payment_required.cta_pay', isArSafe ? 'الانتقال للدفع' : 'Proceed to Payment') %>
                </button>
              </form>
              <button type="button" class="p-btn p-btn-ghost p-btn-block p-btn-sm" style="margin-top:8px;" onclick="document.getElementById('payment-link-fallback').style.display='block'">
                <%= isArSafe ? 'مشكلة في الدفع؟' : 'Having issues?' %>
              </button>
            <% } else { %>
              <div class="p-alert p-alert-warning" style="margin-top:var(--space-2);">
                <div class="p-alert-content">
                  <%= safeT(
                    'patient.payment_required.not_configured',
                    isArSafe
                      ? 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.'
                      : 'Payment is not configured for this service. Please contact support.'
                  ) %>
                </div>
              </div>
            <% } %>

            <a class="p-btn p-btn-ghost p-btn-block p-btn-sm" href="/portal/patient/dashboard" style="margin-top:8px;">
              <%= safeT('common.back_to_dashboard', isArSafe ? 'العودة إلى لوحة التحكم' : 'Back to Dashboard') %>
            </a>
          </div>
        </div>
        <% } else { %>
        <!-- No add-ons: simple payment section -->
        <% if (safePaymentUrl) { %>
        <div class="flow-card" style="text-align:center;">
          <div class="section-head" style="margin-bottom:var(--space-2);">
            <span class="section-title"><%= isArSafe ? 'جاهز للدفع' : 'Ready to Pay' %></span>
          </div>
          <div style="font-size:28px;font-weight:800;color:var(--medical-blue);margin-bottom:var(--space-2);">
            <%= basePrice %> <%= currency %>
          </div>
          <form id="addonForm" method="GET" action="<%= safePaymentUrl %>">
            <input type="hidden" id="addon_video_hidden" name="addon_video_consultation" value="0">
            <input type="hidden" id="addon_sla_hidden" name="addon_sla_24hr" value="0">
            <button type="submit" class="p-btn p-btn-primary p-btn-block p-btn-lg">
              <%= safeT('patient.payment_required.cta_pay', isArSafe ? 'الانتقال للدفع' : 'Proceed to Payment') %>
            </button>
          </form>
          <a class="p-btn p-btn-ghost p-btn-block p-btn-sm" href="/portal/patient/dashboard" style="margin-top:12px;">
            <%= safeT('common.back_to_dashboard', isArSafe ? 'العودة إلى لوحة التحكم' : 'Back to Dashboard') %>
          </a>
        </div>
        <% } else { %>
          <div class="p-alert p-alert-warning">
            <div class="p-alert-content">
              <%= safeT(
                'patient.payment_required.not_configured',
                isArSafe
                  ? 'الدفع غير مفعّل لهذه الخدمة. يرجى التواصل مع الدعم.'
                  : 'Payment is not configured for this service. Please contact support.'
              ) %>
            </div>
          </div>
          <a class="p-btn p-btn-secondary" href="/portal/patient/dashboard">
            <%= safeT('common.back_to_dashboard', isArSafe ? 'العودة إلى لوحة التحكم' : 'Back to Dashboard') %>
          </a>
        <% } %>
        <% } %>

      </div>
    </main>
  </div>
</div>

<%- include('partials/footer', { showFooter: false }) %>

<script src="/js/payment-addons.js" defer></script>
<style>
  /* Payment page responsive override */
  @media (max-width: 768px) {
    .portal-content > div[style*="grid-template-columns"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
